<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Airtime Solution Kenya</title>
    <link rel="manifest" href="/manifest.json">
    <link rel="icon" type="image/png" href="/airtime-logo.png">
    <link rel="apple-touch-icon" href="/airtime-logo.png">
    <meta name="theme-color" content="#1a5f2a">
    <meta name="description" content="Buy and resell airtime in Kenya. Fast, reliable, and affordable.">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #1a5f2a;
            --primary-dark: #0d3d18;
            --primary-light: #2d8b42;
            --secondary: #f4a020;
            --accent: #e63946;
            --success: #28a745;
            --warning: #ffc107;
            --danger: #dc3545;
            --info: #17a2b8;
            --dark: #212529;
            --light: #f8f9fa;
            --white: #ffffff;
            --gray: #6c757d;
            --border: #dee2e6;
        }

        [data-theme="dark"] {
            --primary: #2d8b42;
            --primary-dark: #1a5f2a;
            --dark: #f8f9fa;
            --light: #1a1a2e;
            --white: #16213e;
            --gray: #adb5bd;
            --border: #3a3a5c;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Poppins', sans-serif;
            background: var(--light);
            color: var(--dark);
            min-height: 100vh;
            transition: all 0.3s ease;
        }

        .balance-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.01);
            z-index: 999;
            display: none;
            pointer-events: none;
        }

        .balance-overlay.show {
            display: block;
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 9999;
            display: none;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            gap: 20px;
        }

        .loading-overlay.show { display: flex; }

        .loading-spinner-large {
            width: 60px;
            height: 60px;
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top-color: #f4a020;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        .loading-text {
            color: white;
            font-size: 1.1rem;
            font-weight: 500;
            animation: pulse 1.5s ease-in-out infinite;
        }

        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        @keyframes bellShake {
            0%, 100% { transform: rotate(0); }
            10%, 30%, 50%, 70%, 90% { transform: rotate(-10deg); }
            20%, 40%, 60%, 80% { transform: rotate(10deg); }
        }
        
        @keyframes giftShake {
            0%, 100% { transform: rotate(0) scale(1); }
            15% { transform: rotate(-15deg) scale(1.1); }
            30% { transform: rotate(10deg) scale(1.15); }
            45% { transform: rotate(-10deg) scale(1.1); }
            60% { transform: rotate(8deg) scale(1.05); }
            75% { transform: rotate(-5deg) scale(1); }
        }
        
        .shake-gift {
            animation: giftShake 1.5s ease-in-out infinite;
            color: #f4a020;
        }
        
        .sell-airtime-menu {
            background: linear-gradient(135deg, rgba(244, 160, 32, 0.1), rgba(230, 126, 34, 0.1)) !important;
        }
        
        .notification-btn.has-notification i {
            animation: bellShake 0.8s ease-in-out infinite;
            color: #ffd700;
        }
        
        .notification-item.unread h5 {
            color: #ffd700;
            font-weight: 600;
        }
        
        .scrolling-text-container {
            background: linear-gradient(135deg, var(--secondary), #e67e22);
            overflow: hidden;
            padding: 10px 0;
            margin-bottom: 20px;
            border-radius: 8px;
        }
        
        .scrolling-text {
            display: inline-block;
            white-space: nowrap;
            animation: scrollText 20s linear infinite;
            font-weight: 600;
            color: var(--dark);
        }
        
        @keyframes scrollText {
            0% { transform: translateX(100%); }
            100% { transform: translateX(-100%); }
        }
        
        .users-graph-card {
            background: var(--white);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
        }
        
        .graph-container {
            height: 200px;
            display: flex;
            align-items: flex-end;
            justify-content: space-around;
            gap: 10px;
            padding: 20px 10px 10px;
            background: var(--light);
            border-radius: 12px;
        }
        
        .graph-bar {
            flex: 1;
            background: linear-gradient(to top, var(--primary), var(--primary-light));
            border-radius: 8px 8px 0 0;
            position: relative;
            min-width: 30px;
            transition: height 0.5s ease;
        }
        
        .graph-bar span {
            position: absolute;
            bottom: -25px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.7rem;
            color: var(--gray);
            white-space: nowrap;
        }
        
        .graph-bar::after {
            content: attr(data-value);
            position: absolute;
            top: -20px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--primary);
        }
        
        .profile-avatar {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            object-fit: cover;
            margin: 0 auto 20px;
            display: block;
            border: 4px solid var(--primary);
        }

        .app-container { max-width: 100%; min-height: 100vh; }

        .header {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: var(--white);
            padding: 15px 20px;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 15px rgba(0,0,0,0.2);
        }

        .header-left { display: flex; align-items: center; gap: 15px; }
        .menu-btn { background: none; border: none; color: var(--white); font-size: 1.5rem; cursor: pointer; padding: 5px; }
        .logo { display: flex; align-items: center; gap: 10px; }
        .logo img { width: 40px; height: 40px; border-radius: 50%; }
        .logo-text { font-weight: 600; font-size: 1.1rem; color: #f0f0f0; }
        .header-right { display: flex; align-items: center; gap: 15px; }

        .notification-btn {
            background: none;
            border: none;
            color: var(--white);
            font-size: 1.3rem;
            cursor: pointer;
            position: relative;
        }

        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: var(--accent);
            color: white;
            font-size: 0.7rem;
            padding: 2px 6px;
            border-radius: 50%;
            font-weight: 600;
        }

        .user-balance {
            display: flex;
            align-items: center;
            gap: 8px;
            background: rgba(255,255,255,0.15);
            padding: 8px 15px;
            border-radius: 25px;
        }

        .balance-amount { font-weight: 700; color: var(--secondary); }

        .refresh-btn {
            background: none;
            border: none;
            color: var(--white);
            cursor: pointer;
            font-size: 0.9rem;
            transition: transform 0.3s;
        }

        .refresh-btn:hover { transform: rotate(180deg); }
        .refresh-btn.spinning { animation: spin 1s linear infinite; }

        .sidebar {
            position: fixed;
            top: 0;
            left: -280px;
            width: 280px;
            height: 100vh;
            background: var(--white);
            z-index: 2000;
            transition: left 0.3s ease;
            box-shadow: 5px 0 20px rgba(0,0,0,0.1);
            overflow-y: auto;
        }

        .sidebar.open { left: 0; }

        .sidebar-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1999;
            display: none;
        }

        .sidebar-overlay.show { display: block; }

        .sidebar-header {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: var(--white);
            padding: 25px 20px;
        }

        .sidebar-user { display: flex; align-items: center; gap: 15px; }

        .user-avatar {
            width: 50px;
            height: 50px;
            background: rgba(255,255,255,0.2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }

        .user-info h3 { font-weight: 600; font-size: 1rem; }
        .user-info p { font-size: 0.85rem; opacity: 0.8; }
        .sidebar-menu { padding: 20px 0; }

        .menu-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px 25px;
            color: var(--dark);
            text-decoration: none;
            transition: all 0.3s;
            cursor: pointer;
            border: none;
            background: none;
            width: 100%;
            font-family: inherit;
            font-size: 0.95rem;
        }

        .menu-item:hover, .menu-item.active {
            background: rgba(26, 95, 42, 0.1);
            color: var(--primary);
        }

        .menu-item i { width: 25px; text-align: center; }
        .menu-divider { height: 1px; background: var(--border); margin: 15px 20px; }
        .main-content { padding-top: 70px; padding-bottom: 20px; min-height: 100vh; }

        .page {
            display: none;
            padding: 0;
            animation: fadeIn 0.4s ease;
        }
        
        .page-content {
            padding: 0 20px 20px 20px;
        }

        .page.active { display: block; }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .hero-section {
            background: url('airtime-hero-bg.png') center center / cover no-repeat;
            border-radius: 0;
            padding: 20px;
            margin: 0 0 20px 0;
            position: relative;
        }

        .hero-section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 0;
            z-index: 0;
        }

        .hero-section > * {
            position: relative;
            z-index: 1;
        }

        .card {
            background: var(--white);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
        }

        .card-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 15px;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .balance-card {
            background: linear-gradient(145deg, var(--primary) 0%, var(--primary-dark) 50%, #0a2d12 100%);
            color: var(--white);
            text-align: center;
            padding: 35px 25px;
            border-radius: 24px;
            position: relative;
            overflow: hidden;
            box-shadow: 0 15px 35px rgba(26, 95, 42, 0.25);
        }

        .balance-card::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
            pointer-events: none;
        }

        .balance-card::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--secondary), #e67e22, var(--secondary));
        }

        .balance-label { 
            font-size: 0.95rem; 
            opacity: 0.95; 
            margin-bottom: 8px;
            font-weight: 400;
            letter-spacing: 0.5px;
            text-transform: uppercase;
        }

        .balance-value { 
            font-size: 3rem; 
            font-weight: 800; 
            text-shadow: 0 4px 15px rgba(0,0,0,0.2);
            letter-spacing: 1px;
            margin: 10px 0;
        }

        .balance-bonus { 
            color: var(--secondary); 
            font-size: 0.9rem; 
            margin-top: 12px;
            background: rgba(244, 160, 32, 0.15);
            padding: 10px 18px;
            border-radius: 30px;
            display: inline-block;
            font-weight: 500;
            border: 1px solid rgba(244, 160, 32, 0.3);
        }

        .balance-bonus i {
            animation: giftShake 1.5s ease-in-out infinite;
            margin-right: 6px;
        }

        .quick-actions { 
            display: flex;
            flex-direction: column;
            gap: 12px; 
            margin-top: 20px; 
        }

        .quick-actions-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-top: 20px;
        }

        .action-card {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 25px 15px;
            background: rgba(13, 61, 24, 0.85);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            color: var(--white);
            gap: 12px;
            font-family: inherit;
        }

        .action-card i {
            font-size: 1.8rem;
            color: var(--secondary);
        }

        .action-card span {
            font-size: 0.95rem;
            font-weight: 600;
            color: var(--white);
        }

        .action-card:hover {
            background: rgba(13, 61, 24, 0.95);
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.3);
            border-color: rgba(244, 160, 32, 0.3);
        }

        .action-card:active {
            transform: translateY(0) scale(0.98);
        }

        .action-btn {
            display: flex;
            flex-direction: row;
            align-items: center;
            gap: 16px;
            padding: 18px 22px;
            background: var(--white);
            border: none;
            border-radius: 16px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            text-decoration: none;
            color: var(--dark);
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            position: relative;
            overflow: hidden;
        }

        .action-btn::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 4px;
            background: linear-gradient(180deg, var(--primary), var(--primary-light));
            opacity: 0;
            transition: opacity 0.3s;
        }

        .action-btn:hover::before {
            opacity: 1;
        }

        .action-btn:hover {
            transform: translateX(5px);
            box-shadow: 0 8px 25px rgba(26,95,42,0.18);
            background: linear-gradient(90deg, rgba(26, 95, 42, 0.03), var(--white));
        }

        .action-btn:active {
            transform: translateX(2px) scale(0.98);
        }

        .action-btn i { 
            font-size: 1.5rem; 
            color: var(--primary);
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, rgba(26, 95, 42, 0.1), rgba(45, 139, 66, 0.1));
            border-radius: 14px;
            flex-shrink: 0;
        }

        .action-btn span { 
            font-weight: 600; 
            font-size: 1rem;
            color: var(--dark);
        }

        .action-btn .action-arrow {
            margin-left: auto;
            color: var(--gray);
            font-size: 1rem;
            transition: transform 0.3s, color 0.3s;
        }

        .action-btn:hover .action-arrow {
            transform: translateX(5px);
            color: var(--primary);
        }
        .form-group { margin-bottom: 20px; }
        .form-label { display: block; margin-bottom: 8px; font-weight: 500; color: var(--dark); }
        .form-label i { color: var(--primary); margin-right: 8px; }

        .form-input {
            width: 100%;
            padding: 14px 16px;
            border: 2px solid var(--border);
            border-radius: 12px;
            font-size: 1rem;
            font-family: inherit;
            background: var(--white);
            color: var(--dark);
            transition: all 0.3s;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(26,95,42,0.1);
        }

        .phone-wrapper { display: flex; }

        .phone-prefix {
            background: var(--light);
            padding: 14px 15px;
            border: 2px solid var(--border);
            border-right: none;
            border-radius: 12px 0 0 12px;
            font-weight: 500;
            color: var(--dark);
        }

        .phone-wrapper .form-input { border-radius: 0 12px 12px 0; }

        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            padding: 14px 24px;
            border: none;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            font-family: inherit;
            width: 100%;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            color: var(--white);
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(26,95,42,0.3);
        }

        .btn-secondary { background: var(--secondary); color: var(--dark); }
        .btn-outline { background: transparent; border: 2px solid var(--primary); color: var(--primary); }
        .btn-outline:hover { background: var(--primary); color: var(--white); }
        .btn-link { background: #0066cc; color: var(--white); }
        .btn-link:hover { background: #0052a3; }
        .btn:disabled { opacity: 0.7; cursor: not-allowed; }
        .btn-group { display: flex; flex-direction: column; gap: 10px; margin-top: 20px; }

        .btn .spinner {
            width: 20px;
            height: 20px;
            border: 2px solid transparent;
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        .divider-text {
            display: flex;
            align-items: center;
            margin: 15px 0;
            color: var(--gray);
            font-size: 0.85rem;
        }

        .divider-text::before, .divider-text::after { content: ''; flex: 1; height: 1px; background: var(--border); }
        .divider-text span { padding: 0 15px; }

        .info-box {
            background: rgba(26, 95, 42, 0.1);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            border-left: 4px solid var(--primary);
        }

        .info-box p { font-size: 0.9rem; color: var(--dark); }

        /* Network Selector Styles */
        .network-selector {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            justify-content: center;
        }

        .network-option {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 15px;
            border: 3px solid var(--border);
            border-radius: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            background: var(--white);
            min-width: 90px;
        }

        .network-option:hover {
            border-color: var(--primary-light);
            transform: translateY(-2px);
        }

        .network-option.selected {
            border-color: var(--primary);
            background: rgba(26, 95, 42, 0.1);
            box-shadow: 0 0 0 3px rgba(26, 95, 42, 0.2);
        }

        .network-option img {
            width: 50px;
            height: 50px;
            object-fit: contain;
            margin-bottom: 8px;
        }

        .network-option span {
            font-size: 0.85rem;
            font-weight: 500;
            color: var(--dark);
        }

        .validation-error {
            color: var(--danger);
            font-size: 0.8rem;
            margin-top: 5px;
            display: none;
        }

        .validation-error.show {
            display: block;
        }

        .form-input.valid {
            border-color: var(--success);
        }

        .form-input.invalid {
            border-color: var(--danger);
        }

        .network-error {
            color: var(--danger);
            font-size: 0.85rem;
            text-align: center;
            margin-bottom: 15px;
            display: none;
        }

        .network-error.show {
            display: block;
        }

        .transaction-list { max-height: 400px; overflow-y: auto; }

        .transaction-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid var(--border);
            transition: background 0.2s;
        }

        .transaction-item:hover { background: var(--light); }
        .transaction-item:last-child { border-bottom: none; }
        .transaction-info { display: flex; align-items: center; gap: 12px; }

        .transaction-icon {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
        }

        .transaction-icon.deposit { background: rgba(40, 167, 69, 0.15); color: var(--success); }
        .transaction-icon.airtime { background: rgba(23, 162, 184, 0.15); color: var(--info); }
        .transaction-icon.failed { background: rgba(220, 53, 69, 0.15); color: var(--danger); }
        .transaction-icon.pending { background: rgba(255, 193, 7, 0.15); color: var(--warning); }
        .transaction-details h4 { font-size: 0.95rem; font-weight: 500; margin-bottom: 3px; }
        .transaction-details p { font-size: 0.8rem; color: var(--gray); }
        .transaction-amount { text-align: right; }
        .transaction-amount .amount { font-weight: 600; font-size: 1rem; }
        .transaction-amount .bonus { color: var(--success); font-size: 0.8rem; }
        .transaction-amount .status { font-size: 0.75rem; padding: 3px 8px; border-radius: 20px; }
        .status-completed { background: rgba(40, 167, 69, 0.15); color: var(--success); }
        .status-pending { background: rgba(255, 193, 7, 0.15); color: #856404; }
        .status-failed { background: rgba(220, 53, 69, 0.15); color: var(--danger); }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.6);
            z-index: 3000;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal.show { display: flex; }

        .modal-content {
            background: var(--white);
            border-radius: 20px;
            width: 100%;
            max-width: 450px;
            max-height: 90vh;
            overflow-y: auto;
            animation: modalSlide 0.3s ease;
        }

        @keyframes modalSlide {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }

        .modal-header {
            padding: 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h3 { font-size: 1.2rem; font-weight: 600; color: var(--primary); }
        .modal-close { background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--gray); }
        .modal-body { padding: 20px; }
        .modal-footer { padding: 15px 20px; border-top: 1px solid var(--border); display: flex; gap: 10px; }

        .notification-panel {
            position: fixed;
            top: 70px;
            right: 10px;
            width: 320px;
            max-height: 400px;
            background: var(--white);
            border-radius: 16px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            z-index: 2500;
            display: none;
            overflow: hidden;
        }

        .notification-panel.show { display: block; animation: slideDown 0.3s ease; }

        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .notification-header {
            padding: 15px 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .notification-header h4 { font-weight: 600; color: var(--primary); }
        .notification-list { max-height: 300px; overflow-y: auto; }

        .notification-item {
            padding: 15px 20px;
            border-bottom: 1px solid var(--border);
            cursor: pointer;
            transition: background 0.2s;
            background: rgba(26, 95, 42, 0.08);
        }

        .notification-item:hover { background: rgba(26, 95, 42, 0.15); }
        .notification-item.unread { background: rgba(26, 95, 42, 0.18); }
        .notification-item h5 { font-size: 0.9rem; font-weight: 500; margin-bottom: 5px; }
        .notification-item p { font-size: 0.8rem; color: var(--gray); }
        .notification-item .time { font-size: 0.75rem; color: var(--gray); margin-top: 5px; }

        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--dark);
            color: var(--white);
            padding: 15px 25px;
            border-radius: 12px;
            z-index: 4000;
            display: none;
            animation: toastSlide 0.3s ease;
            max-width: 90%;
        }

        .toast.show { display: flex; align-items: center; gap: 10px; }

        @keyframes toastSlide {
            from { opacity: 0; transform: translate(-50%, 20px); }
            to { opacity: 1; transform: translate(-50%, 0); }
        }

        .toast.success { background: var(--success); }
        .toast.error { background: var(--danger); }
        .toast.info { background: var(--info); }
        .toast.delay { background: #6c5ce7; }
        .toast.cancel { background: #e74c3c; }

        .retry-btn {
            display: none;
            margin-top: 15px;
            padding: 12px 20px;
            background: linear-gradient(135deg, var(--warning), #e67e22);
            color: var(--dark);
            border: none;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            align-items: center;
            justify-content: center;
            gap: 10px;
            width: 100%;
        }

        .retry-btn.show { display: flex; }
        .retry-btn:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(230, 126, 34, 0.3); }

        .status-cancelled { background: rgba(220, 53, 69, 0.15); color: var(--danger); }
        .status-delay { background: rgba(108, 92, 231, 0.15); color: #6c5ce7; }

        .live-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            background: var(--success);
            border-radius: 50%;
            margin-right: 5px;
            animation: livePulse 1.5s ease-in-out infinite;
        }

        @keyframes livePulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(0.8); }
        }

        .coming-soon-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255,255,255,0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10;
            border-radius: 16px;
        }

        .coming-soon-badge {
            background: linear-gradient(135deg, var(--secondary), #e67e22);
            color: var(--white);
            padding: 15px 30px;
            border-radius: 30px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
            box-shadow: 0 5px 20px rgba(244,160,32,0.4);
        }

        .rate-display {
            text-align: center;
            padding: 20px;
            background: var(--light);
            border-radius: 12px;
            margin-bottom: 20px;
        }

        .rate-display .rate {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary);
        }

        .dial-code {
            background: var(--dark);
            color: var(--white);
            padding: 15px;
            border-radius: 10px;
            font-family: monospace;
            font-size: 1.2rem;
            text-align: center;
            margin-bottom: 15px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: var(--white);
            padding: 20px;
            border-radius: 16px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
        }

        .stat-card i { font-size: 2rem; color: var(--primary); margin-bottom: 10px; }
        .stat-card .value { font-size: 1.5rem; font-weight: 700; color: var(--dark); }
        .stat-card .label { font-size: 0.85rem; color: var(--gray); }

        .admin-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .admin-tab {
            padding: 10px 20px;
            border: none;
            background: var(--light);
            border-radius: 10px;
            cursor: pointer;
            font-family: inherit;
            transition: all 0.3s;
        }

        .admin-tab.active { background: var(--primary); color: white; }
        .table-responsive { overflow-x: auto; }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
        }

        .data-table th, .data-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }

        .data-table th { background: var(--light); font-weight: 600; }

        .empty-state { text-align: center; padding: 40px 20px; color: var(--gray); }
        .empty-state i { font-size: 4rem; margin-bottom: 15px; opacity: 0.5; }
        .empty-state h3 { font-size: 1.2rem; margin-bottom: 10px; }
        .empty-state p { font-size: 0.9rem; }

        .footer-links {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 30px;
            flex-wrap: wrap;
        }

        .footer-link {
            color: var(--gray);
            font-size: 0.85rem;
            cursor: pointer;
        }

        .footer-link:hover { color: var(--primary); }

        .pwa-install {
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            gap: 10px;
            background: #000000;
            color: var(--white);
            width: 100%;
            padding: 15px;
            border-radius: 12px;
            cursor: pointer;
            border: none;
            box-shadow: 0 4px 15px rgba(0,0,0,0.15);
            margin-top: 20px;
        }

        .pwa-install p {
            color: #ffffff;
            font-size: 0.9rem;
            margin: 0;
        }

        @media (max-width: 480px) {
            .header { padding: 12px 15px; }
            .logo-text { font-size: 0.9rem; }
            .quick-actions { flex-direction: column; gap: 10px; }
            .action-btn { padding: 15px 18px; }
            .action-btn i:first-child { width: 44px; height: 44px; font-size: 1.3rem; }
            .balance-value { font-size: 2.5rem; }
            .notification-panel { right: 5px; left: 5px; width: auto; }
            .stats-grid { grid-template-columns: repeat(2, 1fr); }
        }

        /* ===== LOAN SYSTEM STYLES ===== */
        .loan-terms-modal .modal-content {
            max-width: 550px;
            max-height: 85vh;
        }
        .loan-terms-content {
            max-height: 300px;
            overflow-y: auto;
            padding: 15px;
            background: var(--light);
            border-radius: 10px;
            border: 1px solid var(--border);
            margin-bottom: 20px;
            font-size: 0.9rem;
            line-height: 1.7;
        }
        .loan-terms-content h4 { margin: 15px 0 10px; color: var(--primary); }
        .loan-terms-content ul { padding-left: 20px; }
        .loan-terms-content li { margin-bottom: 8px; }
        .loan-agree-section { text-align: center; }
        .loan-agree-btn {
            background: linear-gradient(135deg, #4CAF50, #388E3C);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            opacity: 0.5;
            pointer-events: none;
        }
        .loan-agree-btn.enabled { opacity: 1; pointer-events: auto; }
        .loan-agree-btn.enabled:hover { transform: scale(1.05); box-shadow: 0 5px 20px rgba(76, 175, 80, 0.4); }
        .scroll-hint {
            font-size: 0.85rem;
            color: var(--gray);
            margin-bottom: 15px;
            padding: 10px;
            background: rgba(255, 193, 7, 0.1);
            border-radius: 8px;
            border-left: 3px solid var(--warning);
        }
        .loan-dashboard-hero {
            background: linear-gradient(135deg, #1a5f2a 0%, #0d3d18 50%, #0a2d12 100%);
            color: white;
            padding: 30px 20px;
            text-align: center;
            border-radius: 0 0 25px 25px;
            margin-bottom: 20px;
        }
        .loan-dashboard-hero h1 { font-size: 1.8rem; margin-bottom: 10px; }
        .loan-dashboard-hero p { opacity: 0.9; font-size: 1rem; }
        .loan-feature-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            padding: 0 20px;
            margin-bottom: 20px;
        }
        .loan-feature-card {
            background: var(--white);
            padding: 20px;
            border-radius: 16px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            transition: transform 0.3s;
        }
        .loan-feature-card:hover { transform: translateY(-5px); }
        .loan-feature-card i { font-size: 2rem; color: var(--primary); margin-bottom: 10px; }
        .loan-feature-card h4 { font-size: 0.95rem; margin-bottom: 5px; }
        .loan-feature-card p { font-size: 0.8rem; color: var(--gray); }
        .how-it-works-section { padding: 20px; }
        .how-it-works-section h3 { text-align: center; margin-bottom: 20px; color: var(--primary); }
        .step-item {
            display: flex;
            align-items: flex-start;
            gap: 15px;
            margin-bottom: 20px;
            padding: 15px;
            background: var(--white);
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        .step-number {
            width: 40px;
            height: 40px;
            background: var(--primary);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            flex-shrink: 0;
        }
        .step-content h4 { font-size: 1rem; margin-bottom: 5px; }
        .step-content p { font-size: 0.85rem; color: var(--gray); }
        .why-choose-section { padding: 20px; background: linear-gradient(135deg, rgba(76, 175, 80, 0.1), rgba(56, 142, 60, 0.05)); }
        .why-choose-section h3 { text-align: center; margin-bottom: 20px; color: var(--primary); }
        .testimonial-card {
            background: var(--white);
            padding: 20px;
            border-radius: 16px;
            margin-bottom: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
        }
        .testimonial-card .stars { color: #ffc107; margin-bottom: 10px; }
        .testimonial-card p { font-style: italic; color: var(--dark); margin-bottom: 10px; }
        .testimonial-card .author { font-weight: 600; font-size: 0.9rem; color: var(--primary); }
        .faq-section { padding: 20px; }
        .faq-section h3 { text-align: center; margin-bottom: 20px; color: var(--primary); }
        .faq-item {
            background: var(--white);
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        .faq-item h4 { font-size: 0.95rem; margin-bottom: 8px; color: var(--dark); cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
        .faq-item p { font-size: 0.85rem; color: var(--gray); display: none; padding-top: 10px; border-top: 1px solid var(--border); }
        .faq-item.open p { display: block; }
        .loan-images-section { padding: 20px; display: flex; gap: 15px; overflow-x: auto; }
        .loan-image-card { min-width: 200px; border-radius: 16px; overflow: hidden; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .loan-image-card img { width: 100%; height: 150px; object-fit: cover; }
        .apply-loan-btn {
            display: block;
            margin: 20px;
            padding: 18px;
            background: linear-gradient(135deg, #4CAF50, #388E3C);
            color: white;
            text-align: center;
            border-radius: 30px;
            font-size: 1.1rem;
            font-weight: 700;
            text-decoration: none;
            box-shadow: 0 5px 20px rgba(76, 175, 80, 0.4);
            cursor: pointer;
            border: none;
            width: calc(100% - 40px);
        }
        .apply-loan-btn:hover { transform: scale(1.02); }
        .eligibility-form-container { padding: 20px; }
        .form-section { margin-bottom: 25px; }
        .form-section-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--primary);
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--primary);
        }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        @media (max-width: 480px) { .form-row { grid-template-columns: 1fr; } }
        .processing-container {
            text-align: center;
            padding: 40px 20px;
        }
        .processing-icon {
            font-size: 5rem;
            color: var(--primary);
            margin-bottom: 20px;
            animation: pulse 1.5s ease-in-out infinite;
        }
        .processing-bar {
            width: 100%;
            height: 10px;
            background: var(--border);
            border-radius: 5px;
            overflow: hidden;
            margin: 30px 0;
        }
        .processing-progress {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--primary-light));
            border-radius: 5px;
            width: 0%;
            animation: progressFill 10s linear forwards;
        }
        @keyframes progressFill { 0% { width: 0%; } 100% { width: 100%; } }
        .loan-offer-card {
            background: var(--white);
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            border: 2px solid transparent;
            transition: all 0.3s;
            cursor: pointer;
        }
        .loan-offer-card:hover { border-color: var(--primary); transform: translateY(-3px); }
        .loan-offer-card.selected { border-color: var(--primary); background: rgba(76, 175, 80, 0.05); }
        .loan-offer-header { display: flex; align-items: center; gap: 15px; margin-bottom: 15px; }
        .loan-company-logo {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: var(--primary);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.5rem;
            font-weight: 700;
        }
        .loan-company-info h4 { font-size: 1.1rem; margin-bottom: 3px; }
        .loan-company-info p { font-size: 0.85rem; color: var(--gray); }
        .loan-amount-display {
            text-align: center;
            padding: 20px;
            background: linear-gradient(135deg, rgba(76, 175, 80, 0.1), rgba(56, 142, 60, 0.05));
            border-radius: 15px;
            margin-bottom: 15px;
        }
        .loan-amount-display .amount { font-size: 2rem; font-weight: 700; color: var(--primary); }
        .loan-amount-display .label { font-size: 0.9rem; color: var(--gray); }
        .loan-terms-list { display: flex; flex-wrap: wrap; gap: 10px; }
        .loan-term-item {
            background: var(--light);
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .loan-term-item i { color: var(--primary); }
        .loan-details-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-top: 15px;
        }
        .loan-detail-item {
            background: var(--light);
            padding: 12px;
            border-radius: 12px;
            text-align: center;
        }
        .loan-detail-item i {
            color: var(--primary);
            font-size: 1.2rem;
            display: block;
            margin-bottom: 5px;
        }
        .loan-detail-item .detail-label {
            font-size: 0.75rem;
            color: var(--gray);
            display: block;
        }
        .loan-detail-item .detail-value {
            font-size: 0.95rem;
            font-weight: 700;
            color: var(--dark);
            display: block;
        }
        .select-offer-btn {
            transition: all 0.3s;
        }
        .loan-offer-card.selected .select-offer-btn {
            background: var(--success);
        }
        .loan-offer-card.selected .select-offer-btn::before {
            content: "Selected - ";
        }
        .edit-section-btn {
            background: none;
            border: none;
            color: var(--primary);
            cursor: pointer;
            font-size: 0.9rem;
            padding: 5px 10px;
            margin-left: auto;
        }
        .edit-section-btn:hover {
            background: rgba(76, 175, 80, 0.1);
            border-radius: 5px;
        }
        .approval-container {
            text-align: center;
            padding: 40px 20px;
        }
        .approval-icon {
            width: 100px;
            height: 100px;
            margin: 0 auto 20px;
            position: relative;
        }
        .approval-spinner {
            width: 100%;
            height: 100%;
            border: 5px solid var(--border);
            border-top: 5px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        .approval-timer {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            padding: 20px 40px;
            border-radius: 20px;
            display: inline-block;
            margin: 20px 0;
        }
        .approval-timer #approvalCountdown {
            font-size: 3rem;
            font-weight: 700;
            display: block;
        }
        .approval-timer .timer-label {
            font-size: 0.85rem;
            opacity: 0.9;
        }
        .approval-steps {
            text-align: left;
            max-width: 350px;
            margin: 20px auto;
        }
        .approval-step {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            margin-bottom: 8px;
            border-radius: 10px;
            background: var(--light);
            transition: all 0.3s;
        }
        .approval-step i {
            color: var(--primary);
            width: 20px;
            text-align: center;
        }
        .approval-step.pending {
            opacity: 0.5;
        }
        .approval-step.pending i {
            font-size: 0.5rem;
        }
        .approval-step.completed {
            background: rgba(76, 175, 80, 0.1);
        }
        .approval-step.completed i {
            color: var(--success);
        }
        .savings-info-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin: 15px 0;
        }
        .savings-info-item {
            background: rgba(255,255,255,0.15);
            padding: 12px;
            border-radius: 10px;
            text-align: center;
        }
        .savings-info-item .label {
            font-size: 0.75rem;
            opacity: 0.8;
            display: block;
            margin-bottom: 3px;
        }
        .savings-info-item .value {
            font-size: 0.9rem;
            font-weight: 600;
        }
        .receipt-row {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid var(--border);
        }
        .receipt-row:last-child { border-bottom: none; }
        .loan-images-section {
            display: flex;
            gap: 15px;
            overflow-x: auto;
            padding: 20px;
            scrollbar-width: none;
            -ms-overflow-style: none;
        }
        .loan-images-section::-webkit-scrollbar { display: none; }
        .loan-image-card {
            flex-shrink: 0;
            width: 280px;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            background: white;
        }
        .loan-image-card img {
            width: 100%;
            height: 150px;
            object-fit: cover;
        }
        .loan-image-card .card-content {
            padding: 15px;
        }
        .loan-image-card h4 {
            font-size: 1rem;
            margin-bottom: 5px;
        }
        .loan-image-card p {
            font-size: 0.85rem;
            color: var(--gray);
        }
        .loan-promo-section {
            padding: 20px;
            background: var(--light);
            border-radius: 20px;
            margin: 20px;
        }
        .loan-promo-section h3 {
            color: var(--primary);
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .review-section { margin-bottom: 20px; }
        .review-section h4 { font-size: 1rem; color: var(--primary); margin-bottom: 10px; display: flex; align-items: center; gap: 10px; }
        .review-field {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid var(--border);
        }
        .review-field:last-child { border-bottom: none; }
        .review-field .label { color: var(--gray); font-size: 0.9rem; }
        .review-field .value { font-weight: 500; }
        .review-field .edit-btn {
            background: none;
            border: none;
            color: var(--primary);
            cursor: pointer;
            font-size: 0.85rem;
        }
        .approved-container { text-align: center; padding: 30px 20px; }
        .approved-icon {
            font-size: 5rem;
            color: var(--success);
            margin-bottom: 20px;
            animation: bounceIn 0.6s ease;
        }
        @keyframes bounceIn {
            0% { transform: scale(0); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }
        .savings-deposit-card {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 25px;
            border-radius: 20px;
            margin: 20px 0;
            text-align: center;
        }
        .savings-deposit-card h4 { font-size: 1.2rem; margin-bottom: 10px; }
        .savings-deposit-card p { opacity: 0.9; margin-bottom: 20px; }
        .savings-balance-display {
            background: rgba(255,255,255,0.2);
            padding: 15px;
            border-radius: 15px;
            margin-bottom: 20px;
        }
        .savings-balance-display .amount { font-size: 1.8rem; font-weight: 700; }
        .savings-balance-display .label { font-size: 0.85rem; opacity: 0.8; }
        .deposit-savings-btn {
            background: white;
            color: #667eea;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        .deposit-savings-btn:hover { transform: scale(1.05); box-shadow: 0 5px 20px rgba(0,0,0,0.2); }
        .loan-footer-links {
            padding: 20px;
            background: var(--dark);
            color: white;
            margin-top: 20px;
        }
        .loan-footer-links h4 { margin-bottom: 15px; font-size: 1rem; }
        .loan-footer-links a { color: rgba(255,255,255,0.8); text-decoration: none; display: block; padding: 8px 0; font-size: 0.9rem; }
        .loan-footer-links a:hover { color: white; }
        .county-select { width: 100%; padding: 12px 15px; border: 2px solid var(--border); border-radius: 12px; font-size: 1rem; font-family: inherit; background: var(--white); }
    </style>
</head>
<body>
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner-large"></div>
        <div class="loading-text" id="loadingText">Loading...</div>
    </div>

    <div class="balance-overlay" id="balanceOverlay"></div>

    <div class="app-container">
        <header class="header">
            <div class="header-left">
                <button class="menu-btn" onclick="toggleSidebar()">
                    <i class="fas fa-bars"></i>
                </button>
                <div class="logo">
                    <img src="airtime-logo.png" alt="Logo" id="headerLogo">
                    <span class="logo-text">Airtime Solution </span>
                </div>
            </div>
            <div class="header-right">
                <div class="user-balance">
                    <span>KES</span>
                    <span class="balance-amount" id="headerBalance">0.00</span>
                    <button class="refresh-btn" onclick="refreshBalance()" id="refreshBtn">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                </div>
                <button class="notification-btn" onclick="toggleNotifications()">
                    <i class="fas fa-bell"></i>
                    <span class="notification-badge" id="notifBadge">0</span>
                </button>
            </div>
        </header>

        <div class="sidebar-overlay" onclick="closeSidebar()"></div>
        <nav class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-user">
                    <div class="user-avatar">
                        <i class="fas fa-user"></i>
                    </div>
                    <div class="user-info">
                        <h3 id="sidebarEmail">Guest</h3>
                        <p id="sidebarBalance">KES 0.00</p>
                    </div>
                </div>
            </div>
            <div class="sidebar-menu">
                <button class="menu-item active" onclick="showPage('dashboard')">
                    <i class="fas fa-home"></i> Dashboard
                </button>
                <button class="menu-item" onclick="showPage('deposit')">
                    <i class="fas fa-wallet"></i> Deposit
                </button>
                <button class="menu-item" onclick="showPage('buy-airtime')">
                    <i class="fas fa-mobile-alt"></i> Buy Airtime
                </button>
                <button class="menu-item" onclick="showPage('sell-airtime')">
                    <i class="fas fa-gift"></i> Sell Airtime Get Commission
                </button>
                <button class="menu-item" onclick="showPage('airtime-to-cash')">
                    <i class="fas fa-exchange-alt"></i> Airtime to Cash
                </button>
                <button class="menu-item" onclick="closeSidebar(); scrollToDirectBuy();">
                    <i class="fas fa-bolt"></i> Buy Airtime without account
                </button>
                <button class="menu-item" onclick="showPage('transactions')">
                    <i class="fas fa-history"></i> Transactions
                </button>
                <button class="menu-item" onclick="showPage('verify-deposit')">
                    <i class="fas fa-check-circle"></i> Verify Deposit
                </button>
                <div class="menu-divider"></div>
                <button class="menu-item" onclick="showPage('bulk-sms')">
                    <i class="fas fa-sms"></i> Bulk SMS
                </button>
                <div class="menu-divider"></div>
                <button class="menu-item loan-menu-item" onclick="closeSidebar(); showLoanTermsModal();" style="background: linear-gradient(135deg, rgba(76, 175, 80, 0.1), rgba(56, 142, 60, 0.1));">
                    <i class="fas fa-hand-holding-usd" style="color: #4CAF50;"></i> Get Loan Now
                </button>
                <div class="menu-divider"></div>
                <button class="menu-item" onclick="showPage('settings')">
                    <i class="fas fa-cog"></i> Settings
                </button>
                <button class="menu-item" onclick="showPage('about')">
                    <i class="fas fa-info-circle"></i> About Us
                </button>
                <button class="menu-item" onclick="showPage('contact')">
                    <i class="fas fa-envelope"></i> Contact Us
                </button>
                <button class="menu-item" onclick="showPage('privacy')">
                    <i class="fas fa-shield-alt"></i> Privacy Policy
                </button>
                <button class="menu-item" onclick="showPage('terms')">
                    <i class="fas fa-file-contract"></i> Terms of Service
                </button>
                <button class="menu-item" onclick="showPage('cookies')">
                    <i class="fas fa-cookie-bite"></i> Cookie Policy
                </button>
                <div class="menu-divider"></div>
                <button class="menu-item" onclick="showPage('admin')">
                    <i class="fas fa-user-shield"></i> Admin Panel
                </button>
                <button class="menu-item" onclick="logout()" style="color: var(--danger);">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </button>
            </div>
        </nav>

        <main class="main-content">
            <div id="page-dashboard" class="page active">
                <div class="hero-section">
                    <div class="card balance-card">
                        <p class="balance-label" data-translate="yourBalance">Your Current Float Balance</p>
                        <p class="balance-value" id="dashboardBalance">KES 0.00</p>
                        <p class="balance-bonus"><i class="fas fa-gift"></i> Deposit KES 50+ and receive KES 6 bonus instantly!</p>
                    </div>

                    <div class="quick-actions-grid">
                        <button class="action-card" onclick="showPage('deposit')">
                            <i class="fas fa-wallet"></i>
                            <span data-translate="deposit">Deposit</span>
                        </button>
                        <button class="action-card" onclick="showPage('buy-airtime')">
                            <i class="fas fa-mobile-alt"></i>
                            <span data-translate="buyAirtime">Buy Airtime</span>
                        </button>
                        <button class="action-card" onclick="showPage('airtime-to-cash')">
                            <i class="fas fa-exchange-alt"></i>
                            <span data-translate="airtimeToCash">Airtime to Cash</span>
                        </button>
                        <button class="action-card" onclick="showPage('transactions')">
                            <i class="fas fa-history"></i>
                            <span data-translate="history">History</span>
                        </button>
                        <button class="action-card" onclick="scrollToDirectBuy()" style="background: linear-gradient(135deg, rgba(244, 160, 32, 0.3), rgba(230, 126, 34, 0.3)); grid-column: span 2;">
                            <i class="fas fa-bolt"></i>
                            <span>Buy Airtime Directly (No Account)</span>
                        </button>
                        <button class="action-card loan-btn" onclick="showLoanTermsModal()" style="background: linear-gradient(135deg, rgba(76, 175, 80, 0.3), rgba(56, 142, 60, 0.3)); grid-column: span 2;">
                            <i class="fas fa-hand-holding-usd"></i>
                            <span>Get Loan Now</span>
                        </button>
                    </div>

                </div>

                <div class="page-content">
                <button class="pwa-install" id="pwaInstall" onclick="installPWA()" title="Install App">
                    <p>Ease airtime purchase by installing app</p>
                    <img src="https://upload.wikimedia.org/wikipedia/commons/7/78/Google_Play_Store_badge_EN.svg" alt="Get it on Google Play" style="height: 40px; width: auto;">
                </button>

                <!-- Promo Banner Section -->
                <div class="card promo-banner-card" style="margin-top: 20px; padding: 0; overflow: hidden;">
                    <img src="airtime-solution2.png" alt="Airtime Solution Promo" style="width: 100%; height: auto; display: block; border-radius: 16px 16px 0 0;">
                    <div style="padding: 20px; text-align: center;">
                        <h3 style="font-size: 1.2rem; color: var(--primary); margin-bottom: 10px; font-weight: 700;">Your Trusted Airtime Partner</h3>
                        <p style="font-size: 0.9rem; color: var(--gray); line-height: 1.6;">Buy, sell, and manage airtime effortlessly. Fast transactions, secure payments, and unbeatable rates for all networks.</p>
                    </div>
                </div>

                <!-- Scrolling Announcement -->
                <div class="scrolling-text-container" style="margin-top: 15px;">
                    <div class="scrolling-text">
                         IMPORTANT UPDATE: Enjoy instant airtime delivery! Deposit KES 50+ and get KES 6 bonus! New features coming soon! 24/7 Support available! Buy airtime directly without an account - just pay via M-Pesa! All networks supported: Safaricom, Airtel, Telkom! Fast, secure, and reliable service! 
                    </div>
                </div>

                <!-- Direct Buy Section -->
                <div class="card" id="directBuySection" style="margin-top: 20px; border: 2px solid var(--secondary); background: linear-gradient(135deg, rgba(244, 160, 32, 0.05), rgba(255, 255, 255, 1));">
                    <h3 class="card-title" style="color: var(--secondary);"><i class="fas fa-bolt"></i> Buy Airtime Directly (No Account Needed)</h3>
                    
                    <div class="info-box" style="background: rgba(244, 160, 32, 0.1); border-left-color: var(--secondary);">
                        <p><i class="fas fa-info-circle"></i> Purchase airtime instantly via M-Pesa STK Push. No registration required! Works for all networks.</p>
                    </div>

                    <form id="directBuyForm" onsubmit="event.preventDefault(); initiateDirectBuy();">
                        <div class="form-group">
                            <label class="form-label"><i class="fas fa-phone"></i> Phone to Receive Airtime *</label>
                            <div class="phone-wrapper">
                                <span class="phone-prefix">+254</span>
                                <input type="tel" class="form-input" id="directBuyPhone" placeholder="7XXXXXXXX" maxlength="9" required oninput="validateDirectPhone()">
                            </div>
                            <p class="validation-error" id="directPhoneError" style="display: none;">Enter a valid 9-digit phone number starting with 7 or 1</p>
                        </div>

                        <div class="form-group">
                            <label class="form-label"><i class="fas fa-signal"></i> Select Network To receive airtime*</label>
                            <div class="network-selector" id="directNetworkSelector">
                                <div class="network-option" data-network="safaricom" onclick="selectDirectNetwork('safaricom')">
                                    <img src="safaricom.png" alt="Safaricom" onerror="this.src='https://via.placeholder.com/50x50/4CB05B/ffffff?text=SAF'">
                                    <span>Safaricom</span>
                                </div>
                                <div class="network-option" data-network="airtel" onclick="selectDirectNetwork('airtel')">
                                    <img src="airtel.png" alt="Airtel" onerror="this.src='https://via.placeholder.com/50x50/ED1C24/ffffff?text=AIR'">
                                    <span>Airtel</span>
                                </div>
                                <div class="network-option" data-network="telcom" onclick="selectDirectNetwork('telcom')">
                                    <img src="telcom.png" alt="Telcom" onerror="this.src='https://via.placeholder.com/50x50/0066B3/ffffff?text=TEL'">
                                    <span>Telcom</span>
                                </div>
                            </div>
                            <p class="network-error" id="directNetworkError" style="display: none;">Please select a network</p>
                            <input type="hidden" id="selectedDirectNetwork" value="">
                        </div>

                        <div class="form-group">
                            <label class="form-label"><i class="fas fa-money-bill"></i> Amount (KES) *</label>
                            <input type="number" class="form-input" id="directBuyAmount" placeholder="Minimum: 10" min="10" required oninput="validateDirectAmount()">
                            <p class="validation-error" id="directAmountError" style="display: none;">Minimum amount is KES 10</p>
                            <div style="display: flex; gap: 8px; margin-top: 10px; flex-wrap: wrap;">
                                <button type="button" class="btn btn-outline" style="flex: 1; min-width: 60px; padding: 10px;" onclick="document.getElementById('directBuyAmount').value = 10; validateDirectAmount();">10</button>
                                <button type="button" class="btn btn-outline" style="flex: 1; min-width: 60px; padding: 10px;" onclick="document.getElementById('directBuyAmount').value = 20; validateDirectAmount();">20</button>
                                <button type="button" class="btn btn-outline" style="flex: 1; min-width: 60px; padding: 10px;" onclick="document.getElementById('directBuyAmount').value = 50; validateDirectAmount();">50</button>
                                <button type="button" class="btn btn-outline" style="flex: 1; min-width: 60px; padding: 10px;" onclick="document.getElementById('directBuyAmount').value = 100; validateDirectAmount();">100</button>
                                <button type="button" class="btn btn-outline" style="flex: 1; min-width: 60px; padding: 10px;" onclick="document.getElementById('directBuyAmount').value = 200; validateDirectAmount();">200</button>
                                <button type="button" class="btn btn-outline" style="flex: 1; min-width: 60px; padding: 10px;" onclick="document.getElementById('directBuyAmount').value = 500; validateDirectAmount();">500</button>
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label"><i class="fas fa-mobile-alt"></i> Phone to Pay With (M-Pesa) *</label>
                            <div class="phone-wrapper">
                                <span class="phone-prefix">+254</span>
                                <input type="tel" class="form-input" id="directPayPhone" placeholder="7XXXXXXXX" maxlength="9" required oninput="validateDirectPayPhone()">
                            </div>
                            <p class="validation-error" id="directPayPhoneError" style="display: none;">Enter a valid Safaricom number starting with 7 or 1</p>
                            <p style="font-size: 0.8rem; color: var(--gray); margin-top: 5px;"><i class="fas fa-info-circle"></i> STK Push will be sent to this number</p>
                        </div>

                        <button type="submit" class="btn btn-secondary" id="directBuyBtn" disabled style="font-size: 1.1rem; padding: 16px;">
                            <i class="fas fa-bolt"></i> Buy Now via M-Pesa
                        </button>

                        <div id="directBuyStatus" style="margin-top: 15px; text-align: center; display: none;">
                            <span class="live-indicator"></span>
                            <span id="directBuyStatusText">Processing...</span>
                        </div>
                    </form>
                </div>

                <!-- Why Choose Us Section -->
                <div class="card" style="margin-top: 20px;">
                    <h3 class="card-title"><i class="fas fa-star"></i> <span data-translate="whyChooseUs">Why Choose Us</span></h3>
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">
                        <div style="text-align: center; padding: 15px; background: var(--light); border-radius: 12px;">
                            <i class="fas fa-bolt" style="font-size: 2rem; color: var(--secondary); margin-bottom: 10px;"></i>
                            <h4 style="font-size: 0.9rem; margin-bottom: 5px;">Instant Delivery</h4>
                            <p style="font-size: 0.8rem; color: var(--gray);">Airtime delivered in seconds</p>
                        </div>
                        <div style="text-align: center; padding: 15px; background: var(--light); border-radius: 12px;">
                            <i class="fas fa-shield-alt" style="font-size: 2rem; color: var(--success); margin-bottom: 10px;"></i>
                            <h4 style="font-size: 0.9rem; margin-bottom: 5px;">Secure Payments</h4>
                            <p style="font-size: 0.8rem; color: var(--gray);">M-Pesa powered security</p>
                        </div>
                        <div style="text-align: center; padding: 15px; background: var(--light); border-radius: 12px;">
                            <i class="fas fa-percentage" style="font-size: 2rem; color: var(--primary); margin-bottom: 10px;"></i>
                            <h4 style="font-size: 0.9rem; margin-bottom: 5px;">Best Rates</h4>
                            <p style="font-size: 0.8rem; color: var(--gray);">Competitive discounts</p>
                        </div>
                        <div style="text-align: center; padding: 15px; background: var(--light); border-radius: 12px;">
                            <i class="fas fa-headset" style="font-size: 2rem; color: var(--info); margin-bottom: 10px;"></i>
                            <h4 style="font-size: 0.9rem; margin-bottom: 5px;">24/7 Support</h4>
                            <p style="font-size: 0.8rem; color: var(--gray);">Always here to help</p>
                        </div>
                    </div>
                </div>

                <!-- Platform Usage Graph -->
                <div class="users-graph-card" style="margin-top: 20px;">
                    <h3 class="card-title"><i class="fas fa-chart-bar"></i> Platform Activity</h3>
                    <p style="font-size: 0.85rem; color: var(--gray); margin-bottom: 15px;">Users buying airtime this week</p>
                    <div class="graph-container" style="margin-bottom: 30px;">
                        <div class="graph-bar" style="height: 65%;" data-value="1.2K"><span>Mon</span></div>
                        <div class="graph-bar" style="height: 80%;" data-value="1.8K"><span>Tue</span></div>
                        <div class="graph-bar" style="height: 55%;" data-value="950"><span>Wed</span></div>
                        <div class="graph-bar" style="height: 90%;" data-value="2.1K"><span>Thu</span></div>
                        <div class="graph-bar" style="height: 75%;" data-value="1.5K"><span>Fri</span></div>
                        <div class="graph-bar" style="height: 60%;" data-value="1.1K"><span>Sat</span></div>
                        <div class="graph-bar" style="height: 85%;" data-value="1.9K"><span>Sun</span></div>
                    </div>
                    <div style="display: flex; justify-content: space-around; text-align: center; padding-top: 10px; border-top: 1px solid var(--border);">
                        <div>
                            <p style="font-size: 1.5rem; font-weight: 700; color: var(--primary);">10.5K</p>
                            <p style="font-size: 0.75rem; color: var(--gray);">Weekly Users</p>
                        </div>
                        <div>
                            <p style="font-size: 1.5rem; font-weight: 700; color: var(--success);">KES 100k+</p>
                            <p style="font-size: 0.75rem; color: var(--gray);">Airtime Sold</p>
                        </div>
                        <div>
                            <p style="font-size: 1.5rem; font-weight: 700; color: var(--secondary);">99.8%</p>
                            <p style="font-size: 0.75rem; color: var(--gray);">Success Rate</p>
                        </div>
                    </div>
                </div>

                <!-- FAQ Section -->
                <div class="card" style="margin-top: 20px;">
                    <h3 class="card-title"><i class="fas fa-question-circle"></i> <span data-translate="faq">Frequently Asked Questions</span></h3>
                    <div class="faq-item" style="margin-bottom: 15px; padding: 15px; background: var(--light); border-radius: 12px;">
                        <h4 style="font-size: 0.95rem; color: var(--primary); margin-bottom: 8px;"><i class="fas fa-chevron-right" style="margin-right: 8px;"></i>How do I buy airtime?</h4>
                        <p style="font-size: 0.85rem; color: var(--gray);">Simply deposit funds to your wallet, select a network, enter the phone number and amount, then click "Buy Now".</p>
                    </div>
                    <div class="faq-item" style="margin-bottom: 15px; padding: 15px; background: var(--light); border-radius: 12px;">
                        <h4 style="font-size: 0.95rem; color: var(--primary); margin-bottom: 8px;"><i class="fas fa-chevron-right" style="margin-right: 8px;"></i>How long does airtime delivery take?</h4>
                        <p style="font-size: 0.85rem; color: var(--gray);">Airtime is delivered instantly within 5-30 seconds after successful payment.</p>
                    </div>
                    <div class="faq-item" style="margin-bottom: 15px; padding: 15px; background: var(--light); border-radius: 12px;">
                        <h4 style="font-size: 0.95rem; color: var(--primary); margin-bottom: 8px;"><i class="fas fa-chevron-right" style="margin-right: 8px;"></i>What is the minimum deposit?</h4>
                        <p style="font-size: 0.85rem; color: var(--gray);">The minimum deposit is KES 10. Deposits of KES 50 or more receive a KES 6 bonus!</p>
                    </div>
                    <div class="faq-item" style="padding: 15px; background: var(--light); border-radius: 12px;">
                        <h4 style="font-size: 0.95rem; color: var(--primary); margin-bottom: 8px;"><i class="fas fa-chevron-right" style="margin-right: 8px;"></i>Which networks are supported?</h4>
                        <p style="font-size: 0.85rem; color: var(--gray);">We support Safaricom, Airtel, and Telkom Kenya networks.</p>
                    </div>
                </div>

                <div class="card" style="margin-top: 20px;">
                    <h3 class="card-title"><i class="fas fa-clock"></i> <span data-translate="recentTransactions">Recent Transactions</span></h3>
                    <div class="transaction-list" id="recentTransactions">
                        <div class="empty-state">
                            <i class="fas fa-inbox"></i>
                            <h3>No transactions yet</h3>
                            <p>Your recent transactions will appear here</p>
                        </div>
                    </div>
                </div>

                <div class="footer-links">
                    <span class="footer-link" onclick="showPage('about')">About</span>
                    <span class="footer-link" onclick="showPage('contact')">Contact</span>
                    <span class="footer-link" onclick="showPage('privacy')">Privacy</span>
                    <span class="footer-link" onclick="showPage('terms')">Terms</span>
                </div>
                </div>
            </div>

            <div id="page-deposit" class="page">
                <div class="card">
                    <h3 class="card-title"><i class="fas fa-wallet"></i> Deposit Money</h3>

                    <div class="info-box">
                        <p><i class="fas fa-gift"></i> Deposit KES 50+ and get <strong>+6 bonus</strong> added to your account!</p>
                    </div>

                    <form id="depositForm">
                        <div class="form-group">
                            <label class="form-label"><i class="fas fa-phone"></i> Phone Number *</label>
                            <input type="tel" class="form-input" id="depositPhone" placeholder="e.g. 0718369524" maxlength="10" required>
                            <small style="color: var(--gray); font-size: 0.8rem;">Enter your M-Pesa number (starts with 07 or 01)</small>
                        </div>

                        <div class="form-group">
                            <label class="form-label"><i class="fas fa-money-bill"></i> Amount (KES) *</label>
                            <input type="number" class="form-input" id="depositAmount" placeholder="Minimum: 10" min="10" required>
                        </div>

                        <div class="btn-group">
                            <button type="submit" class="btn btn-primary" id="depositStkBtn">
                                <i class="fas fa-mobile-alt"></i> Deposit via M-Pesa STK Push
                            </button>

                            <div class="divider-text"><span>OR</span></div>

                            <button type="button" class="btn btn-link" onclick="depositWithLink()">
                                <i class="fas fa-link"></i> Deposit with Payment Link
                            </button>
                        </div>

                        <button type="button" class="retry-btn" id="retryDepositBtn" onclick="retryDeposit()">
                            <i class="fas fa-sync-alt"></i> Retry Deposit
                        </button>

                        <div id="depositStatus" style="margin-top: 15px; text-align: center; display: none;">
                            <span class="live-indicator"></span>
                            <span id="depositStatusText">Processing...</span>
                        </div>
                    </form>
                </div>
            </div>

            <div id="page-buy-airtime" class="page">
                <div class="card">
                    <h3 class="card-title"><i class="fas fa-mobile-alt"></i> Buy Airtime</h3>

                    <div class="info-box">
                        <p><i class="fas fa-info-circle"></i> Buy KES 20 and above and receive Commissions . Minimum purchase: KES 10</p>
                    </div>

                    <form id="buyAirtimeForm">
                        <!-- Network Selection -->
                        <div class="form-group">
                            <label class="form-label"><i class="fas fa-signal"></i> Select Network * </label>
                            <div class="network-selector">
                                <div class="network-option" data-network="safaricom" onclick="selectNetwork('safaricom')">
                                    <img src="safaricom.png" alt="Safaricom" onerror="this.src='https://via.placeholder.com/50x50/4CB05B/ffffff?text=SAF'">
                                    <span>Safaricom</span>
                                </div>
                                <div class="network-option" data-network="airtel" onclick="selectNetwork('airtel')">
                                    <img src="airtel.png" alt="Airtel" onerror="this.src='https://via.placeholder.com/50x50/ED1C24/ffffff?text=AIR'">
                                    <span>Airtel</span>
                                </div>
                                <div class="network-option" data-network="telcom" onclick="selectNetwork('telcom')">
                                    <img src="telcom.png" alt="Telcom" onerror="this.src='https://via.placeholder.com/50x50/0066B3/ffffff?text=TEL'">
                                    <span>Telcom</span>
                                </div>
                            </div>
                            <p class="network-error" id="networkError">Please select a network to continue</p>
                            <input type="hidden" id="selectedNetwork" value="">
                        </div>

                        <div class="form-group">
                            <label class="form-label"><i class="fas fa-phone"></i> Phone Number *</label>
                            <div class="phone-wrapper">
                                <span class="phone-prefix">+254</span>
                                <input type="tel" class="form-input" id="airtimePhone" placeholder="7XXXXXXXX" maxlength="9" required oninput="validateAirtimePhone()">
                            </div>
                            <p class="validation-error" id="phoneError">Enter a valid 9-digit phone number starting with 7 or 1</p>
                        </div>

                        <div class="form-group">
                            <label class="form-label"><i class="fas fa-money-bill"></i> Amount (KES) *</label>
                            <input type="number" class="form-input" id="airtimeAmount" placeholder="Minimum: 10" min="10" required oninput="validateAirtimeAmount()">
                            <p class="validation-error" id="amountError">Minimum amount is KES 10</p>
                        </div>

                        <div class="btn-group" style="display: flex; gap: 10px; flex-wrap: wrap;">
                            <button type="submit" class="btn btn-primary" id="buyAirtimeBtn" disabled style="flex: 1;">
                                <i class="fas fa-shopping-cart"></i> Buy Now (From Balance)
                            </button>

                            <button type="button" class="btn btn-outline" onclick="goToDirectBuyFromBuyPage()" style="flex: 1; border-color: var(--secondary); color: var(--secondary);">
                                <i class="fas fa-bolt"></i> Buy With mpesa stk push
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <div id="page-sell-airtime" class="page">
                <div class="card">
                    <h3 class="card-title"><i class="fas fa-gift"></i> Sell Airtime Get Commission</h3>

                    <div class="info-box">
                        <p><i class="fas fa-info-circle"></i> Sell airtime and earn commission! KES 10-49 = 5% commission, KES 50+ = 10% commission. Minimum Sell: KES 10</p>
                    </div>

                    <form id="sellAirtimeForm">
                        <!-- Network Selection -->
                        <div class="form-group">
                            <label class="form-label"><i class="fas fa-signal"></i> Select Network * </label>
                            <div class="network-selector">
                                <div class="network-option" data-network="safaricom" data-form="send" onclick="selectSendNetwork('safaricom')">
                                    <img src="safaricom.png" alt="Safaricom" onerror="this.src='https://via.placeholder.com/50x50/4CB05B/ffffff?text=SAF'">
                                    <span>Safaricom</span>
                                </div>
                                <div class="network-option" data-network="airtel" data-form="send" onclick="selectSendNetwork('airtel')">
                                    <img src="airtel.png" alt="Airtel" onerror="this.src='https://via.placeholder.com/50x50/ED1C24/ffffff?text=AIR'">
                                    <span>Airtel</span>
                                </div>
                                <div class="network-option" data-network="telcom" data-form="send" onclick="selectSendNetwork('telcom')">
                                    <img src="telcom.png" alt="Telcom" onerror="this.src='https://via.placeholder.com/50x50/0066B3/ffffff?text=TEL'">
                                    <span>Telcom</span>
                                </div>
                            </div>
                            <p class="network-error" id="sendNetworkError">Please select a network to continue</p>
                            <input type="hidden" id="selectedSendNetwork" value="">
                        </div>

                        <div class="form-group">
                            <label class="form-label"><i class="fas fa-phone"></i> Phone Number to Sell Airtime *</label>
                            <div class="phone-wrapper">
                                <span class="phone-prefix">+254</span>
                                <input type="tel" class="form-input" id="sellAirtimePhone" placeholder="7XXXXXXXX" maxlength="9" required oninput="validateSendPhone()">
                            </div>
                            <p class="validation-error" id="sendPhoneError">Enter a valid 9-digit phone number starting with 7 or 1</p>
                        </div>

                        <div class="form-group">
                            <label class="form-label"><i class="fas fa-money-bill"></i> Airtime Amount (KES) *</label>
                            <input type="number" class="form-input" id="sellAirtimeAmount" placeholder="Minimum: 10" min="10" required oninput="validateSendAmount()">
                            <p class="validation-error" id="sendAmountError">Minimum amount is KES 10</p>
                        </div>

                        <div class="btn-group">
                            <button type="submit" class="btn btn-primary" id="sellAirtimeBalanceBtn" disabled>
                                <i class="fas fa-wallet"></i> Sell from Balance
                            </button>
                        </div>
                    </form>
                </div>

                <div class="card" style="margin-top: 15px;">
                    <h3 class="card-title"><i class="fas fa-chart-line"></i> Service Status</h3>
                    <div id="statumFloatStatus">
                        <p style="color: var(--gray);">Checking service availability...</p>
                    </div>
                </div>
            </div>

            <div id="page-airtime-to-cash" class="page">
                <div class="card" style="position: relative;">
                    <div class="coming-soon-overlay" id="a2cOverlay">
                        <div class="coming-soon-badge">
                            <i class="fas fa-clock"></i>
                            Coming Soon!
                        </div>
                    </div>

                    <h3 class="card-title"><i class="fas fa-exchange-alt"></i> Airtime to Cash</h3>

                    <div class="rate-display">
                        <p>Conversion Rate</p>
                        <p class="rate">80% Cashback</p>
                        <p style="font-size: 0.85rem;">KES 100 Airtime = KES 80 Cash</p>
                    </div>

                    <form id="airtimeToCashForm">
                        <div class="form-group">
                            <label class="form-label"><i class="fas fa-coins"></i> Airtime Amount to Convert *</label>
                            <input type="number" class="form-input" id="a2cAmount" placeholder="Enter amount" min="10" required>
                        </div>

                        <div class="form-group">
                            <label class="form-label"><i class="fas fa-phone"></i> Your Phone Number *</label>
                            <div class="phone-wrapper">
                                <span class="phone-prefix">+254</span>
                                <input type="tel" class="form-input" id="a2cPhone" placeholder="7XXXXXXXX" maxlength="9" required>
                            </div>
                        </div>

                        <div id="dialCodeSection" style="display: none;">
                            <p style="margin-bottom: 10px;">Dial this code to send airtime:</p>
                            <div class="dial-code" id="dialCode">*140*100*0718369524#</div>
                            <p style="font-size: 0.85rem; color: var(--gray); margin-bottom: 15px;">After sending, click "Done" below</p>
                        </div>

                        <div class="btn-group">
                            <button type="submit" class="btn btn-primary" id="sambazaBtn">
                                <i class="fas fa-paper-plane"></i> Generate Dial Code
                            </button>
                            <button type="button" class="btn btn-secondary" id="doneBtn" style="display: none;" onclick="showVerifyA2C()">
                                <i class="fas fa-check"></i> Done - I've Sent Airtime
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <div id="page-verify-a2c" class="page">
                <div class="card">
                    <h3 class="card-title"><i class="fas fa-check-circle"></i> Verify Airtime Sent</h3>
                    <p style="margin-bottom: 20px; color: var(--gray);">Enter the confirmation message code from Safaricom to verify your transfer.</p>
                    <form id="verifyA2CForm">
                        <div class="form-group">
                            <label class="form-label"><i class="fas fa-phone"></i> Your Phone Number</label>
                            <input type="text" class="form-input" id="verifyA2CPhone" readonly>
                        </div>
                        <div class="form-group">
                            <label class="form-label"><i class="fas fa-key"></i> Confirmation Code *</label>
                            <input type="text" class="form-input" id="verifyA2CCode" placeholder="Enter confirmation code" required>
                        </div>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-check"></i> Verify
                        </button>
                    </form>
                </div>
            </div>

            <div id="page-transactions" class="page">
                <div class="card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h3 class="card-title" style="margin: 0;"><i class="fas fa-history"></i> Transaction History</h3>
                        <button class="btn btn-outline" style="width: auto; padding: 10px 15px;" onclick="downloadTransactionsPDF()">
                            <i class="fas fa-download"></i> PDF
                        </button>
                    </div>
                    <div class="transaction-list" id="allTransactions">
                        <div class="empty-state">
                            <i class="fas fa-inbox"></i>
                            <h3>No transactions</h3>
                            <p>Your transaction history will appear here</p>
                        </div>
                    </div>
                </div>
            </div>

            <div id="page-verify-deposit" class="page">
                <div class="card">
                    <h3 class="card-title"><i class="fas fa-check-circle"></i> Verify Deposit</h3>
                    <p style="margin-bottom: 20px; color: var(--gray);">If your deposit was successful but not reflected, enter your M-Pesa code to verify.</p>
                    <form id="verifyDepositForm">
                        <div class="form-group">
                            <label class="form-label"><i class="fas fa-receipt"></i> M-Pesa Transaction Code *</label>
                            <input type="text" class="form-input" id="mpesaCode" placeholder="e.g., ABC123XYZ" required>
                        </div>
                        <button type="submit" class="btn btn-primary" id="verifyDepositBtn">
                            <i class="fas fa-search"></i> Verify Deposit
                        </button>
                    </form>
                </div>
            </div>

            <div id="page-bulk-sms" class="page">
                <div class="card" style="position: relative;">
                    <div class="coming-soon-overlay">
                        <div class="coming-soon-badge">
                            <i class="fas fa-clock"></i>
                            Coming Soon!
                        </div>
                    </div>
                    <h3 class="card-title"><i class="fas fa-sms"></i> Bulk SMS</h3>
                    <p>Send SMS to multiple recipients at affordable rates.</p>
                </div>
            </div>

            <div id="page-settings" class="page">
                <div class="card">
                    <h3 class="card-title"><i class="fas fa-cog"></i> Settings</h3>
                    <div class="form-group">
                        <label class="form-label"><i class="fas fa-language"></i> Language</label>
                        <select class="form-input" id="languageSelect" onchange="changeLanguage(this.value)">
                            <option value="en">English</option>
                            <option value="sw">Kiswahili</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label"><i class="fas fa-moon"></i> Theme</label>
                        <select class="form-input" id="themeSelect" onchange="changeTheme(this.value)">
                            <option value="light">Light Mode</option>
                            <option value="dark">Dark Mode</option>
                        </select>
                    </div>
                    <div class="menu-divider"></div>
                    <button class="btn btn-outline" onclick="showPage('profile')" style="margin-bottom: 10px;">
                        <i class="fas fa-user"></i> Edit Profile
                    </button>
                    <button class="btn btn-outline" onclick="showPage('cookies')">
                        <i class="fas fa-cookie"></i> Cookie Preferences
                    </button>
                </div>
            </div>

            <div id="page-profile" class="page">
                <div class="card">
                    <h3 class="card-title"><i class="fas fa-user"></i> My Profile</h3>
                    <img src="https://api.dicebear.com/7.x/avataaars/svg?seed=airtimeuser&backgroundColor=b6e3f4" alt="Profile Avatar" class="profile-avatar">
                    <form id="profileForm">
                        <div class="form-group">
                            <label class="form-label">Email</label>
                            <input type="email" class="form-input" id="profileEmail" readonly>
                        </div>
                        <div class="form-group">
                            <label class="form-label"><i class="fas fa-phone"></i> Phone Number</label>
                            <div class="phone-wrapper">
                                <span class="phone-prefix">+254</span>
                                <input type="tel" class="form-input" id="profilePhone" maxlength="9" oninput="validateProfilePhone()">
                            </div>
                            <p class="validation-error" id="profilePhoneError">Enter a valid 9-digit phone number starting with 7 or 1</p>
                            <p class="validation-error" id="profilePhoneDuplicateError" style="color: var(--warning);">This phone number is already registered</p>
                        </div>
                        <button type="submit" class="btn btn-primary" id="profileSaveBtn">
                            <i class="fas fa-save"></i> Save Changes
                        </button>
                    </form>
                </div>
            </div>

            <div id="page-about" class="page">
                <div class="card">
                    <h3 class="card-title"><i class="fas fa-info-circle"></i> <span data-translate="aboutUs">About Us</span></h3>
                    
                    <div style="text-align: center; margin-bottom: 20px;">
                        <img src="about1.png" alt="Airtime Solution Kenya" style="max-width: 200px; border-radius: 16px; margin-bottom: 10px;" onerror="this.style.display='none'">
                    </div>
                    
                    <p style="margin-bottom: 15px; font-size: 1.05rem;"><strong>Airtime Solution Kenya</strong> is your trusted partner for buying and reselling airtime across all networks in Kenya.</p>
                    
                    <div style="background: var(--light); padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                        <h4 style="color: var(--primary); margin-bottom: 15px;"><i class="fas fa-bullseye" style="margin-right: 8px;"></i>Our Mission</h4>
                        <p style="color: var(--gray);">To provide Kenyans with the most convenient, affordable, and reliable airtime services, empowering individuals and businesses to stay connected.</p>
                    </div>
                    
                    <div style="background: var(--light); padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                        <h4 style="color: var(--primary); margin-bottom: 15px;"><i class="fas fa-eye" style="margin-right: 8px;"></i>Our Vision</h4>
                        <p style="color: var(--gray);">To become Kenya's leading digital airtime platform, known for innovation, trust, and exceptional customer service.</p>
                    </div>
                    
                    <p style="margin-bottom: 15px;">We provide a fast, secure, and reliable platform that allows you to:</p>
                    <ul style="margin-left: 20px; margin-bottom: 20px; line-height: 1.8;">
                        <li><i class="fas fa-check" style="color: var(--success); margin-right: 8px;"></i>Buy airtime instantly at discounted rates</li>
                        <li><i class="fas fa-check" style="color: var(--success); margin-right: 8px;"></i>Resell airtime and earn profits</li>
                        <li><i class="fas fa-check" style="color: var(--success); margin-right: 8px;"></i>Convert airtime to cash (Coming Soon)</li>
                        <li><i class="fas fa-check" style="color: var(--success); margin-right: 8px;"></i>Deposit and manage your wallet easily</li>
                        <li><i class="fas fa-check" style="color: var(--success); margin-right: 8px;"></i>Send airtime to any network</li>
                    </ul>
                    
                    <div style="text-align: center; margin-bottom: 15px;">
                        <img src="about2.png" alt="Our Team" style="max-width: 100%; border-radius: 16px;" onerror="this.style.display='none'">
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 20px;">
                        <div style="text-align: center; padding: 15px; background: var(--light); border-radius: 12px;">
                            <i class="fas fa-calendar-alt" style="font-size: 1.5rem; color: var(--primary); margin-bottom: 8px;"></i>
                            <p style="font-weight: 600;">Founded</p>
                            <p style="color: var(--gray);">2025</p>
                        </div>
                        <div style="text-align: center; padding: 15px; background: var(--light); border-radius: 12px;">
                            <i class="fas fa-map-marker-alt" style="font-size: 1.5rem; color: var(--primary); margin-bottom: 8px;"></i>
                            <p style="font-weight: 600;">Location</p>
                            <p style="color: var(--gray);">Nairobi, Kenya</p>
                        </div>
                    </div>
                </div>
            </div>

            <div id="page-contact" class="page">
                <div class="card">
                    <h3 class="card-title"><i class="fas fa-envelope"></i> <span data-translate="contactUs">Contact Us</span></h3>
                    
                    <p style="margin-bottom: 20px; font-size: 1.05rem;">Have questions or need help? We're here for you 24/7!</p>
                    
                    <div style="display: grid; gap: 15px; margin-bottom: 25px;">
                        <div style="display: flex; align-items: center; padding: 15px; background: var(--light); border-radius: 12px;">
                            <i class="fab fa-whatsapp" style="font-size: 2rem; color: #25d366; margin-right: 15px;"></i>
                            <div>
                                <p style="font-weight: 600; margin-bottom: 3px;">WhatsApp</p>
                                <a href="https://wa.me/254718369524" target="_blank" style="color: var(--primary);">+254 718 369 524</a>
                            </div>
                        </div>
                        
                        <div style="display: flex; align-items: center; padding: 15px; background: var(--light); border-radius: 12px;">
                            <i class="fas fa-phone-alt" style="font-size: 2rem; color: var(--primary); margin-right: 15px;"></i>
                            <div>
                                <p style="font-weight: 600; margin-bottom: 3px;">Phone Call</p>
                                <a href="tel:+254718369524" style="color: var(--primary);">+254 718 369 524</a>
                            </div>
                        </div>
                        
                        <div style="display: flex; align-items: center; padding: 15px; background: var(--light); border-radius: 12px;">
                            <i class="fas fa-envelope" style="font-size: 2rem; color: var(--info); margin-right: 15px;"></i>
                            <div>
                                <p style="font-weight: 600; margin-bottom: 3px;">Email</p>
                                <a href="mailto:support@airtimesolutionkenya.com" style="color: var(--primary);">support@airtimesolutionkenya.com</a>
                            </div>
                        </div>
                        
                        <div style="display: flex; align-items: center; padding: 15px; background: var(--light); border-radius: 12px;">
                            <i class="fas fa-clock" style="font-size: 2rem; color: var(--secondary); margin-right: 15px;"></i>
                            <div>
                                <p style="font-weight: 600; margin-bottom: 3px;">Working Hours</p>
                                <p style="color: var(--gray);">24 Hours, 7 Days a Week</p>
                            </div>
                        </div>
                    </div>
                    
                    <div style="background: linear-gradient(135deg, var(--primary), var(--primary-dark)); padding: 20px; border-radius: 12px; text-align: center; color: white; margin-bottom: 15px;">
                        <h4 style="margin-bottom: 10px;"><i class="fas fa-headset" style="margin-right: 8px;"></i>Need Immediate Help?</h4>
                        <p style="opacity: 0.9; margin-bottom: 15px;">Our support team is always ready to assist you with any questions or issues.</p>
                        <a href="https://wa.me/254718369524" target="_blank" class="btn btn-secondary" style="display: inline-flex; width: auto;">
                            <i class="fab fa-whatsapp"></i> Chat Now on WhatsApp
                        </a>
                    </div>
                </div>
            </div>

            <div id="page-privacy" class="page">
                <div class="card">
                    <h3 class="card-title"><i class="fas fa-shield-alt"></i> <span data-translate="privacyPolicy">Privacy Policy</span></h3>
                    
                    <div style="text-align: center; margin-bottom: 20px;">
                        <img src="privacy1.png" alt="Privacy" style="max-width: 150px; border-radius: 12px;" onerror="this.style.display='none'">
                    </div>
                    
                    <div style="background: var(--light); padding: 15px; border-radius: 12px; margin-bottom: 20px;">
                        <p style="color: var(--gray);"><i class="fas fa-calendar" style="margin-right: 8px;"></i><strong>Last Updated:</strong> December 2025</p>
                    </div>
                    
                    <p style="margin-bottom: 20px;">At Airtime Solution Kenya, we are committed to protecting your privacy and ensuring the security of your personal information.</p>
                    
                    <div style="border-left: 4px solid var(--primary); padding-left: 15px; margin-bottom: 20px;">
                        <h4 style="color: var(--primary); margin-bottom: 10px;">1. Information We Collect</h4>
                        <ul style="margin-left: 15px; color: var(--gray); line-height: 1.8;">
                            <li>Email address for account authentication</li>
                            <li>Phone number for airtime transactions</li>
                            <li>Transaction history and amounts</li>
                            <li>Device information for security purposes</li>
                        </ul>
                    </div>
                    
                    <div style="border-left: 4px solid var(--info); padding-left: 15px; margin-bottom: 20px;">
                        <h4 style="color: var(--info); margin-bottom: 10px;">2. How We Use Your Information</h4>
                        <ul style="margin-left: 15px; color: var(--gray); line-height: 1.8;">
                            <li>Process airtime purchases and deposits</li>
                            <li>Send transaction confirmations</li>
                            <li>Provide customer support</li>
                            <li>Improve our services and user experience</li>
                            <li>Prevent fraud and maintain security</li>
                        </ul>
                    </div>
                    
                    <div style="border-left: 4px solid var(--success); padding-left: 15px; margin-bottom: 20px;">
                        <h4 style="color: var(--success); margin-bottom: 10px;">3. Data Security</h4>
                        <p style="color: var(--gray); margin-bottom: 10px;">We implement industry-standard security measures including:</p>
                        <ul style="margin-left: 15px; color: var(--gray); line-height: 1.8;">
                            <li>SSL/TLS encryption for all data transfers</li>
                            <li>Secure payment processing via M-Pesa</li>
                            <li>Regular security audits</li>
                            <li>Access controls and authentication</li>
                        </ul>
                    </div>
                    
                    <div style="border-left: 4px solid var(--warning); padding-left: 15px; margin-bottom: 20px;">
                        <h4 style="color: var(--warning); margin-bottom: 10px;">4. Your Rights</h4>
                        <p style="color: var(--gray);">You have the right to access, correct, or delete your personal data. Contact us at support@airtimesolutionkenya.com for any privacy-related requests.</p>
                    </div>
                    
                    <div style="text-align: center;">
                        <img src="privacy2.png" alt="Data Protection" style="max-width: 100%; border-radius: 12px;" onerror="this.style.display='none'">
                    </div>
                </div>
            </div>

            <div id="page-terms" class="page">
                <div class="card">
                    <h3 class="card-title"><i class="fas fa-file-contract"></i> <span data-translate="termsOfService">Terms of Service</span></h3>
                    
                    <div style="background: var(--light); padding: 15px; border-radius: 12px; margin-bottom: 20px;">
                        <p style="color: var(--gray);"><i class="fas fa-calendar" style="margin-right: 8px;"></i><strong>Effective Date:</strong> December 2025</p>
                    </div>
                    
                    <p style="margin-bottom: 20px;">Please read these Terms of Service carefully before using Airtime Solution Kenya.</p>
                    
                    <div style="background: var(--light); padding: 20px; border-radius: 12px; margin-bottom: 15px;">
                        <h4 style="color: var(--primary); margin-bottom: 10px;"><i class="fas fa-handshake" style="margin-right: 8px;"></i>1. Acceptance of Terms</h4>
                        <p style="color: var(--gray);">By accessing or using Airtime Solution Kenya, you agree to be bound by these Terms of Service. If you do not agree, please do not use our services.</p>
                    </div>
                    
                    <div style="background: var(--light); padding: 20px; border-radius: 12px; margin-bottom: 15px;">
                        <h4 style="color: var(--primary); margin-bottom: 10px;"><i class="fas fa-cogs" style="margin-right: 8px;"></i>2. Services Provided</h4>
                        <ul style="margin-left: 15px; color: var(--gray); line-height: 1.8;">
                            <li>Airtime purchase for Safaricom, Airtel, and Telkom networks</li>
                            <li>Wallet deposit and management</li>
                            <li>Airtime to cash conversion (coming soon)</li>
                            <li>All completed transactions are final and non-reversible</li>
                        </ul>
                    </div>
                    
                    <div style="background: var(--light); padding: 20px; border-radius: 12px; margin-bottom: 15px;">
                        <h4 style="color: var(--primary); margin-bottom: 10px;"><i class="fas fa-user-shield" style="margin-right: 8px;"></i>3. User Responsibilities</h4>
                        <ul style="margin-left: 15px; color: var(--gray); line-height: 1.8;">
                            <li>Maintain the security of your account credentials</li>
                            <li>Provide accurate phone numbers for transactions</li>
                            <li>Report any unauthorized activity immediately</li>
                            <li>Use services only for lawful purposes</li>
                        </ul>
                    </div>
                    
                    <div style="background: var(--light); padding: 20px; border-radius: 12px; margin-bottom: 15px;">
                        <h4 style="color: var(--primary); margin-bottom: 10px;"><i class="fas fa-ban" style="margin-right: 8px;"></i>4. Prohibited Activities</h4>
                        <ul style="margin-left: 15px; color: var(--gray); line-height: 1.8;">
                            <li>Fraudulent transactions or money laundering</li>
                            <li>Attempting to exploit system vulnerabilities</li>
                            <li>Using the service for illegal purposes</li>
                            <li>Sharing account credentials with others</li>
                        </ul>
                    </div>
                    
                    <div style="background: var(--light); padding: 20px; border-radius: 12px;">
                        <h4 style="color: var(--primary); margin-bottom: 10px;"><i class="fas fa-gavel" style="margin-right: 8px;"></i>5. Limitation of Liability</h4>
                        <p style="color: var(--gray);">Airtime Solution Kenya shall not be liable for any indirect, incidental, or consequential damages arising from the use of our services. Our maximum liability is limited to the amount of the transaction in question.</p>
                    </div>
                </div>
            </div>

            <div id="page-cookies" class="page">
                <div class="card">
                    <h3 class="card-title"><i class="fas fa-cookie-bite"></i> Cookie Policy</h3>
                    
                    <p style="margin-bottom: 20px;">We use cookies to enhance your experience on Airtime Solution Kenya. This policy explains what cookies are and how we use them.</p>
                    
                    <div style="background: var(--light); padding: 20px; border-radius: 12px; margin-bottom: 15px;">
                        <h4 style="color: var(--primary); margin-bottom: 10px;"><i class="fas fa-question-circle" style="margin-right: 8px;"></i>What Are Cookies?</h4>
                        <p style="color: var(--gray);">Cookies are small text files stored on your device when you visit a website. They help us remember your preferences and improve your experience.</p>
                    </div>
                    
                    <div style="background: var(--light); padding: 20px; border-radius: 12px; margin-bottom: 15px;">
                        <h4 style="color: var(--primary); margin-bottom: 10px;"><i class="fas fa-list" style="margin-right: 8px;"></i>Types of Cookies We Use</h4>
                        <div style="margin-top: 15px;">
                            <div style="display: flex; align-items: start; margin-bottom: 15px;">
                                <i class="fas fa-check-circle" style="color: var(--success); margin-right: 10px; margin-top: 3px;"></i>
                                <div>
                                    <p style="font-weight: 600;">Essential Cookies</p>
                                    <p style="color: var(--gray); font-size: 0.9rem;">Required for basic functionality like authentication and security.</p>
                                </div>
                            </div>
                            <div style="display: flex; align-items: start; margin-bottom: 15px;">
                                <i class="fas fa-chart-bar" style="color: var(--info); margin-right: 10px; margin-top: 3px;"></i>
                                <div>
                                    <p style="font-weight: 600;">Analytics Cookies</p>
                                    <p style="color: var(--gray); font-size: 0.9rem;">Help us understand how users interact with our platform.</p>
                                </div>
                            </div>
                            <div style="display: flex; align-items: start;">
                                <i class="fas fa-sliders-h" style="color: var(--secondary); margin-right: 10px; margin-top: 3px;"></i>
                                <div>
                                    <p style="font-weight: 600;">Preference Cookies</p>
                                    <p style="color: var(--gray); font-size: 0.9rem;">Remember your settings like language and theme preferences.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div style="background: linear-gradient(135deg, var(--primary), var(--primary-dark)); padding: 20px; border-radius: 12px; color: white; text-align: center;">
                        <h4 style="margin-bottom: 15px;"><i class="fas fa-cookie" style="margin-right: 8px;"></i>Your Cookie Preferences</h4>
                        <p style="opacity: 0.9; margin-bottom: 15px;">Choose which cookies you want to accept:</p>
                        <div style="display: flex; gap: 10px; justify-content: center;">
                            <button class="btn btn-secondary" style="flex: 1; max-width: 150px;" onclick="acceptCookies()">Accept All</button>
                            <button class="btn" style="flex: 1; max-width: 150px; background: rgba(255,255,255,0.2); color: white;" onclick="rejectCookies()">Essential Only</button>
                        </div>
                    </div>
                </div>
            </div>

            <div id="page-admin" class="page">
                <div id="adminLogin" class="card" style="max-width: 400px; margin: 0 auto;">
                    <h3 class="card-title"><i class="fas fa-user-shield"></i> Admin Login</h3>
                    <form id="adminLoginForm">
                        <div class="form-group">
                            <label class="form-label"><i class="fas fa-lock"></i> Admin Password</label>
                            <input type="password" class="form-input" id="adminPassword" placeholder="Enter admin password" required>
                        </div>
                        <button type="submit" class="btn btn-primary" id="adminLoginBtn">
                            <i class="fas fa-sign-in-alt"></i> Login
                        </button>
                    </form>
                </div>

                <div id="adminDashboard" style="display: none;">
                    <div class="stats-grid">
                        <div class="stat-card">
                            <i class="fas fa-users"></i>
                            <div class="value" id="statTotalUsers">0</div>
                            <div class="label">Total Users</div>
                        </div>
                        <div class="stat-card">
                            <i class="fas fa-wallet"></i>
                            <div class="value" id="statTotalDeposits">0</div>
                            <div class="label">Total Deposits</div>
                        </div>
                        <div class="stat-card">
                            <i class="fas fa-mobile-alt"></i>
                            <div class="value" id="statTotalAirtime">0</div>
                            <div class="label">Total Airtime</div>
                        </div>
                        <div class="stat-card">
                            <i class="fas fa-clock"></i>
                            <div class="value" id="statPendingVerifications">0</div>
                            <div class="label">Pending</div>
                        </div>
                    </div>

                    <div class="admin-tabs">
                        <button class="admin-tab active" onclick="showAdminTab('users')">Users</button>
                        <button class="admin-tab" onclick="showAdminTab('transactions')">Transactions</button>
                        <button class="admin-tab" onclick="showAdminTab('verifications')">Verifications</button>
                        <button class="admin-tab" onclick="showAdminTab('notifications')">Send Notification</button>
                        <button class="admin-tab" onclick="showAdminTab('settings')">Settings</button>
                    </div>

                    <div class="card" id="adminTabUsers">
                        <h3 class="card-title">All Users</h3>
                        <div class="table-responsive">
                            <table class="data-table" id="usersTable">
                                <thead>
                                    <tr>
                                        <th>Email</th>
                                        <th>Balance</th>
                                        <th>Bonus</th>
                                        <th>Status</th>
                                        <th>Created</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>

                    <div class="card" id="adminTabTransactions" style="display: none;">
                        <h3 class="card-title">All Transactions</h3>
                        <div class="table-responsive">
                            <table class="data-table" id="adminTxTable">
                                <thead>
                                    <tr>
                                        <th>User</th>
                                        <th>Type</th>
                                        <th>Amount</th>
                                        <th>Phone</th>
                                        <th>Status</th>
                                        <th>Date</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>

                    <div class="card" id="adminTabVerifications" style="display: none;">
                        <h3 class="card-title">Deposit Verifications</h3>
                        <div class="table-responsive">
                            <table class="data-table" id="verificationsTable">
                                <thead>
                                    <tr>
                                        <th>User</th>
                                        <th>M-Pesa Code</th>
                                        <th>Amount</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>

                    <div class="card" id="adminTabNotifications" style="display: none;">
                        <h3 class="card-title">Send Notification</h3>
                        <form id="adminNotificationForm">
                            <div class="form-group">
                                <label class="form-label">Recipient</label>
                                <select class="form-input" id="notifRecipient">
                                    <option value="">All Users</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Title</label>
                                <input type="text" class="form-input" id="notifTitle" placeholder="Notification title" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Message</label>
                                <textarea class="form-input" id="notifMessage" rows="4" placeholder="Enter your message" required></textarea>
                            </div>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-paper-plane"></i> Send Notification
                            </button>
                        </form>
                    </div>

                    <div class="card" id="adminTabSettings" style="display: none;">
                        <h3 class="card-title">System Settings</h3>
                        <div class="form-group">
                            <label class="form-label">Float Status</label>
                            <select class="form-input" id="floatStatusSelect" onchange="updateFloatStatus(this.value)">
                                <option value="false">Available</option>
                                <option value="true">Low / Unavailable</option>
                            </select>
                        </div>
                        <div class="form-group" style="margin-top: 20px;">
                            <label class="form-label">Deposit Status</label>
                            <select class="form-input" id="depositStatusSelect" onchange="updateDepositStatus(this.value)">
                                <option value="false">Enabled</option>
                                <option value="true">Disabled</option>
                            </select>
                            <p style="font-size: 0.85rem; color: var(--gray); margin-top: 5px;">When disabled, users cannot make new deposits.</p>
                        </div>
                    </div>

                    <button class="btn btn-outline" style="margin-top: 20px;" onclick="logoutAdmin()">
                        <i class="fas fa-sign-out-alt"></i> Logout Admin
                    </button>
                </div>
            </div>
        </main>

        <div class="notification-panel" id="notificationPanel">
            <div class="notification-header">
                <h4><i class="fas fa-bell"></i> Notifications</h4>
                <button onclick="toggleNotifications()" style="background: none; border: none; cursor: pointer;">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="notification-list" id="notificationList">
                <div class="empty-state" style="padding: 30px;">
                    <i class="fas fa-bell-slash"></i>
                    <p>No notifications yet</p>
                </div>
            </div>
        </div>

        <div class="modal" id="insufficientModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3><i class="fas fa-exclamation-triangle" style="color: var(--warning);"></i> Insufficient Balance</h3>
                    <button class="modal-close" onclick="closeModal('insufficientModal')">&times;</button>
                </div>
                <div class="modal-body">
                    <p style="margin-bottom: 15px;">You need <strong>KES <span id="insufficientShortfall">0</span></strong> more to complete this purchase.</p>
                    <div class="form-group">
                        <label class="form-label"><i class="fas fa-phone"></i> Phone Number</label>
                        <div class="phone-wrapper">
                            <span class="phone-prefix">+254</span>
                            <input type="tel" class="form-input" id="modalDepositPhone" maxlength="9">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label"><i class="fas fa-money-bill"></i> Amount to Deposit</label>
                        <input type="number" class="form-input" id="modalDepositAmount" min="10">
                    </div>
                    <div class="btn-group">
                        <button class="btn btn-primary" onclick="depositFromModal()">
                            <i class="fas fa-mobile-alt"></i> Deposit via M-Pesa STK
                        </button>
                        <button class="btn btn-link" onclick="depositFromModalLink()">
                            <i class="fas fa-link"></i> Deposit with Payment Link
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div class="modal" id="authModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3><i class="fas fa-lock"></i> Login Required</h3>
                    <button class="modal-close" onclick="closeModal('authModal')">&times;</button>
                </div>
                <div class="modal-body">
                    <p style="margin-bottom: 20px;">Please login / create an account or use the USE WITHOUT ACCOUNT button below to buy airtime directly no account needed.</p>
                    <div class="btn-group">
                        <a href="login.html" class="btn btn-primary"><i class="fas fa-sign-in-alt"></i> Login</a>
                        <a href="login.html" class="btn btn-outline"><i class="fas fa-user-plus"></i> Sign Up</a>
                    </div>
                    <div class="divider-text"><span>OR</span></div>
                    <button class="btn btn-secondary" onclick="closeModal('authModal'); scrollToDirectBuy();" style="margin-top: 10px;">
                        <i class="fas fa-bolt"></i> Use Without Account  to buy airtime directly
                    </button>
                </div>
            </div>
        </div>

        <div class="modal" id="directBuyReceiptModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3><i class="fas fa-receipt"></i> Transaction Receipt</h3>
                    <button class="modal-close" onclick="closeModal('directBuyReceiptModal')">&times;</button>
                </div>
                <div class="modal-body">
                    <div id="receiptContent" style="text-align: center;">
                        <div id="receiptIcon" style="font-size: 4rem; margin-bottom: 20px;"></div>
                        <h4 id="receiptStatus" style="font-size: 1.3rem; margin-bottom: 15px;"></h4>
                        <div style="background: var(--light); border-radius: 12px; padding: 20px; margin: 20px 0;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                                <span style="color: var(--gray);">Phone:</span>
                                <span id="receiptPhone" style="font-weight: 600;"></span>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                                <span style="color: var(--gray);">Amount:</span>
                                <span id="receiptAmount" style="font-weight: 600;"></span>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                                <span style="color: var(--gray);">Network:</span>
                                <span id="receiptNetwork" style="font-weight: 600;"></span>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                                <span style="color: var(--gray);">Transaction ID:</span>
                                <span id="receiptTxId" style="font-weight: 600; font-size: 0.85rem;"></span>
                            </div>
                            <div style="display: flex; justify-content: space-between;">
                                <span style="color: var(--gray);">Date:</span>
                                <span id="receiptDate" style="font-weight: 600;"></span>
                            </div>
                        </div>
                        <p id="receiptMessage" style="color: var(--gray); font-size: 0.9rem;"></p>
                    </div>
                    <button class="btn btn-primary" onclick="closeModal('directBuyReceiptModal')" style="margin-top: 15px;">
                        <i class="fas fa-check"></i> Done
                    </button>
                </div>
            </div>
        </div>

        <!-- Loan Terms & Conditions Modal -->
        <div class="modal loan-terms-modal" id="loanTermsModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3><i class="fas fa-file-contract" style="color: var(--primary);"></i> Terms & Conditions</h3>
                    <button class="modal-close" onclick="closeModal('loanTermsModal')">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="scroll-hint" id="scrollHint">
                        <i class="fas fa-arrow-down"></i> Please scroll to the bottom to read all terms before agreeing
                    </div>
                    <div class="loan-terms-content" id="loanTermsContent" onscroll="checkTermsScroll()">
                        <h4>1. Loan Application Terms</h4>
                        <p>By applying for a loan through Airtime Solution Kenya, you agree to the following terms and conditions:</p>
                        <ul>
                            <li>You must be at least 18 years of age to apply for a loan.</li>
                            <li>All information provided in the application must be accurate and truthful.</li>
                            <li>You authorize us to verify your information with relevant authorities.</li>
                        </ul>
                        
                        <h4>2. Eligibility Requirements</h4>
                        <p>To be eligible for a loan, you must:</p>
                        <ul>
                            <li>Be a Kenyan citizen or permanent resident.</li>
                            <li>Have a valid national ID or passport.</li>
                            <li>Have an active M-Pesa account.</li>
                            <li>Meet the minimum income requirements set by our partner lenders.</li>
                        </ul>
                        
                        <h4>3. Interest Rates and Fees</h4>
                        <p>Loan interest rates and fees vary depending on:</p>
                        <ul>
                            <li>The loan amount approved.</li>
                            <li>The repayment period selected.</li>
                            <li>Your credit history and score.</li>
                            <li>The lending partner you choose.</li>
                        </ul>
                        
                        <h4>4. Repayment Terms</h4>
                        <ul>
                            <li>Loans must be repaid within the agreed period.</li>
                            <li>Late payments may incur additional fees and affect your credit score.</li>
                            <li>You may make early repayments without penalty.</li>
                        </ul>
                        
                        <h4>5. Savings Deposit Requirement</h4>
                        <p>To finalize your loan application, you must make a savings deposit:</p>
                        <ul>
                            <li>The savings deposit demonstrates your commitment to responsible borrowing.</li>
                            <li>Your savings balance is permanent and separate from your airtime balance.</li>
                            <li>Savings cannot be used for airtime purchases.</li>
                            <li>Savings will be returned after successful loan repayment.</li>
                        </ul>
                        
                        <h4>6. Privacy and Data Protection</h4>
                        <ul>
                            <li>Your personal information is protected under Kenya's Data Protection Act.</li>
                            <li>We share necessary information with our lending partners only.</li>
                            <li>You can request access to or deletion of your data at any time.</li>
                        </ul>
                        
                        <h4>7. Acceptance of Terms</h4>
                        <p>By clicking "I Agree & Continue", you confirm that you have read, understood, and agree to all the terms and conditions stated above.</p>
                    </div>
                    
                    <div class="loan-agree-section">
                        <button class="loan-agree-btn" id="loanAgreeBtn" onclick="agreeLoanTerms()">
                            <i class="fas fa-check-circle"></i> I Agree & Continue
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Loan Dashboard Page -->
        <div id="page-loan-dashboard" class="page">
            <div class="loan-dashboard-hero">
                <h1><i class="fas fa-hand-holding-usd"></i> Quick Loans</h1>
                <p>Get instant loans from trusted Kenyan lenders</p>
            </div>
            
            <div class="loan-feature-grid">
                <div class="loan-feature-card">
                    <i class="fas fa-bolt"></i>
                    <h4>Instant Approval</h4>
                    <p>Get approved in minutes</p>
                </div>
                <div class="loan-feature-card">
                    <i class="fas fa-shield-alt"></i>
                    <h4>Secure & Safe</h4>
                    <p>Your data is protected</p>
                </div>
                <div class="loan-feature-card">
                    <i class="fas fa-percentage"></i>
                    <h4>Low Interest</h4>
                    <p>Competitive rates</p>
                </div>
                <div class="loan-feature-card">
                    <i class="fas fa-mobile-alt"></i>
                    <h4>M-Pesa Disbursement</h4>
                    <p>Direct to your phone</p>
                </div>
            </div>
            
            <div class="how-it-works-section">
                <h3><i class="fas fa-question-circle"></i> How It Works</h3>
                <div class="step-item">
                    <div class="step-number">1</div>
                    <div class="step-content">
                        <h4>Complete Eligibility Form</h4>
                        <p>Fill in your personal and financial details accurately</p>
                    </div>
                </div>
                <div class="step-item">
                    <div class="step-number">2</div>
                    <div class="step-content">
                        <h4>Choose Your Loan Offer</h4>
                        <p>Select from multiple offers by our trusted partners</p>
                    </div>
                </div>
                <div class="step-item">
                    <div class="step-number">3</div>
                    <div class="step-content">
                        <h4>Make Savings Deposit</h4>
                        <p>Deposit a small amount to confirm your commitment</p>
                    </div>
                </div>
                <div class="step-item">
                    <div class="step-number">4</div>
                    <div class="step-content">
                        <h4>Receive Your Loan</h4>
                        <p>Get funds directly to your M-Pesa within minutes</p>
                    </div>
                </div>
            </div>
            
            <div class="why-choose-section">
                <h3><i class="fas fa-star"></i> Why Choose Us?</h3>
                <div class="testimonial-card">
                    <div class="stars">
                        <i class="fas fa-star"></i>
                        <i class="fas fa-star"></i>
                        <i class="fas fa-star"></i>
                        <i class="fas fa-star"></i>
                        <i class="fas fa-star"></i>
                    </div>
                    <p>"I got my loan in less than 5 minutes! The process was so smooth and the rates are very fair."</p>
                    <div class="author">- James M., Nairobi</div>
                </div>
                <div class="testimonial-card">
                    <div class="stars">
                        <i class="fas fa-star"></i>
                        <i class="fas fa-star"></i>
                        <i class="fas fa-star"></i>
                        <i class="fas fa-star"></i>
                        <i class="fas fa-star-half-alt"></i>
                    </div>
                    <p>"Finally a loan app that doesn't harass you! Very professional and reliable service."</p>
                    <div class="author">- Sarah W., Mombasa</div>
                </div>
            </div>
            
            <!-- Loan Images Section -->
            <div class="loan-promo-section">
                <h3><i class="fas fa-images"></i> Our Loan Partners</h3>
                <div class="loan-images-section">
                    <div class="loan-image-card">
                        <img src="loan1.png" alt="Instant Loans" onerror="this.src='https://via.placeholder.com/280x150/4CAF50/FFFFFF?text=Instant+Loans'">
                        <div class="card-content">
                            <h4>Instant M-Pesa Loans</h4>
                            <p>Get your loan within minutes directly to your M-Pesa</p>
                        </div>
                    </div>
                    <div class="loan-image-card">
                        <img src="loan2.png" alt="Low Interest" onerror="this.src='https://via.placeholder.com/280x150/2196F3/FFFFFF?text=Low+Interest'">
                        <div class="card-content">
                            <h4>Low Interest Rates</h4>
                            <p>Enjoy some of the best rates in the market</p>
                        </div>
                    </div>
                    <div class="loan-image-card">
                        <img src="linker-mkopo.png" alt="Linker Mkopo" onerror="this.src='https://via.placeholder.com/280x150/673AB7/FFFFFF?text=Linker+Mkopo'">
                        <div class="card-content">
                            <h4>Linker Mkopo</h4>
                            <p>Quick personal loans up to KES 4,000</p>
                        </div>
                    </div>
                    <div class="loan-image-card">
                        <img src="pesa-haraka.png" alt="Pesa Haraka" onerror="this.src='https://via.placeholder.com/280x150/FF5722/FFFFFF?text=Pesa+Haraka'">
                        <div class="card-content">
                            <h4>Pesa Haraka</h4>
                            <p>Instant cash loans up to KES 7,000</p>
                        </div>
                    </div>
                    <div class="loan-image-card">
                        <img src="mkopo-sasa.png" alt="Mkopo Sasa" onerror="this.src='https://via.placeholder.com/280x150/FF9800/FFFFFF?text=Mkopo+Sasa'">
                        <div class="card-content">
                            <h4>Mkopo Sasa</h4>
                            <p>Premium loans up to KES 15,000</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="faq-section">
                <h3><i class="fas fa-question-circle"></i> Frequently Asked Questions</h3>
                <div class="faq-item" onclick="toggleFaq(this)">
                    <h4>What documents do I need? <i class="fas fa-chevron-down"></i></h4>
                    <p>You only need your National ID number and a valid M-Pesa registered phone number.</p>
                </div>
                <div class="faq-item" onclick="toggleFaq(this)">
                    <h4>How long does approval take? <i class="fas fa-chevron-down"></i></h4>
                    <p>Most applications are processed within 5-10 minutes. You'll receive your loan directly to M-Pesa.</p>
                </div>
                <div class="faq-item" onclick="toggleFaq(this)">
                    <h4>What is the savings deposit for? <i class="fas fa-chevron-down"></i></h4>
                    <p>The savings deposit shows your commitment to repaying the loan. It's kept safely and returned after full repayment.</p>
                </div>
            </div>
            
            <button class="apply-loan-btn" onclick="showPage('loan-eligibility')">
                <i class="fas fa-arrow-right"></i> Apply Now - Check Eligibility
            </button>
            
            <div class="loan-footer-links">
                <h4>Quick Links</h4>
                <a href="#" onclick="showPage('terms')">Terms of Service</a>
                <a href="#" onclick="showPage('privacy')">Privacy Policy</a>
                <a href="#" onclick="showPage('contact')">Contact Support</a>
            </div>
        </div>

        <!-- Loan Eligibility Form Page -->
        <div id="page-loan-eligibility" class="page">
            <div class="loan-dashboard-hero" style="padding: 20px;">
                <h1 style="font-size: 1.5rem;"><i class="fas fa-clipboard-check"></i> Eligibility Form</h1>
                <p style="font-size: 0.9rem;">Complete all sections to check your loan eligibility</p>
            </div>
            
            <div class="eligibility-form-container">
                <form id="eligibilityForm" onsubmit="event.preventDefault(); submitEligibilityForm();">
                    
                    <!-- Section 1: Personal Information -->
                    <div class="form-section">
                        <div class="form-section-title"><i class="fas fa-user"></i> Personal Information</div>
                        
                        <div class="form-group">
                            <label class="form-label">Email Address *</label>
                            <input type="email" class="form-input" id="loanEmail" readonly style="background: var(--light); cursor: not-allowed;">
                            <p style="font-size: 0.8rem; color: var(--gray); margin-top: 5px;">Email from your account (cannot be changed)</p>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">First Name *</label>
                                <input type="text" class="form-input" id="loanFirstName" required placeholder="Enter first name">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Last Name *</label>
                                <input type="text" class="form-input" id="loanLastName" required placeholder="Enter last name">
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Date of Birth *</label>
                                <input type="date" class="form-input" id="loanDob" required onchange="validateAge()">
                                <p class="validation-error" id="ageError" style="display: none;">You must be 18 years or older</p>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Gender *</label>
                                <select class="form-input" id="loanGender" required>
                                    <option value="">Select Gender</option>
                                    <option value="male">Male</option>
                                    <option value="female">Female</option>
                                    <option value="other">Other</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">National ID Number *</label>
                                <input type="text" class="form-input" id="loanIdNumber" required placeholder="e.g. 12345678" maxlength="10">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Phone Number (M-Pesa) *</label>
                                <div class="phone-wrapper">
                                    <span class="phone-prefix">+254</span>
                                    <input type="tel" class="form-input" id="loanPhone" required placeholder="7XXXXXXXX" maxlength="9" oninput="validateLoanPhone()">
                                </div>
                                <p class="validation-error" id="loanPhoneError" style="display: none;">Enter valid 9-digit number starting with 7 or 1</p>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">County of Residence *</label>
                            <select class="form-input county-select" id="loanCounty" required>
                                <option value="">Select County</option>
                                <option value="Baringo">Baringo</option>
                                <option value="Bomet">Bomet</option>
                                <option value="Bungoma">Bungoma</option>
                                <option value="Busia">Busia</option>
                                <option value="Elgeyo-Marakwet">Elgeyo-Marakwet</option>
                                <option value="Embu">Embu</option>
                                <option value="Garissa">Garissa</option>
                                <option value="Homa Bay">Homa Bay</option>
                                <option value="Isiolo">Isiolo</option>
                                <option value="Kajiado">Kajiado</option>
                                <option value="Kakamega">Kakamega</option>
                                <option value="Kericho">Kericho</option>
                                <option value="Kiambu">Kiambu</option>
                                <option value="Kilifi">Kilifi</option>
                                <option value="Kirinyaga">Kirinyaga</option>
                                <option value="Kisii">Kisii</option>
                                <option value="Kisumu">Kisumu</option>
                                <option value="Kitui">Kitui</option>
                                <option value="Kwale">Kwale</option>
                                <option value="Laikipia">Laikipia</option>
                                <option value="Lamu">Lamu</option>
                                <option value="Machakos">Machakos</option>
                                <option value="Makueni">Makueni</option>
                                <option value="Mandera">Mandera</option>
                                <option value="Marsabit">Marsabit</option>
                                <option value="Meru">Meru</option>
                                <option value="Migori">Migori</option>
                                <option value="Mombasa">Mombasa</option>
                                <option value="Murang'a">Murang'a</option>
                                <option value="Nairobi">Nairobi</option>
                                <option value="Nakuru">Nakuru</option>
                                <option value="Nandi">Nandi</option>
                                <option value="Narok">Narok</option>
                                <option value="Nyamira">Nyamira</option>
                                <option value="Nyandarua">Nyandarua</option>
                                <option value="Nyeri">Nyeri</option>
                                <option value="Samburu">Samburu</option>
                                <option value="Siaya">Siaya</option>
                                <option value="Taita-Taveta">Taita-Taveta</option>
                                <option value="Tana River">Tana River</option>
                                <option value="Tharaka-Nithi">Tharaka-Nithi</option>
                                <option value="Trans-Nzoia">Trans-Nzoia</option>
                                <option value="Turkana">Turkana</option>
                                <option value="Uasin Gishu">Uasin Gishu</option>
                                <option value="Vihiga">Vihiga</option>
                                <option value="Wajir">Wajir</option>
                                <option value="West Pokot">West Pokot</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- Section 2: Emergency Contacts -->
                    <div class="form-section">
                        <div class="form-section-title"><i class="fas fa-phone-alt"></i> Emergency Contacts</div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Emergency Contact 1 Name *</label>
                                <input type="text" class="form-input" id="emergency1Name" required placeholder="Full name">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Relationship *</label>
                                <select class="form-input" id="emergency1Relationship" required>
                                    <option value="">Select</option>
                                    <option value="spouse">Spouse</option>
                                    <option value="parent">Parent</option>
                                    <option value="sibling">Sibling</option>
                                    <option value="friend">Friend</option>
                                    <option value="colleague">Colleague</option>
                                    <option value="other">Other</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Emergency Contact 1 Phone *</label>
                            <div class="phone-wrapper">
                                <span class="phone-prefix">+254</span>
                                <input type="tel" class="form-input" id="emergency1Phone" required placeholder="7XXXXXXXX" maxlength="9" oninput="validateEmergencyPhone1()">
                            </div>
                            <p class="validation-error" id="emergency1PhoneError" style="display: none;">Enter valid 9-digit number</p>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Emergency Contact 2 Name *</label>
                                <input type="text" class="form-input" id="emergency2Name" required placeholder="Full name">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Relationship *</label>
                                <select class="form-input" id="emergency2Relationship" required>
                                    <option value="">Select</option>
                                    <option value="spouse">Spouse</option>
                                    <option value="parent">Parent</option>
                                    <option value="sibling">Sibling</option>
                                    <option value="friend">Friend</option>
                                    <option value="colleague">Colleague</option>
                                    <option value="other">Other</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Emergency Contact 2 Phone *</label>
                            <div class="phone-wrapper">
                                <span class="phone-prefix">+254</span>
                                <input type="tel" class="form-input" id="emergency2Phone" required placeholder="7XXXXXXXX" maxlength="9" oninput="validateEmergencyPhone2()">
                            </div>
                            <p class="validation-error" id="emergency2PhoneError" style="display: none;">Enter valid 9-digit number</p>
                        </div>
                    </div>
                    
                    <!-- Section 3: Employment & Financial -->
                    <div class="form-section">
                        <div class="form-section-title"><i class="fas fa-briefcase"></i> Employment & Financial Information</div>
                        
                        <div class="form-group">
                            <label class="form-label">Employment Status *</label>
                            <select class="form-input" id="loanEmployment" required>
                                <option value="">Select Status</option>
                                <option value="employed">Employed</option>
                                <option value="self-employed">Self-Employed</option>
                                <option value="business-owner">Business Owner</option>
                                <option value="student">Student</option>
                                <option value="unemployed">Unemployed</option>
                                <option value="retired">Retired</option>
                            </select>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Monthly Income (KES) *</label>
                                <input type="number" class="form-input" id="loanIncome" required placeholder="e.g. 50000" min="0">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Loan Amount Needed (KES) *</label>
                                <input type="number" class="form-input" id="loanAmountNeeded" required placeholder="e.g. 5000" min="500" max="50000">
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Purpose of Loan *</label>
                            <select class="form-input" id="loanPurpose" required>
                                <option value="">Select Purpose</option>
                                <option value="business">Business Capital</option>
                                <option value="emergency">Emergency</option>
                                <option value="education">Education</option>
                                <option value="medical">Medical Expenses</option>
                                <option value="bills">Pay Bills</option>
                                <option value="personal">Personal Use</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- Section 4: Terms Agreement -->
                    <div class="form-section">
                        <div class="form-section-title"><i class="fas fa-check-square"></i> Confirmation</div>
                        
                        <div class="form-group">
                            <label style="display: flex; align-items: flex-start; gap: 10px; cursor: pointer;">
                                <input type="checkbox" id="loanTermsCheck" required style="margin-top: 3px;">
                                <span style="font-size: 0.9rem;">I confirm that all information provided is accurate and I agree to the <a href="#" onclick="showPage('terms'); return false;" style="color: var(--primary);">Terms of Service</a> and <a href="#" onclick="showPage('privacy'); return false;" style="color: var(--primary);">Privacy Policy</a></span>
                            </label>
                        </div>
                    </div>
                    
                    <button type="submit" class="apply-loan-btn" style="width: 100%; margin: 0;">
                        <i class="fas fa-paper-plane"></i> Submit Application
                    </button>
                </form>
                
                <button class="btn btn-outline" style="width: 100%; margin-top: 15px;" onclick="showPage('loan-dashboard')">
                    <i class="fas fa-arrow-left"></i> Back to Loan Dashboard
                </button>
            </div>
        </div>

        <!-- Thank You / Processing Page -->
        <div id="page-loan-processing" class="page">
            <div class="processing-container">
                <div class="processing-icon">
                    <i class="fas fa-hourglass-half"></i>
                </div>
                <h2 style="color: var(--primary); margin-bottom: 10px;">Processing Your Application</h2>
                <p style="color: var(--gray); margin-bottom: 20px;">Please wait while we verify your eligibility...</p>
                
                <div class="processing-bar">
                    <div class="processing-progress" id="processingProgress"></div>
                </div>
                
                <p id="processingStatus" style="font-weight: 500;">Verifying personal information...</p>
                
                <div style="background: var(--light); border-radius: 15px; padding: 20px; margin-top: 30px;">
                    <h4 style="margin-bottom: 15px;"><i class="fas fa-info-circle" style="color: var(--primary);"></i> What's Happening?</h4>
                    <ul style="text-align: left; font-size: 0.9rem; color: var(--gray);">
                        <li style="margin-bottom: 8px;">Verifying your personal details</li>
                        <li style="margin-bottom: 8px;">Checking eligibility with partner lenders</li>
                        <li style="margin-bottom: 8px;">Calculating best loan offers for you</li>
                        <li>Preparing personalized loan options</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Loan Offers Page -->
        <div id="page-loan-offers" class="page">
            <div class="loan-dashboard-hero" style="padding: 20px;">
                <h1 style="font-size: 1.5rem;"><i class="fas fa-gift"></i> Congratulations!</h1>
                <p style="font-size: 0.9rem;">You qualify for the following loan offers</p>
            </div>
            
            <div style="padding: 20px;">
                <!-- User Info Card -->
                <div class="card" style="background: linear-gradient(135deg, var(--primary), var(--primary-dark)); color: white; margin-bottom: 20px;">
                    <div style="display: flex; align-items: center; gap: 15px;">
                        <div style="width: 50px; height: 50px; background: rgba(255,255,255,0.2); border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                            <i class="fas fa-user" style="font-size: 1.5rem;"></i>
                        </div>
                        <div>
                            <p style="opacity: 0.9; font-size: 0.85rem;">Applicant</p>
                            <h4 id="offerUserName" style="margin: 0;">-</h4>
                            <p style="font-size: 0.8rem; opacity: 0.8;"><span id="offerUserId">ID: -</span> | <span id="offerUserPhone">+254 -</span></p>
                        </div>
                    </div>
                </div>
                
                <p style="margin-bottom: 20px; color: var(--gray); text-align: center;">Select your preferred loan offer:</p>
                
                <!-- Linker Mkopo Offer -->
                <div class="loan-offer-card" onclick="selectLoanOffer('linker')" id="offerLinker">
                    <div class="loan-offer-header">
                        <img src="linker-mkopo.png" alt="Linker Mkopo" class="loan-company-logo" style="width: 50px; height: 50px; border-radius: 50%; object-fit: cover; background: #2196F3;" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                        <div class="loan-company-logo" style="background: #2196F3; display: none;">LM</div>
                        <div class="loan-company-info">
                            <h4>Linker Mkopo</h4>
                            <p>Quick Personal Loans</p>
                        </div>
                    </div>
                    <div class="loan-amount-display">
                        <div class="amount">KES 4,000</div>
                        <div class="label">Receive KES 3,870 to your M-Pesa</div>
                    </div>
                    <div class="loan-details-grid">
                        <div class="loan-detail-item">
                            <i class="fas fa-piggy-bank"></i>
                            <span class="detail-label">Savings Required</span>
                            <span class="detail-value">KES 130</span>
                        </div>
                        <div class="loan-detail-item">
                            <i class="fas fa-hand-holding-usd"></i>
                            <span class="detail-label">Repayment</span>
                            <span class="detail-value">KES 4,070</span>
                        </div>
                        <div class="loan-detail-item">
                            <i class="fas fa-calendar-alt"></i>
                            <span class="detail-label">Duration</span>
                            <span class="detail-value">60 Days</span>
                        </div>
                        <div class="loan-detail-item">
                            <i class="fas fa-percentage"></i>
                            <span class="detail-label">Interest</span>
                            <span class="detail-value">1.75%</span>
                        </div>
                    </div>
                    <button class="btn btn-primary select-offer-btn" style="width: 100%; margin-top: 15px;">
                        <i class="fas fa-check-circle"></i> Select This Offer
                    </button>
                </div>
                
                <!-- Pesa Haraka Offer -->
                <div class="loan-offer-card" onclick="selectLoanOffer('pesa')" id="offerPesa">
                    <div class="loan-offer-header">
                        <img src="pesa-haraka.png" alt="Pesa Haraka" class="loan-company-logo" style="width: 50px; height: 50px; border-radius: 50%; object-fit: cover; background: #4CAF50;" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                        <div class="loan-company-logo" style="background: #4CAF50; display: none;">PH</div>
                        <div class="loan-company-info">
                            <h4>Pesa Haraka</h4>
                            <p>Instant Cash Loans</p>
                        </div>
                    </div>
                    <div class="loan-amount-display">
                        <div class="amount">KES 7,000</div>
                        <div class="label">Receive KES 6,770 to your M-Pesa</div>
                    </div>
                    <div class="loan-details-grid">
                        <div class="loan-detail-item">
                            <i class="fas fa-piggy-bank"></i>
                            <span class="detail-label">Savings Required</span>
                            <span class="detail-value">KES 230</span>
                        </div>
                        <div class="loan-detail-item">
                            <i class="fas fa-hand-holding-usd"></i>
                            <span class="detail-label">Repayment</span>
                            <span class="detail-value">KES 7,147</span>
                        </div>
                        <div class="loan-detail-item">
                            <i class="fas fa-calendar-alt"></i>
                            <span class="detail-label">Duration</span>
                            <span class="detail-value">70 Days</span>
                        </div>
                        <div class="loan-detail-item">
                            <i class="fas fa-percentage"></i>
                            <span class="detail-label">Interest</span>
                            <span class="detail-value">2.1%</span>
                        </div>
                    </div>
                    <button class="btn btn-primary select-offer-btn" style="width: 100%; margin-top: 15px;">
                        <i class="fas fa-check-circle"></i> Select This Offer
                    </button>
                </div>
                
                <!-- Mkopo Sasa Offer -->
                <div class="loan-offer-card" onclick="selectLoanOffer('mkopo')" id="offerMkopo">
                    <div class="loan-offer-header">
                        <img src="mkopo-sasa.png" alt="Mkopo Sasa" class="loan-company-logo" style="width: 50px; height: 50px; border-radius: 50%; object-fit: cover; background: #FF9800;" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                        <div class="loan-company-logo" style="background: #FF9800; display: none;">MS</div>
                        <div class="loan-company-info">
                            <h4>Mkopo Sasa</h4>
                            <p>Premium Loans</p>
                        </div>
                    </div>
                    <div class="loan-amount-display">
                        <div class="amount">KES 15,000</div>
                        <div class="label">Receive KES 14,570 to your M-Pesa</div>
                    </div>
                    <div class="loan-details-grid">
                        <div class="loan-detail-item">
                            <i class="fas fa-piggy-bank"></i>
                            <span class="detail-label">Savings Required</span>
                            <span class="detail-value">KES 430</span>
                        </div>
                        <div class="loan-detail-item">
                            <i class="fas fa-hand-holding-usd"></i>
                            <span class="detail-label">Repayment</span>
                            <span class="detail-value">KES 15,225</span>
                        </div>
                        <div class="loan-detail-item">
                            <i class="fas fa-calendar-alt"></i>
                            <span class="detail-label">Duration</span>
                            <span class="detail-value">100 Days</span>
                        </div>
                        <div class="loan-detail-item">
                            <i class="fas fa-percentage"></i>
                            <span class="detail-label">Interest</span>
                            <span class="detail-value">1.5%</span>
                        </div>
                    </div>
                    <button class="btn btn-primary select-offer-btn" style="width: 100%; margin-top: 15px;">
                        <i class="fas fa-check-circle"></i> Select This Offer
                    </button>
                </div>
                
                <!-- Why Choose These Lenders -->
                <div class="card" style="margin-top: 20px; background: var(--light);">
                    <h4 style="margin-bottom: 15px; color: var(--primary);"><i class="fas fa-shield-alt"></i> Why Choose These Lenders?</h4>
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <i class="fas fa-bolt" style="color: var(--secondary);"></i>
                            <span style="font-size: 0.9rem;">Instant Approval</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <i class="fas fa-lock" style="color: var(--primary);"></i>
                            <span style="font-size: 0.9rem;">Secure & Private</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <i class="fas fa-mobile-alt" style="color: var(--info);"></i>
                            <span style="font-size: 0.9rem;">Direct to M-Pesa</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <i class="fas fa-undo" style="color: var(--success);"></i>
                            <span style="font-size: 0.9rem;">Refundable Savings</span>
                        </div>
                    </div>
                </div>
                
                <button class="btn btn-outline" style="width: 100%; margin-top: 20px;" onclick="showPage('loan-eligibility')">
                    <i class="fas fa-arrow-left"></i> Back to Eligibility Form
                </button>
            </div>
        </div>

        <!-- Review Application Page -->
        <div id="page-loan-review" class="page">
            <div class="loan-dashboard-hero" style="padding: 20px;">
                <h1 style="font-size: 1.5rem;"><i class="fas fa-clipboard-list"></i> Review Application</h1>
                <p style="font-size: 0.9rem;">Verify your details before final submission</p>
            </div>
            
            <div style="padding: 20px;">
                <div class="card">
                    <div class="review-section">
                        <h4><i class="fas fa-user"></i> Personal Information <button class="edit-section-btn" onclick="editSection('eligibility')"><i class="fas fa-edit"></i></button></h4>
                        <div class="review-field">
                            <span class="label">Full Name</span>
                            <span class="value" id="reviewName">-</span>
                        </div>
                        <div class="review-field">
                            <span class="label">Email</span>
                            <span class="value" id="reviewEmail">-</span>
                        </div>
                        <div class="review-field">
                            <span class="label">Phone</span>
                            <span class="value" id="reviewPhone">-</span>
                        </div>
                        <div class="review-field">
                            <span class="label">ID Number</span>
                            <span class="value" id="reviewId">-</span>
                        </div>
                        <div class="review-field">
                            <span class="label">County</span>
                            <span class="value" id="reviewCounty">-</span>
                        </div>
                    </div>
                    
                    <div class="review-section">
                        <h4><i class="fas fa-hand-holding-usd"></i> Loan Details <button class="edit-section-btn" onclick="editSection('offers')"><i class="fas fa-edit"></i></button></h4>
                        <div class="review-field">
                            <span class="label">Lender</span>
                            <span class="value" id="reviewLender">-</span>
                        </div>
                        <div class="review-field">
                            <span class="label">Loan Amount</span>
                            <span class="value" id="reviewAmount" style="color: var(--primary); font-weight: 700;">-</span>
                        </div>
                        <div class="review-field">
                            <span class="label">You Receive</span>
                            <span class="value" id="reviewReceive" style="color: var(--success);">-</span>
                        </div>
                        <div class="review-field">
                            <span class="label">Savings Required</span>
                            <span class="value" id="reviewSavings" style="color: var(--warning);">-</span>
                        </div>
                        <div class="review-field">
                            <span class="label">Total Repayment</span>
                            <span class="value" id="reviewRepayment">-</span>
                        </div>
                        <div class="review-field">
                            <span class="label">Duration</span>
                            <span class="value" id="reviewPeriod">-</span>
                        </div>
                        <div class="review-field">
                            <span class="label">Interest Rate</span>
                            <span class="value" id="reviewInterest">-</span>
                        </div>
                    </div>
                    
                    <div class="review-section">
                        <h4><i class="fas fa-mobile-alt"></i> Receiving Phone Number</h4>
                        <div class="form-group" style="margin-bottom: 0;">
                            <div class="phone-wrapper">
                                <span class="phone-prefix">+254</span>
                                <input type="tel" class="form-input" id="reviewReceivingPhone" placeholder="7XXXXXXXX" maxlength="9">
                            </div>
                            <p style="font-size: 0.8rem; color: var(--gray); margin-top: 5px;">This is the number where your loan will be sent</p>
                        </div>
                    </div>
                </div>
                
                <div class="info-box" style="background: rgba(255, 193, 7, 0.1); border-left-color: var(--warning);">
                    <p><i class="fas fa-exclamation-triangle"></i> <strong>Important:</strong> Please review all details carefully. Once submitted, your application will be processed immediately.</p>
                </div>
                
                <button class="apply-loan-btn" onclick="startLoanApproval()" style="width: 100%; margin: 20px 0;">
                    <i class="fas fa-paper-plane"></i> Submit & Get Loan
                </button>
                
                <button class="btn btn-outline" style="width: 100%;" onclick="showPage('loan-offers')">
                    <i class="fas fa-arrow-left"></i> Change Loan Offer
                </button>
            </div>
        </div>
        
        <!-- Loan Approval Processing Page (30 seconds) -->
        <div id="page-loan-approval" class="page">
            <div class="approval-container">
                <div class="approval-icon">
                    <div class="approval-spinner"></div>
                </div>
                <h2 style="color: var(--primary); margin-bottom: 10px;">Approving Your Loan</h2>
                <p style="color: var(--danger); margin-bottom: 20px; font-weight: 500;">Please do not close this page</p>
                
                <div class="approval-timer">
                    <span id="approvalCountdown">30</span>
                    <span class="timer-label">seconds remaining</span>
                </div>
                
                <div class="approval-steps">
                    <div class="approval-step" id="approvalStep1">
                        <i class="fas fa-spinner fa-spin"></i>
                        <span>Verifying personal information...</span>
                    </div>
                    <div class="approval-step pending" id="approvalStep2">
                        <i class="fas fa-circle"></i>
                        <span>Checking credit eligibility...</span>
                    </div>
                    <div class="approval-step pending" id="approvalStep3">
                        <i class="fas fa-circle"></i>
                        <span>Contacting lender partner...</span>
                    </div>
                    <div class="approval-step pending" id="approvalStep4">
                        <i class="fas fa-circle"></i>
                        <span>Preparing loan disbursement...</span>
                    </div>
                    <div class="approval-step pending" id="approvalStep5">
                        <i class="fas fa-circle"></i>
                        <span>Final verification in progress...</span>
                    </div>
                </div>
                
                <div style="background: var(--light); border-radius: 15px; padding: 15px; margin-top: 20px;">
                    <p style="font-size: 0.9rem; color: var(--gray);"><i class="fas fa-lock" style="color: var(--primary); margin-right: 8px;"></i>Your data is secure and encrypted</p>
                </div>
            </div>
        </div>

        <!-- Loan Approved Page -->
        <div id="page-loan-approved" class="page">
            <div class="approved-container">
                <div class="approved-icon">
                    <i class="fas fa-check-circle"></i>
                </div>
                <h2 style="color: var(--success); margin-bottom: 10px;">Your loan of <span id="approvedAmount">KES 0</span> is approved successfully!</h2>
                
                <div class="info-box" style="background: rgba(102, 126, 234, 0.1); border-left-color: #667eea; text-align: left; margin: 20px 0;">
                    <h4 style="margin-bottom: 10px; color: var(--primary);"><i class="fas fa-info-circle"></i> Important: Savings Deposit Required</h4>
                    <p style="margin-bottom: 10px;">To complete your loan disbursement, you need to deposit your savings amount. This is a security measure that:</p>
                    <ul style="margin-left: 20px; font-size: 0.9rem; color: var(--gray);">
                        <li>Shows your commitment to repaying the loan</li>
                        <li>Is fully refundable after loan repayment</li>
                        <li>Helps you get instant loan release to your M-Pesa</li>
                    </ul>
                </div>
                
                <div class="savings-deposit-card">
                    <h4><i class="fas fa-piggy-bank"></i> Savings Deposit Details</h4>
                    
                    <div class="savings-info-grid">
                        <div class="savings-info-item">
                            <span class="label">Savings Amount</span>
                            <span class="value" id="requiredSavingsAmount">KES 0</span>
                        </div>
                        <div class="savings-info-item">
                            <span class="label">Loan Released</span>
                            <span class="value">Immediately after deposit</span>
                        </div>
                        <div class="savings-info-item">
                            <span class="label">Phone Number</span>
                            <span class="value" id="approvedPhone">+254 -</span>
                        </div>
                        <div class="savings-info-item">
                            <span class="label">Email</span>
                            <span class="value" id="approvedEmailHidden">*****@***.com</span>
                        </div>
                    </div>
                    
                    <div class="savings-balance-display" style="margin: 20px 0;">
                        <div class="label">Your Current Savings Balance</div>
                        <div class="amount" id="savingsBalance">KES 0.00</div>
                    </div>
                    
                    <div style="margin: 20px 0;">
                        <div class="form-group">
                            <label style="color: white; text-align: left; display: block; margin-bottom: 5px;">M-Pesa Phone Number</label>
                            <div class="phone-wrapper" style="background: rgba(255,255,255,0.9); border-radius: 12px;">
                                <span class="phone-prefix" style="color: #333;">+254</span>
                                <input type="tel" class="form-input" id="savingsDepositPhone" placeholder="7XXXXXXXX" maxlength="9" style="background: transparent; color: #333;">
                            </div>
                        </div>
                    </div>
                    
                    <button class="deposit-savings-btn" onclick="initiateSavingsDeposit()" id="savingsDepositBtn">
                        <i class="fas fa-mobile-alt"></i> Save <span id="savingsBtnAmount">KES 0</span> to Get Loan Now
                    </button>
                </div>
                
                <div id="savingsDepositStatus" style="display: none; margin: 20px 0; padding: 15px; background: var(--light); border-radius: 12px;">
                    <div class="spinner" style="margin: 0 auto 10px;"></div>
                    <p id="savingsStatusText" style="color: var(--gray);">Initiating savings using +254...</p>
                </div>
                
                <button class="btn btn-outline" style="width: 100%; margin-top: 15px;" onclick="changeLoanOffer()">
                    <i class="fas fa-exchange-alt"></i> Change Loan Offer
                </button>
                
                <button class="btn btn-outline" style="width: 100%; margin-top: 10px;" onclick="showPage('dashboard')">
                    <i class="fas fa-home"></i> Back to Dashboard
                </button>
            </div>
        </div>
        
        <!-- Confirm Phone Number Modal -->
        <div class="modal" id="confirmPhoneModal">
            <div class="modal-content" style="max-width: 400px;">
                <div class="modal-header">
                    <h3><i class="fas fa-mobile-alt" style="color: var(--primary);"></i> Confirm Receiving Number</h3>
                    <button class="modal-close" onclick="closeModal('confirmPhoneModal')">&times;</button>
                </div>
                <div class="modal-body">
                    <div style="text-align: center; margin-bottom: 20px;">
                        <img id="confirmOfferLogo" src="" alt="" style="width: 60px; height: 60px; border-radius: 50%; object-fit: cover; margin-bottom: 10px;" onerror="this.style.display='none'">
                        <h4 id="confirmOfferName" style="color: var(--primary);">-</h4>
                        <p style="color: var(--gray); font-size: 0.9rem;">Loan Amount: <strong id="confirmOfferAmount">KES 0</strong></p>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label"><i class="fas fa-phone"></i> Confirm Your M-Pesa Number</label>
                        <div class="phone-wrapper">
                            <span class="phone-prefix">+254</span>
                            <input type="tel" class="form-input" id="confirmPhoneInput" placeholder="7XXXXXXXX" maxlength="9">
                        </div>
                        <p class="validation-error" id="confirmPhoneError" style="display: none;">Enter valid 9-digit number starting with 7 or 1</p>
                    </div>
                    
                    <div class="form-group" style="margin-top: 15px;">
                        <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                            <input type="checkbox" id="confirmPhoneCheck" style="width: 20px; height: 20px;">
                            <span style="font-size: 0.9rem;">Is this the number to receive your loan?</span>
                        </label>
                    </div>
                    
                    <div class="btn-group" style="margin-top: 20px;">
                        <button class="btn btn-primary" onclick="confirmPhoneAndProceed()" id="confirmPhoneProceedBtn" disabled>
                            <i class="fas fa-check"></i> Confirm & Continue
                        </button>
                        <button class="btn btn-outline" onclick="closeModal('confirmPhoneModal')">
                            Cancel
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Savings Receipt Modal -->
        <div class="modal" id="savingsReceiptModal">
            <div class="modal-content" style="max-width: 400px;">
                <div class="modal-header" style="background: var(--success); color: white;">
                    <h3><i class="fas fa-receipt"></i> Savings Receipt</h3>
                    <button class="modal-close" onclick="closeModal('savingsReceiptModal')" style="color: white;">&times;</button>
                </div>
                <div class="modal-body" style="text-align: center;">
                    <div id="receiptIconSavings" style="font-size: 4rem; margin-bottom: 15px;">
                        <i class="fas fa-check-circle" style="color: var(--success);"></i>
                    </div>
                    <h3 id="receiptStatusSavings" style="margin-bottom: 10px;">Savings Deposited!</h3>
                    <p id="receiptMessageSavings" style="color: var(--gray); margin-bottom: 20px;">Your savings deposit was successful.</p>
                    
                    <div class="receipt-details" style="text-align: left; background: var(--light); padding: 15px; border-radius: 12px;">
                        <div class="receipt-row">
                            <span>Amount</span>
                            <strong id="receiptAmountSavings">KES 0</strong>
                        </div>
                        <div class="receipt-row">
                            <span>Phone</span>
                            <strong id="receiptPhoneSavings">+254 -</strong>
                        </div>
                        <div class="receipt-row">
                            <span>M-Pesa Receipt</span>
                            <strong id="receiptCodeSavings">-</strong>
                        </div>
                        <div class="receipt-row">
                            <span>Date</span>
                            <strong id="receiptDateSavings">-</strong>
                        </div>
                        <div class="receipt-row">
                            <span>New Savings Balance</span>
                            <strong id="receiptNewBalance" style="color: var(--primary);">KES 0</strong>
                        </div>
                    </div>
                    
                    <button class="btn btn-primary" style="margin-top: 20px;" onclick="closeModal('savingsReceiptModal')">
                        <i class="fas fa-check"></i> Done
                    </button>
                </div>
            </div>
        </div>

        <div class="toast" id="toast">
            <i class="fas fa-info-circle"></i>
            <span id="toastMessage">Message</span>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js';
        import { getAuth, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js';

        const firebaseConfig = {
            apiKey: "AIzaSyBtx-D3nbl1lKOhCzEixDZRgRDM4NbtOBE",
            authDomain: "swiftauth-5fcb5.firebaseapp.com",
            projectId: "swiftauth-5fcb5",
            storageBucket: "swiftauth-5fcb5.firebasestorage.app",
            messagingSenderId: "990160652137",
            appId: "1:990160652137:web:abac238567edfdb5671ff8",
            measurementId: "G-5C1DS28B5S"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);

        const API_BASE = 'https://airtimesolutionbackend2.onrender.com';

        let currentUser = null;
        let adminLoggedIn = false;
        let deferredPrompt = null;
        let balanceRefreshInterval = null;
        let depositRefreshInterval = null;
        let pendingPurchase = null;
        let currentDepositReference = null;

        function showLoading(text = 'Loading...') {
            document.getElementById('loadingText').textContent = text;
            document.getElementById('loadingOverlay').classList.add('show');
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').classList.remove('show');
        }

        function showBalanceOverlay() {
            document.getElementById('balanceOverlay').classList.add('show');
        }

        function hideBalanceOverlay() {
            document.getElementById('balanceOverlay').classList.remove('show');
        }

        onAuthStateChanged(auth, async (user) => {
            const email = localStorage.getItem('userEmail');
            if (user && email) {
                await loadUserData(email);
            } else if (!email) {
                showAuthModal();
            }
        });

        async function loadUserData(email) {
            try {
                showLoading('Loading your account...');
                const response = await fetch(`${API_BASE}/api/users/by-email/${encodeURIComponent(email)}`);
                const data = await response.json();
                if (data.success) {
                    currentUser = { ...data.user, email };
                    updateUI();
                    loadNotifications();
                    loadTransactions();
                    startAutoRefresh();
                    hideLoading();
                } else {
                    hideLoading();
                    showAuthModal();
                }
            } catch (error) {
                console.error('Failed to load user data:', error);
                hideLoading();
                const cached = localStorage.getItem('cachedBalance');
                if (cached) {
                    const data = JSON.parse(cached);
                    currentUser = { email, balance: data.balance, bonus_balance: data.bonus };
                    updateUI();
                }
            }
        }

        function updateUI() {
            if (currentUser) {
                const total = parseFloat(currentUser.balance || 0) + parseFloat(currentUser.bonus_balance || 0);
                document.getElementById('headerBalance').textContent = total.toFixed(2);
                document.getElementById('sidebarEmail').textContent = currentUser.email;
                document.getElementById('sidebarBalance').textContent = `KES ${total.toFixed(2)}`;
                document.getElementById('dashboardBalance').textContent = `KES ${total.toFixed(2)}`;
                document.getElementById('profileEmail').value = currentUser.email;
                document.getElementById('profilePhone').value = localStorage.getItem('userPhone')?.replace('254', '') || '';
            }
        }

        function startAutoRefresh() {
            if (balanceRefreshInterval) clearInterval(balanceRefreshInterval);
            balanceRefreshInterval = setInterval(() => {
                if (currentUser) {
                    silentRefreshBalance();
                }
            }, 30000);
        }

        function startDepositRefresh() {
            if (depositRefreshInterval) clearInterval(depositRefreshInterval);
            depositRefreshInterval = setInterval(() => {
                if (currentUser) {
                    silentRefreshBalance();
                    silentRefreshTransactions();
                }
            }, 2000);
        }

        function stopDepositRefresh() {
            if (depositRefreshInterval) {
                clearInterval(depositRefreshInterval);
                depositRefreshInterval = null;
            }
        }

        async function silentRefreshBalance() {
            if (!currentUser) return;
            try {
                const response = await fetch(`${API_BASE}/api/users/balance-by-email/${encodeURIComponent(currentUser.email)}`);
                const data = await response.json();
                if (data.success) {
                    currentUser.balance = data.balance;
                    currentUser.bonus_balance = data.bonus;
                    updateUI();
                    localStorage.setItem('cachedBalance', JSON.stringify({
                        balance: data.balance,
                        bonus: data.bonus,
                        total: data.total,
                        timestamp: Date.now()
                    }));
                }
            } catch (error) {
                console.error('Silent refresh error:', error);
            }
        }

        async function silentRefreshTransactions() {
            if (!currentUser) return;
            try {
                const response = await fetch(`${API_BASE}/api/transactions/${encodeURIComponent(currentUser.email)}`);
                const data = await response.json();
                if (data.success) {
                    renderTransactions(data.transactions);
                }
            } catch (error) {
                console.error('Silent transaction refresh error:', error);
            }
        }

        window.refreshBalance = async function() {
            if (!currentUser) return;
            const btn = document.getElementById('refreshBtn');
            btn.classList.add('spinning');
            try {
                const response = await fetch(`${API_BASE}/api/users/balance-by-email/${encodeURIComponent(currentUser.email)}`);
                const data = await response.json();
                if (data.success) {
                    currentUser.balance = data.balance;
                    currentUser.bonus_balance = data.bonus;
                    updateUI();
                    showToast('Balance refreshed successfully!', 'success');
                }
            } catch (error) {
                showToast('Failed to refresh balance', 'error');
            }
            btn.classList.remove('spinning');
        };

        async function loadNotifications() {
            if (!currentUser) return;
            try {
                const response = await fetch(`${API_BASE}/api/notifications/${encodeURIComponent(currentUser.email)}`);
                const data = await response.json();
                if (data.success) {
                    renderNotifications(data.notifications);
                }
            } catch (error) {
                console.error('Failed to load notifications:', error);
            }
        }

        function renderNotifications(notifications) {
            const list = document.getElementById('notificationList');
            const unreadCount = notifications.filter(n => !n.is_read).length;
            document.getElementById('notifBadge').textContent = unreadCount;
            const notifBtn = document.querySelector('.notification-btn');
            if (unreadCount > 0) {
                notifBtn.classList.add('has-notification');
            } else {
                notifBtn.classList.remove('has-notification');
            }
            if (notifications.length === 0) {
                list.innerHTML = '<div class="empty-state" style="padding: 30px;"><i class="fas fa-bell-slash"></i><p>No notifications yet</p></div>';
                return;
            }
            list.innerHTML = notifications.map(n => `
                <div class="notification-item ${!n.is_read ? 'unread' : ''}" onclick="markNotificationRead('${n.id}')">
                    <h5>${n.title}</h5>
                    <p>${n.message}</p>
                    <div class="time">${new Date(n.created_at).toLocaleString()}</div>
                </div>
            `).join('');
        }

        window.markNotificationRead = async function(id) {
            try {
                await fetch(`${API_BASE}/api/notifications/${id}/read`, { method: 'PUT' });
                loadNotifications();
            } catch (error) {
                console.error('Failed to mark as read:', error);
            }
        };

        async function loadTransactions() {
            if (!currentUser) return;
            try {
                const response = await fetch(`${API_BASE}/api/transactions/${encodeURIComponent(currentUser.email)}`);
                const data = await response.json();
                if (data.success) {
                    renderTransactions(data.transactions);
                }
            } catch (error) {
                console.error('Failed to load transactions:', error);
            }
        }

        function renderTransactions(transactions) {
            const renderList = (containerId, limit = null) => {
                const container = document.getElementById(containerId);
                const txToShow = limit ? transactions.slice(0, limit) : transactions;
                if (txToShow.length === 0) {
                    container.innerHTML = '<div class="empty-state"><i class="fas fa-inbox"></i><h3>No transactions</h3><p>Your transactions will appear here</p></div>';
                    return;
                }
                container.innerHTML = txToShow.map(tx => {
                    let iconClass = tx.type === 'deposit' ? 'deposit' : 'airtime';
                    if (tx.status === 'failed' || tx.status === 'cancelled') iconClass = 'failed';
                    if (tx.status === 'pending') iconClass = 'pending';
                    const icon = tx.type === 'deposit' ? 'fa-arrow-down' : 'fa-mobile-alt';
                    
                    let statusClass = 'status-pending';
                    let statusLabel = tx.status;
                    if (tx.status === 'completed') {
                        statusClass = 'status-completed';
                        statusLabel = 'Completed';
                    } else if (tx.status === 'pending') {
                        statusClass = 'status-pending';
                        statusLabel = 'Pending';
                    } else if (tx.status === 'failed') {
                        statusClass = 'status-failed';
                        statusLabel = 'Failed';
                    } else if (tx.status === 'cancelled') {
                        statusClass = 'status-cancelled';
                        statusLabel = 'Cancelled';
                    }
                    
                    return `
                        <div class="transaction-item">
                            <div class="transaction-info">
                                <div class="transaction-icon ${iconClass}"><i class="fas ${icon}"></i></div>
                                <div class="transaction-details">
                                    <h4>${tx.type.charAt(0).toUpperCase() + tx.type.slice(1)}</h4>
                                    <p>${tx.phone || '-'} - ${new Date(tx.created_at).toLocaleDateString()}</p>
                                </div>
                            </div>
                            <div class="transaction-amount">
                                <div class="amount" style="color: ${tx.type === 'deposit' ? 'var(--success)' : 'var(--dark)'};">
                                    ${tx.type === 'deposit' ? '+' : '-'}KES ${tx.amount}
                                </div>
                                ${tx.bonus > 0 ? `<div class="bonus">+${tx.bonus} bonus</div>` : ''}
                                <span class="status ${statusClass}">${statusLabel}</span>
                            </div>
                        </div>
                    `;
                }).join('');
            };
            renderList('recentTransactions', 5);
            renderList('allTransactions');
        }

        window.showPage = function(pageId) {
            const protectedPages = ['deposit', 'buy-airtime', 'sell-airtime', 'airtime-to-cash', 'transactions', 'verify-deposit', 'settings', 'profile'];
            if (protectedPages.includes(pageId) && !currentUser) {
                showAuthModal();
                return;
            }
            if (pageId === 'sell-airtime') checkFloatStatus();
            if (pageId === 'deposit') startDepositRefresh();
            else stopDepositRefresh();
            if (pageId === 'admin' && adminLoggedIn) {
                loadAdminData();
                startAdminAutoRefresh();
            }
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(`page-${pageId}`).classList.add('active');
            document.querySelectorAll('.menu-item').forEach(m => m.classList.remove('active'));
            document.querySelector(`.menu-item[onclick*="${pageId}"]`)?.classList.add('active');
            closeSidebar();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        };

        window.toggleSidebar = function() {
            document.getElementById('sidebar').classList.toggle('open');
            document.querySelector('.sidebar-overlay').classList.toggle('show');
        };

        window.closeSidebar = function() {
            document.getElementById('sidebar').classList.remove('open');
            document.querySelector('.sidebar-overlay').classList.remove('show');
        };

        window.toggleNotifications = function() {
            document.getElementById('notificationPanel').classList.toggle('show');
        };

        window.showToast = function(message, type = 'info') {
            const toast = document.getElementById('toast');
            toast.className = `toast show ${type}`;
            document.getElementById('toastMessage').textContent = message;
            setTimeout(() => toast.classList.remove('show'), 4000);
        };

        window.closeModal = function(modalId) {
            document.getElementById(modalId).classList.remove('show');
        };

        function showAuthModal() {
            document.getElementById('authModal').classList.add('show');
        }

        // Network Selection and Validation for Buy Airtime
        let selectedNetworkValue = '';
        let selectedSendNetworkValue = '';

        window.selectNetwork = function(network) {
            // Remove selected class from Buy Airtime options only
            document.querySelectorAll('#buyAirtimeForm .network-option').forEach(opt => {
                opt.classList.remove('selected');
            });
            // Add selected class to clicked option
            document.querySelector(`#buyAirtimeForm .network-option[data-network="${network}"]`).classList.add('selected');
            selectedNetworkValue = network;
            document.getElementById('selectedNetwork').value = network;
            // Hide network error
            document.getElementById('networkError').classList.remove('show');
            // Validate form
            validateAirtimeForm();
        };

        // Network Selection and Validation for Send Airtime
        window.selectSendNetwork = function(network) {
            // Remove selected class from Send Airtime options only
            document.querySelectorAll('#sellAirtimeForm .network-option').forEach(opt => {
                opt.classList.remove('selected');
            });
            // Add selected class to clicked option
            document.querySelector(`#sellAirtimeForm .network-option[data-network="${network}"]`).classList.add('selected');
            selectedSendNetworkValue = network;
            document.getElementById('selectedSendNetwork').value = network;
            // Hide network error
            document.getElementById('sendNetworkError').classList.remove('show');
            // Validate form
            validateSendForm();
        };

        window.validateSendPhone = function() {
            const phoneInput = document.getElementById('sellAirtimePhone');
            const phoneError = document.getElementById('sendPhoneError');
            const phone = phoneInput.value.trim();
            
            const isValid = /^[71][0-9]{8}$/.test(phone);
            
            if (phone.length === 0) {
                phoneInput.classList.remove('valid', 'invalid');
                phoneError.classList.remove('show');
            } else if (isValid) {
                phoneInput.classList.remove('invalid');
                phoneInput.classList.add('valid');
                phoneError.classList.remove('show');
            } else {
                phoneInput.classList.remove('valid');
                phoneInput.classList.add('invalid');
                phoneError.classList.add('show');
            }
            validateSendForm();
            return isValid;
        };

        window.validateSendAmount = function() {
            const amountInput = document.getElementById('sellAirtimeAmount');
            const amountError = document.getElementById('sendAmountError');
            const amount = parseInt(amountInput.value) || 0;
            
            const isValid = amount >= 10;
            
            if (amountInput.value === '') {
                amountInput.classList.remove('valid', 'invalid');
                amountError.classList.remove('show');
            } else if (isValid) {
                amountInput.classList.remove('invalid');
                amountInput.classList.add('valid');
                amountError.classList.remove('show');
            } else {
                amountInput.classList.remove('valid');
                amountInput.classList.add('invalid');
                amountError.classList.add('show');
            }
            validateSendForm();
            return isValid;
        };

        function validateSendForm() {
            const network = document.getElementById('selectedSendNetwork').value;
            const phone = document.getElementById('sellAirtimePhone').value.trim();
            const amount = parseInt(document.getElementById('sellAirtimeAmount').value) || 0;
            
            const isNetworkSelected = network !== '';
            const isPhoneValid = /^[71][0-9]{8}$/.test(phone);
            const isAmountValid = amount >= 10;
            
            const isFormValid = isNetworkSelected && isPhoneValid && isAmountValid;
            
            // Enable/disable send buttons
            document.getElementById('sellAirtimeBalanceBtn').disabled = !isFormValid;
            
            return isFormValid;
        }

        window.validateAirtimePhone = function() {
            const phoneInput = document.getElementById('airtimePhone');
            const phoneError = document.getElementById('phoneError');
            const phone = phoneInput.value.trim();
            
            // Kenyan phone numbers start with 7 or 1 and have 9 digits
            const isValid = /^[71][0-9]{8}$/.test(phone);
            
            if (phone.length === 0) {
                phoneInput.classList.remove('valid', 'invalid');
                phoneError.classList.remove('show');
            } else if (isValid) {
                phoneInput.classList.remove('invalid');
                phoneInput.classList.add('valid');
                phoneError.classList.remove('show');
            } else {
                phoneInput.classList.remove('valid');
                phoneInput.classList.add('invalid');
                phoneError.classList.add('show');
            }
            validateAirtimeForm();
            return isValid;
        };

        window.validateAirtimeAmount = function() {
            const amountInput = document.getElementById('airtimeAmount');
            const amountError = document.getElementById('amountError');
            const amount = parseInt(amountInput.value) || 0;
            
            const isValid = amount >= 10;
            
            if (amountInput.value === '') {
                amountInput.classList.remove('valid', 'invalid');
                amountError.classList.remove('show');
            } else if (isValid) {
                amountInput.classList.remove('invalid');
                amountInput.classList.add('valid');
                amountError.classList.remove('show');
            } else {
                amountInput.classList.remove('valid');
                amountInput.classList.add('invalid');
                amountError.classList.add('show');
            }
            validateAirtimeForm();
            return isValid;
        };

        function validateAirtimeForm() {
            const network = document.getElementById('selectedNetwork').value;
            const phone = document.getElementById('airtimePhone').value.trim();
            const amount = parseInt(document.getElementById('airtimeAmount').value) || 0;
            
            const isNetworkSelected = network !== '';
            const isPhoneValid = /^[71][0-9]{8}$/.test(phone);
            const isAmountValid = amount >= 10;
            
            const isFormValid = isNetworkSelected && isPhoneValid && isAmountValid;
            
            // Enable/disable all buy buttons
            document.getElementById('buyAirtimeBtn').disabled = !isFormValid;
            document.getElementById('directPurchaseBtn').disabled = !isFormValid;
            
            return isFormValid;
        }

        // Override form submit to check network selection
        document.addEventListener('DOMContentLoaded', function() {
            const buyAirtimeForm = document.getElementById('buyAirtimeForm');
            if (buyAirtimeForm) {
                buyAirtimeForm.addEventListener('submit', function(e) {
                    if (!selectedNetworkValue) {
                        e.preventDefault();
                        document.getElementById('networkError').classList.add('show');
                        showToast('Please select a network first', 'error');
                        return false;
                    }
                    if (!validateAirtimeForm()) {
                        e.preventDefault();
                        showToast('Please fill all fields correctly', 'error');
                        return false;
                    }
                });
            }
        });

        function formatPhoneNumber(phone) {
            let cleaned = phone.replace(/\s+/g, '').replace(/[^0-9]/g, '');
            if (cleaned.startsWith('0')) {
                cleaned = '254' + cleaned.substring(1);
            } else if (cleaned.startsWith('+254')) {
                cleaned = cleaned.substring(1);
            } else if (!cleaned.startsWith('254')) {
                cleaned = '254' + cleaned;
            }
            return cleaned;
        }

        document.getElementById('depositForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!currentUser) { showAuthModal(); return; }
            
            const rawPhone = document.getElementById('depositPhone').value;
            const phone = formatPhoneNumber(rawPhone);
            const amount = parseInt(document.getElementById('depositAmount').value);
            
            lastDepositPhone = rawPhone;
            lastDepositAmount = amount;
            
            if (amount < 10) { 
                showToast('Minimum deposit is KES 10', 'error'); 
                return; 
            }
            
            if (phone.length !== 12) {
                showToast('Please enter a valid phone number', 'error');
                return;
            }
            
            const btn = document.getElementById('depositStkBtn');
            btn.disabled = true;
            btn.innerHTML = '<div class="spinner"></div> Sending STK Push...';
            showLoading('Sending STK Push to ' + phone.substring(0, 6) + '...');
            
            try {
                const response = await fetch(`${API_BASE}/api/payments/deposit`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email: currentUser.email, phone: phone, amount: amount })
                });
                const data = await response.json();
                
                hideLoading();
                
                if (data.success) {
                    currentDepositReference = data.reference;
                    showToast('STK Push sent! Enter your M-Pesa PIN.', 'success');
                    btn.innerHTML = '<div class="spinner"></div> Waiting for payment...';
                    pollDepositStatus(data.reference);
                } else {
                    showToast(data.message || 'Failed to send STK Push', 'error');
                    btn.disabled = false;
                    btn.innerHTML = '<i class="fas fa-mobile-alt"></i> Deposit via M-Pesa STK Push';
                }
            } catch (error) {
                hideLoading();
                showToast('Failed to initiate deposit. Please try again.', 'error');
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-mobile-alt"></i> Deposit via M-Pesa STK Push';
            }
        });

        let lastDepositPhone = '';
        let lastDepositAmount = 0;

        async function pollDepositStatus(reference) {
            let attempts = 0;
            const maxAttempts = 45;
            const btn = document.getElementById('depositStkBtn');
            const retryBtn = document.getElementById('retryDepositBtn');
            const statusDiv = document.getElementById('depositStatus');
            const statusText = document.getElementById('depositStatusText');
            
            statusDiv.style.display = 'block';
            statusText.textContent = 'Waiting for M-Pesa confirmation...';
            retryBtn.classList.remove('show');
            
            const poll = setInterval(async () => {
                attempts++;
                
                if (attempts > maxAttempts) {
                    clearInterval(poll);
                    showToast('Payment confirmation delayed. Your balance will update automatically once confirmed.', 'delay');
                    btn.disabled = false;
                    btn.innerHTML = '<i class="fas fa-mobile-alt"></i> Deposit via M-Pesa STK Push';
                    statusDiv.style.display = 'none';
                    retryBtn.classList.add('show');
                    silentRefreshBalance();
                    loadTransactions();
                    return;
                }
                
                statusText.textContent = `Checking payment status... (${attempts}/${maxAttempts})`;
                
                try {
                    const response = await fetch(`${API_BASE}/api/payments/status/${reference}`);
                    const data = await response.json();
                    
                    if (data.success && data.transaction.status === 'completed') {
                        clearInterval(poll);
                        statusDiv.style.display = 'none';
                        showToast('Deposit successful! Your balance has been updated.', 'success');
                        btn.disabled = false;
                        btn.innerHTML = '<i class="fas fa-mobile-alt"></i> Deposit via M-Pesa STK Push';
                        retryBtn.classList.remove('show');
                        await silentRefreshBalance();
                        await loadTransactions();
                        await loadNotifications();
                        document.getElementById('depositForm').reset();
                    } else if (data.success && data.transaction.status === 'failed') {
                        clearInterval(poll);
                        statusDiv.style.display = 'none';
                        showToast('Payment was cancelled. Please try again.', 'cancel');
                        btn.disabled = false;
                        btn.innerHTML = '<i class="fas fa-mobile-alt"></i> Deposit via M-Pesa STK Push';
                        retryBtn.classList.add('show');
                        silentRefreshBalance();
                        loadTransactions();
                    }
                } catch (error) {
                    console.error('Poll error:', error);
                }
            }, 2000);
        }

        window.retryDeposit = function() {
            if (lastDepositPhone && lastDepositAmount > 0) {
                document.getElementById('depositPhone').value = lastDepositPhone;
                document.getElementById('depositAmount').value = lastDepositAmount;
            }
            document.getElementById('retryDepositBtn').classList.remove('show');
            document.getElementById('depositForm').dispatchEvent(new Event('submit'));
        };

        window.depositWithLink = function() {
            const rawPhone = document.getElementById('depositPhone').value;
            const amount = document.getElementById('depositAmount').value;
            const email = currentUser?.email || 'Guest';
            
            if (!rawPhone || !amount) { 
                showToast('Please enter phone number and amount', 'error'); 
                return; 
            }
            
            const phone = formatPhoneNumber(rawPhone);
            const url = `https://short.payhero.co.ke/s/oEvAxA8Xx6cDoBLxntShmF?phone=${phone}&customer_name=${encodeURIComponent(email)}&amount=${amount}&reference=${encodeURIComponent('#airtime deposit')}`;
            window.open(url, '_blank');
        };

        document.getElementById('buyAirtimeForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!currentUser) { showAuthModal(); return; }
            if (!selectedNetworkValue) { 
                document.getElementById('networkError').classList.add('show');
                showToast('Please select a network first', 'error'); 
                return; 
            }
            const phone = '254' + document.getElementById('airtimePhone').value;
            const amount = parseInt(document.getElementById('airtimeAmount').value);
            if (amount < 10) { showToast('Minimum airtime is KES 10', 'error'); return; }
            const btn = document.getElementById('buyAirtimeBtn');
            btn.disabled = true;
            btn.innerHTML = '<div class="spinner"></div> Processing...';
            showBalanceOverlay();
            try {
                const response = await fetch(`${API_BASE}/api/airtime/buy`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email: currentUser.email, phone: phone, amount: amount })
                });
                const data = await response.json();
                hideBalanceOverlay();
                if (data.success) {
                    showToast(`Airtime sent! KES ${data.airtimeSent} to ${phone}`, 'success');
                    refreshBalance();
                    loadTransactions();
                } else if (data.shortfall) {
                    pendingPurchase = { phone, amount };
                    document.getElementById('shortfallAmount').textContent = `KES ${data.shortfall}`;
                    document.getElementById('modalDepositAmount').value = Math.ceil(data.shortfall);
                    document.getElementById('modalDepositPhone').value = document.getElementById('airtimePhone').value;
                    document.getElementById('insufficientModal').classList.add('show');
                } else {
                    showToast(data.message || 'Purchase failed', 'error');
                }
            } catch (error) {
                hideBalanceOverlay();
                showToast('Failed to buy airtime check balance or contact us', 'error');
            }
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-shopping-cart"></i> Buy Now (From your account balance)';
        });

        window.directAirtimePurchase = async function() {
            if (!selectedNetworkValue) { showToast('Please select a network first', 'error'); return; }
            const phone = document.getElementById('airtimePhone').value;
            const amount = document.getElementById('airtimeAmount').value;
            if (!phone || !amount) { showToast('Please enter phone number and amount', 'error'); return; }
            if (parseInt(amount) < 10) { showToast('Minimum airtime is KES 10', 'error'); return; }
            try {
                const response = await fetch(`${API_BASE}/api/airtime/direct`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ phone_to_receive: '254' + phone, phone_to_pay: '254' + phone, amount: parseInt(amount) })
                });
                const data = await response.json();
                if (data.success) {
                    showToast(`STK Push sent! You'll receive KES ${data.airtime_to_receive} airtime after payment.`, 'success');
                } else {
                    showToast(data.message || 'Failed', 'error');
                }
            } catch (error) {
                showToast('Failed to initiate purchase', 'error');
            }
        };

        window.buyAirtimeWithLink = function() {
            if (!selectedNetworkValue) { showToast('Please select a network first', 'error'); return; }
            const phone = document.getElementById('airtimePhone').value;
            const amount = document.getElementById('airtimeAmount').value;
            const email = currentUser?.email || 'Guest';
            if (!phone || !amount) { showToast('Please enter phone number and amount', 'error'); return; }
            if (parseInt(amount) < 10) { showToast('Minimum airtime is KES 10', 'error'); return; }
            const url = `https://short.payhero.co.ke/s/oEvAxA8Xx6cDoBLxntShmF?phone=254${phone}&customer_name=${encodeURIComponent(email)}&amount=${amount}&reference=${encodeURIComponent('#airtime purchase')}`;
            window.open(url, '_blank');
        };

        let floatAvailable = true;

        async function checkFloatStatus() {
            try {
                const response = await fetch(`${API_BASE}/api/airtime/float-status`);
                const data = await response.json();
                if (data.success) {
                    floatAvailable = !data.floatLow;
                    const statusDiv = document.getElementById('statumFloatStatus');
                    if (floatAvailable) {
                        statusDiv.innerHTML = `<p style="color: var(--success);"><i class="fas fa-check-circle"></i> Airtime service is available</p>`;
                    } else {
                        statusDiv.innerHTML = `<div style="background: linear-gradient(135deg, #fff3cd, #ffeeba); border: 1px solid #ffc107; border-radius: 12px; padding: 15px; margin-bottom: 15px;">
                            <p style="color: #856404; font-weight: 600; margin-bottom: 8px;"><i class="fas fa-exclamation-triangle"></i> Low Float Balance</p>
                            <p style="color: #856404; font-size: 0.9rem;">Our airtime float is currently low. The service will resume once the admin tops up the float. Please try again in a few minutes.</p>
                        </div>`;
                    }
                }
            } catch (error) {
                console.error('Float check error:', error);
            }
        }

        document.getElementById('sellAirtimeForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!currentUser) { showAuthModal(); return; }
            if (!selectedSendNetworkValue) { 
                document.getElementById('sendNetworkError').classList.add('show');
                showToast('Please select a network first', 'error'); 
                return; 
            }
            const phone = '254' + document.getElementById('sellAirtimePhone').value;
            const amount = parseInt(document.getElementById('sellAirtimeAmount').value);
            if (amount < 10) { showToast('Minimum airtime is KES 10', 'error'); return; }
            const btn = document.getElementById('sellAirtimeBalanceBtn');
            btn.disabled = true;
            btn.innerHTML = '<div class="spinner"></div> Processing...';
            showBalanceOverlay();
            try {
                const response = await fetch(`${API_BASE}/api/airtime/buy`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email: currentUser.email, phone: phone, amount: amount })
                });
                const data = await response.json();
                hideBalanceOverlay();
                if (data.success) {
                    let msg = `Airtime sold! KES ${data.airtimeSent || amount} to ${phone}`;
                    if (data.commission > 0) {
                        msg += `. You earned KES ${data.commission} commission!`;
                    }
                    showToast(msg, 'success');
                    refreshBalance();
                    loadTransactions();
                    document.getElementById('sellAirtimeForm').reset();
                    selectedSendNetworkValue = '';
                    document.querySelectorAll('.network-option[data-form="send"]').forEach(opt => opt.classList.remove('selected'));
                } else if (data.errorType === 'insufficient_balance' || data.shortfall) {
                    document.getElementById('insufficientShortfall').textContent = data.shortfall || (amount - (data.balance || 0));
                    document.getElementById('modalDepositAmount').value = Math.ceil(data.shortfall || (amount - (data.balance || 0)));
                    showModal('insufficientModal');
                } else {
                    showToast(data.message || 'Failed to sell airtime Reason:insufficient balance', 'error');
                }
            } catch (error) {
                hideBalanceOverlay();
                showToast('Failed to sell airtime Reason:insufficient balance', 'error');
            }
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-wallet"></i> Sell from Balance';
        });

        window.sellAirtimeWithStk = function() {
            if (!selectedSendNetworkValue) { showToast('Please select a network first', 'error'); return; }
            const phone = document.getElementById('sellAirtimePhone').value;
            const amount = document.getElementById('sellAirtimeAmount').value;
            const email = currentUser?.email || 'Guest';
            if (!phone || !amount) { showToast('Please enter phone number and amount', 'error'); return; }
            if (parseInt(amount) < 10) { showToast('Minimum airtime is KES 10', 'error'); return; }
            if (!floatAvailable) { showToast('Airtime service temporarily unavailable.', 'error'); return; }
            const url = `https://short.payhero.co.ke/s/oEvAxA8Xx6cDoBLxntShmF?phone=254${phone}&customer_name=${encodeURIComponent(email)}&amount=${amount}&reference=${encodeURIComponent('#airtime purchase')}`;
            window.open(url, '_blank');
        };

        window.depositFromModal = async function() {
            const phone = '254' + document.getElementById('modalDepositPhone').value;
            const amount = parseInt(document.getElementById('modalDepositAmount').value);
            const btn = document.querySelector('#insufficientModal .btn-primary');
            const originalBtnHtml = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<div class="spinner"></div> Sending STK Push...';
            
            try {
                const response = await fetch(`${API_BASE}/api/payments/deposit`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email: currentUser.email, phone: phone, amount: amount })
                });
                const data = await response.json();
                if (data.success) {
                    showToast('STK Push sent! Enter your M-Pesa PIN to complete.', 'success');
                    closeModal('insufficientModal');
                    pollDepositStatus(data.reference);
                } else {
                    showToast(data.message || 'Failed', 'error');
                    btn.disabled = false;
                    btn.innerHTML = originalBtnHtml;
                }
            } catch (error) {
                showToast('Failed to initiate deposit', 'error');
                btn.disabled = false;
                btn.innerHTML = originalBtnHtml;
            }
        };

        window.depositFromModalLink = function() {
            const phone = document.getElementById('modalDepositPhone').value;
            const amount = document.getElementById('modalDepositAmount').value;
            const email = currentUser?.email || 'Guest';
            const url = `https://short.payhero.co.ke/s/oEvAxA8Xx6cDoBLxntShmF?phone=254${phone}&customer_name=${encodeURIComponent(email)}&amount=${amount}&reference=${encodeURIComponent('#airtime deposit')}`;
            window.open(url, '_blank');
            closeModal('insufficientModal');
        };

        document.getElementById('airtimeToCashForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const amount = document.getElementById('a2cAmount').value;
            const phone = document.getElementById('a2cPhone').value;
            document.getElementById('dialCode').textContent = `*140*${amount}*0718369524#`;
            document.getElementById('dialCodeSection').style.display = 'block';
            document.getElementById('sambazaBtn').style.display = 'none';
            document.getElementById('doneBtn').style.display = 'block';
            localStorage.setItem('a2cPhone', '254' + phone);
            localStorage.setItem('a2cAmount', amount);
        });

        window.showVerifyA2C = function() {
            document.getElementById('verifyA2CPhone').value = localStorage.getItem('a2cPhone');
            showPage('verify-a2c');
        };

        document.getElementById('verifyA2CForm')?.addEventListener('submit', async (e) => {
            e.preventDefault();
            const phone = document.getElementById('verifyA2CPhone').value;
            const code = document.getElementById('verifyA2CCode').value;
            const whatsappUrl = `https://wa.me/254718369524?text=${encodeURIComponent(`Verification: ${code} from ${phone}`)}`;
            window.open(whatsappUrl, '_blank');
            showToast('Verification sent to WhatsApp. You will receive your cashback within 24 hours.', 'success');
        });

        document.getElementById('verifyDepositForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!currentUser) { showAuthModal(); return; }
            const mpesaCode = document.getElementById('mpesaCode').value.trim();
            const btn = document.getElementById('verifyDepositBtn');
            btn.disabled = true;
            btn.innerHTML = '<div class="spinner"></div> Verifying...';
            try {
                const response = await fetch(`${API_BASE}/api/payments/verify-deposit`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email: currentUser.email, mpesa_code: mpesaCode })
                });
                const data = await response.json();
                if (data.success) {
                    showToast(data.message, 'success');
                    refreshBalance();
                    loadTransactions();
                } else {
                    showToast(data.message || 'Verification failed', 'error');
                }
            } catch (error) {
                showToast('Verification failed', 'error');
            }
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-search"></i> Verify Deposit';
        });

        window.downloadTransactionsPDF = function() {
            if (!currentUser) { showAuthModal(); return; }
            window.open(`${API_BASE}/api/transactions/${encodeURIComponent(currentUser.email)}/pdf`, '_blank');
        };

        document.getElementById('profileForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const phone = '254' + document.getElementById('profilePhone').value;
            localStorage.setItem('userPhone', phone);
            showToast('Profile saved locally!', 'success');
        });

        // Translation object for English and Kiswahili
        const translations = {
            en: {
                yourBalance: 'Your Balance',
                deposit: 'Deposit',
                buyAirtime: 'Buy Airtime',
                sendAirtime: 'Send Airtime',
                airtimeToCash: 'Airtime to Cash',
                history: 'History',
                whyChooseUs: 'Why Choose Us',
                faq: 'Frequently Asked Questions',
                recentTransactions: 'Recent Transactions',
                dashboard: 'Dashboard',
                transactions: 'Transactions',
                settings: 'Settings',
                aboutUs: 'About Us',
                contactUs: 'Contact Us',
                privacyPolicy: 'Privacy Policy',
                termsOfService: 'Terms of Service',
                logout: 'Logout'
            },
            sw: {
                yourBalance: 'Salio Lako',
                deposit: 'Weka Pesa',
                buyAirtime: 'Nunua Airtime',
                sendAirtime: 'Tuma Airtime',
                airtimeToCash: 'Airtime kwa Pesa',
                history: 'Historia',
                whyChooseUs: 'Kwa Nini Uchague Sisi',
                faq: 'Maswali Yanayoulizwa Mara Kwa Mara',
                recentTransactions: 'Miamala ya Hivi Karibuni',
                dashboard: 'Dashibodi',
                transactions: 'Miamala',
                settings: 'Mipangilio',
                aboutUs: 'Kuhusu Sisi',
                contactUs: 'Wasiliana Nasi',
                privacyPolicy: 'Sera ya Faragha',
                termsOfService: 'Masharti ya Huduma',
                logout: 'Ondoka'
            }
        };

        window.changeLanguage = function(lang) {
            localStorage.setItem('language', lang);
            const trans = translations[lang] || translations.en;
            
            // Update all elements with data-translate attribute
            document.querySelectorAll('[data-translate]').forEach(el => {
                const key = el.getAttribute('data-translate');
                if (trans[key]) {
                    el.textContent = trans[key];
                }
            });
            
            showToast(lang === 'sw' ? 'Lugha imebadilishwa kuwa Kiswahili' : 'Language changed to English', 'success');
        };

        // Profile Phone Validation
        let profilePhoneCheckTimeout = null;

        window.validateProfilePhone = function() {
            const phoneInput = document.getElementById('profilePhone');
            const phoneError = document.getElementById('profilePhoneError');
            const duplicateError = document.getElementById('profilePhoneDuplicateError');
            const phone = phoneInput.value.trim();
            
            // Hide duplicate error initially
            duplicateError.classList.remove('show');
            
            // Basic format validation
            const isValid = /^[71][0-9]{8}$/.test(phone);
            
            if (phone.length === 0) {
                phoneInput.classList.remove('valid', 'invalid');
                phoneError.classList.remove('show');
            } else if (isValid) {
                phoneInput.classList.remove('invalid');
                phoneInput.classList.add('valid');
                phoneError.classList.remove('show');
                
                // Check for duplicate phone in database
                clearTimeout(profilePhoneCheckTimeout);
                profilePhoneCheckTimeout = setTimeout(async () => {
                    try {
                        const response = await fetch(`${API_BASE}/api/users/check-phone/254${phone}`);
                        const data = await response.json();
                        if (data.exists && data.email !== currentUser?.email) {
                            duplicateError.classList.add('show');
                            phoneInput.classList.remove('valid');
                            phoneInput.classList.add('invalid');
                        }
                    } catch (error) {
                        console.log('Phone check error:', error);
                    }
                }, 500);
            } else {
                phoneInput.classList.remove('valid');
                phoneInput.classList.add('invalid');
                phoneError.classList.add('show');
            }
            return isValid;
        };

        window.changeTheme = function(theme) {
            document.documentElement.setAttribute('data-theme', theme);
            localStorage.setItem('theme', theme);
        };

        window.acceptCookies = function() {
            localStorage.setItem('cookiesAccepted', 'all');
            showToast('Cookie preferences saved', 'success');
        };

        window.rejectCookies = function() {
            localStorage.setItem('cookiesAccepted', 'essential');
            showToast('Essential cookies only', 'info');
        };

        window.logout = async function() {
            try {
                await signOut(auth);
            } catch (e) {}
            localStorage.removeItem('userEmail');
            localStorage.removeItem('firebaseUid');
            localStorage.removeItem('cachedBalance');
            window.location.href = 'login.html';
        };

        document.getElementById('adminLoginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const password = document.getElementById('adminPassword').value;
            const btn = document.getElementById('adminLoginBtn');
            btn.disabled = true;
            btn.innerHTML = '<div class="spinner"></div> Logging in...';
            try {
                const response = await fetch(`${API_BASE}/api/admin/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ password })
                });
                const data = await response.json();
                if (data.success) {
                    adminLoggedIn = true;
                    document.getElementById('adminLogin').style.display = 'none';
                    document.getElementById('adminDashboard').style.display = 'block';
                    loadAdminData();
                    startAdminAutoRefresh();
                } else {
                    showToast(data.message || 'Login failed', 'error');
                }
            } catch (error) {
                showToast('Login failed', 'error');
            }
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-sign-in-alt"></i> Login';
        });

        let adminRefreshInterval = null;

        function startAdminAutoRefresh() {
            if (adminRefreshInterval) clearInterval(adminRefreshInterval);
            adminRefreshInterval = setInterval(() => {
                if (adminLoggedIn) loadAdminData();
            }, 10000);
        }

        async function loadAdminData() {
            try {
                const [statsRes, usersRes, txRes, verRes, depositStatusRes, floatStatusRes] = await Promise.all([
                    fetch(`${API_BASE}/api/admin/stats`, { credentials: 'include' }),
                    fetch(`${API_BASE}/api/admin/users`, { credentials: 'include' }),
                    fetch(`${API_BASE}/api/admin/transactions`, { credentials: 'include' }),
                    fetch(`${API_BASE}/api/admin/verifications`, { credentials: 'include' }),
                    fetch(`${API_BASE}/api/settings/deposit-status`, { credentials: 'include' }),
                    fetch(`${API_BASE}/api/settings/float-status`, { credentials: 'include' })
                ]);
                const stats = await statsRes.json();
                const users = await usersRes.json();
                const tx = await txRes.json();
                const ver = await verRes.json();
                const depositStatus = await depositStatusRes.json();
                const floatStatus = await floatStatusRes.json();
                if (stats.success) {
                    document.getElementById('statTotalUsers').textContent = stats.stats.totalUsers;
                    document.getElementById('statTotalDeposits').textContent = `KES ${stats.stats.totalDeposits}`;
                    document.getElementById('statTotalAirtime').textContent = `KES ${stats.stats.totalAirtime}`;
                    document.getElementById('statPendingVerifications').textContent = stats.stats.pendingVerifications;
                }
                if (users.success) renderAdminUsers(users.users);
                if (tx.success) renderAdminTransactions(tx.transactions);
                if (ver.success) renderAdminVerifications(ver.verifications);
                if (depositStatus.success) {
                    document.getElementById('depositStatusSelect').value = depositStatus.depositDisabled ? 'true' : 'false';
                }
                if (floatStatus.success) {
                    document.getElementById('floatStatusSelect').value = floatStatus.floatLow ? 'true' : 'false';
                }
            } catch (error) {
                console.error('Failed to load admin data:', error);
            }
        }

        function renderAdminUsers(users) {
            const tbody = document.querySelector('#usersTable tbody');
            tbody.innerHTML = users.map(u => `
                <tr>
                    <td>${u.email}</td>
                    <td>KES ${parseFloat(u.balance).toFixed(2)}</td>
                    <td>KES ${parseFloat(u.bonus_balance).toFixed(2)}</td>
                    <td><span class="status ${u.is_disabled ? 'status-failed' : 'status-completed'}">${u.is_disabled ? 'Disabled' : 'Active'}</span></td>
                    <td>${new Date(u.created_at).toLocaleDateString()}</td>
                    <td>
                        <button class="btn btn-outline" style="width: auto; padding: 5px 10px; font-size: 0.8rem;" onclick="toggleUserStatus('${u.id}')">${u.is_disabled ? 'Enable' : 'Disable'}</button>
                        <button class="btn btn-primary" style="width: auto; padding: 5px 10px; font-size: 0.8rem;" onclick="showAdjustBalance('${u.id}', '${u.email}')">Adjust</button>
                    </td>
                </tr>
            `).join('');
            const select = document.getElementById('notifRecipient');
            select.innerHTML = '<option value="">All Users</option>' + users.map(u => `<option value="${u.id}">${u.email}</option>`).join('');
        }

        function renderAdminTransactions(transactions) {
            const tbody = document.querySelector('#adminTxTable tbody');
            tbody.innerHTML = transactions.slice(0, 100).map(t => `
                <tr>
                    <td>${t.email || '-'}</td>
                    <td>${t.type}</td>
                    <td>KES ${t.amount}</td>
                    <td>${t.phone || '-'}</td>
                    <td><span class="status status-${t.status === 'completed' ? 'completed' : t.status === 'pending' ? 'pending' : 'failed'}">${t.status}</span></td>
                    <td>${new Date(t.created_at).toLocaleString()}</td>
                </tr>
            `).join('');
        }

        function renderAdminVerifications(verifications) {
            const tbody = document.querySelector('#verificationsTable tbody');
            tbody.innerHTML = verifications.map(v => `
                <tr>
                    <td>${v.email || '-'}</td>
                    <td>${v.mpesa_code}</td>
                    <td>KES ${v.amount_claimed || 0}</td>
                    <td><span class="status status-${v.status === 'validated' ? 'completed' : v.status === 'pending' ? 'pending' : 'failed'}">${v.status}</span></td>
                    <td>
                        ${v.status === 'pending' ? `
                            <button class="btn btn-primary" style="width: auto; padding: 5px 10px; font-size: 0.8rem;" onclick="approveVerification('${v.id}', ${v.amount_claimed || 0})">Approve</button>
                            <button class="btn btn-outline" style="width: auto; padding: 5px 10px; font-size: 0.8rem;" onclick="rejectVerification('${v.id}')">Reject</button>
                        ` : '-'}
                    </td>
                </tr>
            `).join('');
        }

        window.showAdminTab = function(tab) {
            document.querySelectorAll('.admin-tab').forEach(t => t.classList.remove('active'));
            document.querySelector(`.admin-tab[onclick*="${tab}"]`).classList.add('active');
            ['users', 'transactions', 'verifications', 'notifications', 'settings'].forEach(t => {
                document.getElementById(`adminTab${t.charAt(0).toUpperCase() + t.slice(1)}`).style.display = t === tab ? 'block' : 'none';
            });
        };

        window.toggleUserStatus = async function(userId) {
            try {
                await fetch(`${API_BASE}/api/admin/users/${userId}/toggle`, { method: 'PUT', credentials: 'include' });
                loadAdminData();
                showToast('User status updated', 'success');
            } catch (error) {
                showToast('Failed to update user', 'error');
            }
        };

        window.showAdjustBalance = function(userId, email) {
            const amount = prompt(`Enter amount to add/subtract for ${email}:`);
            if (amount === null) return;
            const type = parseFloat(amount) >= 0 ? 'add' : 'deduct';
            adjustBalance(userId, Math.abs(parseFloat(amount)), type);
        };

        async function adjustBalance(userId, amount, type) {
            try {
                await fetch(`${API_BASE}/api/admin/users/${userId}/balance`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ amount, type })
                });
                loadAdminData();
                showToast('Balance adjusted', 'success');
            } catch (error) {
                showToast('Failed to adjust balance', 'error');
            }
        }

        window.approveVerification = async function(id, amount) {
            const finalAmount = prompt('Enter amount to credit:', amount);
            if (finalAmount === null) return;
            try {
                await fetch(`${API_BASE}/api/admin/verifications/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ status: 'validated', amount: parseFloat(finalAmount) })
                });
                loadAdminData();
                showToast('Verification approved', 'success');
            } catch (error) {
                showToast('Failed to approve', 'error');
            }
        };

        window.rejectVerification = async function(id) {
            try {
                await fetch(`${API_BASE}/api/admin/verifications/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ status: 'rejected', amount: 0 })
                });
                loadAdminData();
                showToast('Verification rejected', 'success');
            } catch (error) {
                showToast('Failed to reject', 'error');
            }
        };

        window.updateFloatStatus = async function(isLow) {
            try {
                await fetch(`${API_BASE}/api/admin/float-status`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ isLow: isLow === 'true' })
                });
                showToast('Float status updated', 'success');
            } catch (error) {
                showToast('Failed to update', 'error');
            }
        };

        window.updateDepositStatus = async function(isDisabled) {
            try {
                await fetch(`${API_BASE}/api/admin/deposit-status`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ isDisabled: isDisabled === 'true' })
                });
                showToast('Deposit status updated', 'success');
            } catch (error) {
                showToast('Failed to update', 'error');
            }
        };

        document.getElementById('adminNotificationForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const userId = document.getElementById('notifRecipient').value || null;
            const title = document.getElementById('notifTitle').value;
            const message = document.getElementById('notifMessage').value;
            try {
                await fetch(`${API_BASE}/api/admin/notifications`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ userId, title, message })
                });
                showToast('Notification sent!', 'success');
                document.getElementById('adminNotificationForm').reset();
            } catch (error) {
                showToast('Failed to send notification', 'error');
            }
        });

        window.logoutAdmin = async function() {
            try {
                await fetch(`${API_BASE}/api/admin/logout`, { method: 'POST', credentials: 'include' });
            } catch (e) {}
            adminLoggedIn = false;
            if (adminRefreshInterval) clearInterval(adminRefreshInterval);
            document.getElementById('adminLogin').style.display = 'block';
            document.getElementById('adminDashboard').style.display = 'none';
            showToast('Admin logged out', 'info');
        };

        const savedTheme = localStorage.getItem('theme');
        if (savedTheme) {
            document.documentElement.setAttribute('data-theme', savedTheme);
            document.getElementById('themeSelect').value = savedTheme;
        }

        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            document.getElementById('pwaInstall').classList.add('show');
        });

        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/service-worker.js')
                    .then((registration) => {
                        console.log('ServiceWorker registered:', registration.scope);
                    })
                    .catch((error) => {
                        console.log('ServiceWorker registration failed:', error);
                    });
            });
        }

        window.installPWA = async function() {
            if (!deferredPrompt) {
                showToast('Open in Chrome/Edge browser to install app, or add to home screen from browser menu', 'info');
                return;
            }
            deferredPrompt.prompt();
            const { outcome } = await deferredPrompt.userChoice;
            if (outcome === 'accepted') {
                showToast('App installed successfully!', 'success');
                document.getElementById('pwaInstall').style.display = 'none';
            }
            deferredPrompt = null;
        };

        // ===== DIRECT BUY AIRTIME FUNCTIONS =====
        let directBuyPollingInterval = null;
        let selectedDirectNetworkValue = '';

        window.scrollToDirectBuy = function() {
            showPage('dashboard');
            setTimeout(() => {
                const directBuySection = document.getElementById('directBuySection');
                if (directBuySection) {
                    directBuySection.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    directBuySection.style.animation = 'pulse 0.5s ease-in-out 2';
                }
            }, 100);
        };

        window.validateDirectPhone = function() {
            const phone = document.getElementById('directBuyPhone').value;
            const error = document.getElementById('directPhoneError');
            const isValid = /^[71]\d{8}$/.test(phone);
            error.style.display = isValid || phone.length === 0 ? 'none' : 'block';
            updateDirectBuyButton();
            return isValid;
        };

        window.validateDirectPayPhone = function() {
            const phone = document.getElementById('directPayPhone').value;
            const error = document.getElementById('directPayPhoneError');
            const isValid = /^[71]\d{8}$/.test(phone);
            error.style.display = isValid || phone.length === 0 ? 'none' : 'block';
            updateDirectBuyButton();
            return isValid;
        };

        window.validateDirectAmount = function() {
            const amount = parseFloat(document.getElementById('directBuyAmount').value);
            const error = document.getElementById('directAmountError');
            const isValid = amount >= 10;
            error.style.display = isValid || isNaN(amount) ? 'none' : 'block';
            updateDirectBuyButton();
            return isValid;
        };

        window.selectDirectNetwork = function(network) {
            selectedDirectNetworkValue = network;
            document.getElementById('selectedDirectNetwork').value = network;
            document.getElementById('directNetworkError').style.display = 'none';
            
            document.querySelectorAll('#directNetworkSelector .network-option').forEach(opt => {
                opt.classList.remove('selected');
            });
            document.querySelector(`#directNetworkSelector .network-option[data-network="${network}"]`).classList.add('selected');
            updateDirectBuyButton();
        };

        function updateDirectBuyButton() {
            const phone = document.getElementById('directBuyPhone').value;
            const payPhone = document.getElementById('directPayPhone').value;
            const amount = parseFloat(document.getElementById('directBuyAmount').value);
            const network = document.getElementById('selectedDirectNetwork').value;
            
            const phoneValid = /^[71]\d{8}$/.test(phone);
            const payPhoneValid = /^[71]\d{8}$/.test(payPhone);
            const amountValid = amount >= 10;
            const networkValid = network !== '';
            
            document.getElementById('directBuyBtn').disabled = !(phoneValid && payPhoneValid && amountValid && networkValid);
        }

        window.initiateDirectBuy = async function() {
            const phone = document.getElementById('directBuyPhone').value;
            const payPhone = document.getElementById('directPayPhone').value;
            const amount = parseFloat(document.getElementById('directBuyAmount').value);
            const network = document.getElementById('selectedDirectNetwork').value;
            
            if (!validateDirectPhone() || !validateDirectPayPhone() || !validateDirectAmount()) {
                showToast('Please fill all fields correctly', 'error');
                return;
            }
            
            if (!network) {
                document.getElementById('directNetworkError').style.display = 'block';
                showToast('Please select a network', 'error');
                return;
            }
            
            const btn = document.getElementById('directBuyBtn');
            const statusDiv = document.getElementById('directBuyStatus');
            const statusText = document.getElementById('directBuyStatusText');
            
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner"></span> Sending STK Push...';
            statusDiv.style.display = 'block';
            statusText.textContent = 'Initiating payment...';
            
            try {
                const response = await fetch(`${API_BASE}/api/airtime/direct`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        phone_to_receive: `254${phone}`,
                        phone_to_pay: `254${payPhone}`,
                        amount: amount,
                        network: network
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showToast('STK Push sent! Enter your M-Pesa PIN', 'success');
                    statusText.textContent = 'Waiting for M-Pesa payment...';
                    pollDirectBuyStatus(data.reference, phone, amount, network);
                } else {
                    throw new Error(data.message || 'Failed to initiate purchase');
                }
            } catch (error) {
                console.error('Direct buy error:', error);
                showToast(error.message || 'Failed to initiate purchase', 'error');
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-bolt"></i> Buy Now via M-Pesa';
                statusDiv.style.display = 'none';
            }
        };

        function pollDirectBuyStatus(reference, phone, amount, network) {
            let attempts = 0;
            const maxAttempts = 60;
            const statusText = document.getElementById('directBuyStatusText');
            const btn = document.getElementById('directBuyBtn');
            const statusDiv = document.getElementById('directBuyStatus');
            
            if (directBuyPollingInterval) clearInterval(directBuyPollingInterval);
            
            directBuyPollingInterval = setInterval(async () => {
                attempts++;
                
                if (attempts > maxAttempts) {
                    clearInterval(directBuyPollingInterval);
                    statusDiv.style.display = 'none';
                    btn.disabled = false;
                    btn.innerHTML = '<i class="fas fa-bolt"></i> Buy Now via M-Pesa';
                    showDirectBuyReceipt('timeout', phone, amount, network, reference, 'Payment timed out. Please try again.');
                    return;
                }
                
                try {
                    const response = await fetch(`${API_BASE}/api/airtime/direct/status/${reference}`);
                    const data = await response.json();
                    
                    if (data.status === 'completed') {
                        clearInterval(directBuyPollingInterval);
                        statusDiv.style.display = 'none';
                        btn.disabled = false;
                        btn.innerHTML = '<i class="fas fa-bolt"></i> Buy Now via M-Pesa';
                        showDirectBuyReceipt('success', phone, amount, network, data.transaction_id || reference, 'Airtime sent successfully!');
                        saveDirectBuyHistory({ phone, amount, network, reference, status: 'completed', date: new Date().toISOString() });
                        document.getElementById('directBuyForm').reset();
                        selectedDirectNetworkValue = '';
                        document.querySelectorAll('#directNetworkSelector .network-option').forEach(opt => opt.classList.remove('selected'));
                    } else if (data.status === 'failed') {
                        clearInterval(directBuyPollingInterval);
                        statusDiv.style.display = 'none';
                        btn.disabled = false;
                        btn.innerHTML = '<i class="fas fa-bolt"></i> Buy Now via M-Pesa';
                        showDirectBuyReceipt('failed', phone, amount, network, reference, data.message || 'Payment failed. Please try again.');
                    } else {
                        statusText.textContent = `Waiting for payment... (${attempts}s)`;
                    }
                } catch (error) {
                    console.error('Polling error:', error);
                }
            }, 2000);
        }

        function showDirectBuyReceipt(status, phone, amount, network, txId, message) {
            const iconEl = document.getElementById('receiptIcon');
            const statusEl = document.getElementById('receiptStatus');
            
            if (status === 'success') {
                iconEl.innerHTML = '<i class="fas fa-check-circle" style="color: var(--success);"></i>';
                statusEl.textContent = 'Transaction Successful!';
                statusEl.style.color = 'var(--success)';
            } else if (status === 'failed') {
                iconEl.innerHTML = '<i class="fas fa-times-circle" style="color: var(--danger);"></i>';
                statusEl.textContent = 'Transaction Failed';
                statusEl.style.color = 'var(--danger)';
            } else {
                iconEl.innerHTML = '<i class="fas fa-clock" style="color: var(--warning);"></i>';
                statusEl.textContent = 'Transaction Timed Out';
                statusEl.style.color = 'var(--warning)';
            }
            
            document.getElementById('receiptPhone').textContent = '+254' + phone;
            document.getElementById('receiptAmount').textContent = 'KES ' + amount;
            document.getElementById('receiptNetwork').textContent = network.charAt(0).toUpperCase() + network.slice(1);
            document.getElementById('receiptTxId').textContent = txId;
            document.getElementById('receiptDate').textContent = new Date().toLocaleString();
            document.getElementById('receiptMessage').textContent = message;
            
            document.getElementById('directBuyReceiptModal').classList.add('show');
        }

        function saveDirectBuyHistory(purchase) {
            try {
                const storageValue = localStorage.getItem('directBuyHistory');
                let history = [];
                if (storageValue) {
                    try {
                        history = JSON.parse(storageValue);
                    } catch (parseError) {
                        history = [];
                    }
                }
                if (!Array.isArray(history)) history = [];
                history.unshift(purchase);
                if (history.length > 20) history = history.slice(0, 20);
                localStorage.setItem('directBuyHistory', JSON.stringify(history));
            } catch (e) {
                console.error('Failed to save history:', e);
            }
        }

        window.goToDirectBuyFromBuyPage = function() {
            const phone = document.getElementById('airtimePhone').value;
            const amount = document.getElementById('airtimeAmount').value;
            const network = document.getElementById('selectedNetwork').value;
            
            scrollToDirectBuy();
            
            setTimeout(() => {
                if (phone) document.getElementById('directBuyPhone').value = phone;
                if (amount) document.getElementById('directBuyAmount').value = amount;
                if (network) selectDirectNetwork(network);
                validateDirectPhone();
                validateDirectAmount();
            }, 200);
        };

        // ===== LOAN SYSTEM FUNCTIONS =====
        let selectedLoanOffer = null;
        let loanApplicationData = {};
        let savingsPollingInterval = null;

        window.showLoanTermsModal = function() {
            const email = localStorage.getItem('userEmail');
            if (!email) {
                showToast('Please login to access loan services', 'error');
                document.getElementById('authModal').classList.add('show');
                return;
            }
            document.getElementById('loanTermsContent').scrollTop = 0;
            document.getElementById('loanAgreeBtn').classList.remove('enabled');
            document.getElementById('scrollHint').style.display = 'block';
            document.getElementById('loanTermsModal').classList.add('show');
        };

        window.checkTermsScroll = function() {
            const content = document.getElementById('loanTermsContent');
            const scrolledToBottom = content.scrollHeight - content.scrollTop <= content.clientHeight + 20;
            if (scrolledToBottom) {
                document.getElementById('loanAgreeBtn').classList.add('enabled');
                document.getElementById('scrollHint').style.display = 'none';
            }
        };

        window.agreeLoanTerms = function() {
            closeModal('loanTermsModal');
            localStorage.setItem('loanTermsAccepted', 'true');
            showPage('loan-dashboard');
        };

        window.toggleFaq = function(element) {
            element.classList.toggle('open');
        };

        window.validateAge = function() {
            const dob = document.getElementById('loanDob').value;
            if (!dob) return true;
            const birthDate = new Date(dob);
            const today = new Date();
            let age = today.getFullYear() - birthDate.getFullYear();
            const monthDiff = today.getMonth() - birthDate.getMonth();
            if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthDate.getDate())) {
                age--;
            }
            const isValid = age >= 18;
            document.getElementById('ageError').style.display = isValid ? 'none' : 'block';
            return isValid;
        };

        window.validateLoanPhone = function() {
            const phone = document.getElementById('loanPhone').value;
            const isValid = /^[71]\d{8}$/.test(phone);
            document.getElementById('loanPhoneError').style.display = isValid || phone.length === 0 ? 'none' : 'block';
            return isValid;
        };

        window.validateEmergencyPhone1 = function() {
            const phone = document.getElementById('emergency1Phone').value;
            const isValid = /^[71]\d{8}$/.test(phone);
            document.getElementById('emergency1PhoneError').style.display = isValid || phone.length === 0 ? 'none' : 'block';
            return isValid;
        };

        window.validateEmergencyPhone2 = function() {
            const phone = document.getElementById('emergency2Phone').value;
            const isValid = /^[71]\d{8}$/.test(phone);
            document.getElementById('emergency2PhoneError').style.display = isValid || phone.length === 0 ? 'none' : 'block';
            return isValid;
        };

        window.submitEligibilityForm = function() {
            if (!validateAge()) {
                showToast('You must be 18 years or older to apply', 'error');
                return;
            }
            if (!validateLoanPhone()) {
                showToast('Please enter a valid phone number', 'error');
                return;
            }
            if (!validateEmergencyPhone1() || !validateEmergencyPhone2()) {
                showToast('Please enter valid emergency contact phone numbers', 'error');
                return;
            }
            
            loanApplicationData = {
                email: document.getElementById('loanEmail').value,
                firstName: document.getElementById('loanFirstName').value,
                lastName: document.getElementById('loanLastName').value,
                dob: document.getElementById('loanDob').value,
                gender: document.getElementById('loanGender').value,
                idNumber: document.getElementById('loanIdNumber').value,
                phone: document.getElementById('loanPhone').value,
                county: document.getElementById('loanCounty').value,
                emergency1: {
                    name: document.getElementById('emergency1Name').value,
                    relationship: document.getElementById('emergency1Relationship').value,
                    phone: document.getElementById('emergency1Phone').value
                },
                emergency2: {
                    name: document.getElementById('emergency2Name').value,
                    relationship: document.getElementById('emergency2Relationship').value,
                    phone: document.getElementById('emergency2Phone').value
                },
                employment: document.getElementById('loanEmployment').value,
                income: document.getElementById('loanIncome').value,
                amountNeeded: document.getElementById('loanAmountNeeded').value,
                purpose: document.getElementById('loanPurpose').value,
                submittedAt: new Date().toISOString()
            };
            
            localStorage.setItem('loanApplicationData', JSON.stringify(loanApplicationData));
            
            showPage('loan-processing');
            startProcessingAnimation();
        };

        function startProcessingAnimation() {
            const statusText = document.getElementById('processingStatus');
            const statuses = [
                'Verifying personal information...',
                'Checking credit eligibility...',
                'Contacting partner lenders...',
                'Calculating best offers...',
                'Finalizing your options...'
            ];
            let currentIndex = 0;
            
            const interval = setInterval(() => {
                currentIndex++;
                if (currentIndex < statuses.length) {
                    statusText.textContent = statuses[currentIndex];
                }
            }, 2000);
            
            setTimeout(() => {
                clearInterval(interval);
                showPage('loan-offers');
            }, 10000);
        }

        const loanOffers = {
            linker: {
                company: 'linker',
                name: 'Linker Mkopo',
                amount: 4000,
                receive: 3870,
                savings: 130,
                repayment: 4070,
                duration: '60 Days',
                interest: '1.75%',
                logo: 'linker-mkopo.png'
            },
            pesa: {
                company: 'pesa',
                name: 'Pesa Haraka',
                amount: 7000,
                receive: 6770,
                savings: 230,
                repayment: 7147,
                duration: '70 Days',
                interest: '2.1%',
                logo: 'pesa-haraka.png'
            },
            mkopo: {
                company: 'mkopo',
                name: 'Mkopo Sasa',
                amount: 15000,
                receive: 14570,
                savings: 430,
                repayment: 15225,
                duration: '100 Days',
                interest: '1.5%',
                logo: 'mkopo-sasa.png'
            }
        };

        window.selectLoanOffer = function(company) {
            selectedLoanOffer = { ...loanOffers[company] };
            
            document.querySelectorAll('.loan-offer-card').forEach(card => {
                card.classList.remove('selected');
            });
            
            if (company === 'linker') {
                document.getElementById('offerLinker').classList.add('selected');
            } else if (company === 'pesa') {
                document.getElementById('offerPesa').classList.add('selected');
            } else if (company === 'mkopo') {
                document.getElementById('offerMkopo').classList.add('selected');
            }
            
            localStorage.setItem('selectedLoanOffer', JSON.stringify(selectedLoanOffer));
            
            showConfirmPhoneModal();
        };

        window.showConfirmPhoneModal = function() {
            const data = JSON.parse(localStorage.getItem('loanApplicationData') || '{}');
            
            document.getElementById('confirmOfferName').textContent = selectedLoanOffer.name;
            document.getElementById('confirmOfferAmount').textContent = `KES ${selectedLoanOffer.amount.toLocaleString()}`;
            document.getElementById('confirmPhoneInput').value = data.phone || '';
            document.getElementById('confirmPhoneCheck').checked = false;
            document.getElementById('confirmPhoneProceedBtn').disabled = true;
            
            document.getElementById('confirmPhoneModal').classList.add('show');
        };

        document.addEventListener('DOMContentLoaded', function() {
            const phoneInput = document.getElementById('confirmPhoneInput');
            const phoneCheck = document.getElementById('confirmPhoneCheck');
            
            if (phoneInput && phoneCheck) {
                const updateConfirmBtn = () => {
                    const phone = phoneInput.value;
                    const isValid = /^[71]\d{8}$/.test(phone);
                    document.getElementById('confirmPhoneError').style.display = isValid || phone.length === 0 ? 'none' : 'block';
                    document.getElementById('confirmPhoneProceedBtn').disabled = !(isValid && phoneCheck.checked);
                };
                
                phoneInput.addEventListener('input', updateConfirmBtn);
                phoneCheck.addEventListener('change', updateConfirmBtn);
            }
        });

        window.confirmPhoneAndProceed = function() {
            const phone = document.getElementById('confirmPhoneInput').value;
            if (!/^[71]\d{8}$/.test(phone)) {
                showToast('Please enter a valid phone number', 'error');
                return;
            }
            
            const data = JSON.parse(localStorage.getItem('loanApplicationData') || '{}');
            data.receivingPhone = phone;
            localStorage.setItem('loanApplicationData', JSON.stringify(data));
            
            closeModal('confirmPhoneModal');
            
            document.getElementById('reviewName').textContent = `${data.firstName} ${data.lastName}`;
            document.getElementById('reviewEmail').textContent = data.email;
            document.getElementById('reviewPhone').textContent = '+254' + data.phone;
            document.getElementById('reviewId').textContent = data.idNumber;
            document.getElementById('reviewCounty').textContent = data.county;
            
            document.getElementById('reviewLender').textContent = selectedLoanOffer.name;
            document.getElementById('reviewAmount').textContent = `KES ${selectedLoanOffer.amount.toLocaleString()}`;
            document.getElementById('reviewReceive').textContent = `KES ${selectedLoanOffer.receive.toLocaleString()}`;
            document.getElementById('reviewSavings').textContent = `KES ${selectedLoanOffer.savings.toLocaleString()}`;
            document.getElementById('reviewRepayment').textContent = `KES ${selectedLoanOffer.repayment.toLocaleString()}`;
            document.getElementById('reviewInterest').textContent = selectedLoanOffer.interest;
            document.getElementById('reviewPeriod').textContent = selectedLoanOffer.duration;
            document.getElementById('reviewReceivingPhone').value = phone;
            
            showPage('loan-review');
        };

        window.editSection = function(section) {
            if (section === 'eligibility') {
                showPage('loan-eligibility');
            } else if (section === 'offers') {
                showPage('loan-offers');
            }
        };

        window.startLoanApproval = function() {
            const phone = document.getElementById('reviewReceivingPhone').value;
            if (!/^[71]\d{8}$/.test(phone)) {
                showToast('Please enter a valid receiving phone number', 'error');
                return;
            }
            
            const data = JSON.parse(localStorage.getItem('loanApplicationData') || '{}');
            data.receivingPhone = phone;
            localStorage.setItem('loanApplicationData', JSON.stringify(data));
            
            showPage('loan-approval');
            startApprovalTimer();
        };

        function startApprovalTimer() {
            let countdown = 30;
            const countdownEl = document.getElementById('approvalCountdown');
            
            for (let i = 1; i <= 5; i++) {
                const step = document.getElementById(`approvalStep${i}`);
                step.classList.remove('completed');
                if (i === 1) {
                    step.classList.remove('pending');
                    step.querySelector('i').className = 'fas fa-spinner fa-spin';
                } else {
                    step.classList.add('pending');
                    step.querySelector('i').className = 'fas fa-circle';
                }
            }
            
            const stepTimes = [6, 12, 18, 24, 30];
            let currentStep = 0;
            
            const interval = setInterval(() => {
                countdown--;
                countdownEl.textContent = countdown;
                
                if (countdown <= 30 - stepTimes[currentStep] && currentStep < 5) {
                    const step = document.getElementById(`approvalStep${currentStep + 1}`);
                    step.classList.remove('pending');
                    step.classList.add('completed');
                    step.querySelector('i').className = 'fas fa-check-circle';
                    
                    currentStep++;
                    if (currentStep < 5) {
                        const nextStep = document.getElementById(`approvalStep${currentStep + 1}`);
                        nextStep.classList.remove('pending');
                        nextStep.querySelector('i').className = 'fas fa-spinner fa-spin';
                    }
                }
                
                if (countdown <= 0) {
                    clearInterval(interval);
                    showLoanApprovedPage();
                }
            }, 1000);
        }

        function showLoanApprovedPage() {
            const data = JSON.parse(localStorage.getItem('loanApplicationData') || '{}');
            
            document.getElementById('approvedAmount').textContent = `KES ${selectedLoanOffer.amount.toLocaleString()}`;
            document.getElementById('requiredSavingsAmount').textContent = `KES ${selectedLoanOffer.savings.toLocaleString()}`;
            document.getElementById('savingsBtnAmount').textContent = `KES ${selectedLoanOffer.savings.toLocaleString()}`;
            document.getElementById('approvedPhone').textContent = '+254 ' + (data.receivingPhone || data.phone || '');
            
            const email = data.email || '';
            if (email) {
                const parts = email.split('@');
                if (parts.length === 2) {
                    const hiddenEmail = parts[0].substring(0, 2) + '***@***.' + parts[1].split('.').pop();
                    document.getElementById('approvedEmailHidden').textContent = hiddenEmail;
                }
            }
            
            document.getElementById('savingsDepositPhone').value = data.receivingPhone || data.phone || '';
            
            loadSavingsBalance();
            showPage('loan-approved');
        }

        window.changeLoanOffer = function() {
            showPage('loan-offers');
        };

        window.confirmLoanApplication = function() {
            document.getElementById('approvedAmount').textContent = `KES ${selectedLoanOffer.amount.toLocaleString()}`;
            loadSavingsBalance();
            
            const phone = loanApplicationData.phone || '';
            document.getElementById('savingsDepositPhone').value = phone;
            
            showPage('loan-approved');
        };

        async function loadSavingsBalance() {
            const email = localStorage.getItem('userEmail');
            if (!email) return;
            
            try {
                const response = await fetch(`${API_BASE}/api/users/savings-balance/${encodeURIComponent(email)}`);
                const data = await response.json();
                if (data.success) {
                    document.getElementById('savingsBalance').textContent = `KES ${parseFloat(data.savings_balance || 0).toFixed(2)}`;
                }
            } catch (error) {
                console.error('Failed to load savings balance:', error);
            }
        }

        window.initiateSavingsDeposit = async function() {
            const phone = document.getElementById('savingsDepositPhone').value;
            const amount = selectedLoanOffer ? selectedLoanOffer.savings : 0;
            
            if (!amount || amount < 100) {
                showToast('No savings amount specified', 'error');
                return;
            }
            
            if (!/^[71]\d{8}$/.test(phone)) {
                showToast('Please enter a valid M-Pesa phone number', 'error');
                return;
            }
            
            const email = localStorage.getItem('userEmail');
            if (!email) {
                showToast('Please login to continue', 'error');
                return;
            }
            
            const btn = document.getElementById('savingsDepositBtn');
            const statusDiv = document.getElementById('savingsDepositStatus');
            const statusText = document.getElementById('savingsStatusText');
            
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner"></span> Sending STK Push...';
            statusDiv.style.display = 'block';
            statusText.textContent = `Initiating savings deposit of KES ${amount} to +254${phone}...`;
            
            try {
                const response = await fetch(`${API_BASE}/api/loan/savings-deposit`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        email: email,
                        phone: `254${phone}`,
                        amount: amount
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showToast('STK Push sent! Enter your M-Pesa PIN', 'success');
                    statusText.textContent = 'Waiting for M-Pesa payment...';
                    pollSavingsDepositStatus(data.reference, amount, phone);
                } else {
                    throw new Error(data.message || 'Failed to initiate deposit');
                }
            } catch (error) {
                console.error('Savings deposit error:', error);
                showToast(error.message || 'Failed to initiate deposit', 'error');
                btn.disabled = false;
                btn.innerHTML = `<i class="fas fa-mobile-alt"></i> Save <span id="savingsBtnAmount">KES ${amount}</span> to Get Loan Now`;
                statusDiv.style.display = 'none';
            }
        };

        function pollSavingsDepositStatus(reference, amount, phone) {
            let attempts = 0;
            const maxAttempts = 60;
            const statusText = document.getElementById('savingsStatusText');
            const btn = document.getElementById('savingsDepositBtn');
            const statusDiv = document.getElementById('savingsDepositStatus');
            
            if (savingsPollingInterval) clearInterval(savingsPollingInterval);
            
            savingsPollingInterval = setInterval(async () => {
                attempts++;
                
                if (attempts > maxAttempts) {
                    clearInterval(savingsPollingInterval);
                    statusDiv.style.display = 'none';
                    btn.disabled = false;
                    btn.innerHTML = `<i class="fas fa-mobile-alt"></i> Save <span id="savingsBtnAmount">KES ${amount}</span> to Get Loan Now`;
                    showToast('Payment timed out. Please try again.', 'error');
                    return;
                }
                
                try {
                    const response = await fetch(`${API_BASE}/api/loan/savings-status/${reference}`);
                    const data = await response.json();
                    const txStatus = data.transaction ? data.transaction.status : data.status;
                    
                    if (txStatus === 'completed') {
                        clearInterval(savingsPollingInterval);
                        statusDiv.style.display = 'none';
                        btn.disabled = false;
                        btn.innerHTML = `<i class="fas fa-mobile-alt"></i> Save <span id="savingsBtnAmount">KES ${amount}</span> to Get Loan Now`;
                        
                        document.getElementById('receiptAmountSavings').textContent = `KES ${amount.toLocaleString()}`;
                        document.getElementById('receiptPhoneSavings').textContent = `+254 ${phone}`;
                        document.getElementById('receiptCodeSavings').textContent = (data.transaction && data.transaction.mpesa_receipt) || 'N/A';
                        document.getElementById('receiptDateSavings').textContent = new Date().toLocaleString();
                        
                        document.getElementById('savingsReceiptModal').classList.add('show');
                        loadSavingsBalance();
                    } else if (txStatus === 'failed') {
                        clearInterval(savingsPollingInterval);
                        statusDiv.style.display = 'none';
                        btn.disabled = false;
                        btn.innerHTML = `<i class="fas fa-mobile-alt"></i> Save <span id="savingsBtnAmount">KES ${amount}</span> to Get Loan Now`;
                        showToast((data.transaction && data.transaction.failure_reason) || 'Payment failed. Please try again.', 'error');
                    } else {
                        statusText.textContent = `Waiting for payment... (${attempts}s)`;
                    }
                } catch (error) {
                    console.error('Polling error:', error);
                }
            }, 2000);
        }

        // Initialize loan form email on page show
        const originalShowPage = window.showPage;
        window.showPage = function(pageId) {
            originalShowPage(pageId);
            
            if (pageId === 'loan-eligibility') {
                const email = localStorage.getItem('userEmail');
                if (email) {
                    document.getElementById('loanEmail').value = email;
                }
                
                const savedData = localStorage.getItem('loanApplicationData');
                if (savedData) {
                    const data = JSON.parse(savedData);
                    if (data.firstName) document.getElementById('loanFirstName').value = data.firstName;
                    if (data.lastName) document.getElementById('loanLastName').value = data.lastName;
                    if (data.dob) document.getElementById('loanDob').value = data.dob;
                    if (data.gender) document.getElementById('loanGender').value = data.gender;
                    if (data.idNumber) document.getElementById('loanIdNumber').value = data.idNumber;
                    if (data.phone) document.getElementById('loanPhone').value = data.phone;
                    if (data.county) document.getElementById('loanCounty').value = data.county;
                    if (data.emergency1) {
                        document.getElementById('emergency1Name').value = data.emergency1.name || '';
                        document.getElementById('emergency1Relationship').value = data.emergency1.relationship || '';
                        document.getElementById('emergency1Phone').value = data.emergency1.phone || '';
                    }
                    if (data.emergency2) {
                        document.getElementById('emergency2Name').value = data.emergency2.name || '';
                        document.getElementById('emergency2Relationship').value = data.emergency2.relationship || '';
                        document.getElementById('emergency2Phone').value = data.emergency2.phone || '';
                    }
                    if (data.employment) document.getElementById('loanEmployment').value = data.employment;
                    if (data.income) document.getElementById('loanIncome').value = data.income;
                    if (data.amountNeeded) document.getElementById('loanAmountNeeded').value = data.amountNeeded;
                    if (data.purpose) document.getElementById('loanPurpose').value = data.purpose;
                }
            }
            
            if (pageId === 'loan-offers') {
                const savedData = localStorage.getItem('loanApplicationData');
                if (savedData) {
                    const data = JSON.parse(savedData);
                    document.getElementById('offerUserName').textContent = `${data.firstName} ${data.lastName}`;
                    document.getElementById('offerUserId').textContent = `ID: ${data.idNumber}`;
                    document.getElementById('offerUserPhone').textContent = `+254 ${data.phone}`;
                }
                
                document.querySelectorAll('.loan-offer-card').forEach(card => {
                    card.classList.remove('selected');
                });
                
                const savedOffer = localStorage.getItem('selectedLoanOffer');
                if (savedOffer) {
                    const offer = JSON.parse(savedOffer);
                    selectedLoanOffer = { ...loanOffers[offer.company] };
                    document.getElementById(`offer${offer.company.charAt(0).toUpperCase() + offer.company.slice(1)}`).classList.add('selected');
                }
            }
            
            if (pageId === 'loan-approved') {
                loadSavingsBalance();
                
                const savedOffer = localStorage.getItem('selectedLoanOffer');
                if (savedOffer) {
                    const offer = JSON.parse(savedOffer);
                    selectedLoanOffer = { ...loanOffers[offer.company] };
                    document.getElementById('approvedAmount').textContent = `KES ${selectedLoanOffer.amount.toLocaleString()}`;
                    document.getElementById('requiredSavingsAmount').textContent = `KES ${selectedLoanOffer.savings.toLocaleString()}`;
                    document.getElementById('savingsBtnAmount').textContent = `KES ${selectedLoanOffer.savings.toLocaleString()}`;
                }
            }
            
            if (pageId === 'loan-dashboard') {
                const loanApp = localStorage.getItem('loanApplicationData');
                const loanOffer = localStorage.getItem('selectedLoanOffer');
                
                if (loanApp && loanOffer) {
                    const appData = JSON.parse(loanApp);
                    const offerData = JSON.parse(loanOffer);
                    
                    if (appData.submittedAt) {
                        showPreviousApplicationPrompt(appData, offerData);
                    }
                }
            }
        };

        window.showPreviousApplicationPrompt = function(appData, offerData) {
            const continueApp = confirm(
                `You have a pending loan application:\n\n` +
                `Lender: ${offerData.name}\n` +
                `Amount: KES ${offerData.amount.toLocaleString()}\n` +
                `Submitted: ${new Date(appData.submittedAt).toLocaleDateString()}\n\n` +
                `Would you like to continue with this application?`
            );
            
            if (continueApp) {
                selectedLoanOffer = { ...loanOffers[offerData.company] };
                showPage('loan-approved');
            }
        };

        window.checkPreviousApplication = function() {
            const loanApp = localStorage.getItem('loanApplicationData');
            const loanOffer = localStorage.getItem('selectedLoanOffer');
            
            if (loanApp && loanOffer) {
                const appData = JSON.parse(loanApp);
                const offerData = JSON.parse(loanOffer);
                
                if (appData.submittedAt) {
                    return { hasApplication: true, appData, offerData };
                }
            }
            return { hasApplication: false };
        };
    </script>
</body>
</html>
