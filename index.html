<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Airtime Solution Kenya</title>
    <link rel="manifest" href="/manifest.json">
    <link rel="icon" type="image/png" href="/airtime-logo.png">
    <link rel="apple-touch-icon" href="/airtime-logo.png">
    <meta name="theme-color" content="#1a5f2a">
    <meta name="description" content="Buy and resell airtime in Kenya. Fast, reliable, and affordable.">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #1a5f2a;
            --primary-dark: #0d3d18;
            --primary-light: #2d8b42;
            --secondary: #f4a020;
            --accent: #e63946;
            --success: #28a745;
            --warning: #ffc107;
            --danger: #dc3545;
            --info: #17a2b8;
            --dark: #212529;
            --light: #f8f9fa;
            --white: #ffffff;
            --gray: #6c757d;
            --border: #dee2e6;
        }

        [data-theme="dark"] {
            --primary: #2d8b42;
            --primary-dark: #1a5f2a;
            --dark: #f8f9fa;
            --light: #1a1a2e;
            --white: #16213e;
            --gray: #adb5bd;
            --border: #3a3a5c;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Poppins', sans-serif;
            background: var(--light);
            color: var(--dark);
            min-height: 100vh;
            transition: all 0.3s ease;
        }

        .balance-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.01);
            z-index: 999;
            display: none;
            pointer-events: none;
        }

        .balance-overlay.show {
            display: block;
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 9999;
            display: none;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            gap: 20px;
        }

        .loading-overlay.show { display: flex; }

        .loading-spinner-large {
            width: 60px;
            height: 60px;
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top-color: #f4a020;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        .loading-text {
            color: white;
            font-size: 1.1rem;
            font-weight: 500;
            animation: pulse 1.5s ease-in-out infinite;
        }

        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        @keyframes bellShake {
            0%, 100% { transform: rotate(0); }
            10%, 30%, 50%, 70%, 90% { transform: rotate(-10deg); }
            20%, 40%, 60%, 80% { transform: rotate(10deg); }
        }
        
        @keyframes giftShake {
            0%, 100% { transform: rotate(0) scale(1); }
            15% { transform: rotate(-15deg) scale(1.1); }
            30% { transform: rotate(10deg) scale(1.15); }
            45% { transform: rotate(-10deg) scale(1.1); }
            60% { transform: rotate(8deg) scale(1.05); }
            75% { transform: rotate(-5deg) scale(1); }
        }
        
        .shake-gift {
            animation: giftShake 1.5s ease-in-out infinite;
            color: #f4a020;
        }
        
        .sell-airtime-menu {
            background: linear-gradient(135deg, rgba(244, 160, 32, 0.1), rgba(230, 126, 34, 0.1)) !important;
        }
        
        .notification-btn.has-notification i {
            animation: bellShake 0.8s ease-in-out infinite;
            color: #ffd700;
        }
        
        .notification-item.unread h5 {
            color: #ffd700;
            font-weight: 600;
        }
        
        .scrolling-text-container {
            background: linear-gradient(135deg, var(--secondary), #e67e22);
            overflow: hidden;
            padding: 10px 0;
            margin-bottom: 20px;
            border-radius: 8px;
        }
        
        .scrolling-text {
            display: inline-block;
            white-space: nowrap;
            animation: scrollText 20s linear infinite;
            font-weight: 600;
            color: var(--dark);
        }
        
        @keyframes scrollText {
            0% { transform: translateX(100%); }
            100% { transform: translateX(-100%); }
        }
        
        .users-graph-card {
            background: var(--white);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
        }
        
        .graph-container {
            height: 200px;
            display: flex;
            align-items: flex-end;
            justify-content: space-around;
            gap: 10px;
            padding: 20px 10px 10px;
            background: var(--light);
            border-radius: 12px;
        }
        
        .graph-bar {
            flex: 1;
            background: linear-gradient(to top, var(--primary), var(--primary-light));
            border-radius: 8px 8px 0 0;
            position: relative;
            min-width: 30px;
            transition: height 0.5s ease;
        }
        
        .graph-bar span {
            position: absolute;
            bottom: -25px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.7rem;
            color: var(--gray);
            white-space: nowrap;
        }
        
        .graph-bar::after {
            content: attr(data-value);
            position: absolute;
            top: -20px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--primary);
        }
        
        .profile-avatar {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            object-fit: cover;
            margin: 0 auto 20px;
            display: block;
            border: 4px solid var(--primary);
        }

        .app-container { max-width: 100%; min-height: 100vh; }

        .header {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: var(--white);
            padding: 15px 20px;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 15px rgba(0,0,0,0.2);
        }

        .header-left { display: flex; align-items: center; gap: 15px; }
        .menu-btn { background: none; border: none; color: var(--white); font-size: 1.5rem; cursor: pointer; padding: 5px; }
        .logo { display: flex; align-items: center; gap: 10px; }
        .logo img { width: 40px; height: 40px; border-radius: 50%; }
        .logo-text { font-weight: 600; font-size: 1.1rem; color: #f0f0f0; }
        .header-right { display: flex; align-items: center; gap: 15px; }

        .notification-btn {
            background: none;
            border: none;
            color: var(--white);
            font-size: 1.3rem;
            cursor: pointer;
            position: relative;
        }

        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: var(--accent);
            color: white;
            font-size: 0.7rem;
            padding: 2px 6px;
            border-radius: 50%;
            font-weight: 600;
        }

        .user-balance {
            display: flex;
            align-items: center;
            gap: 8px;
            background: rgba(255,255,255,0.15);
            padding: 8px 15px;
            border-radius: 25px;
        }

        .balance-amount { font-weight: 700; color: var(--secondary); }

        .refresh-btn {
            background: none;
            border: none;
            color: var(--white);
            cursor: pointer;
            font-size: 0.9rem;
            transition: transform 0.3s;
        }

        .refresh-btn:hover { transform: rotate(180deg); }
        .refresh-btn.spinning { animation: spin 1s linear infinite; }

        .sidebar {
            position: fixed;
            top: 0;
            left: -280px;
            width: 280px;
            height: 100vh;
            background: var(--white);
            z-index: 2000;
            transition: left 0.3s ease;
            box-shadow: 5px 0 20px rgba(0,0,0,0.1);
            overflow-y: auto;
        }

        .sidebar.open { left: 0; }

        .sidebar-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1999;
            display: none;
        }

        .sidebar-overlay.show { display: block; }

        .sidebar-header {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: var(--white);
            padding: 25px 20px;
        }

        .sidebar-user { display: flex; align-items: center; gap: 15px; }

        .user-avatar {
            width: 50px;
            height: 50px;
            background: rgba(255,255,255,0.2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }

        .user-info h3 { font-weight: 600; font-size: 1rem; }
        .user-info p { font-size: 0.85rem; opacity: 0.8; }
        .sidebar-menu { padding: 20px 0; }

        .menu-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px 25px;
            color: var(--dark);
            text-decoration: none;
            transition: all 0.3s;
            cursor: pointer;
            border: none;
            background: none;
            width: 100%;
            font-family: inherit;
            font-size: 0.95rem;
        }

        .menu-item:hover, .menu-item.active {
            background: rgba(26, 95, 42, 0.1);
            color: var(--primary);
        }

        .menu-item i { width: 25px; text-align: center; }
        .menu-divider { height: 1px; background: var(--border); margin: 15px 20px; }
        .main-content { padding-top: 70px; padding-bottom: 20px; min-height: 100vh; }

        .page {
            display: none;
            padding: 0;
            animation: fadeIn 0.4s ease;
        }
        
        .page-content {
            padding: 0 20px 20px 20px;
        }

        .page.active { display: block; }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .hero-section {
            background: url('airtime-hero-bg.png') center center / cover no-repeat;
            border-radius: 0;
            padding: 20px;
            margin: 0 0 20px 0;
            position: relative;
        }

        .hero-section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 0;
            z-index: 0;
        }

        .hero-section > * {
            position: relative;
            z-index: 1;
        }

        .card {
            background: var(--white);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
        }

        .card-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 15px;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .balance-card {
            background: linear-gradient(145deg, var(--primary) 0%, var(--primary-dark) 50%, #0a2d12 100%);
            color: var(--white);
            text-align: center;
            padding: 35px 25px;
            border-radius: 24px;
            position: relative;
            overflow: hidden;
            box-shadow: 0 15px 35px rgba(26, 95, 42, 0.25);
        }

        .balance-card::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
            pointer-events: none;
        }

        .balance-card::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--secondary), #e67e22, var(--secondary));
        }

        .balance-label { 
            font-size: 0.95rem; 
            opacity: 0.95; 
            margin-bottom: 8px;
            font-weight: 400;
            letter-spacing: 0.5px;
            text-transform: uppercase;
        }

        .balance-value { 
            font-size: 3rem; 
            font-weight: 800; 
            text-shadow: 0 4px 15px rgba(0,0,0,0.2);
            letter-spacing: 1px;
            margin: 10px 0;
        }

        .balance-bonus { 
            color: var(--secondary); 
            font-size: 0.9rem; 
            margin-top: 12px;
            background: rgba(244, 160, 32, 0.15);
            padding: 10px 18px;
            border-radius: 30px;
            display: inline-block;
            font-weight: 500;
            border: 1px solid rgba(244, 160, 32, 0.3);
        }

        .balance-bonus i {
            animation: giftShake 1.5s ease-in-out infinite;
            margin-right: 6px;
        }

        .quick-actions { 
            display: flex;
            flex-direction: column;
            gap: 12px; 
            margin-top: 20px; 
        }

        .quick-actions-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-top: 20px;
        }

        .action-card {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 25px 15px;
            background: rgba(13, 61, 24, 0.85);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            color: var(--white);
            gap: 12px;
            font-family: inherit;
        }

        .action-card i {
            font-size: 1.8rem;
            color: var(--secondary);
        }

        .action-card span {
            font-size: 0.95rem;
            font-weight: 600;
            color: var(--white);
        }

        .action-card:hover {
            background: rgba(13, 61, 24, 0.95);
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.3);
            border-color: rgba(244, 160, 32, 0.3);
        }

        .action-card:active {
            transform: translateY(0) scale(0.98);
        }

        .action-btn {
            display: flex;
            flex-direction: row;
            align-items: center;
            gap: 16px;
            padding: 18px 22px;
            background: var(--white);
            border: none;
            border-radius: 16px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            text-decoration: none;
            color: var(--dark);
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            position: relative;
            overflow: hidden;
        }

        .action-btn::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 4px;
            background: linear-gradient(180deg, var(--primary), var(--primary-light));
            opacity: 0;
            transition: opacity 0.3s;
        }

        .action-btn:hover::before {
            opacity: 1;
        }

        .action-btn:hover {
            transform: translateX(5px);
            box-shadow: 0 8px 25px rgba(26,95,42,0.18);
            background: linear-gradient(90deg, rgba(26, 95, 42, 0.03), var(--white));
        }

        .action-btn:active {
            transform: translateX(2px) scale(0.98);
        }

        .action-btn i { 
            font-size: 1.5rem; 
            color: var(--primary);
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, rgba(26, 95, 42, 0.1), rgba(45, 139, 66, 0.1));
            border-radius: 14px;
            flex-shrink: 0;
        }

        .action-btn span { 
            font-weight: 600; 
            font-size: 1rem;
            color: var(--dark);
        }

        .action-btn .action-arrow {
            margin-left: auto;
            color: var(--gray);
            font-size: 1rem;
            transition: transform 0.3s, color 0.3s;
        }

        .action-btn:hover .action-arrow {
            transform: translateX(5px);
            color: var(--primary);
        }
        .form-group { margin-bottom: 20px; }
        .form-label { display: block; margin-bottom: 8px; font-weight: 500; color: var(--dark); }
        .form-label i { color: var(--primary); margin-right: 8px; }

        .form-input {
            width: 100%;
            padding: 14px 16px;
            border: 2px solid var(--border);
            border-radius: 12px;
            font-size: 1rem;
            font-family: inherit;
            background: var(--white);
            color: var(--dark);
            transition: all 0.3s;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(26,95,42,0.1);
        }

        .phone-wrapper { display: flex; }

        .phone-prefix {
            background: var(--light);
            padding: 14px 15px;
            border: 2px solid var(--border);
            border-right: none;
            border-radius: 12px 0 0 12px;
            font-weight: 500;
            color: var(--dark);
        }

        .phone-wrapper .form-input { border-radius: 0 12px 12px 0; }

        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            padding: 14px 24px;
            border: none;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            font-family: inherit;
            width: 100%;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            color: var(--white);
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(26,95,42,0.3);
        }

        .btn-secondary { background: var(--secondary); color: var(--dark); }
        .btn-outline { background: transparent; border: 2px solid var(--primary); color: var(--primary); }
        .btn-outline:hover { background: var(--primary); color: var(--white); }
        .btn-link { background: #0066cc; color: var(--white); }
        .btn-link:hover { background: #0052a3; }
        .btn:disabled { opacity: 0.7; cursor: not-allowed; }
        .btn-group { display: flex; flex-direction: column; gap: 10px; margin-top: 20px; }

        .btn .spinner {
            width: 20px;
            height: 20px;
            border: 2px solid transparent;
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        .divider-text {
            display: flex;
            align-items: center;
            margin: 15px 0;
            color: var(--gray);
            font-size: 0.85rem;
        }

        .divider-text::before, .divider-text::after { content: ''; flex: 1; height: 1px; background: var(--border); }
        .divider-text span { padding: 0 15px; }

        .info-box {
            background: rgba(26, 95, 42, 0.1);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            border-left: 4px solid var(--primary);
        }

        .info-box p { font-size: 0.9rem; color: var(--dark); }

        /* Network Selector Styles */
        .network-selector {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            justify-content: center;
        }

        .network-option {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 15px;
            border: 3px solid var(--border);
            border-radius: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            background: var(--white);
            min-width: 90px;
        }

        .network-option:hover {
            border-color: var(--primary-light);
            transform: translateY(-2px);
        }

        .network-option.selected {
            border-color: var(--primary);
            background: rgba(26, 95, 42, 0.1);
            box-shadow: 0 0 0 3px rgba(26, 95, 42, 0.2);
        }

        .network-option img {
            width: 50px;
            height: 50px;
            object-fit: contain;
            margin-bottom: 8px;
        }

        .network-option span {
            font-size: 0.85rem;
            font-weight: 500;
            color: var(--dark);
        }

        .validation-error {
            color: var(--danger);
            font-size: 0.8rem;
            margin-top: 5px;
            display: none;
        }

        .validation-error.show {
            display: block;
        }

        .form-input.valid {
            border-color: var(--success);
        }

        .form-input.invalid {
            border-color: var(--danger);
        }

        .network-error {
            color: var(--danger);
            font-size: 0.85rem;
            text-align: center;
            margin-bottom: 15px;
            display: none;
        }

        .network-error.show {
            display: block;
        }

        .transaction-list { max-height: 400px; overflow-y: auto; }

        .transaction-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid var(--border);
            transition: background 0.2s;
        }

        .transaction-item:hover { background: var(--light); }
        .transaction-item:last-child { border-bottom: none; }
        .transaction-info { display: flex; align-items: center; gap: 12px; }

        .transaction-icon {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
        }

        .transaction-icon.deposit { background: rgba(40, 167, 69, 0.15); color: var(--success); }
        .transaction-icon.airtime { background: rgba(23, 162, 184, 0.15); color: var(--info); }
        .transaction-icon.failed { background: rgba(220, 53, 69, 0.15); color: var(--danger); }
        .transaction-icon.pending { background: rgba(255, 193, 7, 0.15); color: var(--warning); }
        .transaction-details h4 { font-size: 0.95rem; font-weight: 500; margin-bottom: 3px; }
        .transaction-details p { font-size: 0.8rem; color: var(--gray); }
        .transaction-amount { text-align: right; }
        .transaction-amount .amount { font-weight: 600; font-size: 1rem; }
        .transaction-amount .bonus { color: var(--success); font-size: 0.8rem; }
        .transaction-amount .status { font-size: 0.75rem; padding: 3px 8px; border-radius: 20px; }
        .status-completed { background: rgba(40, 167, 69, 0.15); color: var(--success); }
        .status-pending { background: rgba(255, 193, 7, 0.15); color: #856404; }
        .status-failed { background: rgba(220, 53, 69, 0.15); color: var(--danger); }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.6);
            z-index: 3000;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal.show { display: flex; }

        .modal-content {
            background: var(--white);
            border-radius: 20px;
            width: 100%;
            max-width: 450px;
            max-height: 90vh;
            overflow-y: auto;
            animation: modalSlide 0.3s ease;
        }

        @keyframes modalSlide {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }

        .modal-header {
            padding: 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h3 { font-size: 1.2rem; font-weight: 600; color: var(--primary); }
        .modal-close { background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--gray); }
        .modal-body { padding: 20px; }
        .modal-footer { padding: 15px 20px; border-top: 1px solid var(--border); display: flex; gap: 10px; }

        .notification-panel {
            position: fixed;
            top: 70px;
            right: 10px;
            width: 320px;
            max-height: 400px;
            background: var(--white);
            border-radius: 16px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            z-index: 2500;
            display: none;
            overflow: hidden;
        }

        .notification-panel.show { display: block; animation: slideDown 0.3s ease; }

        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .notification-header {
            padding: 15px 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .notification-header h4 { font-weight: 600; color: var(--primary); }
        .notification-list { max-height: 300px; overflow-y: auto; }

        .notification-item {
            padding: 15px 20px;
            border-bottom: 1px solid var(--border);
            cursor: pointer;
            transition: background 0.2s;
            background: rgba(26, 95, 42, 0.08);
        }

        .notification-item:hover { background: rgba(26, 95, 42, 0.15); }
        .notification-item.unread { background: rgba(26, 95, 42, 0.18); }
        .notification-item h5 { font-size: 0.9rem; font-weight: 500; margin-bottom: 5px; }
        .notification-item p { font-size: 0.8rem; color: var(--gray); }
        .notification-item .time { font-size: 0.75rem; color: var(--gray); margin-top: 5px; }

        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--dark);
            color: var(--white);
            padding: 15px 25px;
            border-radius: 12px;
            z-index: 4000;
            display: none;
            animation: toastSlide 0.3s ease;
            max-width: 90%;
        }

        .toast.show { display: flex; align-items: center; gap: 10px; }

        @keyframes toastSlide {
            from { opacity: 0; transform: translate(-50%, 20px); }
            to { opacity: 1; transform: translate(-50%, 0); }
        }

        .toast.success { background: var(--success); }
        .toast.error { background: var(--danger); }
        .toast.info { background: var(--info); }
        .toast.delay { background: #6c5ce7; }
        .toast.cancel { background: #e74c3c; }

        .retry-btn {
            display: none;
            margin-top: 15px;
            padding: 12px 20px;
            background: linear-gradient(135deg, var(--warning), #e67e22);
            color: var(--dark);
            border: none;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            align-items: center;
            justify-content: center;
            gap: 10px;
            width: 100%;
        }

        .retry-btn.show { display: flex; }
        .retry-btn:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(230, 126, 34, 0.3); }

        .status-cancelled { background: rgba(220, 53, 69, 0.15); color: var(--danger); }
        .status-delay { background: rgba(108, 92, 231, 0.15); color: #6c5ce7; }

        .live-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            background: var(--success);
            border-radius: 50%;
            margin-right: 5px;
            animation: livePulse 1.5s ease-in-out infinite;
        }

        @keyframes livePulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(0.8); }
        }

        .coming-soon-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255,255,255,0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10;
            border-radius: 16px;
        }

        .coming-soon-badge {
            background: linear-gradient(135deg, var(--secondary), #e67e22);
            color: var(--white);
            padding: 15px 30px;
            border-radius: 30px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
            box-shadow: 0 5px 20px rgba(244,160,32,0.4);
        }

        .rate-display {
            text-align: center;
            padding: 20px;
            background: var(--light);
            border-radius: 12px;
            margin-bottom: 20px;
        }

        .rate-display .rate {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary);
        }

        .dial-code {
            background: var(--dark);
            color: var(--white);
            padding: 15px;
            border-radius: 10px;
            font-family: monospace;
            font-size: 1.2rem;
            text-align: center;
            margin-bottom: 15px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: var(--white);
            padding: 20px;
            border-radius: 16px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
        }

        .stat-card i { font-size: 2rem; color: var(--primary); margin-bottom: 10px; }
        .stat-card .value { font-size: 1.5rem; font-weight: 700; color: var(--dark); }
        .stat-card .label { font-size: 0.85rem; color: var(--gray); }

        .admin-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .admin-tab {
            padding: 10px 20px;
            border: none;
            background: var(--light);
            border-radius: 10px;
            cursor: pointer;
            font-family: inherit;
            transition: all 0.3s;
        }

        .admin-tab.active { background: var(--primary); color: white; }
        .table-responsive { overflow-x: auto; }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
        }

        .data-table th, .data-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }

        .data-table th { background: var(--light); font-weight: 600; }

        .empty-state { text-align: center; padding: 40px 20px; color: var(--gray); }
        .empty-state i { font-size: 4rem; margin-bottom: 15px; opacity: 0.5; }
        .empty-state h3 { font-size: 1.2rem; margin-bottom: 10px; }
        .empty-state p { font-size: 0.9rem; }

        .footer-links {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 30px;
            flex-wrap: wrap;
        }

        .footer-link {
            color: var(--gray);
            font-size: 0.85rem;
            cursor: pointer;
        }

        .footer-link:hover { color: var(--primary); }

        .pwa-install {
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            gap: 10px;
            background: #000000;
            color: var(--white);
            width: 100%;
            padding: 15px;
            border-radius: 12px;
            cursor: pointer;
            border: none;
            box-shadow: 0 4px 15px rgba(0,0,0,0.15);
            margin-top: 20px;
        }

        .pwa-install p {
            color: #ffffff;
            font-size: 0.9rem;
            margin: 0;
        }

        @media (max-width: 480px) {
            .header { padding: 12px 15px; }
            .logo-text { font-size: 0.9rem; }
            .quick-actions { flex-direction: column; gap: 10px; }
            .action-btn { padding: 15px 18px; }
            .action-btn i:first-child { width: 44px; height: 44px; font-size: 1.3rem; }
            .balance-value { font-size: 2.5rem; }
            .notification-panel { right: 5px; left: 5px; width: auto; }
            .stats-grid { grid-template-columns: repeat(2, 1fr); }
        }
    </style>
</head>
<body>
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner-large"></div>
        <div class="loading-text" id="loadingText">Loading...</div>
    </div>

    <div class="balance-overlay" id="balanceOverlay"></div>

    <div class="app-container">
        <header class="header">
            <div class="header-left">
                <button class="menu-btn" onclick="toggleSidebar()">
                    <i class="fas fa-bars"></i>
                </button>
                <div class="logo">
                    <img src="airtime-logo.png" alt="Logo" id="headerLogo">
                    <span class="logo-text">Airtime Solution </span>
                </div>
            </div>
            <div class="header-right">
                <div class="user-balance">
                    <span>KES</span>
                    <span class="balance-amount" id="headerBalance">0.00</span>
                    <button class="refresh-btn" onclick="refreshBalance()" id="refreshBtn">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                </div>
                <button class="notification-btn" onclick="toggleNotifications()">
                    <i class="fas fa-bell"></i>
                    <span class="notification-badge" id="notifBadge">0</span>
                </button>
            </div>
        </header>

        <div class="sidebar-overlay" onclick="closeSidebar()"></div>
        <nav class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-user">
                    <div class="user-avatar">
                        <i class="fas fa-user"></i>
                    </div>
                    <div class="user-info">
                        <h3 id="sidebarEmail">Guest</h3>
                        <p id="sidebarBalance">KES 0.00</p>
                    </div>
                </div>
            </div>
            <div class="sidebar-menu">
                <button class="menu-item active" onclick="showPage('dashboard')">
                    <i class="fas fa-home"></i> Dashboard
                </button>
                <button class="menu-item" onclick="showPage('deposit')">
                    <i class="fas fa-wallet"></i> Deposit
                </button>
                <button class="menu-item" onclick="showPage('buy-airtime')">
                    <i class="fas fa-mobile-alt"></i> Buy Airtime
                </button>
                <button class="menu-item" onclick="showPage('sell-airtime')">
                    <i class="fas fa-gift"></i> Sell Airtime Get Commission
                </button>
                <button class="menu-item" onclick="showPage('airtime-to-cash')">
                    <i class="fas fa-exchange-alt"></i> Airtime to Cash
                </button>
                <button class="menu-item" onclick="closeSidebar(); scrollToDirectBuy();">
                    <i class="fas fa-bolt"></i> Buy Airtime without account
                </button>
                <button class="menu-item" onclick="showPage('transactions')">
                    <i class="fas fa-history"></i> Transactions
                </button>
                <button class="menu-item" onclick="showPage('verify-deposit')">
                    <i class="fas fa-check-circle"></i> Verify Deposit
                </button>
                <div class="menu-divider"></div>
                <button class="menu-item" onclick="showPage('bulk-sms')">
                    <i class="fas fa-sms"></i> Bulk SMS
                </button>
                <div class="menu-divider"></div>
                <button class="menu-item" onclick="showPage('settings')">
                    <i class="fas fa-cog"></i> Settings
                </button>
                <button class="menu-item" onclick="showPage('about')">
                    <i class="fas fa-info-circle"></i> About Us
                </button>
                <button class="menu-item" onclick="showPage('contact')">
                    <i class="fas fa-envelope"></i> Contact Us
                </button>
                <button class="menu-item" onclick="showPage('privacy')">
                    <i class="fas fa-shield-alt"></i> Privacy Policy
                </button>
                <button class="menu-item" onclick="showPage('terms')">
                    <i class="fas fa-file-contract"></i> Terms of Service
                </button>
                <button class="menu-item" onclick="showPage('cookies')">
                    <i class="fas fa-cookie-bite"></i> Cookie Policy
                </button>
                <div class="menu-divider"></div>
                <button class="menu-item" onclick="showPage('admin')">
                    <i class="fas fa-user-shield"></i> Admin Panel
                </button>
                <button class="menu-item" onclick="logout()" style="color: var(--danger);">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </button>
            </div>
        </nav>

        <main class="main-content">
            <div id="page-dashboard" class="page active">
                <div class="hero-section">
                    <div class="card balance-card">
                        <p class="balance-label" data-translate="yourBalance">Your Current Float Balance</p>
                        <p class="balance-value" id="dashboardBalance">KES 0.00</p>
                        <p class="balance-bonus"><i class="fas fa-gift"></i> Deposit KES 50+ and receive KES 6 bonus instantly!</p>
                    </div>

                    <div class="quick-actions-grid">
                        <button class="action-card" onclick="showPage('deposit')">
                            <i class="fas fa-wallet"></i>
                            <span data-translate="deposit">Deposit</span>
                        </button>
                        <button class="action-card" onclick="showPage('buy-airtime')">
                            <i class="fas fa-mobile-alt"></i>
                            <span data-translate="buyAirtime">Buy Airtime</span>
                        </button>
                        <button class="action-card" onclick="showPage('airtime-to-cash')">
                            <i class="fas fa-exchange-alt"></i>
                            <span data-translate="airtimeToCash">Airtime to Cash</span>
                        </button>
                        <button class="action-card" onclick="showPage('transactions')">
                            <i class="fas fa-history"></i>
                            <span data-translate="history">History</span>
                        </button>
                        <button class="action-card" onclick="scrollToDirectBuy()" style="background: linear-gradient(135deg, rgba(244, 160, 32, 0.3), rgba(230, 126, 34, 0.3)); grid-column: span 2;">
                            <i class="fas fa-bolt"></i>
                            <span>Buy Airtime Directly (No Account)</span>
                        </button>
                    </div>

                </div>

                <div class="page-content">
                <button class="pwa-install" id="pwaInstall" onclick="installPWA()" title="Install App">
                    <p>Ease airtime purchase by installing app</p>
                    <img src="https://upload.wikimedia.org/wikipedia/commons/7/78/Google_Play_Store_badge_EN.svg" alt="Get it on Google Play" style="height: 40px; width: auto;">
                </button>

                <!-- Promo Banner Section -->
                <div class="card promo-banner-card" style="margin-top: 20px; padding: 0; overflow: hidden;">
                    <img src="airtime-solution2.png" alt="Airtime Solution Promo" style="width: 100%; height: auto; display: block; border-radius: 16px 16px 0 0;">
                    <div style="padding: 20px; text-align: center;">
                        <h3 style="font-size: 1.2rem; color: var(--primary); margin-bottom: 10px; font-weight: 700;">Your Trusted Airtime Partner</h3>
                        <p style="font-size: 0.9rem; color: var(--gray); line-height: 1.6;">Buy, sell, and manage airtime effortlessly. Fast transactions, secure payments, and unbeatable rates for all networks.</p>
                    </div>
                </div>

                <!-- Scrolling Announcement -->
                <div class="scrolling-text-container" style="margin-top: 15px;">
                    <div class="scrolling-text">
                        üì¢ IMPORTANT UPDATE: Enjoy instant airtime delivery! Deposit KES 50+ and get KES 6 bonus! New features coming soon! 24/7 Support available! Buy airtime directly without an account - just pay via M-Pesa! All networks supported: Safaricom, Airtel, Telkom! Fast, secure, and reliable service! üéâ
                    </div>
                </div>

                <!-- Direct Buy Section -->
                <div class="card" id="directBuySection" style="margin-top: 20px; border: 2px solid var(--secondary); background: linear-gradient(135deg, rgba(244, 160, 32, 0.05), rgba(255, 255, 255, 1));">
                    <h3 class="card-title" style="color: var(--secondary);"><i class="fas fa-bolt"></i> Buy Airtime Directly (No Account Needed)</h3>
                    
                    <div class="info-box" style="background: rgba(244, 160, 32, 0.1); border-left-color: var(--secondary);">
                        <p><i class="fas fa-info-circle"></i> Purchase airtime instantly via M-Pesa STK Push. No registration required! Works for all networks.</p>
                    </div>

                    <form id="directBuyForm" onsubmit="event.preventDefault(); initiateDirectBuy();">
                        <div class="form-group">
                            <label class="form-label"><i class="fas fa-phone"></i> Phone to Receive Airtime *</label>
                            <div class="phone-wrapper">
                                <span class="phone-prefix">+254</span>
                                <input type="tel" class="form-input" id="directBuyPhone" placeholder="7XXXXXXXX" maxlength="9" required oninput="validateDirectPhone()">
                            </div>
                            <p class="validation-error" id="directPhoneError" style="display: none;">Enter a valid 9-digit phone number starting with 7 or 1</p>
                        </div>

                        <div class="form-group">
                            <label class="form-label"><i class="fas fa-signal"></i> Select Network To receive airtime*‚úÖÔ∏è‚úÖÔ∏è</label>
                            <div class="network-selector" id="directNetworkSelector">
                                <div class="network-option" data-network="safaricom" onclick="selectDirectNetwork('safaricom')">
                                    <img src="safaricom.png" alt="Safaricom" onerror="this.src='https://via.placeholder.com/50x50/4CB05B/ffffff?text=SAF'">
                                    <span>Safaricom</span>
                                </div>
                                <div class="network-option" data-network="airtel" onclick="selectDirectNetwork('airtel')">
                                    <img src="airtel.png" alt="Airtel" onerror="this.src='https://via.placeholder.com/50x50/ED1C24/ffffff?text=AIR'">
                                    <span>Airtel</span>
                                </div>
                                <div class="network-option" data-network="telcom" onclick="selectDirectNetwork('telcom')">
                                    <img src="telcom.png" alt="Telcom" onerror="this.src='https://via.placeholder.com/50x50/0066B3/ffffff?text=TEL'">
                                    <span>Telcom</span>
                                </div>
                            </div>
                            <p class="network-error" id="directNetworkError" style="display: none;">Please select a network</p>
                            <input type="hidden" id="selectedDirectNetwork" value="">
                        </div>

                        <div class="form-group">
                            <label class="form-label"><i class="fas fa-money-bill"></i> Amount (KES) *</label>
                            <input type="number" class="form-input" id="directBuyAmount" placeholder="Minimum: 10" min="10" required oninput="validateDirectAmount()">
                            <p class="validation-error" id="directAmountError" style="display: none;">Minimum amount is KES 10</p>
                            <div style="display: flex; gap: 8px; margin-top: 10px; flex-wrap: wrap;">
                                <button type="button" class="btn btn-outline" style="flex: 1; min-width: 60px; padding: 10px;" onclick="document.getElementById('directBuyAmount').value = 10; validateDirectAmount();">10</button>
                                <button type="button" class="btn btn-outline" style="flex: 1; min-width: 60px; padding: 10px;" onclick="document.getElementById('directBuyAmount').value = 20; validateDirectAmount();">20</button>
                                <button type="button" class="btn btn-outline" style="flex: 1; min-width: 60px; padding: 10px;" onclick="document.getElementById('directBuyAmount').value = 50; validateDirectAmount();">50</button>
                                <button type="button" class="btn btn-outline" style="flex: 1; min-width: 60px; padding: 10px;" onclick="document.getElementById('directBuyAmount').value = 100; validateDirectAmount();">100</button>
                                <button type="button" class="btn btn-outline" style="flex: 1; min-width: 60px; padding: 10px;" onclick="document.getElementById('directBuyAmount').value = 200; validateDirectAmount();">200</button>
                                <button type="button" class="btn btn-outline" style="flex: 1; min-width: 60px; padding: 10px;" onclick="document.getElementById('directBuyAmount').value = 500; validateDirectAmount();">500</button>
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label"><i class="fas fa-mobile-alt"></i> Phone to Pay With (M-Pesa) *</label>
                            <div class="phone-wrapper">
                                <span class="phone-prefix">+254</span>
                                <input type="tel" class="form-input" id="directPayPhone" placeholder="7XXXXXXXX" maxlength="9" required oninput="validateDirectPayPhone()">
                            </div>
                            <p class="validation-error" id="directPayPhoneError" style="display: none;">Enter a valid Safaricom number starting with 7 or 1</p>
                            <p style="font-size: 0.8rem; color: var(--gray); margin-top: 5px;"><i class="fas fa-info-circle"></i> STK Push will be sent to this number</p>
                        </div>

                        <button type="submit" class="btn btn-secondary" id="directBuyBtn" disabled style="font-size: 1.1rem; padding: 16px;">
                            <i class="fas fa-bolt"></i> Buy Now via M-Pesa
                        </button>

                        <div id="directBuyStatus" style="margin-top: 15px; text-align: center; display: none;">
                            <span class="live-indicator"></span>
                            <span id="directBuyStatusText">Processing...</span>
                        </div>
                    </form>
                </div>

                <!-- Why Choose Us Section -->
                <div class="card" style="margin-top: 20px;">
                    <h3 class="card-title"><i class="fas fa-star"></i> <span data-translate="whyChooseUs">Why Choose Us</span></h3>
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">
                        <div style="text-align: center; padding: 15px; background: var(--light); border-radius: 12px;">
                            <i class="fas fa-bolt" style="font-size: 2rem; color: var(--secondary); margin-bottom: 10px;"></i>
                            <h4 style="font-size: 0.9rem; margin-bottom: 5px;">Instant Delivery</h4>
                            <p style="font-size: 0.8rem; color: var(--gray);">Airtime delivered in seconds</p>
                        </div>
                        <div style="text-align: center; padding: 15px; background: var(--light); border-radius: 12px;">
                            <i class="fas fa-shield-alt" style="font-size: 2rem; color: var(--success); margin-bottom: 10px;"></i>
                            <h4 style="font-size: 0.9rem; margin-bottom: 5px;">Secure Payments</h4>
                            <p style="font-size: 0.8rem; color: var(--gray);">M-Pesa powered security</p>
                        </div>
                        <div style="text-align: center; padding: 15px; background: var(--light); border-radius: 12px;">
                            <i class="fas fa-percentage" style="font-size: 2rem; color: var(--primary); margin-bottom: 10px;"></i>
                            <h4 style="font-size: 0.9rem; margin-bottom: 5px;">Best Rates</h4>
                            <p style="font-size: 0.8rem; color: var(--gray);">Competitive discounts</p>
                        </div>
                        <div style="text-align: center; padding: 15px; background: var(--light); border-radius: 12px;">
                            <i class="fas fa-headset" style="font-size: 2rem; color: var(--info); margin-bottom: 10px;"></i>
                            <h4 style="font-size: 0.9rem; margin-bottom: 5px;">24/7 Support</h4>
                            <p style="font-size: 0.8rem; color: var(--gray);">Always here to help</p>
                        </div>
                    </div>
                </div>

                <!-- Platform Usage Graph -->
                <div class="users-graph-card" style="margin-top: 20px;">
                    <h3 class="card-title"><i class="fas fa-chart-bar"></i> Platform Activity</h3>
                    <p style="font-size: 0.85rem; color: var(--gray); margin-bottom: 15px;">Users buying airtime this week</p>
                    <div class="graph-container" style="margin-bottom: 30px;">
                        <div class="graph-bar" style="height: 65%;" data-value="1.2K"><span>Mon</span></div>
                        <div class="graph-bar" style="height: 80%;" data-value="1.8K"><span>Tue</span></div>
                        <div class="graph-bar" style="height: 55%;" data-value="950"><span>Wed</span></div>
                        <div class="graph-bar" style="height: 90%;" data-value="2.1K"><span>Thu</span></div>
                        <div class="graph-bar" style="height: 75%;" data-value="1.5K"><span>Fri</span></div>
                        <div class="graph-bar" style="height: 60%;" data-value="1.1K"><span>Sat</span></div>
                        <div class="graph-bar" style="height: 85%;" data-value="1.9K"><span>Sun</span></div>
                    </div>
                    <div style="display: flex; justify-content: space-around; text-align: center; padding-top: 10px; border-top: 1px solid var(--border);">
                        <div>
                            <p style="font-size: 1.5rem; font-weight: 700; color: var(--primary);">10.5K</p>
                            <p style="font-size: 0.75rem; color: var(--gray);">Weekly Users</p>
                        </div>
                        <div>
                            <p style="font-size: 1.5rem; font-weight: 700; color: var(--success);">KES 100k+</p>
                            <p style="font-size: 0.75rem; color: var(--gray);">Airtime Sold</p>
                        </div>
                        <div>
                            <p style="font-size: 1.5rem; font-weight: 700; color: var(--secondary);">99.8%</p>
                            <p style="font-size: 0.75rem; color: var(--gray);">Success Rate</p>
                        </div>
                    </div>
                </div>

                <!-- FAQ Section -->
                <div class="card" style="margin-top: 20px;">
                    <h3 class="card-title"><i class="fas fa-question-circle"></i> <span data-translate="faq">Frequently Asked Questions</span></h3>
                    <div class="faq-item" style="margin-bottom: 15px; padding: 15px; background: var(--light); border-radius: 12px;">
                        <h4 style="font-size: 0.95rem; color: var(--primary); margin-bottom: 8px;"><i class="fas fa-chevron-right" style="margin-right: 8px;"></i>How do I buy airtime?</h4>
                        <p style="font-size: 0.85rem; color: var(--gray);">Simply deposit funds to your wallet, select a network, enter the phone number and amount, then click "Buy Now".</p>
                    </div>
                    <div class="faq-item" style="margin-bottom: 15px; padding: 15px; background: var(--light); border-radius: 12px;">
                        <h4 style="font-size: 0.95rem; color: var(--primary); margin-bottom: 8px;"><i class="fas fa-chevron-right" style="margin-right: 8px;"></i>How long does airtime delivery take?</h4>
                        <p style="font-size: 0.85rem; color: var(--gray);">Airtime is delivered instantly within 5-30 seconds after successful payment.</p>
                    </div>
                    <div class="faq-item" style="margin-bottom: 15px; padding: 15px; background: var(--light); border-radius: 12px;">
                        <h4 style="font-size: 0.95rem; color: var(--primary); margin-bottom: 8px;"><i class="fas fa-chevron-right" style="margin-right: 8px;"></i>What is the minimum deposit?</h4>
                        <p style="font-size: 0.85rem; color: var(--gray);">The minimum deposit is KES 10. Deposits of KES 50 or more receive a KES 6 bonus!</p>
                    </div>
                    <div class="faq-item" style="padding: 15px; background: var(--light); border-radius: 12px;">
                        <h4 style="font-size: 0.95rem; color: var(--primary); margin-bottom: 8px;"><i class="fas fa-chevron-right" style="margin-right: 8px;"></i>Which networks are supported?</h4>
                        <p style="font-size: 0.85rem; color: var(--gray);">We support Safaricom, Airtel, and Telkom Kenya networks.</p>
                    </div>
                </div>

                <div class="card" style="margin-top: 20px;">
                    <h3 class="card-title"><i class="fas fa-clock"></i> <span data-translate="recentTransactions">Recent Transactions</span></h3>
                    <div class="transaction-list" id="recentTransactions">
                        <div class="empty-state">
                            <i class="fas fa-inbox"></i>
                            <h3>No transactions yet</h3>
                            <p>Your recent transactions will appear here</p>
                        </div>
                    </div>
                </div>

                <div class="footer-links">
                    <span class="footer-link" onclick="showPage('about')">About</span>
                    <span class="footer-link" onclick="showPage('contact')">Contact</span>
                    <span class="footer-link" onclick="showPage('privacy')">Privacy</span>
                    <span class="footer-link" onclick="showPage('terms')">Terms</span>
                </div>
                </div>
            </div>

            <div id="page-deposit" class="page">
                <div class="card">
                    <h3 class="card-title"><i class="fas fa-wallet"></i> Deposit Money</h3>

                    <div class="info-box">
                        <p><i class="fas fa-gift"></i> Deposit KES 50+ and get <strong>+6 bonus</strong> added to your account!</p>
                    </div>

                    <form id="depositForm">
                        <div class="form-group">
                            <label class="form-label"><i class="fas fa-phone"></i> Phone Number *</label>
                            <input type="tel" class="form-input" id="depositPhone" placeholder="e.g. 0718369524" maxlength="10" required>
                            <small style="color: var(--gray); font-size: 0.8rem;">Enter your M-Pesa number (starts with 07 or 01)</small>
                        </div>

                        <div class="form-group">
                            <label class="form-label"><i class="fas fa-money-bill"></i> Amount (KES) *</label>
                            <input type="number" class="form-input" id="depositAmount" placeholder="Minimum: 10" min="10" required>
                        </div>

                        <div class="btn-group">
                            <button type="submit" class="btn btn-primary" id="depositStkBtn">
                                <i class="fas fa-mobile-alt"></i> Deposit via M-Pesa STK Push
                            </button>

                            <div class="divider-text"><span>OR</span></div>

                            <button type="button" class="btn btn-link" onclick="depositWithLink()">
                                <i class="fas fa-link"></i> Deposit with Payment Link
                            </button>
                        </div>

                        <button type="button" class="retry-btn" id="retryDepositBtn" onclick="retryDeposit()">
                            <i class="fas fa-sync-alt"></i> Retry Deposit
                        </button>

                        <div id="depositStatus" style="margin-top: 15px; text-align: center; display: none;">
                            <span class="live-indicator"></span>
                            <span id="depositStatusText">Processing...</span>
                        </div>
                    </form>
                </div>
            </div>

            <div id="page-buy-airtime" class="page">
                <div class="card">
                    <h3 class="card-title"><i class="fas fa-mobile-alt"></i> Buy Airtime</h3>

                    <div class="info-box">
                        <p><i class="fas fa-info-circle"></i> Buy KES 20 and above and receive Commissions . Minimum purchase: KES 10</p>
                    </div>

                    <form id="buyAirtimeForm">
                        <!-- Network Selection -->
                        <div class="form-group">
                            <label class="form-label"><i class="fas fa-signal"></i> Select Network *‚úÖÔ∏è‚úÖÔ∏è </label>
                            <div class="network-selector">
                                <div class="network-option" data-network="safaricom" onclick="selectNetwork('safaricom')">
                                    <img src="safaricom.png" alt="Safaricom" onerror="this.src='https://via.placeholder.com/50x50/4CB05B/ffffff?text=SAF'">
                                    <span>Safaricom</span>
                                </div>
                                <div class="network-option" data-network="airtel" onclick="selectNetwork('airtel')">
                                    <img src="airtel.png" alt="Airtel" onerror="this.src='https://via.placeholder.com/50x50/ED1C24/ffffff?text=AIR'">
                                    <span>Airtel</span>
                                </div>
                                <div class="network-option" data-network="telcom" onclick="selectNetwork('telcom')">
                                    <img src="telcom.png" alt="Telcom" onerror="this.src='https://via.placeholder.com/50x50/0066B3/ffffff?text=TEL'">
                                    <span>Telcom</span>
                                </div>
                            </div>
                            <p class="network-error" id="networkError">Please select a network to continue</p>
                            <input type="hidden" id="selectedNetwork" value="">
                        </div>

                        <div class="form-group">
                            <label class="form-label"><i class="fas fa-phone"></i> Phone Number *</label>
                            <div class="phone-wrapper">
                                <span class="phone-prefix">+254</span>
                                <input type="tel" class="form-input" id="airtimePhone" placeholder="7XXXXXXXX" maxlength="9" required oninput="validateAirtimePhone()">
                            </div>
                            <p class="validation-error" id="phoneError">Enter a valid 9-digit phone number starting with 7 or 1</p>
                        </div>

                        <div class="form-group">
                            <label class="form-label"><i class="fas fa-money-bill"></i> Amount (KES) *</label>
                            <input type="number" class="form-input" id="airtimeAmount" placeholder="Minimum: 10" min="10" required oninput="validateAirtimeAmount()">
                            <p class="validation-error" id="amountError">Minimum amount is KES 10</p>
                        </div>

                        <div class="btn-group" style="display: flex; gap: 10px; flex-wrap: wrap;">
                            <button type="submit" class="btn btn-primary" id="buyAirtimeBtn" disabled style="flex: 1;">
                                <i class="fas fa-shopping-cart"></i> Buy Now (From Balance)
                            </button>

                            <button type="button" class="btn btn-outline" onclick="goToDirectBuyFromBuyPage()" style="flex: 1; border-color: var(--secondary); color: var(--secondary);">
                                <i class="fas fa-bolt"></i> Buy With mpesa stk push
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <div id="page-sell-airtime" class="page">
                <div class="card">
                    <h3 class="card-title"><i class="fas fa-gift"></i> Sell Airtime Get Commission</h3>

                    <div class="info-box">
                        <p><i class="fas fa-info-circle"></i> Sell airtime and earn commission! KES 10-49 = 5% commission, KES 50+ = 10% commission. Minimum Sell: KES 10</p>
                    </div>

                    <form id="sellAirtimeForm">
                        <!-- Network Selection -->
                        <div class="form-group">
                            <label class="form-label"><i class="fas fa-signal"></i> Select Network *‚úÖÔ∏è‚úÖÔ∏è </label>
                            <div class="network-selector">
                                <div class="network-option" data-network="safaricom" data-form="send" onclick="selectSendNetwork('safaricom')">
                                    <img src="safaricom.png" alt="Safaricom" onerror="this.src='https://via.placeholder.com/50x50/4CB05B/ffffff?text=SAF'">
                                    <span>Safaricom</span>
                                </div>
                                <div class="network-option" data-network="airtel" data-form="send" onclick="selectSendNetwork('airtel')">
                                    <img src="airtel.png" alt="Airtel" onerror="this.src='https://via.placeholder.com/50x50/ED1C24/ffffff?text=AIR'">
                                    <span>Airtel</span>
                                </div>
                                <div class="network-option" data-network="telcom" data-form="send" onclick="selectSendNetwork('telcom')">
                                    <img src="telcom.png" alt="Telcom" onerror="this.src='https://via.placeholder.com/50x50/0066B3/ffffff?text=TEL'">
                                    <span>Telcom</span>
                                </div>
                            </div>
                            <p class="network-error" id="sendNetworkError">Please select a network to continue</p>
                            <input type="hidden" id="selectedSendNetwork" value="">
                        </div>

                        <div class="form-group">
                            <label class="form-label"><i class="fas fa-phone"></i> Phone Number to Sell Airtime *</label>
                            <div class="phone-wrapper">
                                <span class="phone-prefix">+254</span>
                                <input type="tel" class="form-input" id="sellAirtimePhone" placeholder="7XXXXXXXX" maxlength="9" required oninput="validateSendPhone()">
                            </div>
                            <p class="validation-error" id="sendPhoneError">Enter a valid 9-digit phone number starting with 7 or 1</p>
                        </div>

                        <div class="form-group">
                            <label class="form-label"><i class="fas fa-money-bill"></i> Airtime Amount (KES) *</label>
                            <input type="number" class="form-input" id="sellAirtimeAmount" placeholder="Minimum: 10" min="10" required oninput="validateSendAmount()">
                            <p class="validation-error" id="sendAmountError">Minimum amount is KES 10</p>
                        </div>

                        <div class="btn-group">
                            <button type="submit" class="btn btn-primary" id="sellAirtimeBalanceBtn" disabled>
                                <i class="fas fa-wallet"></i> Sell from Balance
                            </button>
                        </div>
                    </form>
                </div>

                <div class="card" style="margin-top: 15px;">
                    <h3 class="card-title"><i class="fas fa-chart-line"></i> Service Status</h3>
                    <div id="statumFloatStatus">
                        <p style="color: var(--gray);">Checking service availability...</p>
                    </div>
                </div>
            </div>

            <div id="page-airtime-to-cash" class="page">
                <div class="card" style="position: relative;">
                    <div class="coming-soon-overlay" id="a2cOverlay">
                        <div class="coming-soon-badge">
                            <i class="fas fa-clock"></i>
                            Coming Soon!
                        </div>
                    </div>

                    <h3 class="card-title"><i class="fas fa-exchange-alt"></i> Airtime to Cash</h3>

                    <div class="rate-display">
                        <p>Conversion Rate</p>
                        <p class="rate">80% Cashback</p>
                        <p style="font-size: 0.85rem;">KES 100 Airtime = KES 80 Cash</p>
                    </div>

                    <form id="airtimeToCashForm">
                        <div class="form-group">
                            <label class="form-label"><i class="fas fa-coins"></i> Airtime Amount to Convert *</label>
                            <input type="number" class="form-input" id="a2cAmount" placeholder="Enter amount" min="10" required>
                        </div>

                        <div class="form-group">
                            <label class="form-label"><i class="fas fa-phone"></i> Your Phone Number *</label>
                            <div class="phone-wrapper">
                                <span class="phone-prefix">+254</span>
                                <input type="tel" class="form-input" id="a2cPhone" placeholder="7XXXXXXXX" maxlength="9" required>
                            </div>
                        </div>

                        <div id="dialCodeSection" style="display: none;">
                            <p style="margin-bottom: 10px;">Dial this code to send airtime:</p>
                            <div class="dial-code" id="dialCode">*140*100*0718369524#</div>
                            <p style="font-size: 0.85rem; color: var(--gray); margin-bottom: 15px;">After sending, click "Done" below</p>
                        </div>

                        <div class="btn-group">
                            <button type="submit" class="btn btn-primary" id="sambazaBtn">
                                <i class="fas fa-paper-plane"></i> Generate Dial Code
                            </button>
                            <button type="button" class="btn btn-secondary" id="doneBtn" style="display: none;" onclick="showVerifyA2C()">
                                <i class="fas fa-check"></i> Done - I've Sent Airtime
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <div id="page-verify-a2c" class="page">
                <div class="card">
                    <h3 class="card-title"><i class="fas fa-check-circle"></i> Verify Airtime Sent</h3>
                    <p style="margin-bottom: 20px; color: var(--gray);">Enter the confirmation message code from Safaricom to verify your transfer.</p>
                    <form id="verifyA2CForm">
                        <div class="form-group">
                            <label class="form-label"><i class="fas fa-phone"></i> Your Phone Number</label>
                            <input type="text" class="form-input" id="verifyA2CPhone" readonly>
                        </div>
                        <div class="form-group">
                            <label class="form-label"><i class="fas fa-key"></i> Confirmation Code *</label>
                            <input type="text" class="form-input" id="verifyA2CCode" placeholder="Enter confirmation code" required>
                        </div>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-check"></i> Verify
                        </button>
                    </form>
                </div>
            </div>

            <div id="page-transactions" class="page">
                <div class="card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h3 class="card-title" style="margin: 0;"><i class="fas fa-history"></i> Transaction History</h3>
                        <button class="btn btn-outline" style="width: auto; padding: 10px 15px;" onclick="downloadTransactionsPDF()">
                            <i class="fas fa-download"></i> PDF
                        </button>
                    </div>
                    <div class="transaction-list" id="allTransactions">
                        <div class="empty-state">
                            <i class="fas fa-inbox"></i>
                            <h3>No transactions</h3>
                            <p>Your transaction history will appear here</p>
                        </div>
                    </div>
                </div>
            </div>

            <div id="page-verify-deposit" class="page">
                <div class="card">
                    <h3 class="card-title"><i class="fas fa-check-circle"></i> Verify Deposit</h3>
                    <p style="margin-bottom: 20px; color: var(--gray);">If your deposit was successful but not reflected, enter your M-Pesa code to verify.</p>
                    <form id="verifyDepositForm">
                        <div class="form-group">
                            <label class="form-label"><i class="fas fa-receipt"></i> M-Pesa Transaction Code *</label>
                            <input type="text" class="form-input" id="mpesaCode" placeholder="e.g., ABC123XYZ" required>
                        </div>
                        <button type="submit" class="btn btn-primary" id="verifyDepositBtn">
                            <i class="fas fa-search"></i> Verify Deposit
                        </button>
                    </form>
                </div>
            </div>

            <div id="page-bulk-sms" class="page">
                <div class="card" style="position: relative;">
                    <div class="coming-soon-overlay">
                        <div class="coming-soon-badge">
                            <i class="fas fa-clock"></i>
                            Coming Soon!
                        </div>
                    </div>
                    <h3 class="card-title"><i class="fas fa-sms"></i> Bulk SMS</h3>
                    <p>Send SMS to multiple recipients at affordable rates.</p>
                </div>
            </div>

            <div id="page-settings" class="page">
                <div class="card">
                    <h3 class="card-title"><i class="fas fa-cog"></i> Settings</h3>
                    <div class="form-group">
                        <label class="form-label"><i class="fas fa-language"></i> Language</label>
                        <select class="form-input" id="languageSelect" onchange="changeLanguage(this.value)">
                            <option value="en">English</option>
                            <option value="sw">Kiswahili</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label"><i class="fas fa-moon"></i> Theme</label>
                        <select class="form-input" id="themeSelect" onchange="changeTheme(this.value)">
                            <option value="light">Light Mode</option>
                            <option value="dark">Dark Mode</option>
                        </select>
                    </div>
                    <div class="menu-divider"></div>
                    <button class="btn btn-outline" onclick="showPage('profile')" style="margin-bottom: 10px;">
                        <i class="fas fa-user"></i> Edit Profile
                    </button>
                    <button class="btn btn-outline" onclick="showPage('cookies')">
                        <i class="fas fa-cookie"></i> Cookie Preferences
                    </button>
                </div>
            </div>

            <div id="page-profile" class="page">
                <div class="card">
                    <h3 class="card-title"><i class="fas fa-user"></i> My Profile</h3>
                    <img src="https://api.dicebear.com/7.x/avataaars/svg?seed=airtimeuser&backgroundColor=b6e3f4" alt="Profile Avatar" class="profile-avatar">
                    <form id="profileForm">
                        <div class="form-group">
                            <label class="form-label">Email</label>
                            <input type="email" class="form-input" id="profileEmail" readonly>
                        </div>
                        <div class="form-group">
                            <label class="form-label"><i class="fas fa-phone"></i> Phone Number</label>
                            <div class="phone-wrapper">
                                <span class="phone-prefix">+254</span>
                                <input type="tel" class="form-input" id="profilePhone" maxlength="9" oninput="validateProfilePhone()">
                            </div>
                            <p class="validation-error" id="profilePhoneError">Enter a valid 9-digit phone number starting with 7 or 1</p>
                            <p class="validation-error" id="profilePhoneDuplicateError" style="color: var(--warning);">This phone number is already registered</p>
                        </div>
                        <button type="submit" class="btn btn-primary" id="profileSaveBtn">
                            <i class="fas fa-save"></i> Save Changes
                        </button>
                    </form>
                </div>
            </div>

            <div id="page-about" class="page">
                <div class="card">
                    <h3 class="card-title"><i class="fas fa-info-circle"></i> <span data-translate="aboutUs">About Us</span></h3>
                    
                    <div style="text-align: center; margin-bottom: 20px;">
                        <img src="about1.png" alt="Airtime Solution Kenya" style="max-width: 200px; border-radius: 16px; margin-bottom: 10px;" onerror="this.style.display='none'">
                    </div>
                    
                    <p style="margin-bottom: 15px; font-size: 1.05rem;"><strong>Airtime Solution Kenya</strong> is your trusted partner for buying and reselling airtime across all networks in Kenya.</p>
                    
                    <div style="background: var(--light); padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                        <h4 style="color: var(--primary); margin-bottom: 15px;"><i class="fas fa-bullseye" style="margin-right: 8px;"></i>Our Mission</h4>
                        <p style="color: var(--gray);">To provide Kenyans with the most convenient, affordable, and reliable airtime services, empowering individuals and businesses to stay connected.</p>
                    </div>
                    
                    <div style="background: var(--light); padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                        <h4 style="color: var(--primary); margin-bottom: 15px;"><i class="fas fa-eye" style="margin-right: 8px;"></i>Our Vision</h4>
                        <p style="color: var(--gray);">To become Kenya's leading digital airtime platform, known for innovation, trust, and exceptional customer service.</p>
                    </div>
                    
                    <p style="margin-bottom: 15px;">We provide a fast, secure, and reliable platform that allows you to:</p>
                    <ul style="margin-left: 20px; margin-bottom: 20px; line-height: 1.8;">
                        <li><i class="fas fa-check" style="color: var(--success); margin-right: 8px;"></i>Buy airtime instantly at discounted rates</li>
                        <li><i class="fas fa-check" style="color: var(--success); margin-right: 8px;"></i>Resell airtime and earn profits</li>
                        <li><i class="fas fa-check" style="color: var(--success); margin-right: 8px;"></i>Convert airtime to cash (Coming Soon)</li>
                        <li><i class="fas fa-check" style="color: var(--success); margin-right: 8px;"></i>Deposit and manage your wallet easily</li>
                        <li><i class="fas fa-check" style="color: var(--success); margin-right: 8px;"></i>Send airtime to any network</li>
                    </ul>
                    
                    <div style="text-align: center; margin-bottom: 15px;">
                        <img src="about2.png" alt="Our Team" style="max-width: 100%; border-radius: 16px;" onerror="this.style.display='none'">
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 20px;">
                        <div style="text-align: center; padding: 15px; background: var(--light); border-radius: 12px;">
                            <i class="fas fa-calendar-alt" style="font-size: 1.5rem; color: var(--primary); margin-bottom: 8px;"></i>
                            <p style="font-weight: 600;">Founded</p>
                            <p style="color: var(--gray);">2025</p>
                        </div>
                        <div style="text-align: center; padding: 15px; background: var(--light); border-radius: 12px;">
                            <i class="fas fa-map-marker-alt" style="font-size: 1.5rem; color: var(--primary); margin-bottom: 8px;"></i>
                            <p style="font-weight: 600;">Location</p>
                            <p style="color: var(--gray);">Nairobi, Kenya</p>
                        </div>
                    </div>
                </div>
            </div>

            <div id="page-contact" class="page">
                <div class="card">
                    <h3 class="card-title"><i class="fas fa-envelope"></i> <span data-translate="contactUs">Contact Us</span></h3>
                    
                    <p style="margin-bottom: 20px; font-size: 1.05rem;">Have questions or need help? We're here for you 24/7!</p>
                    
                    <div style="display: grid; gap: 15px; margin-bottom: 25px;">
                        <div style="display: flex; align-items: center; padding: 15px; background: var(--light); border-radius: 12px;">
                            <i class="fab fa-whatsapp" style="font-size: 2rem; color: #25d366; margin-right: 15px;"></i>
                            <div>
                                <p style="font-weight: 600; margin-bottom: 3px;">WhatsApp</p>
                                <a href="https://wa.me/254718369524" target="_blank" style="color: var(--primary);">+254 718 369 524</a>
                            </div>
                        </div>
                        
                        <div style="display: flex; align-items: center; padding: 15px; background: var(--light); border-radius: 12px;">
                            <i class="fas fa-phone-alt" style="font-size: 2rem; color: var(--primary); margin-right: 15px;"></i>
                            <div>
                                <p style="font-weight: 600; margin-bottom: 3px;">Phone Call</p>
                                <a href="tel:+254718369524" style="color: var(--primary);">+254 718 369 524</a>
                            </div>
                        </div>
                        
                        <div style="display: flex; align-items: center; padding: 15px; background: var(--light); border-radius: 12px;">
                            <i class="fas fa-envelope" style="font-size: 2rem; color: var(--info); margin-right: 15px;"></i>
                            <div>
                                <p style="font-weight: 600; margin-bottom: 3px;">Email</p>
                                <a href="mailto:support@airtimesolutionkenya.com" style="color: var(--primary);">support@airtimesolutionkenya.com</a>
                            </div>
                        </div>
                        
                        <div style="display: flex; align-items: center; padding: 15px; background: var(--light); border-radius: 12px;">
                            <i class="fas fa-clock" style="font-size: 2rem; color: var(--secondary); margin-right: 15px;"></i>
                            <div>
                                <p style="font-weight: 600; margin-bottom: 3px;">Working Hours</p>
                                <p style="color: var(--gray);">24 Hours, 7 Days a Week</p>
                            </div>
                        </div>
                    </div>
                    
                    <div style="background: linear-gradient(135deg, var(--primary), var(--primary-dark)); padding: 20px; border-radius: 12px; text-align: center; color: white; margin-bottom: 15px;">
                        <h4 style="margin-bottom: 10px;"><i class="fas fa-headset" style="margin-right: 8px;"></i>Need Immediate Help?</h4>
                        <p style="opacity: 0.9; margin-bottom: 15px;">Our support team is always ready to assist you with any questions or issues.</p>
                        <a href="https://wa.me/254718369524" target="_blank" class="btn btn-secondary" style="display: inline-flex; width: auto;">
                            <i class="fab fa-whatsapp"></i> Chat Now on WhatsApp
                        </a>
                    </div>
                </div>
            </div>

            <div id="page-privacy" class="page">
                <div class="card">
                    <h3 class="card-title"><i class="fas fa-shield-alt"></i> <span data-translate="privacyPolicy">Privacy Policy</span></h3>
                    
                    <div style="text-align: center; margin-bottom: 20px;">
                        <img src="privacy1.png" alt="Privacy" style="max-width: 150px; border-radius: 12px;" onerror="this.style.display='none'">
                    </div>
                    
                    <div style="background: var(--light); padding: 15px; border-radius: 12px; margin-bottom: 20px;">
                        <p style="color: var(--gray);"><i class="fas fa-calendar" style="margin-right: 8px;"></i><strong>Last Updated:</strong> December 2025</p>
                    </div>
                    
                    <p style="margin-bottom: 20px;">At Airtime Solution Kenya, we are committed to protecting your privacy and ensuring the security of your personal information.</p>
                    
                    <div style="border-left: 4px solid var(--primary); padding-left: 15px; margin-bottom: 20px;">
                        <h4 style="color: var(--primary); margin-bottom: 10px;">1. Information We Collect</h4>
                        <ul style="margin-left: 15px; color: var(--gray); line-height: 1.8;">
                            <li>Email address for account authentication</li>
                            <li>Phone number for airtime transactions</li>
                            <li>Transaction history and amounts</li>
                            <li>Device information for security purposes</li>
                        </ul>
                    </div>
                    
                    <div style="border-left: 4px solid var(--info); padding-left: 15px; margin-bottom: 20px;">
                        <h4 style="color: var(--info); margin-bottom: 10px;">2. How We Use Your Information</h4>
                        <ul style="margin-left: 15px; color: var(--gray); line-height: 1.8;">
                            <li>Process airtime purchases and deposits</li>
                            <li>Send transaction confirmations</li>
                            <li>Provide customer support</li>
                            <li>Improve our services and user experience</li>
                            <li>Prevent fraud and maintain security</li>
                        </ul>
                    </div>
                    
                    <div style="border-left: 4px solid var(--success); padding-left: 15px; margin-bottom: 20px;">
                        <h4 style="color: var(--success); margin-bottom: 10px;">3. Data Security</h4>
                        <p style="color: var(--gray); margin-bottom: 10px;">We implement industry-standard security measures including:</p>
                        <ul style="margin-left: 15px; color: var(--gray); line-height: 1.8;">
                            <li>SSL/TLS encryption for all data transfers</li>
                            <li>Secure payment processing via M-Pesa</li>
                            <li>Regular security audits</li>
                            <li>Access controls and authentication</li>
                        </ul>
                    </div>
                    
                    <div style="border-left: 4px solid var(--warning); padding-left: 15px; margin-bottom: 20px;">
                        <h4 style="color: var(--warning); margin-bottom: 10px;">4. Your Rights</h4>
                        <p style="color: var(--gray);">You have the right to access, correct, or delete your personal data. Contact us at support@airtimesolutionkenya.com for any privacy-related requests.</p>
                    </div>
                    
                    <div style="text-align: center;">
                        <img src="privacy2.png" alt="Data Protection" style="max-width: 100%; border-radius: 12px;" onerror="this.style.display='none'">
                    </div>
                </div>
            </div>

            <div id="page-terms" class="page">
                <div class="card">
                    <h3 class="card-title"><i class="fas fa-file-contract"></i> <span data-translate="termsOfService">Terms of Service</span></h3>
                    
                    <div style="background: var(--light); padding: 15px; border-radius: 12px; margin-bottom: 20px;">
                        <p style="color: var(--gray);"><i class="fas fa-calendar" style="margin-right: 8px;"></i><strong>Effective Date:</strong> December 2025</p>
                    </div>
                    
                    <p style="margin-bottom: 20px;">Please read these Terms of Service carefully before using Airtime Solution Kenya.</p>
                    
                    <div style="background: var(--light); padding: 20px; border-radius: 12px; margin-bottom: 15px;">
                        <h4 style="color: var(--primary); margin-bottom: 10px;"><i class="fas fa-handshake" style="margin-right: 8px;"></i>1. Acceptance of Terms</h4>
                        <p style="color: var(--gray);">By accessing or using Airtime Solution Kenya, you agree to be bound by these Terms of Service. If you do not agree, please do not use our services.</p>
                    </div>
                    
                    <div style="background: var(--light); padding: 20px; border-radius: 12px; margin-bottom: 15px;">
                        <h4 style="color: var(--primary); margin-bottom: 10px;"><i class="fas fa-cogs" style="margin-right: 8px;"></i>2. Services Provided</h4>
                        <ul style="margin-left: 15px; color: var(--gray); line-height: 1.8;">
                            <li>Airtime purchase for Safaricom, Airtel, and Telkom networks</li>
                            <li>Wallet deposit and management</li>
                            <li>Airtime to cash conversion (coming soon)</li>
                            <li>All completed transactions are final and non-reversible</li>
                        </ul>
                    </div>
                    
                    <div style="background: var(--light); padding: 20px; border-radius: 12px; margin-bottom: 15px;">
                        <h4 style="color: var(--primary); margin-bottom: 10px;"><i class="fas fa-user-shield" style="margin-right: 8px;"></i>3. User Responsibilities</h4>
                        <ul style="margin-left: 15px; color: var(--gray); line-height: 1.8;">
                            <li>Maintain the security of your account credentials</li>
                            <li>Provide accurate phone numbers for transactions</li>
                            <li>Report any unauthorized activity immediately</li>
                            <li>Use services only for lawful purposes</li>
                        </ul>
                    </div>
                    
                    <div style="background: var(--light); padding: 20px; border-radius: 12px; margin-bottom: 15px;">
                        <h4 style="color: var(--primary); margin-bottom: 10px;"><i class="fas fa-ban" style="margin-right: 8px;"></i>4. Prohibited Activities</h4>
                        <ul style="margin-left: 15px; color: var(--gray); line-height: 1.8;">
                            <li>Fraudulent transactions or money laundering</li>
                            <li>Attempting to exploit system vulnerabilities</li>
                            <li>Using the service for illegal purposes</li>
                            <li>Sharing account credentials with others</li>
                        </ul>
                    </div>
                    
                    <div style="background: var(--light); padding: 20px; border-radius: 12px;">
                        <h4 style="color: var(--primary); margin-bottom: 10px;"><i class="fas fa-gavel" style="margin-right: 8px;"></i>5. Limitation of Liability</h4>
                        <p style="color: var(--gray);">Airtime Solution Kenya shall not be liable for any indirect, incidental, or consequential damages arising from the use of our services. Our maximum liability is limited to the amount of the transaction in question.</p>
                    </div>
                </div>
            </div>

            <div id="page-cookies" class="page">
                <div class="card">
                    <h3 class="card-title"><i class="fas fa-cookie-bite"></i> Cookie Policy</h3>
                    
                    <p style="margin-bottom: 20px;">We use cookies to enhance your experience on Airtime Solution Kenya. This policy explains what cookies are and how we use them.</p>
                    
                    <div style="background: var(--light); padding: 20px; border-radius: 12px; margin-bottom: 15px;">
                        <h4 style="color: var(--primary); margin-bottom: 10px;"><i class="fas fa-question-circle" style="margin-right: 8px;"></i>What Are Cookies?</h4>
                        <p style="color: var(--gray);">Cookies are small text files stored on your device when you visit a website. They help us remember your preferences and improve your experience.</p>
                    </div>
                    
                    <div style="background: var(--light); padding: 20px; border-radius: 12px; margin-bottom: 15px;">
                        <h4 style="color: var(--primary); margin-bottom: 10px;"><i class="fas fa-list" style="margin-right: 8px;"></i>Types of Cookies We Use</h4>
                        <div style="margin-top: 15px;">
                            <div style="display: flex; align-items: start; margin-bottom: 15px;">
                                <i class="fas fa-check-circle" style="color: var(--success); margin-right: 10px; margin-top: 3px;"></i>
                                <div>
                                    <p style="font-weight: 600;">Essential Cookies</p>
                                    <p style="color: var(--gray); font-size: 0.9rem;">Required for basic functionality like authentication and security.</p>
                                </div>
                            </div>
                            <div style="display: flex; align-items: start; margin-bottom: 15px;">
                                <i class="fas fa-chart-bar" style="color: var(--info); margin-right: 10px; margin-top: 3px;"></i>
                                <div>
                                    <p style="font-weight: 600;">Analytics Cookies</p>
                                    <p style="color: var(--gray); font-size: 0.9rem;">Help us understand how users interact with our platform.</p>
                                </div>
                            </div>
                            <div style="display: flex; align-items: start;">
                                <i class="fas fa-sliders-h" style="color: var(--secondary); margin-right: 10px; margin-top: 3px;"></i>
                                <div>
                                    <p style="font-weight: 600;">Preference Cookies</p>
                                    <p style="color: var(--gray); font-size: 0.9rem;">Remember your settings like language and theme preferences.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div style="background: linear-gradient(135deg, var(--primary), var(--primary-dark)); padding: 20px; border-radius: 12px; color: white; text-align: center;">
                        <h4 style="margin-bottom: 15px;"><i class="fas fa-cookie" style="margin-right: 8px;"></i>Your Cookie Preferences</h4>
                        <p style="opacity: 0.9; margin-bottom: 15px;">Choose which cookies you want to accept:</p>
                        <div style="display: flex; gap: 10px; justify-content: center;">
                            <button class="btn btn-secondary" style="flex: 1; max-width: 150px;" onclick="acceptCookies()">Accept All</button>
                            <button class="btn" style="flex: 1; max-width: 150px; background: rgba(255,255,255,0.2); color: white;" onclick="rejectCookies()">Essential Only</button>
                        </div>
                    </div>
                </div>
            </div>

            <div id="page-admin" class="page">
                <div id="adminLogin" class="card" style="max-width: 400px; margin: 0 auto;">
                    <h3 class="card-title"><i class="fas fa-user-shield"></i> Admin Login</h3>
                    <form id="adminLoginForm">
                        <div class="form-group">
                            <label class="form-label"><i class="fas fa-lock"></i> Admin Password</label>
                            <input type="password" class="form-input" id="adminPassword" placeholder="Enter admin password" required>
                        </div>
                        <button type="submit" class="btn btn-primary" id="adminLoginBtn">
                            <i class="fas fa-sign-in-alt"></i> Login
                        </button>
                    </form>
                </div>

                <div id="adminDashboard" style="display: none;">
                    <div class="stats-grid">
                        <div class="stat-card">
                            <i class="fas fa-users"></i>
                            <div class="value" id="statTotalUsers">0</div>
                            <div class="label">Total Users</div>
                        </div>
                        <div class="stat-card">
                            <i class="fas fa-wallet"></i>
                            <div class="value" id="statTotalDeposits">0</div>
                            <div class="label">Total Deposits</div>
                        </div>
                        <div class="stat-card">
                            <i class="fas fa-mobile-alt"></i>
                            <div class="value" id="statTotalAirtime">0</div>
                            <div class="label">Total Airtime</div>
                        </div>
                        <div class="stat-card">
                            <i class="fas fa-clock"></i>
                            <div class="value" id="statPendingVerifications">0</div>
                            <div class="label">Pending</div>
                        </div>
                    </div>

                    <div class="admin-tabs">
                        <button class="admin-tab active" onclick="showAdminTab('users')">Users</button>
                        <button class="admin-tab" onclick="showAdminTab('transactions')">Transactions</button>
                        <button class="admin-tab" onclick="showAdminTab('verifications')">Verifications</button>
                        <button class="admin-tab" onclick="showAdminTab('notifications')">Send Notification</button>
                        <button class="admin-tab" onclick="showAdminTab('settings')">Settings</button>
                    </div>

                    <div class="card" id="adminTabUsers">
                        <h3 class="card-title">All Users</h3>
                        <div class="table-responsive">
                            <table class="data-table" id="usersTable">
                                <thead>
                                    <tr>
                                        <th>Email</th>
                                        <th>Balance</th>
                                        <th>Bonus</th>
                                        <th>Status</th>
                                        <th>Created</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>

                    <div class="card" id="adminTabTransactions" style="display: none;">
                        <h3 class="card-title">All Transactions</h3>
                        <div class="table-responsive">
                            <table class="data-table" id="adminTxTable">
                                <thead>
                                    <tr>
                                        <th>User</th>
                                        <th>Type</th>
                                        <th>Amount</th>
                                        <th>Phone</th>
                                        <th>Status</th>
                                        <th>Date</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>

                    <div class="card" id="adminTabVerifications" style="display: none;">
                        <h3 class="card-title">Deposit Verifications</h3>
                        <div class="table-responsive">
                            <table class="data-table" id="verificationsTable">
                                <thead>
                                    <tr>
                                        <th>User</th>
                                        <th>M-Pesa Code</th>
                                        <th>Amount</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>

                    <div class="card" id="adminTabNotifications" style="display: none;">
                        <h3 class="card-title">Send Notification</h3>
                        <form id="adminNotificationForm">
                            <div class="form-group">
                                <label class="form-label">Recipient</label>
                                <select class="form-input" id="notifRecipient">
                                    <option value="">All Users</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Title</label>
                                <input type="text" class="form-input" id="notifTitle" placeholder="Notification title" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Message</label>
                                <textarea class="form-input" id="notifMessage" rows="4" placeholder="Enter your message" required></textarea>
                            </div>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-paper-plane"></i> Send Notification
                            </button>
                        </form>
                    </div>

                    <div class="card" id="adminTabSettings" style="display: none;">
                        <h3 class="card-title">System Settings</h3>
                        <div class="form-group">
                            <label class="form-label">Float Status</label>
                            <select class="form-input" id="floatStatusSelect" onchange="updateFloatStatus(this.value)">
                                <option value="false">Available</option>
                                <option value="true">Low / Unavailable</option>
                            </select>
                        </div>
                        <div class="form-group" style="margin-top: 20px;">
                            <label class="form-label">Deposit Status</label>
                            <select class="form-input" id="depositStatusSelect" onchange="updateDepositStatus(this.value)">
                                <option value="false">Enabled</option>
                                <option value="true">Disabled</option>
                            </select>
                            <p style="font-size: 0.85rem; color: var(--gray); margin-top: 5px;">When disabled, users cannot make new deposits.</p>
                        </div>
                    </div>

                    <button class="btn btn-outline" style="margin-top: 20px;" onclick="logoutAdmin()">
                        <i class="fas fa-sign-out-alt"></i> Logout Admin
                    </button>
                </div>
            </div>
        </main>

        <div class="notification-panel" id="notificationPanel">
            <div class="notification-header">
                <h4><i class="fas fa-bell"></i> Notifications</h4>
                <button onclick="toggleNotifications()" style="background: none; border: none; cursor: pointer;">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="notification-list" id="notificationList">
                <div class="empty-state" style="padding: 30px;">
                    <i class="fas fa-bell-slash"></i>
                    <p>No notifications yet</p>
                </div>
            </div>
        </div>

        <div class="modal" id="insufficientModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3><i class="fas fa-exclamation-triangle" style="color: var(--warning);"></i> Insufficient Balance</h3>
                    <button class="modal-close" onclick="closeModal('insufficientModal')">&times;</button>
                </div>
                <div class="modal-body">
                    <p style="margin-bottom: 15px;">You need <strong>KES <span id="insufficientShortfall">0</span></strong> more to complete this purchase.</p>
                    <div class="form-group">
                        <label class="form-label"><i class="fas fa-phone"></i> Phone Number</label>
                        <div class="phone-wrapper">
                            <span class="phone-prefix">+254</span>
                            <input type="tel" class="form-input" id="modalDepositPhone" maxlength="9">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label"><i class="fas fa-money-bill"></i> Amount to Deposit</label>
                        <input type="number" class="form-input" id="modalDepositAmount" min="10">
                    </div>
                    <div class="btn-group">
                        <button class="btn btn-primary" onclick="depositFromModal()">
                            <i class="fas fa-mobile-alt"></i> Deposit via M-Pesa STK
                        </button>
                        <button class="btn btn-link" onclick="depositFromModalLink()">
                            <i class="fas fa-link"></i> Deposit with Payment Link
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div class="modal" id="authModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3><i class="fas fa-lock"></i> Login Required</h3>
                    <button class="modal-close" onclick="closeModal('authModal')">&times;</button>
                </div>
                <div class="modal-body">
                    <p style="margin-bottom: 20px;">Please login / create an account or use the USE WITHOUT ACCOUNT button below to buy airtime directly no account needed.</p>
                    <div class="btn-group">
                        <a href="login.html" class="btn btn-primary"><i class="fas fa-sign-in-alt"></i> Login</a>
                        <a href="login.html" class="btn btn-outline"><i class="fas fa-user-plus"></i> Sign Up</a>
                    </div>
                    <div class="divider-text"><span>OR</span></div>
                    <button class="btn btn-secondary" onclick="closeModal('authModal'); scrollToDirectBuy();" style="margin-top: 10px;">
                        <i class="fas fa-bolt"></i> Use Without Account  to buy airtime directly
                    </button>
                </div>
            </div>
        </div>

        <div class="modal" id="directBuyReceiptModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3><i class="fas fa-receipt"></i> Transaction Receipt</h3>
                    <button class="modal-close" onclick="closeModal('directBuyReceiptModal')">&times;</button>
                </div>
                <div class="modal-body">
                    <div id="receiptContent" style="text-align: center;">
                        <div id="receiptIcon" style="font-size: 4rem; margin-bottom: 20px;"></div>
                        <h4 id="receiptStatus" style="font-size: 1.3rem; margin-bottom: 15px;"></h4>
                        <div style="background: var(--light); border-radius: 12px; padding: 20px; margin: 20px 0;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                                <span style="color: var(--gray);">Phone:</span>
                                <span id="receiptPhone" style="font-weight: 600;"></span>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                                <span style="color: var(--gray);">Amount:</span>
                                <span id="receiptAmount" style="font-weight: 600;"></span>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                                <span style="color: var(--gray);">Network:</span>
                                <span id="receiptNetwork" style="font-weight: 600;"></span>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                                <span style="color: var(--gray);">Transaction ID:</span>
                                <span id="receiptTxId" style="font-weight: 600; font-size: 0.85rem;"></span>
                            </div>
                            <div style="display: flex; justify-content: space-between;">
                                <span style="color: var(--gray);">Date:</span>
                                <span id="receiptDate" style="font-weight: 600;"></span>
                            </div>
                        </div>
                        <p id="receiptMessage" style="color: var(--gray); font-size: 0.9rem;"></p>
                    </div>
                    <button class="btn btn-primary" onclick="closeModal('directBuyReceiptModal')" style="margin-top: 15px;">
                        <i class="fas fa-check"></i> Done
                    </button>
                </div>
            </div>
        </div>

        <div class="toast" id="toast">
            <i class="fas fa-info-circle"></i>
            <span id="toastMessage">Message</span>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js';
        import { getAuth, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js';

        const firebaseConfig = {
            apiKey: "AIzaSyBtx-D3nbl1lKOhCzEixDZRgRDM4NbtOBE",
            authDomain: "swiftauth-5fcb5.firebaseapp.com",
            projectId: "swiftauth-5fcb5",
            storageBucket: "swiftauth-5fcb5.firebasestorage.app",
            messagingSenderId: "990160652137",
            appId: "1:990160652137:web:abac238567edfdb5671ff8",
            measurementId: "G-5C1DS28B5S"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);

        const API_BASE = 'https://airtimesolutionbackend2.onrender.com';

        let currentUser = null;
        let adminLoggedIn = false;
        let deferredPrompt = null;
        let balanceRefreshInterval = null;
        let depositRefreshInterval = null;
        let pendingPurchase = null;
        let currentDepositReference = null;

        function showLoading(text = 'Loading...') {
            document.getElementById('loadingText').textContent = text;
            document.getElementById('loadingOverlay').classList.add('show');
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').classList.remove('show');
        }

        function showBalanceOverlay() {
            document.getElementById('balanceOverlay').classList.add('show');
        }

        function hideBalanceOverlay() {
            document.getElementById('balanceOverlay').classList.remove('show');
        }

        onAuthStateChanged(auth, async (user) => {
            const email = localStorage.getItem('userEmail');
            if (user && email) {
                await loadUserData(email);
            } else if (!email) {
                showAuthModal();
            }
        });

        async function loadUserData(email) {
            try {
                showLoading('Loading your account...');
                const response = await fetch(`${API_BASE}/api/users/by-email/${encodeURIComponent(email)}`);
                const data = await response.json();
                if (data.success) {
                    currentUser = { ...data.user, email };
                    updateUI();
                    loadNotifications();
                    loadTransactions();
                    startAutoRefresh();
                    hideLoading();
                } else {
                    hideLoading();
                    showAuthModal();
                }
            } catch (error) {
                console.error('Failed to load user data:', error);
                hideLoading();
                const cached = localStorage.getItem('cachedBalance');
                if (cached) {
                    const data = JSON.parse(cached);
                    currentUser = { email, balance: data.balance, bonus_balance: data.bonus };
                    updateUI();
                }
            }
        }

        function updateUI() {
            if (currentUser) {
                const total = parseFloat(currentUser.balance || 0) + parseFloat(currentUser.bonus_balance || 0);
                document.getElementById('headerBalance').textContent = total.toFixed(2);
                document.getElementById('sidebarEmail').textContent = currentUser.email;
                document.getElementById('sidebarBalance').textContent = `KES ${total.toFixed(2)}`;
                document.getElementById('dashboardBalance').textContent = `KES ${total.toFixed(2)}`;
                document.getElementById('profileEmail').value = currentUser.email;
                document.getElementById('profilePhone').value = localStorage.getItem('userPhone')?.replace('254', '') || '';
            }
        }

        function startAutoRefresh() {
            if (balanceRefreshInterval) clearInterval(balanceRefreshInterval);
            balanceRefreshInterval = setInterval(() => {
                if (currentUser) {
                    silentRefreshBalance();
                }
            }, 30000);
        }

        function startDepositRefresh() {
            if (depositRefreshInterval) clearInterval(depositRefreshInterval);
            depositRefreshInterval = setInterval(() => {
                if (currentUser) {
                    silentRefreshBalance();
                    silentRefreshTransactions();
                }
            }, 2000);
        }

        function stopDepositRefresh() {
            if (depositRefreshInterval) {
                clearInterval(depositRefreshInterval);
                depositRefreshInterval = null;
            }
        }

        async function silentRefreshBalance() {
            if (!currentUser) return;
            try {
                const response = await fetch(`${API_BASE}/api/users/balance-by-email/${encodeURIComponent(currentUser.email)}`);
                const data = await response.json();
                if (data.success) {
                    currentUser.balance = data.balance;
                    currentUser.bonus_balance = data.bonus;
                    updateUI();
                    localStorage.setItem('cachedBalance', JSON.stringify({
                        balance: data.balance,
                        bonus: data.bonus,
                        total: data.total,
                        timestamp: Date.now()
                    }));
                }
            } catch (error) {
                console.error('Silent refresh error:', error);
            }
        }

        async function silentRefreshTransactions() {
            if (!currentUser) return;
            try {
                const response = await fetch(`${API_BASE}/api/transactions/${encodeURIComponent(currentUser.email)}`);
                const data = await response.json();
                if (data.success) {
                    renderTransactions(data.transactions);
                }
            } catch (error) {
                console.error('Silent transaction refresh error:', error);
            }
        }

        window.refreshBalance = async function() {
            if (!currentUser) return;
            const btn = document.getElementById('refreshBtn');
            btn.classList.add('spinning');
            try {
                const response = await fetch(`${API_BASE}/api/users/balance-by-email/${encodeURIComponent(currentUser.email)}`);
                const data = await response.json();
                if (data.success) {
                    currentUser.balance = data.balance;
                    currentUser.bonus_balance = data.bonus;
                    updateUI();
                    showToast('Balance refreshed successfully!', 'success');
                }
            } catch (error) {
                showToast('Failed to refresh balance', 'error');
            }
            btn.classList.remove('spinning');
        };

        async function loadNotifications() {
            if (!currentUser) return;
            try {
                const response = await fetch(`${API_BASE}/api/notifications/${encodeURIComponent(currentUser.email)}`);
                const data = await response.json();
                if (data.success) {
                    renderNotifications(data.notifications);
                }
            } catch (error) {
                console.error('Failed to load notifications:', error);
            }
        }

        function renderNotifications(notifications) {
            const list = document.getElementById('notificationList');
            const unreadCount = notifications.filter(n => !n.is_read).length;
            document.getElementById('notifBadge').textContent = unreadCount;
            const notifBtn = document.querySelector('.notification-btn');
            if (unreadCount > 0) {
                notifBtn.classList.add('has-notification');
            } else {
                notifBtn.classList.remove('has-notification');
            }
            if (notifications.length === 0) {
                list.innerHTML = '<div class="empty-state" style="padding: 30px;"><i class="fas fa-bell-slash"></i><p>No notifications yet</p></div>';
                return;
            }
            list.innerHTML = notifications.map(n => `
                <div class="notification-item ${!n.is_read ? 'unread' : ''}" onclick="markNotificationRead('${n.id}')">
                    <h5>${n.title}</h5>
                    <p>${n.message}</p>
                    <div class="time">${new Date(n.created_at).toLocaleString()}</div>
                </div>
            `).join('');
        }

        window.markNotificationRead = async function(id) {
            try {
                await fetch(`${API_BASE}/api/notifications/${id}/read`, { method: 'PUT' });
                loadNotifications();
            } catch (error) {
                console.error('Failed to mark as read:', error);
            }
        };

        async function loadTransactions() {
            if (!currentUser) return;
            try {
                const response = await fetch(`${API_BASE}/api/transactions/${encodeURIComponent(currentUser.email)}`);
                const data = await response.json();
                if (data.success) {
                    renderTransactions(data.transactions);
                }
            } catch (error) {
                console.error('Failed to load transactions:', error);
            }
        }

        function renderTransactions(transactions) {
            const renderList = (containerId, limit = null) => {
                const container = document.getElementById(containerId);
                const txToShow = limit ? transactions.slice(0, limit) : transactions;
                if (txToShow.length === 0) {
                    container.innerHTML = '<div class="empty-state"><i class="fas fa-inbox"></i><h3>No transactions</h3><p>Your transactions will appear here</p></div>';
                    return;
                }
                container.innerHTML = txToShow.map(tx => {
                    let iconClass = tx.type === 'deposit' ? 'deposit' : 'airtime';
                    if (tx.status === 'failed' || tx.status === 'cancelled') iconClass = 'failed';
                    if (tx.status === 'pending') iconClass = 'pending';
                    const icon = tx.type === 'deposit' ? 'fa-arrow-down' : 'fa-mobile-alt';
                    
                    let statusClass = 'status-pending';
                    let statusLabel = tx.status;
                    if (tx.status === 'completed') {
                        statusClass = 'status-completed';
                        statusLabel = 'Completed';
                    } else if (tx.status === 'pending') {
                        statusClass = 'status-pending';
                        statusLabel = 'Pending';
                    } else if (tx.status === 'failed') {
                        statusClass = 'status-failed';
                        statusLabel = 'Failed';
                    } else if (tx.status === 'cancelled') {
                        statusClass = 'status-cancelled';
                        statusLabel = 'Cancelled';
                    }
                    
                    return `
                        <div class="transaction-item">
                            <div class="transaction-info">
                                <div class="transaction-icon ${iconClass}"><i class="fas ${icon}"></i></div>
                                <div class="transaction-details">
                                    <h4>${tx.type.charAt(0).toUpperCase() + tx.type.slice(1)}</h4>
                                    <p>${tx.phone || '-'} - ${new Date(tx.created_at).toLocaleDateString()}</p>
                                </div>
                            </div>
                            <div class="transaction-amount">
                                <div class="amount" style="color: ${tx.type === 'deposit' ? 'var(--success)' : 'var(--dark)'};">
                                    ${tx.type === 'deposit' ? '+' : '-'}KES ${tx.amount}
                                </div>
                                ${tx.bonus > 0 ? `<div class="bonus">+${tx.bonus} bonus</div>` : ''}
                                <span class="status ${statusClass}">${statusLabel}</span>
                            </div>
                        </div>
                    `;
                }).join('');
            };
            renderList('recentTransactions', 5);
            renderList('allTransactions');
        }

        window.showPage = function(pageId) {
            const protectedPages = ['deposit', 'buy-airtime', 'sell-airtime', 'airtime-to-cash', 'transactions', 'verify-deposit', 'settings', 'profile'];
            if (protectedPages.includes(pageId) && !currentUser) {
                showAuthModal();
                return;
            }
            if (pageId === 'sell-airtime') checkFloatStatus();
            if (pageId === 'deposit') startDepositRefresh();
            else stopDepositRefresh();
            if (pageId === 'admin' && adminLoggedIn) {
                loadAdminData();
                startAdminAutoRefresh();
            }
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(`page-${pageId}`).classList.add('active');
            document.querySelectorAll('.menu-item').forEach(m => m.classList.remove('active'));
            document.querySelector(`.menu-item[onclick*="${pageId}"]`)?.classList.add('active');
            closeSidebar();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        };

        window.toggleSidebar = function() {
            document.getElementById('sidebar').classList.toggle('open');
            document.querySelector('.sidebar-overlay').classList.toggle('show');
        };

        window.closeSidebar = function() {
            document.getElementById('sidebar').classList.remove('open');
            document.querySelector('.sidebar-overlay').classList.remove('show');
        };

        window.toggleNotifications = function() {
            document.getElementById('notificationPanel').classList.toggle('show');
        };

        window.showToast = function(message, type = 'info') {
            const toast = document.getElementById('toast');
            toast.className = `toast show ${type}`;
            document.getElementById('toastMessage').textContent = message;
            setTimeout(() => toast.classList.remove('show'), 4000);
        };

        window.closeModal = function(modalId) {
            document.getElementById(modalId).classList.remove('show');
        };

        function showAuthModal() {
            document.getElementById('authModal').classList.add('show');
        }

        // Network Selection and Validation for Buy Airtime
        let selectedNetworkValue = '';
        let selectedSendNetworkValue = '';

        window.selectNetwork = function(network) {
            // Remove selected class from Buy Airtime options only
            document.querySelectorAll('#buyAirtimeForm .network-option').forEach(opt => {
                opt.classList.remove('selected');
            });
            // Add selected class to clicked option
            document.querySelector(`#buyAirtimeForm .network-option[data-network="${network}"]`).classList.add('selected');
            selectedNetworkValue = network;
            document.getElementById('selectedNetwork').value = network;
            // Hide network error
            document.getElementById('networkError').classList.remove('show');
            // Validate form
            validateAirtimeForm();
        };

        // Network Selection and Validation for Send Airtime
        window.selectSendNetwork = function(network) {
            // Remove selected class from Send Airtime options only
            document.querySelectorAll('#sellAirtimeForm .network-option').forEach(opt => {
                opt.classList.remove('selected');
            });
            // Add selected class to clicked option
            document.querySelector(`#sellAirtimeForm .network-option[data-network="${network}"]`).classList.add('selected');
            selectedSendNetworkValue = network;
            document.getElementById('selectedSendNetwork').value = network;
            // Hide network error
            document.getElementById('sendNetworkError').classList.remove('show');
            // Validate form
            validateSendForm();
        };

        window.validateSendPhone = function() {
            const phoneInput = document.getElementById('sellAirtimePhone');
            const phoneError = document.getElementById('sendPhoneError');
            const phone = phoneInput.value.trim();
            
            const isValid = /^[71][0-9]{8}$/.test(phone);
            
            if (phone.length === 0) {
                phoneInput.classList.remove('valid', 'invalid');
                phoneError.classList.remove('show');
            } else if (isValid) {
                phoneInput.classList.remove('invalid');
                phoneInput.classList.add('valid');
                phoneError.classList.remove('show');
            } else {
                phoneInput.classList.remove('valid');
                phoneInput.classList.add('invalid');
                phoneError.classList.add('show');
            }
            validateSendForm();
            return isValid;
        };

        window.validateSendAmount = function() {
            const amountInput = document.getElementById('sellAirtimeAmount');
            const amountError = document.getElementById('sendAmountError');
            const amount = parseInt(amountInput.value) || 0;
            
            const isValid = amount >= 10;
            
            if (amountInput.value === '') {
                amountInput.classList.remove('valid', 'invalid');
                amountError.classList.remove('show');
            } else if (isValid) {
                amountInput.classList.remove('invalid');
                amountInput.classList.add('valid');
                amountError.classList.remove('show');
            } else {
                amountInput.classList.remove('valid');
                amountInput.classList.add('invalid');
                amountError.classList.add('show');
            }
            validateSendForm();
            return isValid;
        };

        function validateSendForm() {
            const network = document.getElementById('selectedSendNetwork').value;
            const phone = document.getElementById('sellAirtimePhone').value.trim();
            const amount = parseInt(document.getElementById('sellAirtimeAmount').value) || 0;
            
            const isNetworkSelected = network !== '';
            const isPhoneValid = /^[71][0-9]{8}$/.test(phone);
            const isAmountValid = amount >= 10;
            
            const isFormValid = isNetworkSelected && isPhoneValid && isAmountValid;
            
            // Enable/disable send buttons
            document.getElementById('sellAirtimeBalanceBtn').disabled = !isFormValid;
            
            return isFormValid;
        }

        window.validateAirtimePhone = function() {
            const phoneInput = document.getElementById('airtimePhone');
            const phoneError = document.getElementById('phoneError');
            const phone = phoneInput.value.trim();
            
            // Kenyan phone numbers start with 7 or 1 and have 9 digits
            const isValid = /^[71][0-9]{8}$/.test(phone);
            
            if (phone.length === 0) {
                phoneInput.classList.remove('valid', 'invalid');
                phoneError.classList.remove('show');
            } else if (isValid) {
                phoneInput.classList.remove('invalid');
                phoneInput.classList.add('valid');
                phoneError.classList.remove('show');
            } else {
                phoneInput.classList.remove('valid');
                phoneInput.classList.add('invalid');
                phoneError.classList.add('show');
            }
            validateAirtimeForm();
            return isValid;
        };

        window.validateAirtimeAmount = function() {
            const amountInput = document.getElementById('airtimeAmount');
            const amountError = document.getElementById('amountError');
            const amount = parseInt(amountInput.value) || 0;
            
            const isValid = amount >= 10;
            
            if (amountInput.value === '') {
                amountInput.classList.remove('valid', 'invalid');
                amountError.classList.remove('show');
            } else if (isValid) {
                amountInput.classList.remove('invalid');
                amountInput.classList.add('valid');
                amountError.classList.remove('show');
            } else {
                amountInput.classList.remove('valid');
                amountInput.classList.add('invalid');
                amountError.classList.add('show');
            }
            validateAirtimeForm();
            return isValid;
        };

        function validateAirtimeForm() {
            const network = document.getElementById('selectedNetwork').value;
            const phone = document.getElementById('airtimePhone').value.trim();
            const amount = parseInt(document.getElementById('airtimeAmount').value) || 0;
            
            const isNetworkSelected = network !== '';
            const isPhoneValid = /^[71][0-9]{8}$/.test(phone);
            const isAmountValid = amount >= 10;
            
            const isFormValid = isNetworkSelected && isPhoneValid && isAmountValid;
            
            // Enable/disable all buy buttons
            document.getElementById('buyAirtimeBtn').disabled = !isFormValid;
            document.getElementById('directPurchaseBtn').disabled = !isFormValid;
            
            return isFormValid;
        }

        // Override form submit to check network selection
        document.addEventListener('DOMContentLoaded', function() {
            const buyAirtimeForm = document.getElementById('buyAirtimeForm');
            if (buyAirtimeForm) {
                buyAirtimeForm.addEventListener('submit', function(e) {
                    if (!selectedNetworkValue) {
                        e.preventDefault();
                        document.getElementById('networkError').classList.add('show');
                        showToast('Please select a network first', 'error');
                        return false;
                    }
                    if (!validateAirtimeForm()) {
                        e.preventDefault();
                        showToast('Please fill all fields correctly', 'error');
                        return false;
                    }
                });
            }
        });

        function formatPhoneNumber(phone) {
            let cleaned = phone.replace(/\s+/g, '').replace(/[^0-9]/g, '');
            if (cleaned.startsWith('0')) {
                cleaned = '254' + cleaned.substring(1);
            } else if (cleaned.startsWith('+254')) {
                cleaned = cleaned.substring(1);
            } else if (!cleaned.startsWith('254')) {
                cleaned = '254' + cleaned;
            }
            return cleaned;
        }

        document.getElementById('depositForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!currentUser) { showAuthModal(); return; }
            
            const rawPhone = document.getElementById('depositPhone').value;
            const phone = formatPhoneNumber(rawPhone);
            const amount = parseInt(document.getElementById('depositAmount').value);
            
            lastDepositPhone = rawPhone;
            lastDepositAmount = amount;
            
            if (amount < 10) { 
                showToast('Minimum deposit is KES 10', 'error'); 
                return; 
            }
            
            if (phone.length !== 12) {
                showToast('Please enter a valid phone number', 'error');
                return;
            }
            
            const btn = document.getElementById('depositStkBtn');
            btn.disabled = true;
            btn.innerHTML = '<div class="spinner"></div> Sending STK Push...';
            showLoading('Sending STK Push to ' + phone.substring(0, 6) + '...');
            
            try {
                const response = await fetch(`${API_BASE}/api/payments/deposit`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email: currentUser.email, phone: phone, amount: amount })
                });
                const data = await response.json();
                
                hideLoading();
                
                if (data.success) {
                    currentDepositReference = data.reference;
                    showToast('STK Push sent! Enter your M-Pesa PIN.', 'success');
                    btn.innerHTML = '<div class="spinner"></div> Waiting for payment...';
                    pollDepositStatus(data.reference);
                } else {
                    showToast(data.message || 'Failed to send STK Push', 'error');
                    btn.disabled = false;
                    btn.innerHTML = '<i class="fas fa-mobile-alt"></i> Deposit via M-Pesa STK Push';
                }
            } catch (error) {
                hideLoading();
                showToast('Failed to initiate deposit. Please try again.', 'error');
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-mobile-alt"></i> Deposit via M-Pesa STK Push';
            }
        });

        let lastDepositPhone = '';
        let lastDepositAmount = 0;

        async function pollDepositStatus(reference) {
            let attempts = 0;
            const maxAttempts = 45;
            const btn = document.getElementById('depositStkBtn');
            const retryBtn = document.getElementById('retryDepositBtn');
            const statusDiv = document.getElementById('depositStatus');
            const statusText = document.getElementById('depositStatusText');
            
            statusDiv.style.display = 'block';
            statusText.textContent = 'Waiting for M-Pesa confirmation...';
            retryBtn.classList.remove('show');
            
            const poll = setInterval(async () => {
                attempts++;
                
                if (attempts > maxAttempts) {
                    clearInterval(poll);
                    showToast('Payment confirmation delayed. Your balance will update automatically once confirmed.', 'delay');
                    btn.disabled = false;
                    btn.innerHTML = '<i class="fas fa-mobile-alt"></i> Deposit via M-Pesa STK Push';
                    statusDiv.style.display = 'none';
                    retryBtn.classList.add('show');
                    silentRefreshBalance();
                    loadTransactions();
                    return;
                }
                
                statusText.textContent = `Checking payment status... (${attempts}/${maxAttempts})`;
                
                try {
                    const response = await fetch(`${API_BASE}/api/payments/status/${reference}`);
                    const data = await response.json();
                    
                    if (data.success && data.transaction.status === 'completed') {
                        clearInterval(poll);
                        statusDiv.style.display = 'none';
                        showToast('Deposit successful! Your balance has been updated.', 'success');
                        btn.disabled = false;
                        btn.innerHTML = '<i class="fas fa-mobile-alt"></i> Deposit via M-Pesa STK Push';
                        retryBtn.classList.remove('show');
                        await silentRefreshBalance();
                        await loadTransactions();
                        await loadNotifications();
                        document.getElementById('depositForm').reset();
                    } else if (data.success && data.transaction.status === 'failed') {
                        clearInterval(poll);
                        statusDiv.style.display = 'none';
                        showToast('Payment was cancelled. Please try again.', 'cancel');
                        btn.disabled = false;
                        btn.innerHTML = '<i class="fas fa-mobile-alt"></i> Deposit via M-Pesa STK Push';
                        retryBtn.classList.add('show');
                        silentRefreshBalance();
                        loadTransactions();
                    }
                } catch (error) {
                    console.error('Poll error:', error);
                }
            }, 2000);
        }

        window.retryDeposit = function() {
            if (lastDepositPhone && lastDepositAmount > 0) {
                document.getElementById('depositPhone').value = lastDepositPhone;
                document.getElementById('depositAmount').value = lastDepositAmount;
            }
            document.getElementById('retryDepositBtn').classList.remove('show');
            document.getElementById('depositForm').dispatchEvent(new Event('submit'));
        };

        window.depositWithLink = function() {
            const rawPhone = document.getElementById('depositPhone').value;
            const amount = document.getElementById('depositAmount').value;
            const email = currentUser?.email || 'Guest';
            
            if (!rawPhone || !amount) { 
                showToast('Please enter phone number and amount', 'error'); 
                return; 
            }
            
            const phone = formatPhoneNumber(rawPhone);
            const url = `https://short.payhero.co.ke/s/oEvAxA8Xx6cDoBLxntShmF?phone=${phone}&customer_name=${encodeURIComponent(email)}&amount=${amount}&reference=${encodeURIComponent('#airtime deposit')}`;
            window.open(url, '_blank');
        };

        document.getElementById('buyAirtimeForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!currentUser) { showAuthModal(); return; }
            if (!selectedNetworkValue) { 
                document.getElementById('networkError').classList.add('show');
                showToast('Please select a network first', 'error'); 
                return; 
            }
            const phone = '254' + document.getElementById('airtimePhone').value;
            const amount = parseInt(document.getElementById('airtimeAmount').value);
            if (amount < 10) { showToast('Minimum airtime is KES 10', 'error'); return; }
            const btn = document.getElementById('buyAirtimeBtn');
            btn.disabled = true;
            btn.innerHTML = '<div class="spinner"></div> Processing...';
            showBalanceOverlay();
            try {
                const response = await fetch(`${API_BASE}/api/airtime/buy`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email: currentUser.email, phone: phone, amount: amount })
                });
                const data = await response.json();
                hideBalanceOverlay();
                if (data.success) {
                    showToast(`Airtime sent! KES ${data.airtimeSent} to ${phone}`, 'success');
                    refreshBalance();
                    loadTransactions();
                } else if (data.shortfall) {
                    pendingPurchase = { phone, amount };
                    document.getElementById('shortfallAmount').textContent = `KES ${data.shortfall}`;
                    document.getElementById('modalDepositAmount').value = Math.ceil(data.shortfall);
                    document.getElementById('modalDepositPhone').value = document.getElementById('airtimePhone').value;
                    document.getElementById('insufficientModal').classList.add('show');
                } else {
                    showToast(data.message || 'Purchase failed', 'error');
                }
            } catch (error) {
                hideBalanceOverlay();
                showToast('Failed to buy airtime check balance or contact us', 'error');
            }
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-shopping-cart"></i> Buy Now (From your account balance)';
        });

        window.directAirtimePurchase = async function() {
            if (!selectedNetworkValue) { showToast('Please select a network first', 'error'); return; }
            const phone = document.getElementById('airtimePhone').value;
            const amount = document.getElementById('airtimeAmount').value;
            if (!phone || !amount) { showToast('Please enter phone number and amount', 'error'); return; }
            if (parseInt(amount) < 10) { showToast('Minimum airtime is KES 10', 'error'); return; }
            try {
                const response = await fetch(`${API_BASE}/api/airtime/direct`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ phone_to_receive: '254' + phone, phone_to_pay: '254' + phone, amount: parseInt(amount) })
                });
                const data = await response.json();
                if (data.success) {
                    showToast(`STK Push sent! You'll receive KES ${data.airtime_to_receive} airtime after payment.`, 'success');
                } else {
                    showToast(data.message || 'Failed', 'error');
                }
            } catch (error) {
                showToast('Failed to initiate purchase', 'error');
            }
        };

        window.buyAirtimeWithLink = function() {
            if (!selectedNetworkValue) { showToast('Please select a network first', 'error'); return; }
            const phone = document.getElementById('airtimePhone').value;
            const amount = document.getElementById('airtimeAmount').value;
            const email = currentUser?.email || 'Guest';
            if (!phone || !amount) { showToast('Please enter phone number and amount', 'error'); return; }
            if (parseInt(amount) < 10) { showToast('Minimum airtime is KES 10', 'error'); return; }
            const url = `https://short.payhero.co.ke/s/oEvAxA8Xx6cDoBLxntShmF?phone=254${phone}&customer_name=${encodeURIComponent(email)}&amount=${amount}&reference=${encodeURIComponent('#airtime purchase')}`;
            window.open(url, '_blank');
        };

        let floatAvailable = true;

        async function checkFloatStatus() {
            try {
                const response = await fetch(`${API_BASE}/api/airtime/float-status`);
                const data = await response.json();
                if (data.success) {
                    floatAvailable = !data.floatLow;
                    const statusDiv = document.getElementById('statumFloatStatus');
                    if (floatAvailable) {
                        statusDiv.innerHTML = `<p style="color: var(--success);"><i class="fas fa-check-circle"></i> Airtime service is available</p>`;
                    } else {
                        statusDiv.innerHTML = `<div style="background: linear-gradient(135deg, #fff3cd, #ffeeba); border: 1px solid #ffc107; border-radius: 12px; padding: 15px; margin-bottom: 15px;">
                            <p style="color: #856404; font-weight: 600; margin-bottom: 8px;"><i class="fas fa-exclamation-triangle"></i> Low Float Balance</p>
                            <p style="color: #856404; font-size: 0.9rem;">Our airtime float is currently low. The service will resume once the admin tops up the float. Please try again in a few minutes.</p>
                        </div>`;
                    }
                }
            } catch (error) {
                console.error('Float check error:', error);
            }
        }

        document.getElementById('sellAirtimeForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!currentUser) { showAuthModal(); return; }
            if (!selectedSendNetworkValue) { 
                document.getElementById('sendNetworkError').classList.add('show');
                showToast('Please select a network first', 'error'); 
                return; 
            }
            const phone = '254' + document.getElementById('sellAirtimePhone').value;
            const amount = parseInt(document.getElementById('sellAirtimeAmount').value);
            if (amount < 10) { showToast('Minimum airtime is KES 10', 'error'); return; }
            const btn = document.getElementById('sellAirtimeBalanceBtn');
            btn.disabled = true;
            btn.innerHTML = '<div class="spinner"></div> Processing...';
            showBalanceOverlay();
            try {
                const response = await fetch(`${API_BASE}/api/airtime/buy`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email: currentUser.email, phone: phone, amount: amount })
                });
                const data = await response.json();
                hideBalanceOverlay();
                if (data.success) {
                    let msg = `Airtime sold! KES ${data.airtimeSent || amount} to ${phone}`;
                    if (data.commission > 0) {
                        msg += `. You earned KES ${data.commission} commission!`;
                    }
                    showToast(msg, 'success');
                    refreshBalance();
                    loadTransactions();
                    document.getElementById('sellAirtimeForm').reset();
                    selectedSendNetworkValue = '';
                    document.querySelectorAll('.network-option[data-form="send"]').forEach(opt => opt.classList.remove('selected'));
                } else if (data.errorType === 'insufficient_balance' || data.shortfall) {
                    document.getElementById('insufficientShortfall').textContent = data.shortfall || (amount - (data.balance || 0));
                    document.getElementById('modalDepositAmount').value = Math.ceil(data.shortfall || (amount - (data.balance || 0)));
                    showModal('insufficientModal');
                } else {
                    showToast(data.message || 'Failed to sell airtime Reason:insufficient balance', 'error');
                }
            } catch (error) {
                hideBalanceOverlay();
                showToast('Failed to sell airtime Reason:insufficient balance', 'error');
            }
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-wallet"></i> Sell from Balance';
        });

        window.sellAirtimeWithStk = function() {
            if (!selectedSendNetworkValue) { showToast('Please select a network first', 'error'); return; }
            const phone = document.getElementById('sellAirtimePhone').value;
            const amount = document.getElementById('sellAirtimeAmount').value;
            const email = currentUser?.email || 'Guest';
            if (!phone || !amount) { showToast('Please enter phone number and amount', 'error'); return; }
            if (parseInt(amount) < 10) { showToast('Minimum airtime is KES 10', 'error'); return; }
            if (!floatAvailable) { showToast('Airtime service temporarily unavailable.', 'error'); return; }
            const url = `https://short.payhero.co.ke/s/oEvAxA8Xx6cDoBLxntShmF?phone=254${phone}&customer_name=${encodeURIComponent(email)}&amount=${amount}&reference=${encodeURIComponent('#airtime purchase')}`;
            window.open(url, '_blank');
        };

        window.depositFromModal = async function() {
            const phone = '254' + document.getElementById('modalDepositPhone').value;
            const amount = parseInt(document.getElementById('modalDepositAmount').value);
            const btn = document.querySelector('#insufficientModal .btn-primary');
            const originalBtnHtml = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<div class="spinner"></div> Sending STK Push...';
            
            try {
                const response = await fetch(`${API_BASE}/api/payments/deposit`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email: currentUser.email, phone: phone, amount: amount })
                });
                const data = await response.json();
                if (data.success) {
                    showToast('STK Push sent! Enter your M-Pesa PIN to complete.', 'success');
                    closeModal('insufficientModal');
                    pollDepositStatus(data.reference);
                } else {
                    showToast(data.message || 'Failed', 'error');
                    btn.disabled = false;
                    btn.innerHTML = originalBtnHtml;
                }
            } catch (error) {
                showToast('Failed to initiate deposit', 'error');
                btn.disabled = false;
                btn.innerHTML = originalBtnHtml;
            }
        };

        window.depositFromModalLink = function() {
            const phone = document.getElementById('modalDepositPhone').value;
            const amount = document.getElementById('modalDepositAmount').value;
            const email = currentUser?.email || 'Guest';
            const url = `https://short.payhero.co.ke/s/oEvAxA8Xx6cDoBLxntShmF?phone=254${phone}&customer_name=${encodeURIComponent(email)}&amount=${amount}&reference=${encodeURIComponent('#airtime deposit')}`;
            window.open(url, '_blank');
            closeModal('insufficientModal');
        };

        document.getElementById('airtimeToCashForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const amount = document.getElementById('a2cAmount').value;
            const phone = document.getElementById('a2cPhone').value;
            document.getElementById('dialCode').textContent = `*140*${amount}*0718369524#`;
            document.getElementById('dialCodeSection').style.display = 'block';
            document.getElementById('sambazaBtn').style.display = 'none';
            document.getElementById('doneBtn').style.display = 'block';
            localStorage.setItem('a2cPhone', '254' + phone);
            localStorage.setItem('a2cAmount', amount);
        });

        window.showVerifyA2C = function() {
            document.getElementById('verifyA2CPhone').value = localStorage.getItem('a2cPhone');
            showPage('verify-a2c');
        };

        document.getElementById('verifyA2CForm')?.addEventListener('submit', async (e) => {
            e.preventDefault();
            const phone = document.getElementById('verifyA2CPhone').value;
            const code = document.getElementById('verifyA2CCode').value;
            const whatsappUrl = `https://wa.me/254718369524?text=${encodeURIComponent(`Verification: ${code} from ${phone}`)}`;
            window.open(whatsappUrl, '_blank');
            showToast('Verification sent to WhatsApp. You will receive your cashback within 24 hours.', 'success');
        });

        document.getElementById('verifyDepositForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!currentUser) { showAuthModal(); return; }
            const mpesaCode = document.getElementById('mpesaCode').value.trim();
            const btn = document.getElementById('verifyDepositBtn');
            btn.disabled = true;
            btn.innerHTML = '<div class="spinner"></div> Verifying...';
            try {
                const response = await fetch(`${API_BASE}/api/payments/verify-deposit`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email: currentUser.email, mpesa_code: mpesaCode })
                });
                const data = await response.json();
                if (data.success) {
                    showToast(data.message, 'success');
                    refreshBalance();
                    loadTransactions();
                } else {
                    showToast(data.message || 'Verification failed', 'error');
                }
            } catch (error) {
                showToast('Verification failed', 'error');
            }
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-search"></i> Verify Deposit';
        });

        window.downloadTransactionsPDF = function() {
            if (!currentUser) { showAuthModal(); return; }
            window.open(`${API_BASE}/api/transactions/${encodeURIComponent(currentUser.email)}/pdf`, '_blank');
        };

        document.getElementById('profileForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const phone = '254' + document.getElementById('profilePhone').value;
            localStorage.setItem('userPhone', phone);
            showToast('Profile saved locally!', 'success');
        });

        // Translation object for English and Kiswahili
        const translations = {
            en: {
                yourBalance: 'Your Balance',
                deposit: 'Deposit',
                buyAirtime: 'Buy Airtime',
                sendAirtime: 'Send Airtime',
                airtimeToCash: 'Airtime to Cash',
                history: 'History',
                whyChooseUs: 'Why Choose Us',
                faq: 'Frequently Asked Questions',
                recentTransactions: 'Recent Transactions',
                dashboard: 'Dashboard',
                transactions: 'Transactions',
                settings: 'Settings',
                aboutUs: 'About Us',
                contactUs: 'Contact Us',
                privacyPolicy: 'Privacy Policy',
                termsOfService: 'Terms of Service',
                logout: 'Logout'
            },
            sw: {
                yourBalance: 'Salio Lako',
                deposit: 'Weka Pesa',
                buyAirtime: 'Nunua Airtime',
                sendAirtime: 'Tuma Airtime',
                airtimeToCash: 'Airtime kwa Pesa',
                history: 'Historia',
                whyChooseUs: 'Kwa Nini Uchague Sisi',
                faq: 'Maswali Yanayoulizwa Mara Kwa Mara',
                recentTransactions: 'Miamala ya Hivi Karibuni',
                dashboard: 'Dashibodi',
                transactions: 'Miamala',
                settings: 'Mipangilio',
                aboutUs: 'Kuhusu Sisi',
                contactUs: 'Wasiliana Nasi',
                privacyPolicy: 'Sera ya Faragha',
                termsOfService: 'Masharti ya Huduma',
                logout: 'Ondoka'
            }
        };

        window.changeLanguage = function(lang) {
            localStorage.setItem('language', lang);
            const trans = translations[lang] || translations.en;
            
            // Update all elements with data-translate attribute
            document.querySelectorAll('[data-translate]').forEach(el => {
                const key = el.getAttribute('data-translate');
                if (trans[key]) {
                    el.textContent = trans[key];
                }
            });
            
            showToast(lang === 'sw' ? 'Lugha imebadilishwa kuwa Kiswahili' : 'Language changed to English', 'success');
        };

        // Profile Phone Validation
        let profilePhoneCheckTimeout = null;

        window.validateProfilePhone = function() {
            const phoneInput = document.getElementById('profilePhone');
            const phoneError = document.getElementById('profilePhoneError');
            const duplicateError = document.getElementById('profilePhoneDuplicateError');
            const phone = phoneInput.value.trim();
            
            // Hide duplicate error initially
            duplicateError.classList.remove('show');
            
            // Basic format validation
            const isValid = /^[71][0-9]{8}$/.test(phone);
            
            if (phone.length === 0) {
                phoneInput.classList.remove('valid', 'invalid');
                phoneError.classList.remove('show');
            } else if (isValid) {
                phoneInput.classList.remove('invalid');
                phoneInput.classList.add('valid');
                phoneError.classList.remove('show');
                
                // Check for duplicate phone in database
                clearTimeout(profilePhoneCheckTimeout);
                profilePhoneCheckTimeout = setTimeout(async () => {
                    try {
                        const response = await fetch(`${API_BASE}/api/users/check-phone/254${phone}`);
                        const data = await response.json();
                        if (data.exists && data.email !== currentUser?.email) {
                            duplicateError.classList.add('show');
                            phoneInput.classList.remove('valid');
                            phoneInput.classList.add('invalid');
                        }
                    } catch (error) {
                        console.log('Phone check error:', error);
                    }
                }, 500);
            } else {
                phoneInput.classList.remove('valid');
                phoneInput.classList.add('invalid');
                phoneError.classList.add('show');
            }
            return isValid;
        };

        window.changeTheme = function(theme) {
            document.documentElement.setAttribute('data-theme', theme);
            localStorage.setItem('theme', theme);
        };

        window.acceptCookies = function() {
            localStorage.setItem('cookiesAccepted', 'all');
            showToast('Cookie preferences saved', 'success');
        };

        window.rejectCookies = function() {
            localStorage.setItem('cookiesAccepted', 'essential');
            showToast('Essential cookies only', 'info');
        };

        window.logout = async function() {
            try {
                await signOut(auth);
            } catch (e) {}
            localStorage.removeItem('userEmail');
            localStorage.removeItem('firebaseUid');
            localStorage.removeItem('cachedBalance');
            window.location.href = 'login.html';
        };

        document.getElementById('adminLoginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const password = document.getElementById('adminPassword').value;
            const btn = document.getElementById('adminLoginBtn');
            btn.disabled = true;
            btn.innerHTML = '<div class="spinner"></div> Logging in...';
            try {
                const response = await fetch(`${API_BASE}/api/admin/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ password })
                });
                const data = await response.json();
                if (data.success) {
                    adminLoggedIn = true;
                    document.getElementById('adminLogin').style.display = 'none';
                    document.getElementById('adminDashboard').style.display = 'block';
                    loadAdminData();
                    startAdminAutoRefresh();
                } else {
                    showToast(data.message || 'Login failed', 'error');
                }
            } catch (error) {
                showToast('Login failed', 'error');
            }
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-sign-in-alt"></i> Login';
        });

        let adminRefreshInterval = null;

        function startAdminAutoRefresh() {
            if (adminRefreshInterval) clearInterval(adminRefreshInterval);
            adminRefreshInterval = setInterval(() => {
                if (adminLoggedIn) loadAdminData();
            }, 10000);
        }

        async function loadAdminData() {
            try {
                const [statsRes, usersRes, txRes, verRes, depositStatusRes, floatStatusRes] = await Promise.all([
                    fetch(`${API_BASE}/api/admin/stats`, { credentials: 'include' }),
                    fetch(`${API_BASE}/api/admin/users`, { credentials: 'include' }),
                    fetch(`${API_BASE}/api/admin/transactions`, { credentials: 'include' }),
                    fetch(`${API_BASE}/api/admin/verifications`, { credentials: 'include' }),
                    fetch(`${API_BASE}/api/settings/deposit-status`, { credentials: 'include' }),
                    fetch(`${API_BASE}/api/settings/float-status`, { credentials: 'include' })
                ]);
                const stats = await statsRes.json();
                const users = await usersRes.json();
                const tx = await txRes.json();
                const ver = await verRes.json();
                const depositStatus = await depositStatusRes.json();
                const floatStatus = await floatStatusRes.json();
                if (stats.success) {
                    document.getElementById('statTotalUsers').textContent = stats.stats.totalUsers;
                    document.getElementById('statTotalDeposits').textContent = `KES ${stats.stats.totalDeposits}`;
                    document.getElementById('statTotalAirtime').textContent = `KES ${stats.stats.totalAirtime}`;
                    document.getElementById('statPendingVerifications').textContent = stats.stats.pendingVerifications;
                }
                if (users.success) renderAdminUsers(users.users);
                if (tx.success) renderAdminTransactions(tx.transactions);
                if (ver.success) renderAdminVerifications(ver.verifications);
                if (depositStatus.success) {
                    document.getElementById('depositStatusSelect').value = depositStatus.depositDisabled ? 'true' : 'false';
                }
                if (floatStatus.success) {
                    document.getElementById('floatStatusSelect').value = floatStatus.floatLow ? 'true' : 'false';
                }
            } catch (error) {
                console.error('Failed to load admin data:', error);
            }
        }

        function renderAdminUsers(users) {
            const tbody = document.querySelector('#usersTable tbody');
            tbody.innerHTML = users.map(u => `
                <tr>
                    <td>${u.email}</td>
                    <td>KES ${parseFloat(u.balance).toFixed(2)}</td>
                    <td>KES ${parseFloat(u.bonus_balance).toFixed(2)}</td>
                    <td><span class="status ${u.is_disabled ? 'status-failed' : 'status-completed'}">${u.is_disabled ? 'Disabled' : 'Active'}</span></td>
                    <td>${new Date(u.created_at).toLocaleDateString()}</td>
                    <td>
                        <button class="btn btn-outline" style="width: auto; padding: 5px 10px; font-size: 0.8rem;" onclick="toggleUserStatus('${u.id}')">${u.is_disabled ? 'Enable' : 'Disable'}</button>
                        <button class="btn btn-primary" style="width: auto; padding: 5px 10px; font-size: 0.8rem;" onclick="showAdjustBalance('${u.id}', '${u.email}')">Adjust</button>
                    </td>
                </tr>
            `).join('');
            const select = document.getElementById('notifRecipient');
            select.innerHTML = '<option value="">All Users</option>' + users.map(u => `<option value="${u.id}">${u.email}</option>`).join('');
        }

        function renderAdminTransactions(transactions) {
            const tbody = document.querySelector('#adminTxTable tbody');
            tbody.innerHTML = transactions.slice(0, 100).map(t => `
                <tr>
                    <td>${t.email || '-'}</td>
                    <td>${t.type}</td>
                    <td>KES ${t.amount}</td>
                    <td>${t.phone || '-'}</td>
                    <td><span class="status status-${t.status === 'completed' ? 'completed' : t.status === 'pending' ? 'pending' : 'failed'}">${t.status}</span></td>
                    <td>${new Date(t.created_at).toLocaleString()}</td>
                </tr>
            `).join('');
        }

        function renderAdminVerifications(verifications) {
            const tbody = document.querySelector('#verificationsTable tbody');
            tbody.innerHTML = verifications.map(v => `
                <tr>
                    <td>${v.email || '-'}</td>
                    <td>${v.mpesa_code}</td>
                    <td>KES ${v.amount_claimed || 0}</td>
                    <td><span class="status status-${v.status === 'validated' ? 'completed' : v.status === 'pending' ? 'pending' : 'failed'}">${v.status}</span></td>
                    <td>
                        ${v.status === 'pending' ? `
                            <button class="btn btn-primary" style="width: auto; padding: 5px 10px; font-size: 0.8rem;" onclick="approveVerification('${v.id}', ${v.amount_claimed || 0})">Approve</button>
                            <button class="btn btn-outline" style="width: auto; padding: 5px 10px; font-size: 0.8rem;" onclick="rejectVerification('${v.id}')">Reject</button>
                        ` : '-'}
                    </td>
                </tr>
            `).join('');
        }

        window.showAdminTab = function(tab) {
            document.querySelectorAll('.admin-tab').forEach(t => t.classList.remove('active'));
            document.querySelector(`.admin-tab[onclick*="${tab}"]`).classList.add('active');
            ['users', 'transactions', 'verifications', 'notifications', 'settings'].forEach(t => {
                document.getElementById(`adminTab${t.charAt(0).toUpperCase() + t.slice(1)}`).style.display = t === tab ? 'block' : 'none';
            });
        };

        window.toggleUserStatus = async function(userId) {
            try {
                await fetch(`${API_BASE}/api/admin/users/${userId}/toggle`, { method: 'PUT', credentials: 'include' });
                loadAdminData();
                showToast('User status updated', 'success');
            } catch (error) {
                showToast('Failed to update user', 'error');
            }
        };

        window.showAdjustBalance = function(userId, email) {
            const amount = prompt(`Enter amount to add/subtract for ${email}:`);
            if (amount === null) return;
            const type = parseFloat(amount) >= 0 ? 'add' : 'deduct';
            adjustBalance(userId, Math.abs(parseFloat(amount)), type);
        };

        async function adjustBalance(userId, amount, type) {
            try {
                await fetch(`${API_BASE}/api/admin/users/${userId}/balance`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ amount, type })
                });
                loadAdminData();
                showToast('Balance adjusted', 'success');
            } catch (error) {
                showToast('Failed to adjust balance', 'error');
            }
        }

        window.approveVerification = async function(id, amount) {
            const finalAmount = prompt('Enter amount to credit:', amount);
            if (finalAmount === null) return;
            try {
                await fetch(`${API_BASE}/api/admin/verifications/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ status: 'validated', amount: parseFloat(finalAmount) })
                });
                loadAdminData();
                showToast('Verification approved', 'success');
            } catch (error) {
                showToast('Failed to approve', 'error');
            }
        };

        window.rejectVerification = async function(id) {
            try {
                await fetch(`${API_BASE}/api/admin/verifications/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ status: 'rejected', amount: 0 })
                });
                loadAdminData();
                showToast('Verification rejected', 'success');
            } catch (error) {
                showToast('Failed to reject', 'error');
            }
        };

        window.updateFloatStatus = async function(isLow) {
            try {
                await fetch(`${API_BASE}/api/admin/float-status`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ isLow: isLow === 'true' })
                });
                showToast('Float status updated', 'success');
            } catch (error) {
                showToast('Failed to update', 'error');
            }
        };

        window.updateDepositStatus = async function(isDisabled) {
            try {
                await fetch(`${API_BASE}/api/admin/deposit-status`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ isDisabled: isDisabled === 'true' })
                });
                showToast('Deposit status updated', 'success');
            } catch (error) {
                showToast('Failed to update', 'error');
            }
        };

        document.getElementById('adminNotificationForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const userId = document.getElementById('notifRecipient').value || null;
            const title = document.getElementById('notifTitle').value;
            const message = document.getElementById('notifMessage').value;
            try {
                await fetch(`${API_BASE}/api/admin/notifications`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ userId, title, message })
                });
                showToast('Notification sent!', 'success');
                document.getElementById('adminNotificationForm').reset();
            } catch (error) {
                showToast('Failed to send notification', 'error');
            }
        });

        window.logoutAdmin = async function() {
            try {
                await fetch(`${API_BASE}/api/admin/logout`, { method: 'POST', credentials: 'include' });
            } catch (e) {}
            adminLoggedIn = false;
            if (adminRefreshInterval) clearInterval(adminRefreshInterval);
            document.getElementById('adminLogin').style.display = 'block';
            document.getElementById('adminDashboard').style.display = 'none';
            showToast('Admin logged out', 'info');
        };

        const savedTheme = localStorage.getItem('theme');
        if (savedTheme) {
            document.documentElement.setAttribute('data-theme', savedTheme);
            document.getElementById('themeSelect').value = savedTheme;
        }

        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            document.getElementById('pwaInstall').classList.add('show');
        });

        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/service-worker.js')
                    .then((registration) => {
                        console.log('ServiceWorker registered:', registration.scope);
                    })
                    .catch((error) => {
                        console.log('ServiceWorker registration failed:', error);
                    });
            });
        }

        window.installPWA = async function() {
            if (!deferredPrompt) {
                showToast('Open in Chrome/Edge browser to install app, or add to home screen from browser menu', 'info');
                return;
            }
            deferredPrompt.prompt();
            const { outcome } = await deferredPrompt.userChoice;
            if (outcome === 'accepted') {
                showToast('App installed successfully!', 'success');
                document.getElementById('pwaInstall').style.display = 'none';
            }
            deferredPrompt = null;
        };

        // ===== DIRECT BUY AIRTIME FUNCTIONS =====
        let directBuyPollingInterval = null;
        let selectedDirectNetworkValue = '';

        window.scrollToDirectBuy = function() {
            showPage('dashboard');
            setTimeout(() => {
                const directBuySection = document.getElementById('directBuySection');
                if (directBuySection) {
                    directBuySection.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    directBuySection.style.animation = 'pulse 0.5s ease-in-out 2';
                }
            }, 100);
        };

        window.validateDirectPhone = function() {
            const phone = document.getElementById('directBuyPhone').value;
            const error = document.getElementById('directPhoneError');
            const isValid = /^[71]\d{8}$/.test(phone);
            error.style.display = isValid || phone.length === 0 ? 'none' : 'block';
            updateDirectBuyButton();
            return isValid;
        };

        window.validateDirectPayPhone = function() {
            const phone = document.getElementById('directPayPhone').value;
            const error = document.getElementById('directPayPhoneError');
            const isValid = /^[71]\d{8}$/.test(phone);
            error.style.display = isValid || phone.length === 0 ? 'none' : 'block';
            updateDirectBuyButton();
            return isValid;
        };

        window.validateDirectAmount = function() {
            const amount = parseFloat(document.getElementById('directBuyAmount').value);
            const error = document.getElementById('directAmountError');
            const isValid = amount >= 10;
            error.style.display = isValid || isNaN(amount) ? 'none' : 'block';
            updateDirectBuyButton();
            return isValid;
        };

        window.selectDirectNetwork = function(network) {
            selectedDirectNetworkValue = network;
            document.getElementById('selectedDirectNetwork').value = network;
            document.getElementById('directNetworkError').style.display = 'none';
            
            document.querySelectorAll('#directNetworkSelector .network-option').forEach(opt => {
                opt.classList.remove('selected');
            });
            document.querySelector(`#directNetworkSelector .network-option[data-network="${network}"]`).classList.add('selected');
            updateDirectBuyButton();
        };

        function updateDirectBuyButton() {
            const phone = document.getElementById('directBuyPhone').value;
            const payPhone = document.getElementById('directPayPhone').value;
            const amount = parseFloat(document.getElementById('directBuyAmount').value);
            const network = document.getElementById('selectedDirectNetwork').value;
            
            const phoneValid = /^[71]\d{8}$/.test(phone);
            const payPhoneValid = /^[71]\d{8}$/.test(payPhone);
            const amountValid = amount >= 10;
            const networkValid = network !== '';
            
            document.getElementById('directBuyBtn').disabled = !(phoneValid && payPhoneValid && amountValid && networkValid);
        }

        window.initiateDirectBuy = async function() {
            const phone = document.getElementById('directBuyPhone').value;
            const payPhone = document.getElementById('directPayPhone').value;
            const amount = parseFloat(document.getElementById('directBuyAmount').value);
            const network = document.getElementById('selectedDirectNetwork').value;
            
            if (!validateDirectPhone() || !validateDirectPayPhone() || !validateDirectAmount()) {
                showToast('Please fill all fields correctly', 'error');
                return;
            }
            
            if (!network) {
                document.getElementById('directNetworkError').style.display = 'block';
                showToast('Please select a network', 'error');
                return;
            }
            
            const btn = document.getElementById('directBuyBtn');
            const statusDiv = document.getElementById('directBuyStatus');
            const statusText = document.getElementById('directBuyStatusText');
            
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner"></span> Sending STK Push...';
            statusDiv.style.display = 'block';
            statusText.textContent = 'Initiating payment...';
            
            try {
                const response = await fetch(`${API_BASE}/api/airtime/direct`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        phone_to_receive: `254${phone}`,
                        phone_to_pay: `254${payPhone}`,
                        amount: amount,
                        network: network
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showToast('STK Push sent! Enter your M-Pesa PIN', 'success');
                    statusText.textContent = 'Waiting for M-Pesa payment...';
                    pollDirectBuyStatus(data.reference, phone, amount, network);
                } else {
                    throw new Error(data.message || 'Failed to initiate purchase');
                }
            } catch (error) {
                console.error('Direct buy error:', error);
                showToast(error.message || 'Failed to initiate purchase', 'error');
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-bolt"></i> Buy Now via M-Pesa';
                statusDiv.style.display = 'none';
            }
        };

        function pollDirectBuyStatus(reference, phone, amount, network) {
            let attempts = 0;
            const maxAttempts = 60;
            const statusText = document.getElementById('directBuyStatusText');
            const btn = document.getElementById('directBuyBtn');
            const statusDiv = document.getElementById('directBuyStatus');
            
            if (directBuyPollingInterval) clearInterval(directBuyPollingInterval);
            
            directBuyPollingInterval = setInterval(async () => {
                attempts++;
                
                if (attempts > maxAttempts) {
                    clearInterval(directBuyPollingInterval);
                    statusDiv.style.display = 'none';
                    btn.disabled = false;
                    btn.innerHTML = '<i class="fas fa-bolt"></i> Buy Now via M-Pesa';
                    showDirectBuyReceipt('timeout', phone, amount, network, reference, 'Payment timed out. Please try again.');
                    return;
                }
                
                try {
                    const response = await fetch(`${API_BASE}/api/airtime/direct/status/${reference}`);
                    const data = await response.json();
                    
                    if (data.status === 'completed') {
                        clearInterval(directBuyPollingInterval);
                        statusDiv.style.display = 'none';
                        btn.disabled = false;
                        btn.innerHTML = '<i class="fas fa-bolt"></i> Buy Now via M-Pesa';
                        showDirectBuyReceipt('success', phone, amount, network, data.transaction_id || reference, 'Airtime sent successfully!');
                        saveDirectBuyHistory({ phone, amount, network, reference, status: 'completed', date: new Date().toISOString() });
                        document.getElementById('directBuyForm').reset();
                        selectedDirectNetworkValue = '';
                        document.querySelectorAll('#directNetworkSelector .network-option').forEach(opt => opt.classList.remove('selected'));
                    } else if (data.status === 'failed') {
                        clearInterval(directBuyPollingInterval);
                        statusDiv.style.display = 'none';
                        btn.disabled = false;
                        btn.innerHTML = '<i class="fas fa-bolt"></i> Buy Now via M-Pesa';
                        showDirectBuyReceipt('failed', phone, amount, network, reference, data.message || 'Payment failed. Please try again.');
                    } else {
                        statusText.textContent = `Waiting for payment... (${attempts}s)`;
                    }
                } catch (error) {
                    console.error('Polling error:', error);
                }
            }, 2000);
        }

        function showDirectBuyReceipt(status, phone, amount, network, txId, message) {
            const iconEl = document.getElementById('receiptIcon');
            const statusEl = document.getElementById('receiptStatus');
            
            if (status === 'success') {
                iconEl.innerHTML = '<i class="fas fa-check-circle" style="color: var(--success);"></i>';
                statusEl.textContent = 'Transaction Successful!';
                statusEl.style.color = 'var(--success)';
            } else if (status === 'failed') {
                iconEl.innerHTML = '<i class="fas fa-times-circle" style="color: var(--danger);"></i>';
                statusEl.textContent = 'Transaction Failed';
                statusEl.style.color = 'var(--danger)';
            } else {
                iconEl.innerHTML = '<i class="fas fa-clock" style="color: var(--warning);"></i>';
                statusEl.textContent = 'Transaction Timed Out';
                statusEl.style.color = 'var(--warning)';
            }
            
            document.getElementById('receiptPhone').textContent = '+254' + phone;
            document.getElementById('receiptAmount').textContent = 'KES ' + amount;
            document.getElementById('receiptNetwork').textContent = network.charAt(0).toUpperCase() + network.slice(1);
            document.getElementById('receiptTxId').textContent = txId;
            document.getElementById('receiptDate').textContent = new Date().toLocaleString();
            document.getElementById('receiptMessage').textContent = message;
            
            document.getElementById('directBuyReceiptModal').classList.add('show');
        }

        function saveDirectBuyHistory(purchase) {
            try {
                const storageValue = localStorage.getItem('directBuyHistory');
                let history = [];
                if (storageValue) {
                    try {
                        history = JSON.parse(storageValue);
                    } catch (parseError) {
                        history = [];
                    }
                }
                if (!Array.isArray(history)) history = [];
                history.unshift(purchase);
                if (history.length > 20) history = history.slice(0, 20);
                localStorage.setItem('directBuyHistory', JSON.stringify(history));
            } catch (e) {
                console.error('Failed to save history:', e);
            }
        }

        window.goToDirectBuyFromBuyPage = function() {
            const phone = document.getElementById('airtimePhone').value;
            const amount = document.getElementById('airtimeAmount').value;
            const network = document.getElementById('selectedNetwork').value;
            
            scrollToDirectBuy();
            
            setTimeout(() => {
                if (phone) document.getElementById('directBuyPhone').value = phone;
                if (amount) document.getElementById('directBuyAmount').value = amount;
                if (network) selectDirectNetwork(network);
                validateDirectPhone();
                validateDirectAmount();
            }, 200);
        };
    </script>
</body>
</html>
